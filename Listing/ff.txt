; generated by ARM C/C++ Compiler, 5.03 [Build 76]
; commandline ArmCC [--list --split_sections --debug -c --asm --interleave -o..\output\ff.o --asm_dir=..\Listing\ --list_dir=..\Listing\ --depend=..\output\ff.d --cpu=Cortex-M4.fp --apcs=interwork -O1 --diag_suppress=870 -I..\APP -I..\drive -I..\Include -I..\Libraries\CMSIS\inc -I..\Libraries\CMSIS\src -I..\Libraries\FWlib\inc -I..\Libraries\FWlib\src -I..\Listing -I..\Output -I..\Project -I..\STemWinLibrary522\Config -I..\STemWinLibrary522\emWinTask -I..\STemWinLibrary522\GUILib -I..\STemWinLibrary522\inc -I..\User -I..\USB\STM32_USB_HOST_Library\Class\HID\inc -I..\USB\STM32_USB_HOST_Library\Class\MSC\src -I..\USB\STM32_USB_HOST_Library\Core\src -I..\USB\USB_APP -I..\USB\STM32_USB_HOST_Library\Class\HID\src -I..\USB\STM32_USB_HOST_Library\Class\MSC\inc -I..\USB\STM32_USB_HOST_Library\Core\inc -I..\USB\STM32_USB_OTG_Driver\inc -I..\FATFS\exfuns -I..\FATFS\src\option -I..\FATFS\src -I..\MALLOC -Id:\Keil\ARM\RV31\INC -Id:\Keil\ARM\CMSIS\Include -Id:\Keil\ARM\Inc\ST\STM32F4xx -DUSE_STDPERIPH_DRIVER -DSTM32F40XX -DUSE_USB_OTG_FS -DUSE_EMBEDDED_PHY -DUSE_USB_OTG_HS -DSTM32F40XX --omf_browse=..\output\ff.crf ..\drive\ff.c]
                          THUMB

                          AREA ||i.check_fs||, CODE, READONLY, ALIGN=2

                  check_fs PROC
;;;2134   static
;;;2135   BYTE check_fs (	/* 0:FAT boor sector, 1:Valid boor sector but not FAT, 2:Not a boot sector, 3:Disk error */
000000  b510              PUSH     {r4,lr}
;;;2136   	FATFS* fs,	/* File system object */
;;;2137   	DWORD sect	/* Sector# (lba) to check if it is an FAT boot record or not */
;;;2138   )
;;;2139   {
000002  4604              MOV      r4,r0
;;;2140   	fs->wflag = 0; fs->winsect = 0xFFFFFFFF;	/* Invaidate window */
000004  2000              MOVS     r0,#0
000006  7120              STRB     r0,[r4,#4]
000008  1e40              SUBS     r0,r0,#1
00000a  62e0              STR      r0,[r4,#0x2c]
;;;2141   	if (move_window(fs, sect) != FR_OK)			/* Load boot record */
00000c  4620              MOV      r0,r4
00000e  f7fffffe          BL       move_window
000012  b108              CBZ      r0,|L1.24|
;;;2142   		return 3;
000014  2003              MOVS     r0,#3
;;;2143   
;;;2144   	if (LD_WORD(&fs->win[BS_55AA]) != 0xAA55)	/* Check boot record signature (always placed at offset 510 even if the sector size is >512) */
;;;2145   		return 2;
;;;2146   
;;;2147   	if ((LD_DWORD(&fs->win[BS_FilSysType]) & 0xFFFFFF) == 0x544146)		/* Check "FAT" string */
;;;2148   		return 0;
;;;2149   	if ((LD_DWORD(&fs->win[BS_FilSysType32]) & 0xFFFFFF) == 0x544146)	/* Check "FAT" string */
;;;2150   		return 0;
;;;2151   
;;;2152   	return 1;
;;;2153   }
000016  bd10              POP      {r4,pc}
                  |L1.24|
000018  f894022e          LDRB     r0,[r4,#0x22e]        ;2144
00001c  f894122f          LDRB     r1,[r4,#0x22f]        ;2144
000020  ea402001          ORR      r0,r0,r1,LSL #8       ;2144
000024  f5a0412a          SUB      r1,r0,#0xaa00         ;2144
000028  3955              SUBS     r1,r1,#0x55           ;2144
00002a  d001              BEQ      |L1.48|
00002c  2002              MOVS     r0,#2                 ;2145
00002e  bd10              POP      {r4,pc}
                  |L1.48|
000030  f8140f66          LDRB     r0,[r4,#0x66]!        ;2147
000034  78e1              LDRB     r1,[r4,#3]            ;2147
000036  7862              LDRB     r2,[r4,#1]            ;2147
000038  ea406101          ORR      r1,r0,r1,LSL #24      ;2147
00003c  78a0              LDRB     r0,[r4,#2]            ;2147
00003e  f1a40466          SUB      r4,r4,#0x66           ;2147
000042  0400              LSLS     r0,r0,#16             ;2147
000044  ea402002          ORR      r0,r0,r2,LSL #8       ;2147
000048  ea410100          ORR      r1,r1,r0              ;2147
00004c  480b              LDR      r0,|L1.124|
00004e  ebb02f01          CMP      r0,r1,LSL #8          ;2147
000052  d101              BNE      |L1.88|
000054  2000              MOVS     r0,#0                 ;2148
000056  bd10              POP      {r4,pc}
                  |L1.88|
000058  f8141f82          LDRB     r1,[r4,#0x82]!        ;2149
00005c  78e2              LDRB     r2,[r4,#3]            ;2149
00005e  7863              LDRB     r3,[r4,#1]            ;2149
000060  ea416102          ORR      r1,r1,r2,LSL #24      ;2149
000064  78a2              LDRB     r2,[r4,#2]            ;2149
000066  0412              LSLS     r2,r2,#16             ;2149
000068  ea422203          ORR      r2,r2,r3,LSL #8       ;2149
00006c  4311              ORRS     r1,r1,r2              ;2149
00006e  ebb02f01          CMP      r0,r1,LSL #8          ;2149
000072  d101              BNE      |L1.120|
000074  2000              MOVS     r0,#0                 ;2150
000076  bd10              POP      {r4,pc}
                  |L1.120|
000078  2001              MOVS     r0,#1                 ;2152
00007a  bd10              POP      {r4,pc}
;;;2154   
                          ENDP

                  |L1.124|
                          DCD      0x54414600

                          AREA ||i.chk_chr||, CODE, READONLY, ALIGN=1

                  chk_chr PROC
;;;597    static
;;;598    int chk_chr (const char* str, int chr) {
000000  e000              B        |L2.4|
                  |L2.2|
;;;599    	while (*str && *str != chr) str++;
000002  1c40              ADDS     r0,r0,#1
                  |L2.4|
000004  7802              LDRB     r2,[r0,#0]
000006  b10a              CBZ      r2,|L2.12|
000008  428a              CMP      r2,r1
00000a  d1fa              BNE      |L2.2|
                  |L2.12|
;;;600    	return *str;
00000c  7800              LDRB     r0,[r0,#0]
;;;601    }
00000e  4770              BX       lr
;;;602    
                          ENDP


                          AREA ||i.clmt_clust||, CODE, READONLY, ALIGN=1

                  clmt_clust PROC
;;;1088   static
;;;1089   DWORD clmt_clust (	/* <2:Error, >=2:Cluster number */
000000  6a42              LDR      r2,[r0,#0x24]
;;;1090   	FIL* fp,		/* Pointer to the file object */
;;;1091   	DWORD ofs		/* File offset to be converted to cluster# */
;;;1092   )
;;;1093   {
;;;1094   	DWORD cl, ncl, *tbl;
;;;1095   
;;;1096   
;;;1097   	tbl = fp->cltbl + 1;	/* Top of CLMT */
000002  1d12              ADDS     r2,r2,#4
;;;1098   	cl = ofs / SS(fp->fs) / fp->fs->csize;	/* Cluster order from top of the file */
000004  6800              LDR      r0,[r0,#0]
000006  0a49              LSRS     r1,r1,#9
000008  7880              LDRB     r0,[r0,#2]
00000a  fbb1f0f0          UDIV     r0,r1,r0
                  |L3.14|
;;;1099   	for (;;) {
;;;1100   		ncl = *tbl++;			/* Number of cluters in the fragment */
00000e  ca02              LDM      r2!,{r1}
;;;1101   		if (!ncl) return 0;		/* End of table? (error) */
000010  b121              CBZ      r1,|L3.28|
;;;1102   		if (cl < ncl) break;	/* In this fragment? */
000012  4288              CMP      r0,r1
000014  d204              BCS      |L3.32|
;;;1103   		cl -= ncl; tbl++;		/* Next fragment */
;;;1104   	}
;;;1105   	return cl + *tbl;	/* Return the cluster number */
000016  6811              LDR      r1,[r2,#0]
000018  4408              ADD      r0,r0,r1
;;;1106   }
00001a  4770              BX       lr
                  |L3.28|
00001c  2000              MOVS     r0,#0                 ;1101
00001e  4770              BX       lr
                  |L3.32|
000020  1a40              SUBS     r0,r0,r1              ;1103
000022  1d12              ADDS     r2,r2,#4              ;1103
000024  e7f3              B        |L3.14|
;;;1107   #endif	/* _USE_FASTSEEK */
                          ENDP


                          AREA ||i.clust2sect||, CODE, READONLY, ALIGN=1

                  clust2sect PROC
;;;846    
;;;847    DWORD clust2sect (	/* !=0: Sector number, 0: Failed - invalid cluster# */
000000  1e89              SUBS     r1,r1,#2
;;;848    	FATFS* fs,		/* File system object */
;;;849    	DWORD clst		/* Cluster# to be converted */
;;;850    )
;;;851    {
;;;852    	clst -= 2;
;;;853    	if (clst >= (fs->n_fatent - 2)) return 0;		/* Invalid cluster# */
000002  6942              LDR      r2,[r0,#0x14]
000004  1e92              SUBS     r2,r2,#2
000006  428a              CMP      r2,r1
000008  d801              BHI      |L4.14|
00000a  2000              MOVS     r0,#0
;;;854    	return clst * fs->csize + fs->database;
;;;855    }
00000c  4770              BX       lr
                  |L4.14|
00000e  6a82              LDR      r2,[r0,#0x28]         ;854
000010  7880              LDRB     r0,[r0,#2]            ;854
000012  fb012000          MLA      r0,r1,r0,r2           ;854
000016  4770              BX       lr
;;;856    
                          ENDP


                          AREA ||i.cmp_lfn||, CODE, READONLY, ALIGN=2

                  cmp_lfn PROC
;;;1307   static
;;;1308   int cmp_lfn (			/* 1:Matched, 0:Not matched */
000000  e92d5ff0          PUSH     {r4-r12,lr}
;;;1309   	WCHAR* lfnbuf,		/* Pointer to the LFN to be compared */
;;;1310   	BYTE* dir			/* Pointer to the directory entry containing a part of LFN */
;;;1311   )
;;;1312   {
000004  4681              MOV      r9,r0
000006  460f              MOV      r7,r1
;;;1313   	UINT i, s;
;;;1314   	WCHAR wc, uc;
;;;1315   
;;;1316   
;;;1317   	i = ((dir[LDIR_Ord] & ~LLE) - 1) * 13;	/* Get offset in the LFN buffer */
000008  7838              LDRB     r0,[r7,#0]
00000a  f0200040          BIC      r0,r0,#0x40
00000e  1e40              SUBS     r0,r0,#1
000010  eb000180          ADD      r1,r0,r0,LSL #2
000014  eb0104c0          ADD      r4,r1,r0,LSL #3
;;;1318   	s = 0; wc = 1;
000018  2600              MOVS     r6,#0
00001a  2501              MOVS     r5,#1
;;;1319   	do {
;;;1320   		uc = LD_WORD(dir+LfnOfs[s]);	/* Pick an LFN character from the entry */
00001c  f8dfa05c          LDR      r10,|L5.124|
000020  f1070801          ADD      r8,r7,#1
;;;1321   		if (wc) {	/* Last character has not been processed */
;;;1322   			wc = ff_wtoupper(uc);		/* Convert it to upper case */
;;;1323   			if (i >= _MAX_LFN || wc != ff_wtoupper(lfnbuf[i++]))	/* Compare it */
;;;1324   				return 0;				/* Not matched */
;;;1325   		} else {
;;;1326   			if (uc != 0xFFFF) return 0;	/* Check filler */
000024  f64f7bff          MOV      r11,#0xffff
                  |L5.40|
000028  f81a0006          LDRB     r0,[r10,r6]           ;1320
00002c  5c39              LDRB     r1,[r7,r0]            ;1320
00002e  f8100008          LDRB     r0,[r0,r8]            ;1320
000032  ea412000          ORR      r0,r1,r0,LSL #8       ;1320
000036  b17d              CBZ      r5,|L5.88|
000038  f7fffffe          BL       ff_wtoupper
00003c  4605              MOV      r5,r0                 ;1322
00003e  2cff              CMP      r4,#0xff              ;1323
000040  d207              BCS      |L5.82|
000042  4620              MOV      r0,r4                 ;1323
000044  1c64              ADDS     r4,r4,#1              ;1323
000046  f8390010          LDRH     r0,[r9,r0,LSL #1]     ;1323
00004a  f7fffffe          BL       ff_wtoupper
00004e  42a8              CMP      r0,r5                 ;1323
000050  d006              BEQ      |L5.96|
                  |L5.82|
000052  2000              MOVS     r0,#0                 ;1324
                  |L5.84|
;;;1327   		}
;;;1328   	} while (++s < 13);				/* Repeat until all characters in the entry are checked */
;;;1329   
;;;1330   	if ((dir[LDIR_Ord] & LLE) && wc && lfnbuf[i])	/* Last segment matched but different length */
;;;1331   		return 0;
;;;1332   
;;;1333   	return 1;						/* The part of LFN matched */
;;;1334   }
000054  e8bd9ff0          POP      {r4-r12,pc}
                  |L5.88|
000058  4558              CMP      r0,r11                ;1326
00005a  d001              BEQ      |L5.96|
00005c  2000              MOVS     r0,#0                 ;1326
00005e  e7f9              B        |L5.84|
                  |L5.96|
000060  1c76              ADDS     r6,r6,#1              ;1328
000062  2e0d              CMP      r6,#0xd               ;1328
000064  d3e0              BCC      |L5.40|
000066  7838              LDRB     r0,[r7,#0]            ;1330
000068  0640              LSLS     r0,r0,#25             ;1330
00006a  d505              BPL      |L5.120|
00006c  b125              CBZ      r5,|L5.120|
00006e  f8390014          LDRH     r0,[r9,r4,LSL #1]     ;1330
000072  b108              CBZ      r0,|L5.120|
000074  2000              MOVS     r0,#0                 ;1331
000076  e7ed              B        |L5.84|
                  |L5.120|
000078  2001              MOVS     r0,#1                 ;1333
00007a  e7eb              B        |L5.84|
;;;1335   
                          ENDP

                  |L5.124|
                          DCD      ||.constdata||

                          AREA ||i.create_chain||, CODE, READONLY, ALIGN=1

                  create_chain PROC
;;;1026   static
;;;1027   DWORD create_chain (	/* 0:No free cluster, 1:Internal error, 0xFFFFFFFF:Disk error, >=2:New cluster# */
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;1028   	FATFS* fs,			/* File system object */
;;;1029   	DWORD clst			/* Cluster# to stretch. 0 means create a new chain. */
;;;1030   )
;;;1031   {
000004  4606              MOV      r6,r0
000006  460f              MOV      r7,r1
;;;1032   	DWORD cs, ncl, scl;
;;;1033   	FRESULT res;
;;;1034   
;;;1035   
;;;1036   	if (clst == 0) {		/* Create a new chain */
000008  2f00              CMP      r7,#0
00000a  d008              BEQ      |L6.30|
;;;1037   		scl = fs->last_clust;			/* Get suggested start point */
;;;1038   		if (!scl || scl >= fs->n_fatent) scl = 1;
;;;1039   	}
;;;1040   	else {					/* Stretch the current chain */
;;;1041   		cs = get_fat(fs, clst);			/* Check the cluster status */
00000c  4639              MOV      r1,r7
00000e  4630              MOV      r0,r6
000010  f7fffffe          BL       get_fat
;;;1042   		if (cs < 2) return 1;			/* Invalid value */
000014  2802              CMP      r0,#2
000016  d209              BCS      |L6.44|
000018  2001              MOVS     r0,#1
                  |L6.26|
;;;1043   		if (cs == 0xFFFFFFFF) return cs;	/* A disk error occurred */
;;;1044   		if (cs < fs->n_fatent) return cs;	/* It is already followed by next cluster */
;;;1045   		scl = clst;
;;;1046   	}
;;;1047   
;;;1048   	ncl = scl;				/* Start cluster */
;;;1049   	for (;;) {
;;;1050   		ncl++;							/* Next cluster */
;;;1051   		if (ncl >= fs->n_fatent) {		/* Check wrap around */
;;;1052   			ncl = 2;
;;;1053   			if (ncl > scl) return 0;	/* No free cluster */
;;;1054   		}
;;;1055   		cs = get_fat(fs, ncl);			/* Get the cluster status */
;;;1056   		if (cs == 0) break;				/* Found a free cluster */
;;;1057   		if (cs == 0xFFFFFFFF || cs == 1)/* An error occurred */
;;;1058   			return cs;
;;;1059   		if (ncl == scl) return 0;		/* No free cluster */
;;;1060   	}
;;;1061   
;;;1062   	res = put_fat(fs, ncl, 0x0FFFFFFF);	/* Mark the new cluster "last link" */
;;;1063   	if (res == FR_OK && clst != 0) {
;;;1064   		res = put_fat(fs, clst, ncl);	/* Link it to the previous one if needed */
;;;1065   	}
;;;1066   	if (res == FR_OK) {
;;;1067   		fs->last_clust = ncl;			/* Update FSINFO */
;;;1068   		if (fs->free_clust != 0xFFFFFFFF) {
;;;1069   			fs->free_clust--;
;;;1070   			fs->fsi_flag |= 1;
;;;1071   		}
;;;1072   	} else {
;;;1073   		ncl = (res == FR_DISK_ERR) ? 0xFFFFFFFF : 1;
;;;1074   	}
;;;1075   
;;;1076   	return ncl;		/* Return new cluster number or error code */
;;;1077   }
00001a  e8bd81f0          POP      {r4-r8,pc}
                  |L6.30|
00001e  68f5              LDR      r5,[r6,#0xc]          ;1037
000020  b115              CBZ      r5,|L6.40|
000022  6970              LDR      r0,[r6,#0x14]         ;1038
000024  42a8              CMP      r0,r5                 ;1038
000026  d807              BHI      |L6.56|
                  |L6.40|
000028  2501              MOVS     r5,#1                 ;1038
00002a  e005              B        |L6.56|
                  |L6.44|
00002c  1c41              ADDS     r1,r0,#1              ;1043
00002e  d0f4              BEQ      |L6.26|
000030  6971              LDR      r1,[r6,#0x14]         ;1044
000032  4281              CMP      r1,r0                 ;1044
000034  d8f1              BHI      |L6.26|
000036  463d              MOV      r5,r7                 ;1045
                  |L6.56|
000038  462c              MOV      r4,r5                 ;1048
                  |L6.58|
00003a  1c64              ADDS     r4,r4,#1              ;1050
00003c  6970              LDR      r0,[r6,#0x14]         ;1051
00003e  42a0              CMP      r0,r4                 ;1051
000040  d804              BHI      |L6.76|
000042  2402              MOVS     r4,#2                 ;1052
000044  2d02              CMP      r5,#2                 ;1053
000046  d201              BCS      |L6.76|
000048  2000              MOVS     r0,#0                 ;1053
00004a  e7e6              B        |L6.26|
                  |L6.76|
00004c  4621              MOV      r1,r4                 ;1055
00004e  4630              MOV      r0,r6                 ;1055
000050  f7fffffe          BL       get_fat
000054  b138              CBZ      r0,|L6.102|
000056  1c41              ADDS     r1,r0,#1              ;1057
000058  d0df              BEQ      |L6.26|
00005a  2801              CMP      r0,#1                 ;1057
00005c  d0dd              BEQ      |L6.26|
00005e  42ac              CMP      r4,r5                 ;1059
000060  d1eb              BNE      |L6.58|
000062  2000              MOVS     r0,#0                 ;1059
000064  e7d9              B        |L6.26|
                  |L6.102|
000066  f06f4270          MVN      r2,#0xf0000000        ;1062
00006a  4621              MOV      r1,r4                 ;1062
00006c  4630              MOV      r0,r6                 ;1062
00006e  f7fffffe          BL       put_fat
000072  b928              CBNZ     r0,|L6.128|
000074  b127              CBZ      r7,|L6.128|
000076  4622              MOV      r2,r4                 ;1064
000078  4639              MOV      r1,r7                 ;1064
00007a  4630              MOV      r0,r6                 ;1064
00007c  f7fffffe          BL       put_fat
                  |L6.128|
000080  b120              CBZ      r0,|L6.140|
000082  2801              CMP      r0,#1                 ;1073
000084  d00d              BEQ      |L6.162|
000086  2401              MOVS     r4,#1                 ;1073
                  |L6.136|
000088  4620              MOV      r0,r4                 ;1076
00008a  e7c6              B        |L6.26|
                  |L6.140|
00008c  60f4              STR      r4,[r6,#0xc]          ;1067
00008e  6930              LDR      r0,[r6,#0x10]         ;1068
000090  1c41              ADDS     r1,r0,#1              ;1068
000092  d0f9              BEQ      |L6.136|
000094  1e40              SUBS     r0,r0,#1              ;1069
000096  6130              STR      r0,[r6,#0x10]         ;1069
000098  7970              LDRB     r0,[r6,#5]            ;1070
00009a  f0400001          ORR      r0,r0,#1              ;1070
00009e  7170              STRB     r0,[r6,#5]            ;1070
0000a0  e7f2              B        |L6.136|
                  |L6.162|
0000a2  f04f34ff          MOV      r4,#0xffffffff        ;1073
0000a6  e7ef              B        |L6.136|
;;;1078   #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.create_name||, CODE, READONLY, ALIGN=2

                  create_name PROC
;;;1803   static
;;;1804   FRESULT create_name (
000000  e92d5ff3          PUSH     {r0,r1,r4-r12,lr}
;;;1805   	DIR* dp,			/* Pointer to the directory object */
;;;1806   	const TCHAR** path	/* Pointer to pointer to the segment in the path string */
;;;1807   )
;;;1808   {
000004  4688              MOV      r8,r1
;;;1809   #if _USE_LFN	/* LFN configuration */
;;;1810   	BYTE b, cf;
;;;1811   	WCHAR w, *lfn;
;;;1812   	UINT i, ni, si, di;
;;;1813   	const TCHAR *p;
;;;1814   
;;;1815   	/* Create LFN in Unicode */
;;;1816   	for (p = *path; *p == '/' || *p == '\\'; p++) ;	/* Strip duplicated separator */
000006  f8d86000          LDR      r6,[r8,#0]
00000a  e000              B        |L7.14|
                  |L7.12|
00000c  1c76              ADDS     r6,r6,#1
                  |L7.14|
00000e  7830              LDRB     r0,[r6,#0]
000010  282f              CMP      r0,#0x2f
000012  d0fb              BEQ      |L7.12|
000014  285c              CMP      r0,#0x5c
000016  d0f9              BEQ      |L7.12|
;;;1817   	lfn = dp->lfn;
000018  9800              LDR      r0,[sp,#0]
00001a  f8d0a01c          LDR      r10,[r0,#0x1c]
;;;1818   	si = di = 0;
00001e  2400              MOVS     r4,#0
000020  4625              MOV      r5,r4
                  |L7.34|
;;;1819   	for (;;) {
;;;1820   		w = p[si++];					/* Get a character */
000022  4628              MOV      r0,r5
000024  1c6d              ADDS     r5,r5,#1
000026  5c30              LDRB     r0,[r6,r0]
;;;1821   		if (w < ' ' || w == '/' || w == '\\') break;	/* Break on end of segment */
000028  2820              CMP      r0,#0x20
00002a  d308              BCC      |L7.62|
00002c  282f              CMP      r0,#0x2f
00002e  d006              BEQ      |L7.62|
000030  285c              CMP      r0,#0x5c
000032  d004              BEQ      |L7.62|
;;;1822   		if (di >= _MAX_LFN)				/* Reject too long name */
000034  2cff              CMP      r4,#0xff
000036  d309              BCC      |L7.76|
;;;1823   			return FR_INVALID_NAME;
000038  2006              MOVS     r0,#6
                  |L7.58|
;;;1824   #if !_LFN_UNICODE
;;;1825   		w &= 0xFF;
;;;1826   		if (IsDBCS1(w)) {				/* Check if it is a DBC 1st byte (always false on SBCS cfg) */
;;;1827   			b = (BYTE)p[si++];			/* Get 2nd byte */
;;;1828   			if (!IsDBCS2(b))
;;;1829   				return FR_INVALID_NAME;	/* Reject invalid sequence */
;;;1830   			w = (w << 8) + b;			/* Create a DBC */
;;;1831   		}
;;;1832   		w = ff_convert(w, 1);			/* Convert ANSI/OEM to Unicode */
;;;1833   		if (!w) return FR_INVALID_NAME;	/* Reject invalid code */
;;;1834   #endif
;;;1835   		if (w < 0x80 && chk_chr("\"*:<>\?|\x7F", w)) /* Reject illegal characters for LFN */
;;;1836   			return FR_INVALID_NAME;
;;;1837   		lfn[di++] = w;					/* Store the Unicode character */
;;;1838   	}
;;;1839   	*path = &p[si];						/* Return pointer to the next segment */
;;;1840   	cf = (w < ' ') ? NS_LAST : 0;		/* Set last segment flag if end of path */
;;;1841   #if _FS_RPATH
;;;1842   	if ((di == 1 && lfn[di-1] == '.') || /* Is this a dot entry? */
;;;1843   		(di == 2 && lfn[di-1] == '.' && lfn[di-2] == '.')) {
;;;1844   		lfn[di] = 0;
;;;1845   		for (i = 0; i < 11; i++)
;;;1846   			dp->fn[i] = (i < di) ? '.' : ' ';
;;;1847   		dp->fn[i] = cf | NS_DOT;		/* This is a dot entry */
;;;1848   		return FR_OK;
;;;1849   	}
;;;1850   #endif
;;;1851   	while (di) {						/* Strip trailing spaces and dots */
;;;1852   		w = lfn[di-1];
;;;1853   		if (w != ' ' && w != '.') break;
;;;1854   		di--;
;;;1855   	}
;;;1856   	if (!di) return FR_INVALID_NAME;	/* Reject nul string */
;;;1857   
;;;1858   	lfn[di] = 0;						/* LFN is created */
;;;1859   
;;;1860   	/* Create SFN in directory form */
;;;1861   	mem_set(dp->fn, ' ', 11);
;;;1862   	for (si = 0; lfn[si] == ' ' || lfn[si] == '.'; si++) ;	/* Strip leading spaces and dots */
;;;1863   	if (si) cf |= NS_LOSS | NS_LFN;
;;;1864   	while (di && lfn[di - 1] != '.') di--;	/* Find extension (di<=si: no extension) */
;;;1865   
;;;1866   	b = i = 0; ni = 8;
;;;1867   	for (;;) {
;;;1868   		w = lfn[si++];					/* Get an LFN character */
;;;1869   		if (!w) break;					/* Break on end of the LFN */
;;;1870   		if (w == ' ' || (w == '.' && si != di)) {	/* Remove spaces and dots */
;;;1871   			cf |= NS_LOSS | NS_LFN; continue;
;;;1872   		}
;;;1873   
;;;1874   		if (i >= ni || si == di) {		/* Extension or end of SFN */
;;;1875   			if (ni == 11) {				/* Long extension */
;;;1876   				cf |= NS_LOSS | NS_LFN; break;
;;;1877   			}
;;;1878   			if (si != di) cf |= NS_LOSS | NS_LFN;	/* Out of 8.3 format */
;;;1879   			if (si > di) break;			/* No extension */
;;;1880   			si = di; i = 8; ni = 11;	/* Enter extension section */
;;;1881   			b <<= 2; continue;
;;;1882   		}
;;;1883   
;;;1884   		if (w >= 0x80) {				/* Non ASCII character */
;;;1885   #ifdef _EXCVT
;;;1886   			w = ff_convert(w, 0);		/* Unicode -> OEM code */
;;;1887   			if (w) w = ExCvt[w - 0x80];	/* Convert extended character to upper (SBCS) */
;;;1888   #else
;;;1889   			w = ff_convert(ff_wtoupper(w), 0);	/* Upper converted Unicode -> OEM code */
;;;1890   #endif
;;;1891   			cf |= NS_LFN;				/* Force create LFN entry */
;;;1892   		}
;;;1893   
;;;1894   		if (_DF1S && w >= 0x100) {		/* Double byte character (always false on SBCS cfg) */
;;;1895   			if (i >= ni - 1) {
;;;1896   				cf |= NS_LOSS | NS_LFN; i = ni; continue;
;;;1897   			}
;;;1898   			dp->fn[i++] = (BYTE)(w >> 8);
;;;1899   		} else {						/* Single byte character */
;;;1900   			if (!w || chk_chr("+,;=[]", w)) {	/* Replace illegal characters for SFN */
;;;1901   				w = '_'; cf |= NS_LOSS | NS_LFN;/* Lossy conversion */
;;;1902   			} else {
;;;1903   				if (IsUpper(w)) {		/* ASCII large capital */
;;;1904   					b |= 2;
;;;1905   				} else {
;;;1906   					if (IsLower(w)) {	/* ASCII small capital */
;;;1907   						b |= 1; w -= 0x20;
;;;1908   					}
;;;1909   				}
;;;1910   			}
;;;1911   		}
;;;1912   		dp->fn[i++] = (BYTE)w;
;;;1913   	}
;;;1914   
;;;1915   	if (dp->fn[0] == DDE) dp->fn[0] = NDDE;	/* If the first character collides with deleted mark, replace it with 0x05 */
;;;1916   
;;;1917   	if (ni == 8) b <<= 2;
;;;1918   	if ((b & 0x0C) == 0x0C || (b & 0x03) == 0x03)	/* Create LFN entry when there are composite capitals */
;;;1919   		cf |= NS_LFN;
;;;1920   	if (!(cf & NS_LFN)) {						/* When LFN is in 8.3 format without extended character, NT flags are created */
;;;1921   		if ((b & 0x03) == 0x01) cf |= NS_EXT;	/* NT flag (Extension has only small capital) */
;;;1922   		if ((b & 0x0C) == 0x04) cf |= NS_BODY;	/* NT flag (Filename has only small capital) */
;;;1923   	}
;;;1924   
;;;1925   	dp->fn[NS] = cf;	/* SFN is created */
;;;1926   
;;;1927   	return FR_OK;
;;;1928   
;;;1929   
;;;1930   #else	/* Non-LFN configuration */
;;;1931   	BYTE b, c, d, *sfn;
;;;1932   	UINT ni, si, i;
;;;1933   	const char *p;
;;;1934   
;;;1935   	/* Create file name in directory form */
;;;1936   	for (p = *path; *p == '/' || *p == '\\'; p++) ;	/* Strip duplicated separator */
;;;1937   	sfn = dp->fn;
;;;1938   	mem_set(sfn, ' ', 11);
;;;1939   	si = i = b = 0; ni = 8;
;;;1940   #if _FS_RPATH
;;;1941   	if (p[si] == '.') { /* Is this a dot entry? */
;;;1942   		for (;;) {
;;;1943   			c = (BYTE)p[si++];
;;;1944   			if (c != '.' || si >= 3) break;
;;;1945   			sfn[i++] = c;
;;;1946   		}
;;;1947   		if (c != '/' && c != '\\' && c > ' ') return FR_INVALID_NAME;
;;;1948   		*path = &p[si];									/* Return pointer to the next segment */
;;;1949   		sfn[NS] = (c <= ' ') ? NS_LAST | NS_DOT : NS_DOT;	/* Set last segment flag if end of path */
;;;1950   		return FR_OK;
;;;1951   	}
;;;1952   #endif
;;;1953   	for (;;) {
;;;1954   		c = (BYTE)p[si++];
;;;1955   		if (c <= ' ' || c == '/' || c == '\\') break;	/* Break on end of segment */
;;;1956   		if (c == '.' || i >= ni) {
;;;1957   			if (ni != 8 || c != '.') return FR_INVALID_NAME;
;;;1958   			i = 8; ni = 11;
;;;1959   			b <<= 2; continue;
;;;1960   		}
;;;1961   		if (c >= 0x80) {				/* Extended character? */
;;;1962   			b |= 3;						/* Eliminate NT flag */
;;;1963   #ifdef _EXCVT
;;;1964   			c = ExCvt[c - 0x80];		/* To upper extended characters (SBCS cfg) */
;;;1965   #else
;;;1966   #if !_DF1S
;;;1967   			return FR_INVALID_NAME;		/* Reject extended characters (ASCII cfg) */
;;;1968   #endif
;;;1969   #endif
;;;1970   		}
;;;1971   		if (IsDBCS1(c)) {				/* Check if it is a DBC 1st byte (always false on SBCS cfg) */
;;;1972   			d = (BYTE)p[si++];			/* Get 2nd byte */
;;;1973   			if (!IsDBCS2(d) || i >= ni - 1)	/* Reject invalid DBC */
;;;1974   				return FR_INVALID_NAME;
;;;1975   			sfn[i++] = c;
;;;1976   			sfn[i++] = d;
;;;1977   		} else {						/* Single byte code */
;;;1978   			if (chk_chr("\"*+,:;<=>\?[]|\x7F", c))	/* Reject illegal chrs for SFN */
;;;1979   				return FR_INVALID_NAME;
;;;1980   			if (IsUpper(c)) {			/* ASCII large capital? */
;;;1981   				b |= 2;
;;;1982   			} else {
;;;1983   				if (IsLower(c)) {		/* ASCII small capital? */
;;;1984   					b |= 1; c -= 0x20;
;;;1985   				}
;;;1986   			}
;;;1987   			sfn[i++] = c;
;;;1988   		}
;;;1989   	}
;;;1990   	*path = &p[si];						/* Return pointer to the next segment */
;;;1991   	c = (c <= ' ') ? NS_LAST : 0;		/* Set last segment flag if end of path */
;;;1992   
;;;1993   	if (!i) return FR_INVALID_NAME;		/* Reject nul string */
;;;1994   	if (sfn[0] == DDE) sfn[0] = NDDE;	/* When first character collides with DDE, replace it with 0x05 */
;;;1995   
;;;1996   	if (ni == 8) b <<= 2;
;;;1997   	if ((b & 0x03) == 0x01) c |= NS_EXT;	/* NT flag (Name extension has only small capital) */
;;;1998   	if ((b & 0x0C) == 0x04) c |= NS_BODY;	/* NT flag (Name body has only small capital) */
;;;1999   
;;;2000   	sfn[NS] = c;		/* Store NT flag, File name is created */
;;;2001   
;;;2002   	return FR_OK;
;;;2003   #endif
;;;2004   }
00003a  e8bd9ffc          POP      {r2-r12,pc}
                  |L7.62|
00003e  1971              ADDS     r1,r6,r5              ;1839
000040  f8c81000          STR      r1,[r8,#0]            ;1839
000044  2820              CMP      r0,#0x20              ;1840
000046  d22a              BCS      |L7.158|
000048  2504              MOVS     r5,#4                 ;1840
00004a  e032              B        |L7.178|
                  |L7.76|
00004c  b2c0              UXTB     r0,r0                 ;1825
00004e  f1a00181          SUB      r1,r0,#0x81           ;1826
000052  297d              CMP      r1,#0x7d              ;1826
000054  d80e              BHI      |L7.116|
000056  4629              MOV      r1,r5                 ;1827
000058  1c6d              ADDS     r5,r5,#1              ;1827
00005a  5c71              LDRB     r1,[r6,r1]            ;1827
00005c  f1a10240          SUB      r2,r1,#0x40           ;1828
000060  2a3f              CMP      r2,#0x3f              ;1828
000062  d304              BCC      |L7.110|
000064  3a40              SUBS     r2,r2,#0x40           ;1828
000066  2a7f              CMP      r2,#0x7f              ;1828
000068  d301              BCC      |L7.110|
00006a  2006              MOVS     r0,#6                 ;1829
00006c  e7e5              B        |L7.58|
                  |L7.110|
00006e  eb012000          ADD      r0,r1,r0,LSL #8       ;1830
000072  b280              UXTH     r0,r0                 ;1830
                  |L7.116|
000074  2101              MOVS     r1,#1                 ;1832
000076  f7fffffe          BL       ff_convert
00007a  4607              MOV      r7,r0                 ;1832
00007c  b147              CBZ      r7,|L7.144|
00007e  2f80              CMP      r7,#0x80              ;1835
000080  d208              BCS      |L7.148|
000082  4639              MOV      r1,r7                 ;1835
000084  a065              ADR      r0,|L7.540|
000086  f7fffffe          BL       chk_chr
00008a  b118              CBZ      r0,|L7.148|
00008c  2006              MOVS     r0,#6                 ;1836
00008e  e7d4              B        |L7.58|
                  |L7.144|
000090  2006              MOVS     r0,#6                 ;1833
000092  e7d2              B        |L7.58|
                  |L7.148|
000094  4620              MOV      r0,r4                 ;1837
000096  1c64              ADDS     r4,r4,#1              ;1837
000098  f82a7010          STRH     r7,[r10,r0,LSL #1]    ;1837
00009c  e7c1              B        |L7.34|
                  |L7.158|
00009e  2500              MOVS     r5,#0                 ;1840
0000a0  e007              B        |L7.178|
                  |L7.162|
0000a2  1e60              SUBS     r0,r4,#1              ;1852
0000a4  f83a0010          LDRH     r0,[r10,r0,LSL #1]    ;1852
0000a8  2820              CMP      r0,#0x20              ;1853
0000aa  d001              BEQ      |L7.176|
0000ac  282e              CMP      r0,#0x2e              ;1853
0000ae  d102              BNE      |L7.182|
                  |L7.176|
0000b0  1e64              SUBS     r4,r4,#1              ;1854
                  |L7.178|
0000b2  2c00              CMP      r4,#0                 ;1851
0000b4  d1f5              BNE      |L7.162|
                  |L7.182|
0000b6  b154              CBZ      r4,|L7.206|
0000b8  2000              MOVS     r0,#0                 ;1858
0000ba  f82a0014          STRH     r0,[r10,r4,LSL #1]    ;1858
0000be  9800              LDR      r0,[sp,#0]            ;1861
0000c0  220b              MOVS     r2,#0xb               ;1861
0000c2  2120              MOVS     r1,#0x20              ;1861
0000c4  6980              LDR      r0,[r0,#0x18]         ;1861
0000c6  f7fffffe          BL       mem_set
0000ca  2700              MOVS     r7,#0                 ;1862
0000cc  e002              B        |L7.212|
                  |L7.206|
0000ce  2006              MOVS     r0,#6                 ;1856
0000d0  e7b3              B        |L7.58|
                  |L7.210|
0000d2  1c7f              ADDS     r7,r7,#1              ;1862
                  |L7.212|
0000d4  f83a0017          LDRH     r0,[r10,r7,LSL #1]    ;1862
0000d8  2820              CMP      r0,#0x20              ;1862
0000da  d0fa              BEQ      |L7.210|
0000dc  282e              CMP      r0,#0x2e              ;1862
0000de  d0f8              BEQ      |L7.210|
0000e0  b11f              CBZ      r7,|L7.234|
0000e2  f0450503          ORR      r5,r5,#3              ;1863
0000e6  e000              B        |L7.234|
                  |L7.232|
0000e8  1e64              SUBS     r4,r4,#1              ;1864
                  |L7.234|
0000ea  b124              CBZ      r4,|L7.246|
0000ec  1e60              SUBS     r0,r4,#1              ;1864
0000ee  f83a0010          LDRH     r0,[r10,r0,LSL #1]    ;1864
0000f2  282e              CMP      r0,#0x2e              ;1864
0000f4  d1f8              BNE      |L7.232|
                  |L7.246|
0000f6  f04f0800          MOV      r8,#0                 ;1866
0000fa  46c1              MOV      r9,r8                 ;1866
0000fc  f04f0b08          MOV      r11,#8                ;1866
                  |L7.256|
000100  4638              MOV      r0,r7                 ;1868
000102  1c7f              ADDS     r7,r7,#1              ;1868
000104  f83a6010          LDRH     r6,[r10,r0,LSL #1]    ;1868
000108  b306              CBZ      r6,|L7.332|
00010a  2e20              CMP      r6,#0x20              ;1870
00010c  d003              BEQ      |L7.278|
00010e  2e2e              CMP      r6,#0x2e              ;1870
000110  d104              BNE      |L7.284|
000112  42a7              CMP      r7,r4                 ;1870
000114  d002              BEQ      |L7.284|
                  |L7.278|
000116  f0450503          ORR      r5,r5,#3              ;1871
00011a  e7f1              B        |L7.256|
                  |L7.284|
00011c  45d8              CMP      r8,r11                ;1874
00011e  d201              BCS      |L7.292|
000120  42a7              CMP      r7,r4                 ;1874
000122  d119              BNE      |L7.344|
                  |L7.292|
000124  f1bb0f0b          CMP      r11,#0xb              ;1875
000128  d00e              BEQ      |L7.328|
00012a  42a7              CMP      r7,r4                 ;1878
00012c  d001              BEQ      |L7.306|
00012e  f0450503          ORR      r5,r5,#3              ;1878
                  |L7.306|
000132  d80b              BHI      |L7.332|
000134  4627              MOV      r7,r4                 ;1880
000136  f04f0808          MOV      r8,#8                 ;1880
00013a  f04f0b0b          MOV      r11,#0xb              ;1880
00013e  ea4f6089          LSL      r0,r9,#26             ;1881
000142  ea4f6910          LSR      r9,r0,#24             ;1881
000146  e7db              B        |L7.256|
                  |L7.328|
000148  f0450503          ORR      r5,r5,#3              ;1876
                  |L7.332|
00014c  9800              LDR      r0,[sp,#0]            ;1915
00014e  6980              LDR      r0,[r0,#0x18]         ;1915
000150  7801              LDRB     r1,[r0,#0]            ;1915
000152  29e5              CMP      r1,#0xe5              ;1915
000154  d03d              BEQ      |L7.466|
000156  e03e              B        |L7.470|
                  |L7.344|
000158  2e80              CMP      r6,#0x80              ;1884
00015a  d308              BCC      |L7.366|
00015c  4630              MOV      r0,r6                 ;1889
00015e  f7fffffe          BL       ff_wtoupper
000162  2100              MOVS     r1,#0                 ;1889
000164  f7fffffe          BL       ff_convert
000168  4606              MOV      r6,r0                 ;1889
00016a  f0450502          ORR      r5,r5,#2              ;1891
                  |L7.366|
00016e  2eff              CMP      r6,#0xff              ;1894
000170  d90f              BLS      |L7.402|
000172  f1ab0001          SUB      r0,r11,#1             ;1895
000176  4580              CMP      r8,r0                 ;1895
000178  d303              BCC      |L7.386|
00017a  f0450503          ORR      r5,r5,#3              ;1896
00017e  46d8              MOV      r8,r11                ;1896
000180  e7be              B        |L7.256|
                  |L7.386|
000182  9800              LDR      r0,[sp,#0]            ;1898
000184  0a31              LSRS     r1,r6,#8              ;1898
000186  6982              LDR      r2,[r0,#0x18]         ;1898
000188  4640              MOV      r0,r8                 ;1898
00018a  f1080801          ADD      r8,r8,#1              ;1898
00018e  5411              STRB     r1,[r2,r0]            ;1898
000190  e018              B        |L7.452|
                  |L7.402|
000192  b126              CBZ      r6,|L7.414|
000194  4631              MOV      r1,r6                 ;1900
000196  a024              ADR      r0,|L7.552|
000198  f7fffffe          BL       chk_chr
00019c  b118              CBZ      r0,|L7.422|
                  |L7.414|
00019e  265f              MOVS     r6,#0x5f              ;1901
0001a0  f0450503          ORR      r5,r5,#3              ;1901
0001a4  e00e              B        |L7.452|
                  |L7.422|
0001a6  f1a60041          SUB      r0,r6,#0x41           ;1903
0001aa  2819              CMP      r0,#0x19              ;1903
0001ac  d802              BHI      |L7.436|
0001ae  f0490902          ORR      r9,r9,#2              ;1904
0001b2  e007              B        |L7.452|
                  |L7.436|
0001b4  f1a60061          SUB      r0,r6,#0x61           ;1906
0001b8  2819              CMP      r0,#0x19              ;1906
0001ba  d803              BHI      |L7.452|
0001bc  f0490901          ORR      r9,r9,#1              ;1907
0001c0  3e20              SUBS     r6,r6,#0x20           ;1907
0001c2  b2b6              UXTH     r6,r6                 ;1907
                  |L7.452|
0001c4  9800              LDR      r0,[sp,#0]            ;1912
0001c6  6981              LDR      r1,[r0,#0x18]         ;1912
0001c8  4640              MOV      r0,r8                 ;1912
0001ca  f1080801          ADD      r8,r8,#1              ;1912
0001ce  540e              STRB     r6,[r1,r0]            ;1912
0001d0  e796              B        |L7.256|
                  |L7.466|
0001d2  2105              MOVS     r1,#5                 ;1915
0001d4  7001              STRB     r1,[r0,#0]            ;1915
                  |L7.470|
0001d6  f1bb0f08          CMP      r11,#8                ;1917
0001da  d103              BNE      |L7.484|
0001dc  ea4f6089          LSL      r0,r9,#26             ;1917
0001e0  ea4f6910          LSR      r9,r0,#24             ;1917
                  |L7.484|
0001e4  f3c90081          UBFX     r0,r9,#2,#2           ;1918
0001e8  2803              CMP      r0,#3                 ;1918
0001ea  d003              BEQ      |L7.500|
0001ec  ea6f0109          MVN      r1,r9                 ;1918
0001f0  0789              LSLS     r1,r1,#30             ;1918
0001f2  d101              BNE      |L7.504|
                  |L7.500|
0001f4  f0450502          ORR      r5,r5,#2              ;1919
                  |L7.504|
0001f8  07a9              LSLS     r1,r5,#30             ;1920
0001fa  d409              BMI      |L7.528|
0001fc  f0090103          AND      r1,r9,#3              ;1921
000200  2901              CMP      r1,#1                 ;1921
000202  d101              BNE      |L7.520|
000204  f0450510          ORR      r5,r5,#0x10           ;1921
                  |L7.520|
000208  2801              CMP      r0,#1                 ;1922
00020a  d101              BNE      |L7.528|
00020c  f0450508          ORR      r5,r5,#8              ;1922
                  |L7.528|
000210  9800              LDR      r0,[sp,#0]            ;1925
000212  6980              LDR      r0,[r0,#0x18]         ;1925
000214  72c5              STRB     r5,[r0,#0xb]          ;1925
000216  2000              MOVS     r0,#0                 ;1927
000218  e70f              B        |L7.58|
;;;2005   
                          ENDP

00021a  0000              DCW      0x0000
                  |L7.540|
00021c  222a3a3c          DCB      """*:<>?|",127,0
000220  3e3f7c7f
000224  00      
000225  00                DCB      0
000226  00                DCB      0
000227  00                DCB      0
                  |L7.552|
000228  2b2c3b3d          DCB      "+,;=[]",0
00022c  5b5d00  
00022f  00                DCB      0

                          AREA ||i.dir_alloc||, CODE, READONLY, ALIGN=1

                  dir_alloc PROC
;;;1232   static
;;;1233   FRESULT dir_alloc (
000000  b570              PUSH     {r4-r6,lr}
;;;1234   	DIR* dp,	/* Pointer to the directory object */
;;;1235   	UINT nent	/* Number of contiguous entries to allocate (1-21) */
;;;1236   )
;;;1237   {
000002  4605              MOV      r5,r0
000004  460e              MOV      r6,r1
;;;1238   	FRESULT res;
;;;1239   	UINT n;
;;;1240   
;;;1241   
;;;1242   	res = dir_sdi(dp, 0);
000006  2100              MOVS     r1,#0
000008  4628              MOV      r0,r5
00000a  f7fffffe          BL       dir_sdi
;;;1243   	if (res == FR_OK) {
00000e  b988              CBNZ     r0,|L8.52|
;;;1244   		n = 0;
000010  2400              MOVS     r4,#0
                  |L8.18|
;;;1245   		do {
;;;1246   			res = move_window(dp->fs, dp->sect);
000012  6929              LDR      r1,[r5,#0x10]
000014  6828              LDR      r0,[r5,#0]
000016  f7fffffe          BL       move_window
;;;1247   			if (res != FR_OK) break;
00001a  b958              CBNZ     r0,|L8.52|
;;;1248   			if (dp->dir[0] == DDE || dp->dir[0] == 0) {	/* Is it a blank entry? */
00001c  6969              LDR      r1,[r5,#0x14]
00001e  7809              LDRB     r1,[r1,#0]
000020  29e5              CMP      r1,#0xe5
000022  d00b              BEQ      |L8.60|
000024  b151              CBZ      r1,|L8.60|
;;;1249   				if (++n == nent) break;	/* A block of contiguous entries is found */
;;;1250   			} else {
;;;1251   				n = 0;					/* Not a blank entry. Restart to search */
000026  2400              MOVS     r4,#0
                  |L8.40|
;;;1252   			}
;;;1253   			res = dir_next(dp, 1);		/* Next entry with table stretch enabled */
000028  2101              MOVS     r1,#1
00002a  4628              MOV      r0,r5
00002c  f7fffffe          BL       dir_next
;;;1254   		} while (res == FR_OK);
000030  2800              CMP      r0,#0
000032  d0ee              BEQ      |L8.18|
                  |L8.52|
;;;1255   	}
;;;1256   	if (res == FR_NO_FILE) res = FR_DENIED;	/* No directory entry to allocate */
000034  2804              CMP      r0,#4
000036  d100              BNE      |L8.58|
000038  2007              MOVS     r0,#7
                  |L8.58|
;;;1257   	return res;
;;;1258   }
00003a  bd70              POP      {r4-r6,pc}
                  |L8.60|
00003c  1c64              ADDS     r4,r4,#1              ;1249
00003e  42b4              CMP      r4,r6                 ;1249
000040  d0f8              BEQ      |L8.52|
000042  e7f1              B        |L8.40|
;;;1259   #endif
                          ENDP


                          AREA ||i.dir_find||, CODE, READONLY, ALIGN=1

                  dir_find PROC
;;;1488   static
;;;1489   FRESULT dir_find (
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;1490   	DIR* dp			/* Pointer to the directory object linked to the file name */
;;;1491   )
;;;1492   {
000004  4604              MOV      r4,r0
;;;1493   	FRESULT res;
;;;1494   	BYTE c, *dir;
;;;1495   #if _USE_LFN
;;;1496   	BYTE a, ord, sum;
;;;1497   #endif
;;;1498   
;;;1499   	res = dir_sdi(dp, 0);			/* Rewind directory object */
000006  2100              MOVS     r1,#0
000008  4620              MOV      r0,r4
00000a  f7fffffe          BL       dir_sdi
;;;1500   	if (res != FR_OK) return res;
00000e  2800              CMP      r0,#0
000010  d157              BNE      |L9.194|
;;;1501   
;;;1502   #if _USE_LFN
;;;1503   	ord = sum = 0xFF; dp->lfn_idx = 0xFFFF;	/* Reset LFN sequence */
000012  26ff              MOVS     r6,#0xff
000014  46b1              MOV      r9,r6
000016  f64f7aff          MOV      r10,#0xffff
00001a  f8a4a020          STRH     r10,[r4,#0x20]
                  |L9.30|
;;;1504   #endif
;;;1505   	do {
;;;1506   		res = move_window(dp->fs, dp->sect);
00001e  6921              LDR      r1,[r4,#0x10]
000020  6820              LDR      r0,[r4,#0]
000022  f7fffffe          BL       move_window
000026  4680              MOV      r8,r0
;;;1507   		if (res != FR_OK) break;
000028  f1b80f00          CMP      r8,#0
00002c  d148              BNE      |L9.192|
;;;1508   		dir = dp->dir;					/* Ptr to the directory entry of current index */
00002e  6967              LDR      r7,[r4,#0x14]
;;;1509   		c = dir[DIR_Name];
000030  783d              LDRB     r5,[r7,#0]
;;;1510   		if (c == 0) { res = FR_NO_FILE; break; }	/* Reached to end of table */
000032  b165              CBZ      r5,|L9.78|
;;;1511   #if _USE_LFN	/* LFN configuration */
;;;1512   		a = dir[DIR_Attr] & AM_MASK;
000034  7af8              LDRB     r0,[r7,#0xb]
000036  f000003f          AND      r0,r0,#0x3f
;;;1513   		if (c == DDE || ((a & AM_VOL) && a != AM_LFN)) {	/* An entry without valid data */
00003a  2de5              CMP      r5,#0xe5
00003c  d003              BEQ      |L9.70|
00003e  0701              LSLS     r1,r0,#28
000040  d508              BPL      |L9.84|
000042  280f              CMP      r0,#0xf
000044  d006              BEQ      |L9.84|
                  |L9.70|
;;;1514   			ord = 0xFF; dp->lfn_idx = 0xFFFF;	/* Reset LFN sequence */
000046  26ff              MOVS     r6,#0xff
000048  f8a4a020          STRH     r10,[r4,#0x20]
00004c  e030              B        |L9.176|
                  |L9.78|
00004e  f04f0804          MOV      r8,#4                 ;1510
000052  e035              B        |L9.192|
                  |L9.84|
;;;1515   		} else {
;;;1516   			if (a == AM_LFN) {			/* An LFN entry is found */
000054  280f              CMP      r0,#0xf
000056  d001              BEQ      |L9.92|
;;;1517   				if (dp->lfn) {
;;;1518   					if (c & LLE) {		/* Is it start of LFN sequence? */
;;;1519   						sum = dir[LDIR_Chksum];
;;;1520   						c &= ~LLE; ord = c;	/* LFN start order */
;;;1521   						dp->lfn_idx = dp->index;	/* Start index of LFN */
;;;1522   					}
;;;1523   					/* Check validity of the LFN entry and compare it with given name */
;;;1524   					ord = (c == ord && sum == dir[LDIR_Chksum] && cmp_lfn(dp->lfn, dir)) ? ord - 1 : 0xFF;
;;;1525   				}
;;;1526   			} else {					/* An SFN entry is found */
;;;1527   				if (!ord && sum == sum_sfn(dir)) break;	/* LFN matched? */
000058  b1ce              CBZ      r6,|L9.142|
00005a  e01d              B        |L9.152|
                  |L9.92|
00005c  69e0              LDR      r0,[r4,#0x1c]         ;1517
00005e  b338              CBZ      r0,|L9.176|
000060  0669              LSLS     r1,r5,#25             ;1518
000062  d506              BPL      |L9.114|
000064  f897900d          LDRB     r9,[r7,#0xd]          ;1519
000068  f0250540          BIC      r5,r5,#0x40           ;1520
00006c  462e              MOV      r6,r5                 ;1520
00006e  88e1              LDRH     r1,[r4,#6]            ;1521
000070  8421              STRH     r1,[r4,#0x20]         ;1521
                  |L9.114|
000072  42b5              CMP      r5,r6                 ;1524
000074  d108              BNE      |L9.136|
000076  7b79              LDRB     r1,[r7,#0xd]          ;1524
000078  4549              CMP      r1,r9                 ;1524
00007a  d105              BNE      |L9.136|
00007c  4639              MOV      r1,r7                 ;1524
00007e  f7fffffe          BL       cmp_lfn
000082  b108              CBZ      r0,|L9.136|
000084  1e76              SUBS     r6,r6,#1              ;1524
000086  e000              B        |L9.138|
                  |L9.136|
000088  26ff              MOVS     r6,#0xff              ;1524
                  |L9.138|
00008a  b2f6              UXTB     r6,r6                 ;1524
00008c  e010              B        |L9.176|
                  |L9.142|
00008e  4638              MOV      r0,r7
000090  f7fffffe          BL       sum_sfn
000094  4548              CMP      r0,r9
000096  d013              BEQ      |L9.192|
                  |L9.152|
;;;1528   				if (!(dp->fn[NS] & NS_LOSS) && !mem_cmp(dir, dp->fn, 11)) break;	/* SFN matched? */
000098  69a1              LDR      r1,[r4,#0x18]
00009a  7ac8              LDRB     r0,[r1,#0xb]
00009c  07c0              LSLS     r0,r0,#31
00009e  d104              BNE      |L9.170|
0000a0  220b              MOVS     r2,#0xb
0000a2  4638              MOV      r0,r7
0000a4  f7fffffe          BL       mem_cmp
0000a8  b150              CBZ      r0,|L9.192|
                  |L9.170|
;;;1529   				ord = 0xFF; dp->lfn_idx = 0xFFFF;	/* Reset LFN sequence */
0000aa  26ff              MOVS     r6,#0xff
0000ac  f8a4a020          STRH     r10,[r4,#0x20]
                  |L9.176|
;;;1530   			}
;;;1531   		}
;;;1532   #else		/* Non LFN configuration */
;;;1533   		if (!(dir[DIR_Attr] & AM_VOL) && !mem_cmp(dir, dp->fn, 11)) /* Is it a valid entry? */
;;;1534   			break;
;;;1535   #endif
;;;1536   		res = dir_next(dp, 0);		/* Next entry */
0000b0  2100              MOVS     r1,#0
0000b2  4620              MOV      r0,r4
0000b4  f7fffffe          BL       dir_next
0000b8  4680              MOV      r8,r0
;;;1537   	} while (res == FR_OK);
0000ba  f1b80f00          CMP      r8,#0
0000be  d0ae              BEQ      |L9.30|
                  |L9.192|
;;;1538   
;;;1539   	return res;
0000c0  4640              MOV      r0,r8
                  |L9.194|
;;;1540   }
0000c2  e8bd87f0          POP      {r4-r10,pc}
;;;1541   
                          ENDP


                          AREA ||i.dir_next||, CODE, READONLY, ALIGN=1

                  dir_next PROC
;;;1163   static
;;;1164   FRESULT dir_next (	/* FR_OK:Succeeded, FR_NO_FILE:End of table, FR_DENIED:Could not stretch */
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;1165   	DIR* dp,		/* Pointer to the directory object */
;;;1166   	int stretch		/* 0: Do not stretch table, 1: Stretch table if needed */
;;;1167   )
;;;1168   {
000004  4604              MOV      r4,r0
000006  460e              MOV      r6,r1
;;;1169   	DWORD clst;
;;;1170   	UINT i;
;;;1171   
;;;1172   
;;;1173   	i = dp->index + 1;
000008  88e7              LDRH     r7,[r4,#6]
00000a  1c7f              ADDS     r7,r7,#1
;;;1174   	if (!(i & 0xFFFF) || !dp->sect)	/* Report EOT when index has reached 65535 */
00000c  0438              LSLS     r0,r7,#16
00000e  0c00              LSRS     r0,r0,#16
000010  d004              BEQ      |L10.28|
000012  6920              LDR      r0,[r4,#0x10]
000014  b110              CBZ      r0,|L10.28|
;;;1175   		return FR_NO_FILE;
;;;1176   
;;;1177   	if (!(i % (SS(dp->fs) / SZ_DIR))) {	/* Sector changed? */
000016  0739              LSLS     r1,r7,#28
000018  d003              BEQ      |L10.34|
00001a  e066              B        |L10.234|
                  |L10.28|
00001c  2004              MOVS     r0,#4                 ;1175
                  |L10.30|
;;;1178   		dp->sect++;					/* Next sector */
;;;1179   
;;;1180   		if (!dp->clust) {		/* Static table */
;;;1181   			if (i >= dp->fs->n_rootdir)	/* Report EOT if it reached end of static table */
;;;1182   				return FR_NO_FILE;
;;;1183   		}
;;;1184   		else {					/* Dynamic table */
;;;1185   			if (((i / (SS(dp->fs) / SZ_DIR)) & (dp->fs->csize - 1)) == 0) {	/* Cluster changed? */
;;;1186   				clst = get_fat(dp->fs, dp->clust);				/* Get next cluster */
;;;1187   				if (clst <= 1) return FR_INT_ERR;
;;;1188   				if (clst == 0xFFFFFFFF) return FR_DISK_ERR;
;;;1189   				if (clst >= dp->fs->n_fatent) {					/* If it reached end of dynamic table, */
;;;1190   #if !_FS_READONLY
;;;1191   					UINT c;
;;;1192   					if (!stretch) return FR_NO_FILE;			/* If do not stretch, report EOT */
;;;1193   					clst = create_chain(dp->fs, dp->clust);		/* Stretch cluster chain */
;;;1194   					if (clst == 0) return FR_DENIED;			/* No free cluster */
;;;1195   					if (clst == 1) return FR_INT_ERR;
;;;1196   					if (clst == 0xFFFFFFFF) return FR_DISK_ERR;
;;;1197   					/* Clean-up stretched table */
;;;1198   					if (sync_window(dp->fs)) return FR_DISK_ERR;/* Flush disk access window */
;;;1199   					mem_set(dp->fs->win, 0, SS(dp->fs));		/* Clear window buffer */
;;;1200   					dp->fs->winsect = clust2sect(dp->fs, clst);	/* Cluster start sector */
;;;1201   					for (c = 0; c < dp->fs->csize; c++) {		/* Fill the new cluster with 0 */
;;;1202   						dp->fs->wflag = 1;
;;;1203   						if (sync_window(dp->fs)) return FR_DISK_ERR;
;;;1204   						dp->fs->winsect++;
;;;1205   					}
;;;1206   					dp->fs->winsect -= c;						/* Rewind window offset */
;;;1207   #else
;;;1208   					if (!stretch) return FR_NO_FILE;			/* If do not stretch, report EOT (this is to suppress warning) */
;;;1209   					return FR_NO_FILE;							/* Report EOT */
;;;1210   #endif
;;;1211   				}
;;;1212   				dp->clust = clst;				/* Initialize data for new cluster */
;;;1213   				dp->sect = clust2sect(dp->fs, clst);
;;;1214   			}
;;;1215   		}
;;;1216   	}
;;;1217   
;;;1218   	dp->index = (WORD)i;	/* Current index */
;;;1219   	dp->dir = dp->fs->win + (i % (SS(dp->fs) / SZ_DIR)) * SZ_DIR;	/* Current entry in the window */
;;;1220   
;;;1221   	return FR_OK;
;;;1222   }
00001e  e8bd81f0          POP      {r4-r8,pc}
                  |L10.34|
000022  1c40              ADDS     r0,r0,#1              ;1178
000024  6120              STR      r0,[r4,#0x10]         ;1178
000026  68e1              LDR      r1,[r4,#0xc]          ;1180
000028  b131              CBZ      r1,|L10.56|
00002a  6820              LDR      r0,[r4,#0]            ;1185
00002c  7882              LDRB     r2,[r0,#2]            ;1185
00002e  1e52              SUBS     r2,r2,#1              ;1185
000030  ea121f17          TST      r2,r7,LSR #4          ;1185
000034  d006              BEQ      |L10.68|
000036  e058              B        |L10.234|
                  |L10.56|
000038  6820              LDR      r0,[r4,#0]            ;1181
00003a  8900              LDRH     r0,[r0,#8]            ;1181
00003c  42b8              CMP      r0,r7                 ;1181
00003e  d854              BHI      |L10.234|
000040  2004              MOVS     r0,#4                 ;1182
000042  e7ec              B        |L10.30|
                  |L10.68|
000044  f7fffffe          BL       get_fat
000048  4605              MOV      r5,r0                 ;1186
00004a  2d01              CMP      r5,#1                 ;1187
00004c  d801              BHI      |L10.82|
00004e  2002              MOVS     r0,#2                 ;1187
000050  e7e5              B        |L10.30|
                  |L10.82|
000052  1c68              ADDS     r0,r5,#1              ;1188
000054  d013              BEQ      |L10.126|
000056  6820              LDR      r0,[r4,#0]            ;1189
000058  6941              LDR      r1,[r0,#0x14]         ;1189
00005a  42a9              CMP      r1,r5                 ;1189
00005c  d83f              BHI      |L10.222|
00005e  b186              CBZ      r6,|L10.130|
000060  68e1              LDR      r1,[r4,#0xc]          ;1193
000062  f7fffffe          BL       create_chain
000066  4605              MOV      r5,r0                 ;1193
000068  b16d              CBZ      r5,|L10.134|
00006a  2d01              CMP      r5,#1                 ;1195
00006c  d00d              BEQ      |L10.138|
00006e  1c68              ADDS     r0,r5,#1              ;1196
000070  d00d              BEQ      |L10.142|
000072  6820              LDR      r0,[r4,#0]            ;1198
000074  f7fffffe          BL       sync_window
000078  b158              CBZ      r0,|L10.146|
00007a  2001              MOVS     r0,#1                 ;1198
00007c  e7cf              B        |L10.30|
                  |L10.126|
00007e  2001              MOVS     r0,#1                 ;1188
000080  e7cd              B        |L10.30|
                  |L10.130|
000082  2004              MOVS     r0,#4                 ;1192
000084  e7cb              B        |L10.30|
                  |L10.134|
000086  2007              MOVS     r0,#7                 ;1194
000088  e7c9              B        |L10.30|
                  |L10.138|
00008a  2002              MOVS     r0,#2                 ;1195
00008c  e7c7              B        |L10.30|
                  |L10.142|
00008e  2001              MOVS     r0,#1                 ;1196
000090  e7c5              B        |L10.30|
                  |L10.146|
000092  6820              LDR      r0,[r4,#0]            ;1199
000094  f44f7200          MOV      r2,#0x200             ;1199
000098  3030              ADDS     r0,r0,#0x30           ;1199
00009a  2100              MOVS     r1,#0                 ;1199
00009c  f7fffffe          BL       mem_set
0000a0  4629              MOV      r1,r5                 ;1200
0000a2  6820              LDR      r0,[r4,#0]            ;1200
0000a4  f7fffffe          BL       clust2sect
0000a8  6821              LDR      r1,[r4,#0]            ;1200
0000aa  62c8              STR      r0,[r1,#0x2c]         ;1200
0000ac  2600              MOVS     r6,#0                 ;1201
0000ae  f04f0801          MOV      r8,#1                 ;1188
0000b2  e00c              B        |L10.206|
                  |L10.180|
0000b4  f8808004          STRB     r8,[r0,#4]            ;1202
0000b8  6820              LDR      r0,[r4,#0]            ;1203
0000ba  f7fffffe          BL       sync_window
0000be  b108              CBZ      r0,|L10.196|
0000c0  2001              MOVS     r0,#1                 ;1203
0000c2  e7ac              B        |L10.30|
                  |L10.196|
0000c4  6820              LDR      r0,[r4,#0]            ;1204
0000c6  6ac1              LDR      r1,[r0,#0x2c]         ;1204
0000c8  1c49              ADDS     r1,r1,#1              ;1204
0000ca  62c1              STR      r1,[r0,#0x2c]         ;1204
0000cc  1c76              ADDS     r6,r6,#1              ;1201
                  |L10.206|
0000ce  6820              LDR      r0,[r4,#0]            ;1201
0000d0  7881              LDRB     r1,[r0,#2]            ;1201
0000d2  42b1              CMP      r1,r6                 ;1201
0000d4  d8ee              BHI      |L10.180|
0000d6  6821              LDR      r1,[r4,#0]            ;1206
0000d8  6ac9              LDR      r1,[r1,#0x2c]         ;1206
0000da  1b89              SUBS     r1,r1,r6              ;1206
0000dc  62c1              STR      r1,[r0,#0x2c]         ;1206
                  |L10.222|
0000de  60e5              STR      r5,[r4,#0xc]          ;1212
0000e0  4629              MOV      r1,r5                 ;1213
0000e2  6820              LDR      r0,[r4,#0]            ;1213
0000e4  f7fffffe          BL       clust2sect
0000e8  6120              STR      r0,[r4,#0x10]         ;1213
                  |L10.234|
0000ea  80e7              STRH     r7,[r4,#6]            ;1218
0000ec  f007010f          AND      r1,r7,#0xf            ;1219
0000f0  2230              MOVS     r2,#0x30              ;1219
0000f2  6820              LDR      r0,[r4,#0]            ;1219
0000f4  eb021141          ADD      r1,r2,r1,LSL #5       ;1219
0000f8  4408              ADD      r0,r0,r1              ;1219
0000fa  6160              STR      r0,[r4,#0x14]         ;1219
0000fc  2000              MOVS     r0,#0                 ;1221
0000fe  e78e              B        |L10.30|
;;;1223   
                          ENDP


                          AREA ||i.dir_read||, CODE, READONLY, ALIGN=1

                  dir_read PROC
;;;1549   static
;;;1550   FRESULT dir_read (
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;1551   	DIR* dp,		/* Pointer to the directory object */
;;;1552   	int vol			/* Filtered by 0:file/directory or 1:volume label */
;;;1553   )
;;;1554   {
000004  4605              MOV      r5,r0
000006  4689              MOV      r9,r1
;;;1555   	FRESULT res;
;;;1556   	BYTE a, c, *dir;
;;;1557   #if _USE_LFN
;;;1558   	BYTE ord = 0xFF, sum = 0xFF;
000008  26ff              MOVS     r6,#0xff
00000a  46b0              MOV      r8,r6
;;;1559   #endif
;;;1560   
;;;1561   	res = FR_NO_FILE;
00000c  2704              MOVS     r7,#4
00000e  e044              B        |L11.154|
                  |L11.16|
;;;1562   	while (dp->sect) {
;;;1563   		res = move_window(dp->fs, dp->sect);
000010  6828              LDR      r0,[r5,#0]
000012  f7fffffe          BL       move_window
000016  4607              MOV      r7,r0
;;;1564   		if (res != FR_OK) break;
000018  bbb7              CBNZ     r7,|L11.136|
;;;1565   		dir = dp->dir;					/* Ptr to the directory entry of current index */
00001a  6968              LDR      r0,[r5,#0x14]
;;;1566   		c = dir[DIR_Name];
00001c  7804              LDRB     r4,[r0,#0]
;;;1567   		if (c == 0) { res = FR_NO_FILE; break; }	/* Reached to end of table */
00001e  b16c              CBZ      r4,|L11.60|
;;;1568   		a = dir[DIR_Attr] & AM_MASK;
000020  7ac1              LDRB     r1,[r0,#0xb]
000022  f001013f          AND      r1,r1,#0x3f
;;;1569   #if _USE_LFN	/* LFN configuration */
;;;1570   		if (c == DDE || (!_FS_RPATH && c == '.') || (int)(a == AM_VOL) != vol) {	/* An entry without valid data */
000026  2ce5              CMP      r4,#0xe5
000028  d006              BEQ      |L11.56|
00002a  2c2e              CMP      r4,#0x2e
00002c  d004              BEQ      |L11.56|
00002e  2908              CMP      r1,#8
000030  d006              BEQ      |L11.64|
000032  2200              MOVS     r2,#0
                  |L11.52|
000034  454a              CMP      r2,r9
000036  d005              BEQ      |L11.68|
                  |L11.56|
;;;1571   			ord = 0xFF;
000038  26ff              MOVS     r6,#0xff
00003a  e01f              B        |L11.124|
                  |L11.60|
00003c  2704              MOVS     r7,#4                 ;1567
00003e  e02f              B        |L11.160|
                  |L11.64|
000040  2201              MOVS     r2,#1                 ;1570
000042  e7f7              B        |L11.52|
                  |L11.68|
;;;1572   		} else {
;;;1573   			if (a == AM_LFN) {			/* An LFN entry is found */
000044  290f              CMP      r1,#0xf
000046  d001              BEQ      |L11.76|
;;;1574   				if (c & LLE) {			/* Is it start of LFN sequence? */
;;;1575   					sum = dir[LDIR_Chksum];
;;;1576   					c &= ~LLE; ord = c;
;;;1577   					dp->lfn_idx = dp->index;
;;;1578   				}
;;;1579   				/* Check LFN validity and capture it */
;;;1580   				ord = (c == ord && sum == dir[LDIR_Chksum] && pick_lfn(dp->lfn, dir)) ? ord - 1 : 0xFF;
;;;1581   			} else {					/* An SFN entry is found */
;;;1582   				if (ord || sum != sum_sfn(dir))	/* Is there a valid LFN? */
000048  bb1e              CBNZ     r6,|L11.146|
00004a  e01e              B        |L11.138|
                  |L11.76|
00004c  0661              LSLS     r1,r4,#25             ;1574
00004e  d506              BPL      |L11.94|
000050  f890800d          LDRB     r8,[r0,#0xd]          ;1575
000054  f0240440          BIC      r4,r4,#0x40           ;1576
000058  4626              MOV      r6,r4                 ;1576
00005a  88e9              LDRH     r1,[r5,#6]            ;1577
00005c  8429              STRH     r1,[r5,#0x20]         ;1577
                  |L11.94|
00005e  42b4              CMP      r4,r6                 ;1580
000060  d10a              BNE      |L11.120|
000062  7b41              LDRB     r1,[r0,#0xd]          ;1580
000064  4541              CMP      r1,r8                 ;1580
000066  d107              BNE      |L11.120|
000068  69ea              LDR      r2,[r5,#0x1c]         ;1580
00006a  4601              MOV      r1,r0                 ;1580
00006c  4610              MOV      r0,r2                 ;1580
00006e  f7fffffe          BL       pick_lfn
000072  b108              CBZ      r0,|L11.120|
000074  1e76              SUBS     r6,r6,#1              ;1580
000076  e000              B        |L11.122|
                  |L11.120|
000078  26ff              MOVS     r6,#0xff              ;1580
                  |L11.122|
00007a  b2f6              UXTB     r6,r6                 ;1580
                  |L11.124|
;;;1583   					dp->lfn_idx = 0xFFFF;		/* It has no LFN. */
;;;1584   				break;
;;;1585   			}
;;;1586   		}
;;;1587   #else		/* Non LFN configuration */
;;;1588   		if (c != DDE && (_FS_RPATH || c != '.') && a != AM_LFN && (int)(a == AM_VOL) == vol)	/* Is it a valid entry? */
;;;1589   			break;
;;;1590   #endif
;;;1591   		res = dir_next(dp, 0);				/* Next entry */
00007c  2100              MOVS     r1,#0
00007e  4628              MOV      r0,r5
000080  f7fffffe          BL       dir_next
000084  4607              MOV      r7,r0
;;;1592   		if (res != FR_OK) break;
000086  b147              CBZ      r7,|L11.154|
                  |L11.136|
000088  e00a              B        |L11.160|
                  |L11.138|
00008a  f7fffffe          BL       sum_sfn
00008e  4540              CMP      r0,r8                 ;1582
000090  d006              BEQ      |L11.160|
                  |L11.146|
000092  f64f70ff          MOV      r0,#0xffff            ;1583
000096  8428              STRH     r0,[r5,#0x20]         ;1583
000098  e002              B        |L11.160|
                  |L11.154|
00009a  6929              LDR      r1,[r5,#0x10]         ;1562
00009c  2900              CMP      r1,#0                 ;1562
00009e  d1b7              BNE      |L11.16|
                  |L11.160|
;;;1593   	}
;;;1594   
;;;1595   	if (res != FR_OK) dp->sect = 0;
0000a0  b10f              CBZ      r7,|L11.166|
0000a2  2000              MOVS     r0,#0
0000a4  6128              STR      r0,[r5,#0x10]
                  |L11.166|
;;;1596   
;;;1597   	return res;
0000a6  4638              MOV      r0,r7
;;;1598   }
0000a8  e8bd87f0          POP      {r4-r10,pc}
;;;1599   #endif	/* _FS_MINIMIZE <= 1 || _USE_LABEL || _FS_RPATH >= 2 */
                          ENDP


                          AREA ||i.dir_register||, CODE, READONLY, ALIGN=1

                  dir_register PROC
;;;1608   static
;;;1609   FRESULT dir_register (	/* FR_OK:Successful, FR_DENIED:No free entry or too many SFN collision, FR_DISK_ERR:Disk error */
000000  e92d43fe          PUSH     {r1-r9,lr}
;;;1610   	DIR* dp				/* Target directory with object name to be created */
;;;1611   )
;;;1612   {
000004  4604              MOV      r4,r0
;;;1613   	FRESULT res;
;;;1614   #if _USE_LFN	/* LFN configuration */
;;;1615   	UINT n, nent;
;;;1616   	BYTE sn[12], *fn, sum;
;;;1617   	WCHAR *lfn;
;;;1618   
;;;1619   
;;;1620   	fn = dp->fn; lfn = dp->lfn;
000006  69a7              LDR      r7,[r4,#0x18]
000008  69e6              LDR      r6,[r4,#0x1c]
;;;1621   	mem_cpy(sn, fn, 12);
00000a  220c              MOVS     r2,#0xc
00000c  4639              MOV      r1,r7
00000e  4668              MOV      r0,sp
000010  f7fffffe          BL       mem_cpy
;;;1622   
;;;1623   	if (_FS_RPATH && (sn[NS] & NS_DOT))		/* Cannot create dot entry */
;;;1624   		return FR_INVALID_NAME;
;;;1625   
;;;1626   	if (sn[NS] & NS_LOSS) {			/* When LFN is out of 8.3 format, generate a numbered name */
000014  f89d000b          LDRB     r0,[sp,#0xb]
000018  07c0              LSLS     r0,r0,#31
00001a  d018              BEQ      |L12.78|
;;;1627   		fn[NS] = 0; dp->lfn = 0;			/* Find only SFN */
00001c  2000              MOVS     r0,#0
00001e  72f8              STRB     r0,[r7,#0xb]
000020  61e0              STR      r0,[r4,#0x1c]
;;;1628   		for (n = 1; n < 100; n++) {
000022  2501              MOVS     r5,#1
                  |L12.36|
;;;1629   			gen_numname(fn, sn, lfn, n);	/* Generate a numbered name */
000024  462b              MOV      r3,r5
000026  4632              MOV      r2,r6
000028  4669              MOV      r1,sp
00002a  4638              MOV      r0,r7
00002c  f7fffffe          BL       gen_numname
;;;1630   			res = dir_find(dp);				/* Check if the name collides with existing SFN */
000030  4620              MOV      r0,r4
000032  f7fffffe          BL       dir_find
;;;1631   			if (res != FR_OK) break;
000036  b910              CBNZ     r0,|L12.62|
000038  1c6d              ADDS     r5,r5,#1              ;1628
00003a  2d64              CMP      r5,#0x64              ;1628
00003c  d3f2              BCC      |L12.36|
                  |L12.62|
;;;1632   		}
;;;1633   		if (n == 100) return FR_DENIED;		/* Abort if too many collisions */
00003e  2d64              CMP      r5,#0x64
000040  d00b              BEQ      |L12.90|
;;;1634   		if (res != FR_NO_FILE) return res;	/* Abort if the result is other than 'not collided' */
000042  2804              CMP      r0,#4
000044  d10a              BNE      |L12.92|
;;;1635   		fn[NS] = sn[NS]; dp->lfn = lfn;
000046  f89d000b          LDRB     r0,[sp,#0xb]
00004a  72f8              STRB     r0,[r7,#0xb]
00004c  61e6              STR      r6,[r4,#0x1c]
                  |L12.78|
;;;1636   	}
;;;1637   
;;;1638   	if (sn[NS] & NS_LFN) {			/* When LFN is to be created, allocate entries for an SFN + LFNs. */
00004e  f89d000b          LDRB     r0,[sp,#0xb]
000052  0780              LSLS     r0,r0,#30
000054  d50e              BPL      |L12.116|
;;;1639   		for (n = 0; lfn[n]; n++) ;
000056  2000              MOVS     r0,#0
000058  e003              B        |L12.98|
                  |L12.90|
00005a  2007              MOVS     r0,#7                 ;1633
                  |L12.92|
;;;1640   		nent = (n + 25) / 13;
;;;1641   	} else {						/* Otherwise allocate an entry for an SFN  */
;;;1642   		nent = 1;
;;;1643   	}
;;;1644   	res = dir_alloc(dp, nent);		/* Allocate entries */
;;;1645   
;;;1646   	if (res == FR_OK && --nent) {	/* Set LFN entry if needed */
;;;1647   		res = dir_sdi(dp, dp->index - nent);
;;;1648   		if (res == FR_OK) {
;;;1649   			sum = sum_sfn(dp->fn);	/* Sum value of the SFN tied to the LFN */
;;;1650   			do {					/* Store LFN entries in bottom first */
;;;1651   				res = move_window(dp->fs, dp->sect);
;;;1652   				if (res != FR_OK) break;
;;;1653   				fit_lfn(dp->lfn, dp->dir, (BYTE)nent, sum);
;;;1654   				dp->fs->wflag = 1;
;;;1655   				res = dir_next(dp, 0);	/* Next entry */
;;;1656   			} while (res == FR_OK && --nent);
;;;1657   		}
;;;1658   	}
;;;1659   #else	/* Non LFN configuration */
;;;1660   	res = dir_alloc(dp, 1);		/* Allocate an entry for SFN */
;;;1661   #endif
;;;1662   
;;;1663   	if (res == FR_OK) {				/* Set SFN entry */
;;;1664   		res = move_window(dp->fs, dp->sect);
;;;1665   		if (res == FR_OK) {
;;;1666   			mem_set(dp->dir, 0, SZ_DIR);	/* Clean the entry */
;;;1667   			mem_cpy(dp->dir, dp->fn, 11);	/* Put SFN */
;;;1668   #if _USE_LFN
;;;1669   			dp->dir[DIR_NTres] = dp->fn[NS] & (NS_BODY | NS_EXT);	/* Put NT flag */
;;;1670   #endif
;;;1671   			dp->fs->wflag = 1;
;;;1672   		}
;;;1673   	}
;;;1674   
;;;1675   	return res;
;;;1676   }
00005c  e8bd83fe          POP      {r1-r9,pc}
                  |L12.96|
000060  1c40              ADDS     r0,r0,#1              ;1639
                  |L12.98|
000062  f8361010          LDRH     r1,[r6,r0,LSL #1]     ;1639
000066  2900              CMP      r1,#0                 ;1639
000068  d1fa              BNE      |L12.96|
00006a  3019              ADDS     r0,r0,#0x19           ;1640
00006c  210d              MOVS     r1,#0xd               ;1640
00006e  fbb0f6f1          UDIV     r6,r0,r1              ;1640
000072  e000              B        |L12.118|
                  |L12.116|
000074  2601              MOVS     r6,#1                 ;1642
                  |L12.118|
000076  4631              MOV      r1,r6                 ;1644
000078  4620              MOV      r0,r4                 ;1644
00007a  f7fffffe          BL       dir_alloc
00007e  4605              MOV      r5,r0                 ;1644
000080  2701              MOVS     r7,#1                 ;1628
000082  bb15              CBNZ     r5,|L12.202|
000084  1e76              SUBS     r6,r6,#1              ;1646
000086  d020              BEQ      |L12.202|
000088  88e0              LDRH     r0,[r4,#6]            ;1647
00008a  1b81              SUBS     r1,r0,r6              ;1647
00008c  4620              MOV      r0,r4                 ;1647
00008e  f7fffffe          BL       dir_sdi
000092  4605              MOV      r5,r0                 ;1647
000094  b9cd              CBNZ     r5,|L12.202|
000096  69a0              LDR      r0,[r4,#0x18]         ;1649
000098  f7fffffe          BL       sum_sfn
00009c  4680              MOV      r8,r0                 ;1649
                  |L12.158|
00009e  6921              LDR      r1,[r4,#0x10]         ;1651
0000a0  6820              LDR      r0,[r4,#0]            ;1651
0000a2  f7fffffe          BL       move_window
0000a6  4605              MOV      r5,r0                 ;1651
0000a8  b97d              CBNZ     r5,|L12.202|
0000aa  b2f2              UXTB     r2,r6                 ;1653
0000ac  4643              MOV      r3,r8                 ;1653
0000ae  6961              LDR      r1,[r4,#0x14]         ;1653
0000b0  69e0              LDR      r0,[r4,#0x1c]         ;1653
0000b2  f7fffffe          BL       fit_lfn
0000b6  6820              LDR      r0,[r4,#0]            ;1654
0000b8  7107              STRB     r7,[r0,#4]            ;1654
0000ba  2100              MOVS     r1,#0                 ;1655
0000bc  4620              MOV      r0,r4                 ;1655
0000be  f7fffffe          BL       dir_next
0000c2  4605              MOV      r5,r0                 ;1655
0000c4  b90d              CBNZ     r5,|L12.202|
0000c6  1e76              SUBS     r6,r6,#1              ;1656
0000c8  d1e9              BNE      |L12.158|
                  |L12.202|
0000ca  b9bd              CBNZ     r5,|L12.252|
0000cc  6921              LDR      r1,[r4,#0x10]         ;1664
0000ce  6820              LDR      r0,[r4,#0]            ;1664
0000d0  f7fffffe          BL       move_window
0000d4  4605              MOV      r5,r0                 ;1664
0000d6  b98d              CBNZ     r5,|L12.252|
0000d8  2220              MOVS     r2,#0x20              ;1666
0000da  2100              MOVS     r1,#0                 ;1666
0000dc  6960              LDR      r0,[r4,#0x14]         ;1666
0000de  f7fffffe          BL       mem_set
0000e2  e9d40105          LDRD     r0,r1,[r4,#0x14]      ;1667
0000e6  220b              MOVS     r2,#0xb               ;1667
0000e8  f7fffffe          BL       mem_cpy
0000ec  69a0              LDR      r0,[r4,#0x18]         ;1669
0000ee  6961              LDR      r1,[r4,#0x14]         ;1669
0000f0  7ac0              LDRB     r0,[r0,#0xb]          ;1669
0000f2  f0000018          AND      r0,r0,#0x18           ;1669
0000f6  7308              STRB     r0,[r1,#0xc]          ;1669
0000f8  6820              LDR      r0,[r4,#0]            ;1671
0000fa  7107              STRB     r7,[r0,#4]            ;1671
                  |L12.252|
0000fc  4628              MOV      r0,r5                 ;1675
0000fe  e7ad              B        |L12.92|
;;;1677   #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.dir_remove||, CODE, READONLY, ALIGN=1

                  dir_remove PROC
;;;1686   static
;;;1687   FRESULT dir_remove (	/* FR_OK: Successful, FR_DISK_ERR: A disk error */
000000  b570              PUSH     {r4-r6,lr}
;;;1688   	DIR* dp				/* Directory object pointing the entry to be removed */
;;;1689   )
;;;1690   {
000002  4604              MOV      r4,r0
;;;1691   	FRESULT res;
;;;1692   #if _USE_LFN	/* LFN configuration */
;;;1693   	UINT i;
;;;1694   
;;;1695   	i = dp->index;	/* SFN index */
000004  88e6              LDRH     r6,[r4,#6]
;;;1696   	res = dir_sdi(dp, (dp->lfn_idx == 0xFFFF) ? i : dp->lfn_idx);	/* Goto the SFN or top of the LFN entries */
000006  8c21              LDRH     r1,[r4,#0x20]
000008  f5a1407f          SUB      r0,r1,#0xff00
00000c  38ff              SUBS     r0,r0,#0xff
00000e  d100              BNE      |L13.18|
000010  4631              MOV      r1,r6
                  |L13.18|
000012  4620              MOV      r0,r4
000014  f7fffffe          BL       dir_sdi
000018  4605              MOV      r5,r0
;;;1697   	if (res == FR_OK) {
00001a  b9ed              CBNZ     r5,|L13.88|
                  |L13.28|
;;;1698   		do {
;;;1699   			res = move_window(dp->fs, dp->sect);
00001c  6921              LDR      r1,[r4,#0x10]
00001e  6820              LDR      r0,[r4,#0]
000020  f7fffffe          BL       move_window
000024  4605              MOV      r5,r0
;;;1700   			if (res != FR_OK) break;
000026  b9a5              CBNZ     r5,|L13.82|
;;;1701   			mem_set(dp->dir, 0, SZ_DIR);	/* Clear and mark the entry "deleted" */
000028  2220              MOVS     r2,#0x20
00002a  2100              MOVS     r1,#0
00002c  6960              LDR      r0,[r4,#0x14]
00002e  f7fffffe          BL       mem_set
;;;1702   			*dp->dir = DDE;
000032  6961              LDR      r1,[r4,#0x14]
000034  20e5              MOVS     r0,#0xe5
000036  7008              STRB     r0,[r1,#0]
;;;1703   			dp->fs->wflag = 1;
000038  6821              LDR      r1,[r4,#0]
00003a  2001              MOVS     r0,#1
00003c  7108              STRB     r0,[r1,#4]
;;;1704   			if (dp->index >= i) break;	/* When reached SFN, all entries of the object has been deleted. */
00003e  88e0              LDRH     r0,[r4,#6]
000040  42b0              CMP      r0,r6
000042  d206              BCS      |L13.82|
;;;1705   			res = dir_next(dp, 0);		/* Next entry */
000044  2100              MOVS     r1,#0
000046  4620              MOV      r0,r4
000048  f7fffffe          BL       dir_next
00004c  4605              MOV      r5,r0
;;;1706   		} while (res == FR_OK);
00004e  2d00              CMP      r5,#0
000050  d0e4              BEQ      |L13.28|
                  |L13.82|
;;;1707   		if (res == FR_NO_FILE) res = FR_INT_ERR;
000052  2d04              CMP      r5,#4
000054  d100              BNE      |L13.88|
000056  2502              MOVS     r5,#2
                  |L13.88|
;;;1708   	}
;;;1709   
;;;1710   #else			/* Non LFN configuration */
;;;1711   	res = dir_sdi(dp, dp->index);
;;;1712   	if (res == FR_OK) {
;;;1713   		res = move_window(dp->fs, dp->sect);
;;;1714   		if (res == FR_OK) {
;;;1715   			mem_set(dp->dir, 0, SZ_DIR);	/* Clear and mark the entry "deleted" */
;;;1716   			*dp->dir = DDE;
;;;1717   			dp->fs->wflag = 1;
;;;1718   		}
;;;1719   	}
;;;1720   #endif
;;;1721   
;;;1722   	return res;
000058  4628              MOV      r0,r5
;;;1723   }
00005a  bd70              POP      {r4-r6,pc}
;;;1724   #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.dir_sdi||, CODE, READONLY, ALIGN=1

                  dir_sdi PROC
;;;1115   //static //
;;;1116   FRESULT dir_sdi (
000000  b570              PUSH     {r4-r6,lr}
;;;1117   	DIR* dp,		/* Pointer to directory object */
;;;1118   	UINT idx		/* Index of directory table */
;;;1119   )
;;;1120   {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;1121   	DWORD clst, sect;
;;;1122   	UINT ic;
;;;1123   
;;;1124   
;;;1125   	dp->index = (WORD)idx;	/* Current index */
000006  80e5              STRH     r5,[r4,#6]
;;;1126   	clst = dp->sclust;		/* Table start cluster (0:root) */
000008  68a3              LDR      r3,[r4,#8]
;;;1127   	if (clst == 1 || clst >= dp->fs->n_fatent)	/* Check start cluster range */
00000a  2b01              CMP      r3,#1
00000c  d003              BEQ      |L14.22|
00000e  6820              LDR      r0,[r4,#0]
000010  6941              LDR      r1,[r0,#0x14]
000012  4299              CMP      r1,r3
000014  d801              BHI      |L14.26|
                  |L14.22|
;;;1128   		return FR_INT_ERR;
000016  2002              MOVS     r0,#2
;;;1129   	if (!clst && dp->fs->fs_type == FS_FAT32)	/* Replace cluster# 0 with root cluster# if in FAT32 */
;;;1130   		clst = dp->fs->dirbase;
;;;1131   
;;;1132   	if (clst == 0) {	/* Static table (root-directory in FAT12/16) */
;;;1133   		if (idx >= dp->fs->n_rootdir)	/* Is index out of range? */
;;;1134   			return FR_INT_ERR;
;;;1135   		sect = dp->fs->dirbase;
;;;1136   	}
;;;1137   	else {				/* Dynamic table (root-directory in FAT32 or sub-directory) */
;;;1138   		ic = SS(dp->fs) / SZ_DIR * dp->fs->csize;	/* Entries per cluster */
;;;1139   		while (idx >= ic) {	/* Follow cluster chain */
;;;1140   			clst = get_fat(dp->fs, clst);				/* Get next cluster */
;;;1141   			if (clst == 0xFFFFFFFF) return FR_DISK_ERR;	/* Disk error */
;;;1142   			if (clst < 2 || clst >= dp->fs->n_fatent)	/* Reached to end of table or internal error */
;;;1143   				return FR_INT_ERR;
;;;1144   			idx -= ic;
;;;1145   		}
;;;1146   		sect = clust2sect(dp->fs, clst);
;;;1147   	}
;;;1148   	dp->clust = clst;	/* Current cluster# */
;;;1149   	if (!sect) return FR_INT_ERR;
;;;1150   	dp->sect = sect + idx / (SS(dp->fs) / SZ_DIR);					/* Sector# of the directory entry */
;;;1151   	dp->dir = dp->fs->win + (idx % (SS(dp->fs) / SZ_DIR)) * SZ_DIR;	/* Ptr to the entry in the sector */
;;;1152   
;;;1153   	return FR_OK;
;;;1154   }
000018  bd70              POP      {r4-r6,pc}
                  |L14.26|
00001a  b91b              CBNZ     r3,|L14.36|
00001c  7801              LDRB     r1,[r0,#0]            ;1129
00001e  2903              CMP      r1,#3                 ;1129
000020  d100              BNE      |L14.36|
000022  6a43              LDR      r3,[r0,#0x24]         ;1130
                  |L14.36|
000024  b113              CBZ      r3,|L14.44|
000026  7880              LDRB     r0,[r0,#2]            ;1138
000028  0106              LSLS     r6,r0,#4              ;1138
00002a  e018              B        |L14.94|
                  |L14.44|
00002c  8901              LDRH     r1,[r0,#8]            ;1133
00002e  42a9              CMP      r1,r5                 ;1133
000030  d801              BHI      |L14.54|
000032  2002              MOVS     r0,#2                 ;1134
000034  bd70              POP      {r4-r6,pc}
                  |L14.54|
000036  6a40              LDR      r0,[r0,#0x24]         ;1135
000038  e017              B        |L14.106|
                  |L14.58|
00003a  4619              MOV      r1,r3                 ;1140
00003c  6820              LDR      r0,[r4,#0]            ;1140
00003e  f7fffffe          BL       get_fat
000042  4603              MOV      r3,r0                 ;1140
000044  1c58              ADDS     r0,r3,#1              ;1141
000046  d007              BEQ      |L14.88|
000048  2b02              CMP      r3,#2                 ;1142
00004a  d303              BCC      |L14.84|
00004c  6820              LDR      r0,[r4,#0]            ;1142
00004e  6940              LDR      r0,[r0,#0x14]         ;1142
000050  4298              CMP      r0,r3                 ;1142
000052  d803              BHI      |L14.92|
                  |L14.84|
000054  2002              MOVS     r0,#2                 ;1143
000056  bd70              POP      {r4-r6,pc}
                  |L14.88|
000058  2001              MOVS     r0,#1                 ;1141
00005a  bd70              POP      {r4-r6,pc}
                  |L14.92|
00005c  1bad              SUBS     r5,r5,r6              ;1144
                  |L14.94|
00005e  42b5              CMP      r5,r6                 ;1139
000060  d2eb              BCS      |L14.58|
000062  4619              MOV      r1,r3                 ;1146
000064  6820              LDR      r0,[r4,#0]            ;1146
000066  f7fffffe          BL       clust2sect
                  |L14.106|
00006a  60e3              STR      r3,[r4,#0xc]          ;1148
00006c  b160              CBZ      r0,|L14.136|
00006e  eb001015          ADD      r0,r0,r5,LSR #4       ;1150
000072  6120              STR      r0,[r4,#0x10]         ;1150
000074  f005010f          AND      r1,r5,#0xf            ;1151
000078  2230              MOVS     r2,#0x30              ;1151
00007a  6820              LDR      r0,[r4,#0]            ;1151
00007c  eb021141          ADD      r1,r2,r1,LSL #5       ;1151
000080  4408              ADD      r0,r0,r1              ;1151
000082  6160              STR      r0,[r4,#0x14]         ;1151
000084  2000              MOVS     r0,#0                 ;1153
000086  bd70              POP      {r4-r6,pc}
                  |L14.136|
000088  2002              MOVS     r0,#2                 ;1149
00008a  bd70              POP      {r4-r6,pc}
;;;1155   
                          ENDP


                          AREA ||i.f_chmod||, CODE, READONLY, ALIGN=1

                  f_chmod PROC
;;;3584   
;;;3585   FRESULT f_chmod (
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;3586   	const TCHAR* path,	/* Pointer to the file path */
;;;3587   	BYTE value,			/* Attribute bits */
;;;3588   	BYTE mask			/* Attribute mask to change */
;;;3589   )
;;;3590   {
000002  b08c              SUB      sp,sp,#0x30
000004  460e              MOV      r6,r1
000006  4617              MOV      r7,r2
;;;3591   	FRESULT res;
;;;3592   	DIR dj;
;;;3593   	BYTE *dir;
;;;3594   	DEF_NAMEBUF;
;;;3595   
;;;3596   
;;;3597   	/* Get logical drive number */
;;;3598   	res = find_volume(&dj.fs, &path, 1);
000008  2201              MOVS     r2,#1
00000a  a90c              ADD      r1,sp,#0x30
00000c  a803              ADD      r0,sp,#0xc
00000e  f7fffffe          BL       find_volume
000012  4604              MOV      r4,r0
;;;3599   	if (res == FR_OK) {
000014  bb2c              CBNZ     r4,|L15.98|
;;;3600   		INIT_BUF(dj);
000016  f44f7000          MOV      r0,#0x200
00001a  f7fffffe          BL       ff_memalloc
00001e  4605              MOV      r5,r0
000020  b165              CBZ      r5,|L15.60|
000022  950a              STR      r5,[sp,#0x28]
000024  f8cdd024          STR      sp,[sp,#0x24]
;;;3601   		res = follow_path(&dj, path);		/* Follow the file path */
000028  a803              ADD      r0,sp,#0xc
00002a  990c              LDR      r1,[sp,#0x30]
00002c  f7fffffe          BL       follow_path
000030  4604              MOV      r4,r0
;;;3602   		FREE_BUF();
000032  4628              MOV      r0,r5
000034  f7fffffe          BL       ff_memfree
;;;3603   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
;;;3604   			res = FR_INVALID_NAME;
;;;3605   		if (res == FR_OK) {
000038  b11c              CBZ      r4,|L15.66|
00003a  e012              B        |L15.98|
                  |L15.60|
00003c  2011              MOVS     r0,#0x11              ;3600
                  |L15.62|
;;;3606   			dir = dj.dir;
;;;3607   			if (!dir) {						/* Is it a root directory? */
;;;3608   				res = FR_INVALID_NAME;
;;;3609   			} else {						/* File or sub directory */
;;;3610   				mask &= AM_RDO|AM_HID|AM_SYS|AM_ARC;	/* Valid attribute mask */
;;;3611   				dir[DIR_Attr] = (value & mask) | (dir[DIR_Attr] & (BYTE)~mask);	/* Apply attribute change */
;;;3612   				dj.fs->wflag = 1;
;;;3613   				res = sync_fs(dj.fs);
;;;3614   			}
;;;3615   		}
;;;3616   	}
;;;3617   
;;;3618   	LEAVE_FF(dj.fs, res);
;;;3619   }
00003e  b00f              ADD      sp,sp,#0x3c
000040  bdf0              POP      {r4-r7,pc}
                  |L15.66|
000042  9808              LDR      r0,[sp,#0x20]         ;3606
000044  b178              CBZ      r0,|L15.102|
000046  f0070227          AND      r2,r7,#0x27           ;3610
00004a  7ac1              LDRB     r1,[r0,#0xb]          ;3611
00004c  4016              ANDS     r6,r6,r2              ;3611
00004e  4391              BICS     r1,r1,r2              ;3611
000050  430e              ORRS     r6,r6,r1              ;3611
000052  72c6              STRB     r6,[r0,#0xb]          ;3611
000054  9903              LDR      r1,[sp,#0xc]          ;3612
000056  2001              MOVS     r0,#1                 ;3612
000058  7108              STRB     r0,[r1,#4]            ;3612
00005a  9803              LDR      r0,[sp,#0xc]          ;3613
00005c  f7fffffe          BL       sync_fs
000060  4604              MOV      r4,r0                 ;3613
                  |L15.98|
000062  4620              MOV      r0,r4                 ;3618
000064  e7eb              B        |L15.62|
                  |L15.102|
000066  2406              MOVS     r4,#6                 ;3608
000068  e7fb              B        |L15.98|
;;;3620   
                          ENDP


                          AREA ||i.f_close||, CODE, READONLY, ALIGN=1

                  f_close PROC
;;;2820   
;;;2821   FRESULT f_close (
000000  b510              PUSH     {r4,lr}
;;;2822   	FIL *fp		/* Pointer to the file object to be closed */
;;;2823   )
;;;2824   {
000002  4604              MOV      r4,r0
;;;2825   	FRESULT res;
;;;2826   
;;;2827   
;;;2828   #if !_FS_READONLY
;;;2829   	res = f_sync(fp);					/* Flush cached data */
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       f_sync
;;;2830   	if (res == FR_OK)
00000a  2800              CMP      r0,#0
00000c  d106              BNE      |L16.28|
;;;2831   #endif
;;;2832   	{
;;;2833   		res = validate(fp);				/* Lock volume */
00000e  4620              MOV      r0,r4
000010  f7fffffe          BL       validate
;;;2834   		if (res == FR_OK) {
000014  2800              CMP      r0,#0
000016  d101              BNE      |L16.28|
;;;2835   #if _FS_REENTRANT
;;;2836   			FATFS *fs = fp->fs;
;;;2837   #endif
;;;2838   #if _FS_LOCK
;;;2839   			res = dec_lock(fp->lockid);	/* Decrement file open counter */
;;;2840   			if (res == FR_OK)
;;;2841   #endif
;;;2842   				fp->fs = 0;				/* Invalidate file object */
000018  2100              MOVS     r1,#0
00001a  6021              STR      r1,[r4,#0]
                  |L16.28|
;;;2843   #if _FS_REENTRANT
;;;2844   			unlock_fs(fs, FR_OK);		/* Unlock volume */
;;;2845   #endif	
;;;2846   		}
;;;2847   		LEAVE_FF(fp->fs,res);			//FATFSbug,,OS,,,.
;;;2848   	}
;;;2849   	return res;
;;;2850   }
00001c  bd10              POP      {r4,pc}
;;;2851   
                          ENDP


                          AREA ||i.f_closedir||, CODE, READONLY, ALIGN=1

                  f_closedir PROC
;;;3207   
;;;3208   FRESULT f_closedir (
000000  b510              PUSH     {r4,lr}
;;;3209   	DIR *dp		/* Pointer to the directory object to be closed */
;;;3210   )
;;;3211   {
000002  4604              MOV      r4,r0
;;;3212   	FRESULT res;
;;;3213   
;;;3214   
;;;3215   	res = validate(dp);
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       validate
;;;3216   	if (res == FR_OK) {
00000a  2800              CMP      r0,#0
00000c  d101              BNE      |L17.18|
;;;3217   #if _FS_REENTRANT
;;;3218   		FATFS *fs = dp->fs;
;;;3219   #endif			
;;;3220   #if _FS_LOCK
;;;3221   		if (dp->lockid)				/* Decrement sub-directory open counter */
;;;3222   			res = dec_lock(dp->lockid);
;;;3223   		if (res == FR_OK)
;;;3224   #endif
;;;3225   			dp->fs = 0;				/* Invalidate directory object */
00000e  2100              MOVS     r1,#0
000010  6021              STR      r1,[r4,#0]
                  |L17.18|
;;;3226   #if _FS_REENTRANT
;;;3227   		unlock_fs(fs, FR_OK);		/* Unlock volume */
;;;3228   #endif
;;;3229   	}
;;;3230   	LEAVE_FF(dp->fs,res);		//FATFSbug,,OS,,,.
;;;3231   	//return res;
;;;3232   }
000012  bd10              POP      {r4,pc}
;;;3233   
                          ENDP


                          AREA ||i.f_getfree||, CODE, READONLY, ALIGN=1

                  f_getfree PROC
;;;3317   
;;;3318   FRESULT f_getfree (
000000  e92d4ff7          PUSH     {r0-r2,r4-r11,lr}
;;;3319   	const TCHAR* path,	/* Path name of the logical drive number */
;;;3320   	DWORD* nclst,		/* Pointer to a variable to return number of free clusters */
;;;3321   	FATFS** fatfs		/* Pointer to return pointer to corresponding file system object */
;;;3322   )
;;;3323   {
000004  468b              MOV      r11,r1
000006  4614              MOV      r4,r2
;;;3324   	FRESULT res;
;;;3325   	FATFS *fs;
;;;3326   	DWORD n, clst, sect, stat;
;;;3327   	UINT i;
;;;3328   	BYTE fat, *p;
;;;3329   
;;;3330   
;;;3331   	/* Get logical drive number */
;;;3332   	res = find_volume(fatfs, &path, 0);
000008  2200              MOVS     r2,#0
00000a  4669              MOV      r1,sp
00000c  4620              MOV      r0,r4
00000e  f7fffffe          BL       find_volume
000012  4680              MOV      r8,r0
;;;3333   	fs = *fatfs;
000014  6826              LDR      r6,[r4,#0]
;;;3334   	if (res == FR_OK) {
000016  f1b80f00          CMP      r8,#0
00001a  d15d              BNE      |L18.216|
;;;3335   		/* If free_clust is valid, return it without full cluster scan */
;;;3336   		if (fs->free_clust <= fs->n_fatent - 2) {
00001c  e9d60904          LDRD     r0,r9,[r6,#0x10]
000020  f1a90102          SUB      r1,r9,#2
000024  4288              CMP      r0,r1
000026  d802              BHI      |L18.46|
;;;3337   			*nclst = fs->free_clust;
000028  f8cb0000          STR      r0,[r11,#0]
00002c  e054              B        |L18.216|
                  |L18.46|
;;;3338   		} else {
;;;3339   			/* Get number of free clusters */
;;;3340   			fat = fs->fs_type;
00002e  f896a000          LDRB     r10,[r6,#0]
;;;3341   			n = 0;
000032  2500              MOVS     r5,#0
;;;3342   			if (fat == FS_FAT12) {
000034  f1ba0f01          CMP      r10,#1
000038  d004              BEQ      |L18.68|
;;;3343   				clst = 2;
;;;3344   				do {
;;;3345   					stat = get_fat(fs, clst);
;;;3346   					if (stat == 0xFFFFFFFF) { res = FR_DISK_ERR; break; }
;;;3347   					if (stat == 1) { res = FR_INT_ERR; break; }
;;;3348   					if (stat == 0) n++;
;;;3349   				} while (++clst < fs->n_fatent);
;;;3350   			} else {
;;;3351   				clst = fs->n_fatent;
;;;3352   				sect = fs->fatbase;
00003a  6a37              LDR      r7,[r6,#0x20]
;;;3353   				i = 0; p = 0;
00003c  2000              MOVS     r0,#0
00003e  2400              MOVS     r4,#0
                  |L18.64|
;;;3354   				do {
;;;3355   					if (!i) {
000040  b1b8              CBZ      r0,|L18.114|
000042  e023              B        |L18.140|
                  |L18.68|
000044  2402              MOVS     r4,#2                 ;3343
                  |L18.70|
000046  4621              MOV      r1,r4                 ;3345
000048  4630              MOV      r0,r6                 ;3345
00004a  f7fffffe          BL       get_fat
00004e  1c41              ADDS     r1,r0,#1              ;3346
000050  d003              BEQ      |L18.90|
000052  2801              CMP      r0,#1                 ;3347
000054  d004              BEQ      |L18.96|
000056  b130              CBZ      r0,|L18.102|
000058  e006              B        |L18.104|
                  |L18.90|
00005a  f04f0801          MOV      r8,#1                 ;3346
00005e  e034              B        |L18.202|
                  |L18.96|
000060  f04f0802          MOV      r8,#2                 ;3347
000064  e031              B        |L18.202|
                  |L18.102|
000066  1c6d              ADDS     r5,r5,#1              ;3348
                  |L18.104|
000068  6970              LDR      r0,[r6,#0x14]         ;3349
00006a  1c64              ADDS     r4,r4,#1              ;3349
00006c  4284              CMP      r4,r0                 ;3349
00006e  d3ea              BCC      |L18.70|
000070  e02b              B        |L18.202|
                  |L18.114|
;;;3356   						res = move_window(fs, sect++);
000072  4639              MOV      r1,r7
000074  1c7f              ADDS     r7,r7,#1
000076  4630              MOV      r0,r6
000078  f7fffffe          BL       move_window
00007c  4680              MOV      r8,r0
;;;3357   						if (res != FR_OK) break;
00007e  f1b80f00          CMP      r8,#0
000082  d122              BNE      |L18.202|
;;;3358   						p = fs->win;
000084  f1060430          ADD      r4,r6,#0x30
;;;3359   						i = SS(fs);
000088  f44f7000          MOV      r0,#0x200
                  |L18.140|
;;;3360   					}
;;;3361   					if (fat == FS_FAT16) {
00008c  f1ba0f02          CMP      r10,#2
000090  d00c              BEQ      |L18.172|
;;;3362   						if (LD_WORD(p) == 0) n++;
;;;3363   						p += 2; i -= 2;
;;;3364   					} else {
;;;3365   						if ((LD_DWORD(p) & 0x0FFFFFFF) == 0) n++;
000092  7821              LDRB     r1,[r4,#0]
000094  78e2              LDRB     r2,[r4,#3]
000096  7863              LDRB     r3,[r4,#1]
000098  ea416102          ORR      r1,r1,r2,LSL #24
00009c  78a2              LDRB     r2,[r4,#2]
00009e  0412              LSLS     r2,r2,#16
0000a0  ea422203          ORR      r2,r2,r3,LSL #8
0000a4  4311              ORRS     r1,r1,r2
0000a6  0109              LSLS     r1,r1,#4
0000a8  d009              BEQ      |L18.190|
0000aa  e009              B        |L18.192|
                  |L18.172|
0000ac  7821              LDRB     r1,[r4,#0]            ;3362
0000ae  7862              LDRB     r2,[r4,#1]            ;3362
0000b0  ea512102          ORRS     r1,r1,r2,LSL #8       ;3362
0000b4  d100              BNE      |L18.184|
0000b6  1c6d              ADDS     r5,r5,#1              ;3362
                  |L18.184|
0000b8  1ca4              ADDS     r4,r4,#2              ;3363
0000ba  1e80              SUBS     r0,r0,#2              ;3363
0000bc  e002              B        |L18.196|
                  |L18.190|
0000be  1c6d              ADDS     r5,r5,#1
                  |L18.192|
;;;3366   						p += 4; i -= 4;
0000c0  1d24              ADDS     r4,r4,#4
0000c2  1f00              SUBS     r0,r0,#4
                  |L18.196|
;;;3367   					}
;;;3368   				} while (--clst);
0000c4  f1b90901          SUBS     r9,r9,#1
0000c8  d1ba              BNE      |L18.64|
                  |L18.202|
;;;3369   			}
;;;3370   			fs->free_clust = n;
0000ca  6135              STR      r5,[r6,#0x10]
;;;3371   			fs->fsi_flag |= 1;
0000cc  7970              LDRB     r0,[r6,#5]
0000ce  f0400001          ORR      r0,r0,#1
0000d2  7170              STRB     r0,[r6,#5]
;;;3372   			*nclst = n;
0000d4  f8cb5000          STR      r5,[r11,#0]
                  |L18.216|
;;;3373   		}
;;;3374   	}
;;;3375   	LEAVE_FF(fs, res);
0000d8  4640              MOV      r0,r8
;;;3376   }
0000da  e8bd8ffe          POP      {r1-r11,pc}
;;;3377   
                          ENDP


                          AREA ||i.f_getlabel||, CODE, READONLY, ALIGN=1

                  f_getlabel PROC
;;;3753   
;;;3754   FRESULT f_getlabel (
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;3755   	const TCHAR* path,	/* Path name of the logical drive number */
;;;3756   	TCHAR* label,		/* Pointer to a buffer to return the volume label */
;;;3757   	DWORD* vsn			/* Pointer to a variable to return the volume serial number */
;;;3758   )
;;;3759   {
000002  b08a              SUB      sp,sp,#0x28
000004  460d              MOV      r5,r1
000006  4617              MOV      r7,r2
;;;3760   	FRESULT res;
;;;3761   	DIR dj;
;;;3762   	UINT i, j;
;;;3763   
;;;3764   
;;;3765   	/* Get logical drive number */
;;;3766   	res = find_volume(&dj.fs, &path, 0);
000008  2200              MOVS     r2,#0
00000a  a90a              ADD      r1,sp,#0x28
00000c  a801              ADD      r0,sp,#4
00000e  f7fffffe          BL       find_volume
000012  4604              MOV      r4,r0
;;;3767   
;;;3768   	/* Get volume label */
;;;3769   	if (res == FR_OK && label) {
000014  b9f4              CBNZ     r4,|L19.84|
000016  b1ed              CBZ      r5,|L19.84|
;;;3770   		dj.sclust = 0;					/* Open root directory */
000018  2600              MOVS     r6,#0
00001a  9603              STR      r6,[sp,#0xc]
;;;3771   		res = dir_sdi(&dj, 0);
00001c  2100              MOVS     r1,#0
00001e  a801              ADD      r0,sp,#4
000020  f7fffffe          BL       dir_sdi
000024  4604              MOV      r4,r0
;;;3772   		if (res == FR_OK) {
000026  b9ac              CBNZ     r4,|L19.84|
;;;3773   			res = dir_read(&dj, 1);		/* Get an entry with AM_VOL */
000028  2101              MOVS     r1,#1
00002a  a801              ADD      r0,sp,#4
00002c  f7fffffe          BL       dir_read
000030  4604              MOV      r4,r0
;;;3774   			if (res == FR_OK) {			/* A volume label is exist */
000032  b95c              CBNZ     r4,|L19.76|
;;;3775   #if _USE_LFN && _LFN_UNICODE
;;;3776   				WCHAR w;
;;;3777   				i = j = 0;
;;;3778   				do {
;;;3779   					w = (i < 11) ? dj.dir[i++] : ' ';
;;;3780   					if (IsDBCS1(w) && i < 11 && IsDBCS2(dj.dir[i]))
;;;3781   						w = w << 8 | dj.dir[i++];
;;;3782   					label[j++] = ff_convert(w, 1);	/* OEM -> Unicode */
;;;3783   				} while (j < 11);
;;;3784   #else
;;;3785   				mem_cpy(label, dj.dir, 11);
000034  220b              MOVS     r2,#0xb
000036  4628              MOV      r0,r5
000038  9906              LDR      r1,[sp,#0x18]
00003a  f7fffffe          BL       mem_cpy
;;;3786   #endif
;;;3787   				j = 11;
00003e  200b              MOVS     r0,#0xb
                  |L19.64|
;;;3788   				do {
;;;3789   					label[j] = 0;
000040  542e              STRB     r6,[r5,r0]
;;;3790   					if (!j) break;
000042  b118              CBZ      r0,|L19.76|
;;;3791   				} while (label[--j] == ' ');
000044  1e40              SUBS     r0,r0,#1
000046  5c29              LDRB     r1,[r5,r0]
000048  2920              CMP      r1,#0x20
00004a  d0f9              BEQ      |L19.64|
                  |L19.76|
;;;3792   			}
;;;3793   			if (res == FR_NO_FILE) {	/* No label, return nul string */
00004c  2c04              CMP      r4,#4
00004e  d101              BNE      |L19.84|
;;;3794   				label[0] = 0;
000050  702e              STRB     r6,[r5,#0]
;;;3795   				res = FR_OK;
000052  2400              MOVS     r4,#0
                  |L19.84|
;;;3796   			}
;;;3797   		}
;;;3798   	}
;;;3799   
;;;3800   	/* Get volume serial number */
;;;3801   	if (res == FR_OK && vsn) {
000054  b9f4              CBNZ     r4,|L19.148|
000056  b1ef              CBZ      r7,|L19.148|
;;;3802   		res = move_window(dj.fs, dj.fs->volbase);
000058  9801              LDR      r0,[sp,#4]
00005a  69c1              LDR      r1,[r0,#0x1c]
00005c  f7fffffe          BL       move_window
000060  4604              MOV      r4,r0
;;;3803   		if (res == FR_OK) {
000062  b9bc              CBNZ     r4,|L19.148|
;;;3804   			i = dj.fs->fs_type == FS_FAT32 ? BS_VolID32 : BS_VolID;
000064  9801              LDR      r0,[sp,#4]
000066  7800              LDRB     r0,[r0,#0]
000068  2803              CMP      r0,#3
00006a  d016              BEQ      |L19.154|
00006c  2027              MOVS     r0,#0x27
                  |L19.110|
;;;3805   			*vsn = LD_DWORD(&dj.fs->win[i]);
00006e  9a01              LDR      r2,[sp,#4]
000070  f1000130          ADD      r1,r0,#0x30
000074  9b01              LDR      r3,[sp,#4]
000076  5c52              LDRB     r2,[r2,r1]
000078  1cc9              ADDS     r1,r1,#3
00007a  5c59              LDRB     r1,[r3,r1]
00007c  ea426101          ORR      r1,r2,r1,LSL #24
000080  f1000232          ADD      r2,r0,#0x32
000084  5c9a              LDRB     r2,[r3,r2]
000086  0412              LSLS     r2,r2,#16
000088  3031              ADDS     r0,r0,#0x31
00008a  5c18              LDRB     r0,[r3,r0]
00008c  ea422000          ORR      r0,r2,r0,LSL #8
000090  4301              ORRS     r1,r1,r0
000092  6039              STR      r1,[r7,#0]
                  |L19.148|
;;;3806   		}
;;;3807   	}
;;;3808   
;;;3809   	LEAVE_FF(dj.fs, res);
;;;3810   }
000094  b00d              ADD      sp,sp,#0x34
000096  4620              MOV      r0,r4                 ;3809
000098  bdf0              POP      {r4-r7,pc}
                  |L19.154|
00009a  2043              MOVS     r0,#0x43              ;3804
00009c  e7e7              B        |L19.110|
;;;3811   
                          ENDP


                          AREA ||i.f_gets||, CODE, READONLY, ALIGN=1

                  f_gets PROC
;;;4294   
;;;4295   TCHAR* f_gets (
000000  e92d41fc          PUSH     {r2-r8,lr}
;;;4296   	TCHAR* buff,	/* Pointer to the string buffer to read */
;;;4297   	int len,		/* Size of string buffer (characters) */
;;;4298   	FIL* fp			/* Pointer to the file object */
;;;4299   )
;;;4300   {
000004  4607              MOV      r7,r0
000006  4690              MOV      r8,r2
;;;4301   	int n = 0;
000008  2500              MOVS     r5,#0
;;;4302   	TCHAR c, *p = buff;
00000a  463c              MOV      r4,r7
;;;4303   	BYTE s[2];
;;;4304   	UINT rc;
;;;4305   
;;;4306   
;;;4307   	while (n < len - 1) {	/* Read characters until buffer gets filled */
00000c  1e4e              SUBS     r6,r1,#1
00000e  e00f              B        |L20.48|
                  |L20.16|
;;;4308   #if _USE_LFN && _LFN_UNICODE
;;;4309   #if _STRF_ENCODE == 3		/* Read a character in UTF-8 */
;;;4310   		f_read(fp, s, 1, &rc);
;;;4311   		if (rc != 1) break;
;;;4312   		c = s[0];
;;;4313   		if (c >= 0x80) {
;;;4314   			if (c < 0xC0) continue;	/* Skip stray trailer */
;;;4315   			if (c < 0xE0) {			/* Two-byte sequence */
;;;4316   				f_read(fp, s, 1, &rc);
;;;4317   				if (rc != 1) break;
;;;4318   				c = (c & 0x1F) << 6 | (s[0] & 0x3F);
;;;4319   				if (c < 0x80) c = '?';
;;;4320   			} else {
;;;4321   				if (c < 0xF0) {		/* Three-byte sequence */
;;;4322   					f_read(fp, s, 2, &rc);
;;;4323   					if (rc != 2) break;
;;;4324   					c = c << 12 | (s[0] & 0x3F) << 6 | (s[1] & 0x3F);
;;;4325   					if (c < 0x800) c = '?';
;;;4326   				} else {			/* Reject four-byte sequence */
;;;4327   					c = '?';
;;;4328   				}
;;;4329   			}
;;;4330   		}
;;;4331   #elif _STRF_ENCODE == 2		/* Read a character in UTF-16BE */
;;;4332   		f_read(fp, s, 2, &rc);
;;;4333   		if (rc != 2) break;
;;;4334   		c = s[1] + (s[0] << 8);
;;;4335   #elif _STRF_ENCODE == 1		/* Read a character in UTF-16LE */
;;;4336   		f_read(fp, s, 2, &rc);
;;;4337   		if (rc != 2) break;
;;;4338   		c = s[0] + (s[1] << 8);
;;;4339   #else						/* Read a character in ANSI/OEM */
;;;4340   		f_read(fp, s, 1, &rc);
;;;4341   		if (rc != 1) break;
;;;4342   		c = s[0];
;;;4343   		if (IsDBCS1(c)) {
;;;4344   			f_read(fp, s, 1, &rc);
;;;4345   			if (rc != 1) break;
;;;4346   			c = (c << 8) + s[0];
;;;4347   		}
;;;4348   		c = ff_convert(c, 1);	/* OEM -> Unicode */
;;;4349   		if (!c) c = '?';
;;;4350   #endif
;;;4351   #else						/* Read a character without conversion */
;;;4352   		f_read(fp, s, 1, &rc);
000010  466b              MOV      r3,sp
000012  2201              MOVS     r2,#1
000014  a901              ADD      r1,sp,#4
000016  4640              MOV      r0,r8
000018  f7fffffe          BL       f_read
;;;4353   		if (rc != 1) break;
00001c  9800              LDR      r0,[sp,#0]
00001e  2801              CMP      r0,#1
000020  d108              BNE      |L20.52|
;;;4354   		c = s[0];
000022  f89d0004          LDRB     r0,[sp,#4]
;;;4355   #endif
;;;4356   		if (_USE_STRFUNC == 2 && c == '\r') continue;	/* Strip '\r' */
;;;4357   		*p++ = c;
000026  f8040b01          STRB     r0,[r4],#1
;;;4358   		n++;
00002a  1c6d              ADDS     r5,r5,#1
;;;4359   		if (c == '\n') break;		/* Break on EOL */
00002c  280a              CMP      r0,#0xa
00002e  d001              BEQ      |L20.52|
                  |L20.48|
000030  42b5              CMP      r5,r6                 ;4307
000032  dbed              BLT      |L20.16|
                  |L20.52|
;;;4360   	}
;;;4361   	*p = 0;
000034  2000              MOVS     r0,#0
000036  7020              STRB     r0,[r4,#0]
000038  b115              CBZ      r5,|L20.64|
;;;4362   	return n ? buff : 0;			/* When no data read (eof or error), return with error. */
00003a  4638              MOV      r0,r7
                  |L20.60|
;;;4363   }
00003c  e8bd81fc          POP      {r2-r8,pc}
                  |L20.64|
000040  2000              MOVS     r0,#0                 ;4362
000042  e7fb              B        |L20.60|
;;;4364   
                          ENDP


                          AREA ||i.f_lseek||, CODE, READONLY, ALIGN=1

                  f_lseek PROC
;;;2993   
;;;2994   FRESULT f_lseek (
000000  e92d4ff8          PUSH     {r3-r11,lr}
;;;2995   	FIL* fp,		/* Pointer to the file object */
;;;2996   	DWORD ofs		/* File pointer from top of file */
;;;2997   )
;;;2998   {
000004  4604              MOV      r4,r0
000006  460d              MOV      r5,r1
;;;2999   	FRESULT res;
;;;3000   
;;;3001   
;;;3002   	res = validate(fp);					/* Check validity of the object */
000008  4620              MOV      r0,r4
00000a  f7fffffe          BL       validate
00000e  4682              MOV      r10,r0
;;;3003   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
000010  f1ba0f00          CMP      r10,#0
000014  d002              BEQ      |L21.28|
000016  4650              MOV      r0,r10
                  |L21.24|
;;;3004   	if (fp->err)						/* Check error */
;;;3005   		LEAVE_FF(fp->fs, (FRESULT)fp->err);
;;;3006   
;;;3007   #if _USE_FASTSEEK
;;;3008   	if (fp->cltbl) {	/* Fast seek */
;;;3009   		DWORD cl, pcl, ncl, tcl, dsc, tlen, ulen, *tbl;
;;;3010   
;;;3011   		if (ofs == CREATE_LINKMAP) {	/* Create CLMT */
;;;3012   			tbl = fp->cltbl;
;;;3013   			tlen = *tbl++; ulen = 2;	/* Given table size and required table size */
;;;3014   			cl = fp->sclust;			/* Top of the chain */
;;;3015   			if (cl) {
;;;3016   				do {
;;;3017   					/* Get a fragment */
;;;3018   					tcl = cl; ncl = 0; ulen += 2;	/* Top, length and used items */
;;;3019   					do {
;;;3020   						pcl = cl; ncl++;
;;;3021   						cl = get_fat(fp->fs, cl);
;;;3022   						if (cl <= 1) ABORT(fp->fs, FR_INT_ERR);
;;;3023   						if (cl == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;3024   					} while (cl == pcl + 1);
;;;3025   					if (ulen <= tlen) {		/* Store the length and top of the fragment */
;;;3026   						*tbl++ = ncl; *tbl++ = tcl;
;;;3027   					}
;;;3028   				} while (cl < fp->fs->n_fatent);	/* Repeat until end of chain */
;;;3029   			}
;;;3030   			*fp->cltbl = ulen;	/* Number of items used */
;;;3031   			if (ulen <= tlen)
;;;3032   				*tbl = 0;		/* Terminate table */
;;;3033   			else
;;;3034   				res = FR_NOT_ENOUGH_CORE;	/* Given table size is smaller than required */
;;;3035   
;;;3036   		} else {						/* Fast seek */
;;;3037   			if (ofs > fp->fsize)		/* Clip offset at the file size */
;;;3038   				ofs = fp->fsize;
;;;3039   			fp->fptr = ofs;				/* Set file pointer */
;;;3040   			if (ofs) {
;;;3041   				fp->clust = clmt_clust(fp, ofs - 1);
;;;3042   				dsc = clust2sect(fp->fs, fp->clust);
;;;3043   				if (!dsc) ABORT(fp->fs, FR_INT_ERR);
;;;3044   				dsc += (ofs - 1) / SS(fp->fs) & (fp->fs->csize - 1);
;;;3045   				if (fp->fptr % SS(fp->fs) && dsc != fp->dsect) {	/* Refill sector cache if needed */
;;;3046   #if !_FS_TINY
;;;3047   #if !_FS_READONLY
;;;3048   					if (fp->flag & FA__DIRTY) {		/* Write-back dirty sector cache */
;;;3049   						if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;3050   							ABORT(fp->fs, FR_DISK_ERR);
;;;3051   						fp->flag &= ~FA__DIRTY;
;;;3052   					}
;;;3053   #endif
;;;3054   					if (disk_read(fp->fs->drv, fp->buf, dsc, 1))	/* Load current sector */
;;;3055   						ABORT(fp->fs, FR_DISK_ERR);
;;;3056   #endif
;;;3057   					fp->dsect = dsc;
;;;3058   				}
;;;3059   			}
;;;3060   		}
;;;3061   	} else
;;;3062   #endif
;;;3063   
;;;3064   	/* Normal Seek */
;;;3065   	{
;;;3066   		DWORD clst, bcs, nsect, ifptr;
;;;3067   
;;;3068   		if (ofs > fp->fsize					/* In read-only mode, clip offset with the file size */
;;;3069   #if !_FS_READONLY
;;;3070   			 && !(fp->flag & FA_WRITE)
;;;3071   #endif
;;;3072   			) ofs = fp->fsize;
;;;3073   
;;;3074   		ifptr = fp->fptr;
;;;3075   		fp->fptr = nsect = 0;
;;;3076   		if (ofs) {
;;;3077   			bcs = (DWORD)fp->fs->csize * SS(fp->fs);	/* Cluster size (byte) */
;;;3078   			if (ifptr > 0 &&
;;;3079   				(ofs - 1) / bcs >= (ifptr - 1) / bcs) {	/* When seek to same or following cluster, */
;;;3080   				fp->fptr = (ifptr - 1) & ~(bcs - 1);	/* start from the current cluster */
;;;3081   				ofs -= fp->fptr;
;;;3082   				clst = fp->clust;
;;;3083   			} else {									/* When seek to back cluster, */
;;;3084   				clst = fp->sclust;						/* start from the first cluster */
;;;3085   #if !_FS_READONLY
;;;3086   				if (clst == 0) {						/* If no cluster chain, create a new chain */
;;;3087   					clst = create_chain(fp->fs, 0);
;;;3088   					if (clst == 1) ABORT(fp->fs, FR_INT_ERR);
;;;3089   					if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;3090   					fp->sclust = clst;
;;;3091   				}
;;;3092   #endif
;;;3093   				fp->clust = clst;
;;;3094   			}
;;;3095   			if (clst != 0) {
;;;3096   				while (ofs > bcs) {						/* Cluster following loop */
;;;3097   #if !_FS_READONLY
;;;3098   					if (fp->flag & FA_WRITE) {			/* Check if in write mode or not */
;;;3099   						clst = create_chain(fp->fs, clst);	/* Force stretch if in write mode */
;;;3100   						if (clst == 0) {				/* When disk gets full, clip file size */
;;;3101   							ofs = bcs; break;
;;;3102   						}
;;;3103   					} else
;;;3104   #endif
;;;3105   						clst = get_fat(fp->fs, clst);	/* Follow cluster chain if not in write mode */
;;;3106   					if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;3107   					if (clst <= 1 || clst >= fp->fs->n_fatent) ABORT(fp->fs, FR_INT_ERR);
;;;3108   					fp->clust = clst;
;;;3109   					fp->fptr += bcs;
;;;3110   					ofs -= bcs;
;;;3111   				}
;;;3112   				fp->fptr += ofs;
;;;3113   				if (ofs % SS(fp->fs)) {
;;;3114   					nsect = clust2sect(fp->fs, clst);	/* Current sector */
;;;3115   					if (!nsect) ABORT(fp->fs, FR_INT_ERR);
;;;3116   					nsect += ofs / SS(fp->fs);
;;;3117   				}
;;;3118   			}
;;;3119   		}
;;;3120   		if (fp->fptr % SS(fp->fs) && nsect != fp->dsect) {	/* Fill sector cache if needed */
;;;3121   #if !_FS_TINY
;;;3122   #if !_FS_READONLY
;;;3123   			if (fp->flag & FA__DIRTY) {			/* Write-back dirty sector cache */
;;;3124   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;3125   					ABORT(fp->fs, FR_DISK_ERR);
;;;3126   				fp->flag &= ~FA__DIRTY;
;;;3127   			}
;;;3128   #endif
;;;3129   			if (disk_read(fp->fs->drv, fp->buf, nsect, 1))	/* Fill sector cache */
;;;3130   				ABORT(fp->fs, FR_DISK_ERR);
;;;3131   #endif
;;;3132   			fp->dsect = nsect;
;;;3133   		}
;;;3134   #if !_FS_READONLY
;;;3135   		if (fp->fptr > fp->fsize) {			/* Set file change flag if the file size is extended */
;;;3136   			fp->fsize = fp->fptr;
;;;3137   			fp->flag |= FA__WRITTEN;
;;;3138   		}
;;;3139   #endif
;;;3140   	}
;;;3141   
;;;3142   	LEAVE_FF(fp->fs, res);
;;;3143   }
000018  e8bd8ff8          POP      {r3-r11,pc}
                  |L21.28|
00001c  79e0              LDRB     r0,[r4,#7]            ;3004
00001e  2800              CMP      r0,#0                 ;3004
000020  d1fa              BNE      |L21.24|
000022  6a67              LDR      r7,[r4,#0x24]         ;3008
000024  f04f0901          MOV      r9,#1                 ;3023
000028  f1040828          ADD      r8,r4,#0x28           ;3049
00002c  2f00              CMP      r7,#0                 ;3008
00002e  d078              BEQ      |L21.290|
000030  1c68              ADDS     r0,r5,#1              ;3011
000032  d02b              BEQ      |L21.140|
000034  68e0              LDR      r0,[r4,#0xc]          ;3037
000036  42a8              CMP      r0,r5                 ;3037
000038  d200              BCS      |L21.60|
00003a  4605              MOV      r5,r0                 ;3038
                  |L21.60|
00003c  60a5              STR      r5,[r4,#8]            ;3039
00003e  2d00              CMP      r5,#0                 ;3040
                  |L21.64|
000040  d051              BEQ      |L21.230|
000042  1e69              SUBS     r1,r5,#1              ;3041
000044  4620              MOV      r0,r4                 ;3041
000046  f7fffffe          BL       clmt_clust
00004a  6160              STR      r0,[r4,#0x14]         ;3041
00004c  6822              LDR      r2,[r4,#0]            ;3042
00004e  4601              MOV      r1,r0                 ;3042
000050  4610              MOV      r0,r2                 ;3042
000052  f7fffffe          BL       clust2sect
000056  b3e8              CBZ      r0,|L21.212|
000058  6821              LDR      r1,[r4,#0]            ;3044
00005a  1e6d              SUBS     r5,r5,#1              ;3044
00005c  788a              LDRB     r2,[r1,#2]            ;3044
00005e  1e52              SUBS     r2,r2,#1              ;3044
000060  ea022255          AND      r2,r2,r5,LSR #9       ;3044
000064  1815              ADDS     r5,r2,r0              ;3044
000066  8920              LDRH     r0,[r4,#8]            ;3045
000068  05c0              LSLS     r0,r0,#23             ;3045
00006a  d0e9              BEQ      |L21.64|
00006c  69a2              LDR      r2,[r4,#0x18]         ;3045
00006e  42aa              CMP      r2,r5                 ;3045
000070  d0e6              BEQ      |L21.64|
000072  79a0              LDRB     r0,[r4,#6]            ;3048
000074  0640              LSLS     r0,r0,#25             ;3048
000076  d545              BPL      |L21.260|
000078  7848              LDRB     r0,[r1,#1]            ;3049
00007a  2301              MOVS     r3,#1                 ;3049
00007c  4641              MOV      r1,r8                 ;3049
00007e  f7fffffe          BL       disk_write
000082  b340              CBZ      r0,|L21.214|
000084  f8849007          STRB     r9,[r4,#7]            ;3050
000088  2001              MOVS     r0,#1                 ;3050
00008a  e7c5              B        |L21.24|
                  |L21.140|
00008c  cf01              LDM      r7!,{r0}              ;3013
00008e  9000              STR      r0,[sp,#0]            ;3013
000090  2602              MOVS     r6,#2                 ;3013
000092  6921              LDR      r1,[r4,#0x10]         ;3014
000094  b1e9              CBZ      r1,|L21.210|
                  |L21.150|
000096  468b              MOV      r11,r1                ;3018
000098  2500              MOVS     r5,#0                 ;3018
00009a  1cb6              ADDS     r6,r6,#2              ;3018
                  |L21.156|
00009c  4688              MOV      r8,r1                 ;3020
00009e  1c6d              ADDS     r5,r5,#1              ;3020
0000a0  6820              LDR      r0,[r4,#0]            ;3021
0000a2  f7fffffe          BL       get_fat
0000a6  4601              MOV      r1,r0                 ;3021
0000a8  2901              CMP      r1,#1                 ;3022
0000aa  d802              BHI      |L21.178|
0000ac  2002              MOVS     r0,#2                 ;3022
0000ae  71e0              STRB     r0,[r4,#7]            ;3022
0000b0  e7b2              B        |L21.24|
                  |L21.178|
0000b2  1c48              ADDS     r0,r1,#1              ;3023
0000b4  d018              BEQ      |L21.232|
0000b6  f1080801          ADD      r8,r8,#1              ;3024
0000ba  4541              CMP      r1,r8                 ;3024
0000bc  d0ee              BEQ      |L21.156|
0000be  9800              LDR      r0,[sp,#0]            ;3025
0000c0  4286              CMP      r6,r0                 ;3025
0000c2  d802              BHI      |L21.202|
0000c4  c720              STM      r7!,{r5}              ;3026
0000c6  f847bb04          STR      r11,[r7],#4           ;3026
                  |L21.202|
0000ca  6820              LDR      r0,[r4,#0]            ;3028
0000cc  6940              LDR      r0,[r0,#0x14]         ;3028
0000ce  4288              CMP      r0,r1                 ;3028
0000d0  d8e1              BHI      |L21.150|
                  |L21.210|
0000d2  e001              B        |L21.216|
                  |L21.212|
0000d4  e00f              B        |L21.246|
                  |L21.214|
0000d6  e011              B        |L21.252|
                  |L21.216|
0000d8  6a60              LDR      r0,[r4,#0x24]         ;3030
0000da  6006              STR      r6,[r0,#0]            ;3030
0000dc  9800              LDR      r0,[sp,#0]            ;3031
0000de  4286              CMP      r6,r0                 ;3031
0000e0  d806              BHI      |L21.240|
0000e2  2000              MOVS     r0,#0                 ;3032
0000e4  6038              STR      r0,[r7,#0]            ;3032
                  |L21.230|
0000e6  e0af              B        |L21.584|
                  |L21.232|
0000e8  f8849007          STRB     r9,[r4,#7]            ;3023
0000ec  2001              MOVS     r0,#1                 ;3023
0000ee  e793              B        |L21.24|
                  |L21.240|
0000f0  f04f0a11          MOV      r10,#0x11             ;3034
0000f4  e0a8              B        |L21.584|
                  |L21.246|
0000f6  2002              MOVS     r0,#2                 ;3043
0000f8  71e0              STRB     r0,[r4,#7]            ;3043
0000fa  e78d              B        |L21.24|
                  |L21.252|
0000fc  79a0              LDRB     r0,[r4,#6]            ;3051
0000fe  f0200040          BIC      r0,r0,#0x40           ;3051
000102  71a0              STRB     r0,[r4,#6]            ;3051
                  |L21.260|
000104  6820              LDR      r0,[r4,#0]            ;3054
000106  2301              MOVS     r3,#1                 ;3054
000108  462a              MOV      r2,r5                 ;3054
00010a  7840              LDRB     r0,[r0,#1]            ;3054
00010c  4641              MOV      r1,r8                 ;3054
00010e  f7fffffe          BL       disk_read
000112  b120              CBZ      r0,|L21.286|
000114  f8849007          STRB     r9,[r4,#7]            ;3055
000118  2001              MOVS     r0,#1                 ;3055
00011a  e77d              B        |L21.24|
00011c  e001              B        |L21.290|
                  |L21.286|
00011e  61a5              STR      r5,[r4,#0x18]         ;3057
000120  e092              B        |L21.584|
                  |L21.290|
000122  68e0              LDR      r0,[r4,#0xc]          ;3068
000124  42a8              CMP      r0,r5                 ;3068
000126  d203              BCS      |L21.304|
000128  79a1              LDRB     r1,[r4,#6]            ;3070
00012a  0789              LSLS     r1,r1,#30             ;3070
00012c  d400              BMI      |L21.304|
00012e  4605              MOV      r5,r0                 ;3072
                  |L21.304|
000130  68a0              LDR      r0,[r4,#8]            ;3074
000132  2700              MOVS     r7,#0                 ;3075
000134  60a7              STR      r7,[r4,#8]            ;3075
000136  b1fd              CBZ      r5,|L21.376|
000138  6822              LDR      r2,[r4,#0]            ;3077
00013a  7891              LDRB     r1,[r2,#2]            ;3077
00013c  024e              LSLS     r6,r1,#9              ;3077
00013e  b168              CBZ      r0,|L21.348|
000140  1e69              SUBS     r1,r5,#1              ;3079
000142  1e40              SUBS     r0,r0,#1              ;3079
000144  fbb1f1f6          UDIV     r1,r1,r6              ;3079
000148  fbb0f3f6          UDIV     r3,r0,r6              ;3079
00014c  4299              CMP      r1,r3                 ;3079
00014e  d305              BCC      |L21.348|
000150  1e71              SUBS     r1,r6,#1              ;3080
000152  4388              BICS     r0,r0,r1              ;3080
000154  60a0              STR      r0,[r4,#8]            ;3080
000156  1a2d              SUBS     r5,r5,r0              ;3081
000158  6961              LDR      r1,[r4,#0x14]         ;3082
00015a  e00c              B        |L21.374|
                  |L21.348|
00015c  6921              LDR      r1,[r4,#0x10]         ;3084
00015e  b949              CBNZ     r1,|L21.372|
000160  2100              MOVS     r1,#0                 ;3087
000162  4610              MOV      r0,r2                 ;3087
000164  f7fffffe          BL       create_chain
000168  4601              MOV      r1,r0                 ;3087
00016a  2901              CMP      r1,#1                 ;3088
00016c  d005              BEQ      |L21.378|
00016e  1c48              ADDS     r0,r1,#1              ;3089
000170  d006              BEQ      |L21.384|
000172  6121              STR      r1,[r4,#0x10]         ;3090
                  |L21.372|
000174  6161              STR      r1,[r4,#0x14]         ;3093
                  |L21.374|
000176  bb49              CBNZ     r1,|L21.460|
                  |L21.376|
000178  e035              B        |L21.486|
                  |L21.378|
00017a  2002              MOVS     r0,#2                 ;3088
00017c  71e0              STRB     r0,[r4,#7]            ;3088
00017e  e74b              B        |L21.24|
                  |L21.384|
000180  f8849007          STRB     r9,[r4,#7]            ;3089
000184  2001              MOVS     r0,#1                 ;3089
000186  e747              B        |L21.24|
                  |L21.392|
000188  79a0              LDRB     r0,[r4,#6]            ;3098
00018a  0780              LSLS     r0,r0,#30             ;3098
00018c  d506              BPL      |L21.412|
00018e  6820              LDR      r0,[r4,#0]            ;3099
000190  f7fffffe          BL       create_chain
000194  4601              MOV      r1,r0                 ;3099
000196  b929              CBNZ     r1,|L21.420|
000198  4635              MOV      r5,r6                 ;3101
00019a  e019              B        |L21.464|
                  |L21.412|
00019c  6820              LDR      r0,[r4,#0]            ;3105
00019e  f7fffffe          BL       get_fat
0001a2  4601              MOV      r1,r0                 ;3105
                  |L21.420|
0001a4  1c48              ADDS     r0,r1,#1              ;3106
0001a6  d008              BEQ      |L21.442|
0001a8  2901              CMP      r1,#1                 ;3107
0001aa  d903              BLS      |L21.436|
0001ac  6820              LDR      r0,[r4,#0]            ;3107
0001ae  6940              LDR      r0,[r0,#0x14]         ;3107
0001b0  4288              CMP      r0,r1                 ;3107
0001b2  d806              BHI      |L21.450|
                  |L21.436|
0001b4  2002              MOVS     r0,#2                 ;3107
0001b6  71e0              STRB     r0,[r4,#7]            ;3107
0001b8  e72e              B        |L21.24|
                  |L21.442|
0001ba  f8849007          STRB     r9,[r4,#7]            ;3106
0001be  2001              MOVS     r0,#1                 ;3106
0001c0  e72a              B        |L21.24|
                  |L21.450|
0001c2  6161              STR      r1,[r4,#0x14]         ;3108
0001c4  68a0              LDR      r0,[r4,#8]            ;3109
0001c6  4430              ADD      r0,r0,r6              ;3109
0001c8  60a0              STR      r0,[r4,#8]            ;3109
0001ca  1bad              SUBS     r5,r5,r6              ;3110
                  |L21.460|
0001cc  42b5              CMP      r5,r6                 ;3096
0001ce  d8db              BHI      |L21.392|
                  |L21.464|
0001d0  68a0              LDR      r0,[r4,#8]            ;3112
0001d2  4428              ADD      r0,r0,r5              ;3112
0001d4  60a0              STR      r0,[r4,#8]            ;3112
0001d6  05e8              LSLS     r0,r5,#23             ;3113
0001d8  d005              BEQ      |L21.486|
0001da  6820              LDR      r0,[r4,#0]            ;3114
0001dc  f7fffffe          BL       clust2sect
0001e0  b1a8              CBZ      r0,|L21.526|
0001e2  eb002755          ADD      r7,r0,r5,LSR #9       ;3116
                  |L21.486|
0001e6  8920              LDRH     r0,[r4,#8]            ;3120
0001e8  05c0              LSLS     r0,r0,#23             ;3120
0001ea  d024              BEQ      |L21.566|
0001ec  69a2              LDR      r2,[r4,#0x18]         ;3120
0001ee  42ba              CMP      r2,r7                 ;3120
0001f0  d021              BEQ      |L21.566|
0001f2  79a0              LDRB     r0,[r4,#6]            ;3123
0001f4  0640              LSLS     r0,r0,#25             ;3123
0001f6  d511              BPL      |L21.540|
0001f8  6820              LDR      r0,[r4,#0]            ;3124
0001fa  2301              MOVS     r3,#1                 ;3124
0001fc  4641              MOV      r1,r8                 ;3124
0001fe  7840              LDRB     r0,[r0,#1]            ;3124
000200  f7fffffe          BL       disk_write
000204  b130              CBZ      r0,|L21.532|
000206  f8849007          STRB     r9,[r4,#7]            ;3125
00020a  2001              MOVS     r0,#1                 ;3125
00020c  e704              B        |L21.24|
                  |L21.526|
00020e  2002              MOVS     r0,#2                 ;3115
000210  71e0              STRB     r0,[r4,#7]            ;3115
000212  e701              B        |L21.24|
                  |L21.532|
000214  79a0              LDRB     r0,[r4,#6]            ;3126
000216  f0200040          BIC      r0,r0,#0x40           ;3126
00021a  71a0              STRB     r0,[r4,#6]            ;3126
                  |L21.540|
00021c  6820              LDR      r0,[r4,#0]            ;3129
00021e  2301              MOVS     r3,#1                 ;3129
000220  463a              MOV      r2,r7                 ;3129
000222  7840              LDRB     r0,[r0,#1]            ;3129
000224  4641              MOV      r1,r8                 ;3129
000226  f7fffffe          BL       disk_read
00022a  b118              CBZ      r0,|L21.564|
00022c  f8849007          STRB     r9,[r4,#7]            ;3130
000230  2001              MOVS     r0,#1                 ;3130
000232  e6f1              B        |L21.24|
                  |L21.564|
000234  61a7              STR      r7,[r4,#0x18]         ;3132
                  |L21.566|
000236  e9d40102          LDRD     r0,r1,[r4,#8]         ;3135
00023a  4288              CMP      r0,r1                 ;3135
00023c  d904              BLS      |L21.584|
00023e  60e0              STR      r0,[r4,#0xc]          ;3136
000240  79a0              LDRB     r0,[r4,#6]            ;3137
000242  f0400020          ORR      r0,r0,#0x20           ;3137
000246  71a0              STRB     r0,[r4,#6]            ;3137
                  |L21.584|
000248  4650              MOV      r0,r10                ;3142
00024a  e6e5              B        |L21.24|
;;;3144   
                          ENDP


                          AREA ||i.f_mkdir||, CODE, READONLY, ALIGN=1

                  f_mkdir PROC
;;;3510   
;;;3511   FRESULT f_mkdir (
000000  e92d4ff1          PUSH     {r0,r4-r11,lr}
;;;3512   	const TCHAR* path		/* Pointer to the directory path */
;;;3513   )
;;;3514   {
000004  b08e              SUB      sp,sp,#0x38
;;;3515   	FRESULT res;
;;;3516   	DIR dj;
;;;3517   	BYTE *dir, n;
;;;3518   	DWORD dsc, dcl, pcl, tm = get_fattime();
000006  f7fffffe          BL       get_fattime
00000a  4606              MOV      r6,r0
;;;3519   	DEF_NAMEBUF;
;;;3520   
;;;3521   
;;;3522   	/* Get logical drive number */
;;;3523   	res = find_volume(&dj.fs, &path, 1);
00000c  2201              MOVS     r2,#1
00000e  a90e              ADD      r1,sp,#0x38
000010  a804              ADD      r0,sp,#0x10
000012  f7fffffe          BL       find_volume
000016  4604              MOV      r4,r0
;;;3524   	if (res == FR_OK) {
000018  2c00              CMP      r4,#0
00001a  d16e              BNE      |L22.250|
;;;3525   		INIT_BUF(dj);
00001c  f44f7000          MOV      r0,#0x200
000020  f7fffffe          BL       ff_memalloc
000024  4681              MOV      r9,r0
000026  f1b90f00          CMP      r9,#0
00002a  d00a              BEQ      |L22.66|
00002c  f8cd902c          STR      r9,[sp,#0x2c]
000030  a801              ADD      r0,sp,#4
000032  900a              STR      r0,[sp,#0x28]
;;;3526   		res = follow_path(&dj, path);			/* Follow the file path */
000034  a804              ADD      r0,sp,#0x10
000036  990e              LDR      r1,[sp,#0x38]
000038  f7fffffe          BL       follow_path
00003c  4604              MOV      r4,r0
;;;3527   		if (res == FR_OK) res = FR_EXIST;		/* Any object with same name is already existing */
00003e  b124              CBZ      r4,|L22.74|
000040  e004              B        |L22.76|
                  |L22.66|
000042  2011              MOVS     r0,#0x11              ;3525
                  |L22.68|
;;;3528   		if (_FS_RPATH && res == FR_NO_FILE && (dj.fn[NS] & NS_DOT))
;;;3529   			res = FR_INVALID_NAME;
;;;3530   		if (res == FR_NO_FILE) {				/* Can create a new directory */
;;;3531   			dcl = create_chain(dj.fs, 0);		/* Allocate a cluster for the new directory table */
;;;3532   			res = FR_OK;
;;;3533   			if (dcl == 0) res = FR_DENIED;		/* No space to allocate a new cluster */
;;;3534   			if (dcl == 1) res = FR_INT_ERR;
;;;3535   			if (dcl == 0xFFFFFFFF) res = FR_DISK_ERR;
;;;3536   			if (res == FR_OK)					/* Flush FAT */
;;;3537   				res = sync_window(dj.fs);
;;;3538   			if (res == FR_OK) {					/* Initialize the new directory table */
;;;3539   				dsc = clust2sect(dj.fs, dcl);
;;;3540   				dir = dj.fs->win;
;;;3541   				mem_set(dir, 0, SS(dj.fs));
;;;3542   				mem_set(dir+DIR_Name, ' ', 11);	/* Create "." entry */
;;;3543   				dir[DIR_Name] = '.';
;;;3544   				dir[DIR_Attr] = AM_DIR;
;;;3545   				ST_DWORD(dir+DIR_WrtTime, tm);
;;;3546   				st_clust(dir, dcl);
;;;3547   				mem_cpy(dir+SZ_DIR, dir, SZ_DIR); 	/* Create ".." entry */
;;;3548   				dir[SZ_DIR+1] = '.'; pcl = dj.sclust;
;;;3549   				if (dj.fs->fs_type == FS_FAT32 && pcl == dj.fs->dirbase)
;;;3550   					pcl = 0;
;;;3551   				st_clust(dir+SZ_DIR, pcl);
;;;3552   				for (n = dj.fs->csize; n; n--) {	/* Write dot entries and clear following sectors */
;;;3553   					dj.fs->winsect = dsc++;
;;;3554   					dj.fs->wflag = 1;
;;;3555   					res = sync_window(dj.fs);
;;;3556   					if (res != FR_OK) break;
;;;3557   					mem_set(dir, 0, SS(dj.fs));
;;;3558   				}
;;;3559   			}
;;;3560   			if (res == FR_OK) res = dir_register(&dj);	/* Register the object to the directoy */
;;;3561   			if (res != FR_OK) {
;;;3562   				remove_chain(dj.fs, dcl);			/* Could not register, remove cluster chain */
;;;3563   			} else {
;;;3564   				dir = dj.dir;
;;;3565   				dir[DIR_Attr] = AM_DIR;				/* Attribute */
;;;3566   				ST_DWORD(dir+DIR_WrtTime, tm);		/* Created time */
;;;3567   				st_clust(dir, dcl);					/* Table start cluster */
;;;3568   				dj.fs->wflag = 1;
;;;3569   				res = sync_fs(dj.fs);
;;;3570   			}
;;;3571   		}
;;;3572   		FREE_BUF();
;;;3573   	}
;;;3574   
;;;3575   	LEAVE_FF(dj.fs, res);
;;;3576   }
000044  b00f              ADD      sp,sp,#0x3c
000046  e8bd8ff0          POP      {r4-r11,pc}
                  |L22.74|
00004a  2408              MOVS     r4,#8                 ;3527
                  |L22.76|
00004c  2c04              CMP      r4,#4                 ;3530
00004e  d176              BNE      |L22.318|
000050  2100              MOVS     r1,#0                 ;3531
000052  9804              LDR      r0,[sp,#0x10]         ;3531
000054  f7fffffe          BL       create_chain
000058  4680              MOV      r8,r0                 ;3531
00005a  2400              MOVS     r4,#0                 ;3532
00005c  f1b80f00          CMP      r8,#0                 ;3533
000060  d100              BNE      |L22.100|
000062  2407              MOVS     r4,#7                 ;3533
                  |L22.100|
000064  f1b80f01          CMP      r8,#1                 ;3534
000068  d100              BNE      |L22.108|
00006a  2402              MOVS     r4,#2                 ;3534
                  |L22.108|
00006c  f1180001          ADDS     r0,r8,#1              ;3535
000070  d100              BNE      |L22.116|
000072  2401              MOVS     r4,#1                 ;3535
                  |L22.116|
000074  b91c              CBNZ     r4,|L22.126|
000076  9804              LDR      r0,[sp,#0x10]         ;3537
000078  f7fffffe          BL       sync_window
00007c  4604              MOV      r4,r0                 ;3537
                  |L22.126|
00007e  f04f0a01          MOV      r10,#1                ;3523
000082  bbcc              CBNZ     r4,|L22.248|
000084  4641              MOV      r1,r8                 ;3539
000086  9804              LDR      r0,[sp,#0x10]         ;3539
000088  f7fffffe          BL       clust2sect
00008c  4683              MOV      r11,r0                ;3539
00008e  9d04              LDR      r5,[sp,#0x10]         ;3540
000090  3530              ADDS     r5,r5,#0x30           ;3540
000092  f44f7200          MOV      r2,#0x200             ;3541
000096  2100              MOVS     r1,#0                 ;3541
000098  4628              MOV      r0,r5                 ;3541
00009a  f7fffffe          BL       mem_set
00009e  220b              MOVS     r2,#0xb               ;3542
0000a0  2120              MOVS     r1,#0x20              ;3542
0000a2  4628              MOV      r0,r5                 ;3542
0000a4  f7fffffe          BL       mem_set
0000a8  272e              MOVS     r7,#0x2e              ;3543
0000aa  702f              STRB     r7,[r5,#0]            ;3543
0000ac  2010              MOVS     r0,#0x10              ;3544
0000ae  72e8              STRB     r0,[r5,#0xb]          ;3544
0000b0  75ae              STRB     r6,[r5,#0x16]         ;3545
0000b2  0a30              LSRS     r0,r6,#8              ;3545
0000b4  75e8              STRB     r0,[r5,#0x17]         ;3545
0000b6  0c30              LSRS     r0,r6,#16             ;3545
0000b8  7628              STRB     r0,[r5,#0x18]         ;3545
0000ba  0e30              LSRS     r0,r6,#24             ;3545
0000bc  7668              STRB     r0,[r5,#0x19]         ;3545
0000be  4641              MOV      r1,r8                 ;3546
0000c0  4628              MOV      r0,r5                 ;3546
0000c2  f7fffffe          BL       st_clust
0000c6  f1050020          ADD      r0,r5,#0x20           ;3547
0000ca  2220              MOVS     r2,#0x20              ;3547
0000cc  4629              MOV      r1,r5                 ;3547
0000ce  900d              STR      r0,[sp,#0x34]         ;3547
0000d0  f7fffffe          BL       mem_cpy
0000d4  f8857021          STRB     r7,[r5,#0x21]         ;3548
0000d8  9906              LDR      r1,[sp,#0x18]         ;3548
0000da  9804              LDR      r0,[sp,#0x10]         ;3549
0000dc  7800              LDRB     r0,[r0,#0]            ;3549
0000de  2803              CMP      r0,#3                 ;3549
0000e0  d104              BNE      |L22.236|
0000e2  9804              LDR      r0,[sp,#0x10]         ;3549
0000e4  6a40              LDR      r0,[r0,#0x24]         ;3549
0000e6  4288              CMP      r0,r1                 ;3549
0000e8  d100              BNE      |L22.236|
0000ea  2100              MOVS     r1,#0                 ;3550
                  |L22.236|
0000ec  980d              LDR      r0,[sp,#0x34]         ;3551
0000ee  f7fffffe          BL       st_clust
0000f2  9804              LDR      r0,[sp,#0x10]         ;3552
0000f4  7887              LDRB     r7,[r0,#2]            ;3552
0000f6  e016              B        |L22.294|
                  |L22.248|
0000f8  e017              B        |L22.298|
                  |L22.250|
0000fa  e038              B        |L22.366|
                  |L22.252|
0000fc  9804              LDR      r0,[sp,#0x10]         ;3553
0000fe  f8c0b02c          STR      r11,[r0,#0x2c]        ;3553
000102  f10b0b01          ADD      r11,r11,#1            ;3553
000106  9804              LDR      r0,[sp,#0x10]         ;3554
000108  f880a004          STRB     r10,[r0,#4]           ;3554
00010c  9804              LDR      r0,[sp,#0x10]         ;3555
00010e  f7fffffe          BL       sync_window
000112  4604              MOV      r4,r0                 ;3555
000114  b94c              CBNZ     r4,|L22.298|
000116  f44f7200          MOV      r2,#0x200             ;3557
00011a  2100              MOVS     r1,#0                 ;3557
00011c  4628              MOV      r0,r5                 ;3557
00011e  f7fffffe          BL       mem_set
000122  1e7f              SUBS     r7,r7,#1              ;3552
000124  b2ff              UXTB     r7,r7                 ;3552
                  |L22.294|
000126  2f00              CMP      r7,#0                 ;3552
000128  d1e8              BNE      |L22.252|
                  |L22.298|
00012a  b91c              CBNZ     r4,|L22.308|
00012c  a804              ADD      r0,sp,#0x10           ;3560
00012e  f7fffffe          BL       dir_register
000132  4604              MOV      r4,r0                 ;3560
                  |L22.308|
000134  b124              CBZ      r4,|L22.320|
000136  4641              MOV      r1,r8                 ;3562
000138  9804              LDR      r0,[sp,#0x10]         ;3562
00013a  f7fffffe          BL       remove_chain
                  |L22.318|
00013e  e013              B        |L22.360|
                  |L22.320|
000140  9809              LDR      r0,[sp,#0x24]         ;3564
000142  2110              MOVS     r1,#0x10              ;3565
000144  72c1              STRB     r1,[r0,#0xb]          ;3565
000146  7586              STRB     r6,[r0,#0x16]         ;3566
000148  0a31              LSRS     r1,r6,#8              ;3566
00014a  75c1              STRB     r1,[r0,#0x17]         ;3566
00014c  0c31              LSRS     r1,r6,#16             ;3566
00014e  7601              STRB     r1,[r0,#0x18]         ;3566
000150  0e31              LSRS     r1,r6,#24             ;3566
000152  7641              STRB     r1,[r0,#0x19]         ;3566
000154  4641              MOV      r1,r8                 ;3567
000156  f7fffffe          BL       st_clust
00015a  9804              LDR      r0,[sp,#0x10]         ;3568
00015c  f880a004          STRB     r10,[r0,#4]           ;3568
000160  9804              LDR      r0,[sp,#0x10]         ;3569
000162  f7fffffe          BL       sync_fs
000166  4604              MOV      r4,r0                 ;3569
                  |L22.360|
000168  4648              MOV      r0,r9                 ;3572
00016a  f7fffffe          BL       ff_memfree
                  |L22.366|
00016e  4620              MOV      r0,r4                 ;3575
000170  e768              B        |L22.68|
;;;3577   
                          ENDP


                          AREA ||i.f_mkfs||, CODE, READONLY, ALIGN=2

                  f_mkfs PROC
;;;3976   
;;;3977   FRESULT f_mkfs (
000000  e92d4ff7          PUSH     {r0-r2,r4-r11,lr}
;;;3978   	const TCHAR* path,	/* Logical drive number */
;;;3979   	BYTE sfd,			/* Partitioning rule 0:FDISK, 1:SFD */
;;;3980   	UINT au				/* Allocation unit [bytes] */
;;;3981   )
;;;3982   {
000004  b088              SUB      sp,sp,#0x20
000006  4615              MOV      r5,r2
;;;3983   	static const WORD vst[] = { 1024,   512,  256,  128,   64,    32,   16,    8,    4,    2,   0};
;;;3984   	static const WORD cst[] = {32768, 16384, 8192, 4096, 2048, 16384, 8192, 4096, 2048, 1024, 512};
;;;3985   	int vol;
;;;3986   	BYTE fmt, md, sys, *tbl, pdrv, part;
;;;3987   	DWORD n_clst, vs, n, wsect;
;;;3988   	UINT i;
;;;3989   	DWORD b_vol, b_fat, b_dir, b_data;	/* LBA */
;;;3990   	DWORD n_vol, n_rsv, n_fat, n_dir;	/* Size */
;;;3991   	FATFS *fs;
;;;3992   	DSTATUS stat;
;;;3993   
;;;3994   
;;;3995   	/* Check mounted drive and clear work area */
;;;3996   	vol = get_ldnumber(&path);
000008  a808              ADD      r0,sp,#0x20
00000a  f7fffffe          BL       get_ldnumber
;;;3997   	if (vol < 0) return FR_INVALID_DRIVE;
00000e  2800              CMP      r0,#0
000010  da03              BGE      |L23.26|
000012  200b              MOVS     r0,#0xb
                  |L23.20|
;;;3998   	if (sfd > 1) return FR_INVALID_PARAMETER;
;;;3999   	if (au & (au - 1)) return FR_INVALID_PARAMETER;
;;;4000   	fs = FatFs[vol];
;;;4001   	if (!fs) return FR_NOT_ENABLED;
;;;4002   	fs->fs_type = 0;
;;;4003   	pdrv = LD2PD(vol);	/* Physical drive */
;;;4004   	part = LD2PT(vol);	/* Partition (0:auto detect, 1-4:get from partition table)*/
;;;4005   
;;;4006   	/* Get disk statics */
;;;4007   	stat = disk_initialize(pdrv);
;;;4008   	if (stat & STA_NOINIT) return FR_NOT_READY;
;;;4009   	if (stat & STA_PROTECT) return FR_WRITE_PROTECTED;
;;;4010   #if _MAX_SS != _MIN_SS		/* Get disk sector size */
;;;4011   	if (disk_ioctl(pdrv, GET_SECTOR_SIZE, &SS(fs)) != RES_OK || SS(fs) > _MAX_SS || SS(fs) < _MIN_SS)
;;;4012   		return FR_DISK_ERR;
;;;4013   #endif
;;;4014   	if (_MULTI_PARTITION && part) {
;;;4015   		/* Get partition information from partition table in the MBR */
;;;4016   		if (disk_read(pdrv, fs->win, 0, 1)) return FR_DISK_ERR;
;;;4017   		if (LD_WORD(fs->win+BS_55AA) != 0xAA55) return FR_MKFS_ABORTED;
;;;4018   		tbl = &fs->win[MBR_Table + (part - 1) * SZ_PTE];
;;;4019   		if (!tbl[4]) return FR_MKFS_ABORTED;	/* No partition? */
;;;4020   		b_vol = LD_DWORD(tbl+8);	/* Volume start sector */
;;;4021   		n_vol = LD_DWORD(tbl+12);	/* Volume size */
;;;4022   	} else {
;;;4023   		/* Create a partition in this function */
;;;4024   		if (disk_ioctl(pdrv, GET_SECTOR_COUNT, &n_vol) != RES_OK || n_vol < 128)
;;;4025   			return FR_DISK_ERR;
;;;4026   		b_vol = (sfd) ? 0 : 63;		/* Volume start sector */
;;;4027   		n_vol -= b_vol;				/* Volume size */
;;;4028   	}
;;;4029   
;;;4030   	if (!au) {				/* AU auto selection */
;;;4031   		vs = n_vol / (2000 / (SS(fs) / 512));
;;;4032   		for (i = 0; vs < vst[i]; i++) ;
;;;4033   		au = cst[i];
;;;4034   	}
;;;4035   	au /= SS(fs);		/* Number of sectors per cluster */
;;;4036   	if (au == 0) au = 1;
;;;4037   	if (au > 128) au = 128;
;;;4038   
;;;4039   	/* Pre-compute number of clusters and FAT sub-type */
;;;4040   	n_clst = n_vol / au;
;;;4041   	fmt = FS_FAT12;
;;;4042   	if (n_clst >= MIN_FAT16) fmt = FS_FAT16;
;;;4043   	if (n_clst >= MIN_FAT32) fmt = FS_FAT32;
;;;4044   
;;;4045   	/* Determine offset and size of FAT structure */
;;;4046   	if (fmt == FS_FAT32) {
;;;4047   		n_fat = ((n_clst * 4) + 8 + SS(fs) - 1) / SS(fs);
;;;4048   		n_rsv = 32;
;;;4049   		n_dir = 0;
;;;4050   	} else {
;;;4051   		n_fat = (fmt == FS_FAT12) ? (n_clst * 3 + 1) / 2 + 3 : (n_clst * 2) + 4;
;;;4052   		n_fat = (n_fat + SS(fs) - 1) / SS(fs);
;;;4053   		n_rsv = 1;
;;;4054   		n_dir = (DWORD)N_ROOTDIR * SZ_DIR / SS(fs);
;;;4055   	}
;;;4056   	b_fat = b_vol + n_rsv;				/* FAT area start sector */
;;;4057   	b_dir = b_fat + n_fat * N_FATS;		/* Directory area start sector */
;;;4058   	b_data = b_dir + n_dir;				/* Data area start sector */
;;;4059   	if (n_vol < b_data + au - b_vol) return FR_MKFS_ABORTED;	/* Too small volume */
;;;4060   
;;;4061   	/* Align data start sector to erase block boundary (for flash memory media) */
;;;4062   	if (disk_ioctl(pdrv, GET_BLOCK_SIZE, &n) != RES_OK || !n || n > 32768) n = 1;
;;;4063   	n = (b_data + n - 1) & ~(n - 1);	/* Next nearest erase block from current data start */
;;;4064   	n = (n - b_data) / N_FATS;
;;;4065   	if (fmt == FS_FAT32) {		/* FAT32: Move FAT offset */
;;;4066   		n_rsv += n;
;;;4067   		b_fat += n;
;;;4068   	} else {					/* FAT12/16: Expand FAT size */
;;;4069   		n_fat += n;
;;;4070   	}
;;;4071   
;;;4072   	/* Determine number of clusters and final check of validity of the FAT sub-type */
;;;4073   	n_clst = (n_vol - n_rsv - n_fat * N_FATS - n_dir) / au;
;;;4074   	if (   (fmt == FS_FAT16 && n_clst < MIN_FAT16)
;;;4075   		|| (fmt == FS_FAT32 && n_clst < MIN_FAT32))
;;;4076   		return FR_MKFS_ABORTED;
;;;4077   
;;;4078   	/* Determine system ID in the partition table */
;;;4079   	if (fmt == FS_FAT32) {
;;;4080   		sys = 0x0C;		/* FAT32X */
;;;4081   	} else {
;;;4082   		if (fmt == FS_FAT12 && n_vol < 0x10000) {
;;;4083   			sys = 0x01;	/* FAT12(<65536) */
;;;4084   		} else {
;;;4085   			sys = (n_vol < 0x10000) ? 0x04 : 0x06;	/* FAT16(<65536) : FAT12/16(>=65536) */
;;;4086   		}
;;;4087   	}
;;;4088   
;;;4089   	if (_MULTI_PARTITION && part) {
;;;4090   		/* Update system ID in the partition table */
;;;4091   		tbl = &fs->win[MBR_Table + (part - 1) * SZ_PTE];
;;;4092   		tbl[4] = sys;
;;;4093   		if (disk_write(pdrv, fs->win, 0, 1))	/* Write it to teh MBR */
;;;4094   			return FR_DISK_ERR;
;;;4095   		md = 0xF8;
;;;4096   	} else {
;;;4097   		if (sfd) {	/* No partition table (SFD) */
;;;4098   			md = 0xF0;
;;;4099   		} else {	/* Create partition table (FDISK) */
;;;4100   			mem_set(fs->win, 0, SS(fs));
;;;4101   			tbl = fs->win+MBR_Table;	/* Create partition table for single partition in the drive */
;;;4102   			tbl[1] = 1;						/* Partition start head */
;;;4103   			tbl[2] = 1;						/* Partition start sector */
;;;4104   			tbl[3] = 0;						/* Partition start cylinder */
;;;4105   			tbl[4] = sys;					/* System type */
;;;4106   			tbl[5] = 254;					/* Partition end head */
;;;4107   			n = (b_vol + n_vol) / 63 / 255;
;;;4108   			tbl[6] = (BYTE)(n >> 2 | 63);	/* Partition end sector */
;;;4109   			tbl[7] = (BYTE)n;				/* End cylinder */
;;;4110   			ST_DWORD(tbl+8, 63);			/* Partition start in LBA */
;;;4111   			ST_DWORD(tbl+12, n_vol);		/* Partition size in LBA */
;;;4112   			ST_WORD(fs->win+BS_55AA, 0xAA55);	/* MBR signature */
;;;4113   			if (disk_write(pdrv, fs->win, 0, 1))	/* Write it to the MBR */
;;;4114   				return FR_DISK_ERR;
;;;4115   			md = 0xF8;
;;;4116   		}
;;;4117   	}
;;;4118   
;;;4119   	/* Create BPB in the VBR */
;;;4120   	tbl = fs->win;							/* Clear sector */
;;;4121   	mem_set(tbl, 0, SS(fs));
;;;4122   	mem_cpy(tbl, "\xEB\xFE\x90" "MSDOS5.0", 11);/* Boot jump code, OEM name */
;;;4123   	i = SS(fs);								/* Sector size */
;;;4124   	ST_WORD(tbl+BPB_BytsPerSec, i);
;;;4125   	tbl[BPB_SecPerClus] = (BYTE)au;			/* Sectors per cluster */
;;;4126   	ST_WORD(tbl+BPB_RsvdSecCnt, n_rsv);		/* Reserved sectors */
;;;4127   	tbl[BPB_NumFATs] = N_FATS;				/* Number of FATs */
;;;4128   	i = (fmt == FS_FAT32) ? 0 : N_ROOTDIR;	/* Number of root directory entries */
;;;4129   	ST_WORD(tbl+BPB_RootEntCnt, i);
;;;4130   	if (n_vol < 0x10000) {					/* Number of total sectors */
;;;4131   		ST_WORD(tbl+BPB_TotSec16, n_vol);
;;;4132   	} else {
;;;4133   		ST_DWORD(tbl+BPB_TotSec32, n_vol);
;;;4134   	}
;;;4135   	tbl[BPB_Media] = md;					/* Media descriptor */
;;;4136   	ST_WORD(tbl+BPB_SecPerTrk, 63);			/* Number of sectors per track */
;;;4137   	ST_WORD(tbl+BPB_NumHeads, 255);			/* Number of heads */
;;;4138   	ST_DWORD(tbl+BPB_HiddSec, b_vol);		/* Hidden sectors */
;;;4139   	n = get_fattime();						/* Use current time as VSN */
;;;4140   	if (fmt == FS_FAT32) {
;;;4141   		ST_DWORD(tbl+BS_VolID32, n);		/* VSN */
;;;4142   		ST_DWORD(tbl+BPB_FATSz32, n_fat);	/* Number of sectors per FAT */
;;;4143   		ST_DWORD(tbl+BPB_RootClus, 2);		/* Root directory start cluster (2) */
;;;4144   		ST_WORD(tbl+BPB_FSInfo, 1);			/* FSINFO record offset (VBR+1) */
;;;4145   		ST_WORD(tbl+BPB_BkBootSec, 6);		/* Backup boot record offset (VBR+6) */
;;;4146   		tbl[BS_DrvNum32] = 0x80;			/* Drive number */
;;;4147   		tbl[BS_BootSig32] = 0x29;			/* Extended boot signature */
;;;4148   		mem_cpy(tbl+BS_VolLab32, "NO NAME    " "FAT32   ", 19);	/* Volume label, FAT signature */
;;;4149   	} else {
;;;4150   		ST_DWORD(tbl+BS_VolID, n);			/* VSN */
;;;4151   		ST_WORD(tbl+BPB_FATSz16, n_fat);	/* Number of sectors per FAT */
;;;4152   		tbl[BS_DrvNum] = 0x80;				/* Drive number */
;;;4153   		tbl[BS_BootSig] = 0x29;				/* Extended boot signature */
;;;4154   		mem_cpy(tbl+BS_VolLab, "NO NAME    " "FAT     ", 19);	/* Volume label, FAT signature */
;;;4155   	}
;;;4156   	ST_WORD(tbl+BS_55AA, 0xAA55);			/* Signature (Offset is fixed here regardless of sector size) */
;;;4157   	if (disk_write(pdrv, tbl, b_vol, 1))	/* Write it to the VBR sector */
;;;4158   		return FR_DISK_ERR;
;;;4159   	if (fmt == FS_FAT32)					/* Write backup VBR if needed (VBR+6) */
;;;4160   		disk_write(pdrv, tbl, b_vol + 6, 1);
;;;4161   
;;;4162   	/* Initialize FAT area */
;;;4163   	wsect = b_fat;
;;;4164   	for (i = 0; i < N_FATS; i++) {		/* Initialize each FAT copy */
;;;4165   		mem_set(tbl, 0, SS(fs));			/* 1st sector of the FAT  */
;;;4166   		n = md;								/* Media descriptor byte */
;;;4167   		if (fmt != FS_FAT32) {
;;;4168   			n |= (fmt == FS_FAT12) ? 0x00FFFF00 : 0xFFFFFF00;
;;;4169   			ST_DWORD(tbl+0, n);				/* Reserve cluster #0-1 (FAT12/16) */
;;;4170   		} else {
;;;4171   			n |= 0xFFFFFF00;
;;;4172   			ST_DWORD(tbl+0, n);				/* Reserve cluster #0-1 (FAT32) */
;;;4173   			ST_DWORD(tbl+4, 0xFFFFFFFF);
;;;4174   			ST_DWORD(tbl+8, 0x0FFFFFFF);	/* Reserve cluster #2 for root directory */
;;;4175   		}
;;;4176   		if (disk_write(pdrv, tbl, wsect++, 1))
;;;4177   			return FR_DISK_ERR;
;;;4178   		mem_set(tbl, 0, SS(fs));			/* Fill following FAT entries with zero */
;;;4179   		for (n = 1; n < n_fat; n++) {		/* This loop may take a time on FAT32 volume due to many single sector writes */
;;;4180   			if (disk_write(pdrv, tbl, wsect++, 1))
;;;4181   				return FR_DISK_ERR;
;;;4182   		}
;;;4183   	}
;;;4184   
;;;4185   	/* Initialize root directory */
;;;4186   	i = (fmt == FS_FAT32) ? au : (UINT)n_dir;
;;;4187   	do {
;;;4188   		if (disk_write(pdrv, tbl, wsect++, 1))
;;;4189   			return FR_DISK_ERR;
;;;4190   	} while (--i);
;;;4191   
;;;4192   #if _USE_ERASE	/* Erase data area if needed */
;;;4193   	{
;;;4194   		DWORD eb[2];
;;;4195   
;;;4196   		eb[0] = wsect; eb[1] = wsect + (n_clst - ((fmt == FS_FAT32) ? 1 : 0)) * au - 1;
;;;4197   		disk_ioctl(pdrv, CTRL_ERASE_SECTOR, eb);
;;;4198   	}
;;;4199   #endif
;;;4200   
;;;4201   	/* Create FSINFO if needed */
;;;4202   	if (fmt == FS_FAT32) {
;;;4203   		ST_DWORD(tbl+FSI_LeadSig, 0x41615252);
;;;4204   		ST_DWORD(tbl+FSI_StrucSig, 0x61417272);
;;;4205   		ST_DWORD(tbl+FSI_Free_Count, n_clst - 1);	/* Number of free clusters */
;;;4206   		ST_DWORD(tbl+FSI_Nxt_Free, 2);				/* Last allocated cluster# */
;;;4207   		ST_WORD(tbl+BS_55AA, 0xAA55);
;;;4208   		disk_write(pdrv, tbl, b_vol + 1, 1);	/* Write original (VBR+1) */
;;;4209   		disk_write(pdrv, tbl, b_vol + 7, 1);	/* Write backup (VBR+7) */
;;;4210   	}
;;;4211   
;;;4212   	return (disk_ioctl(pdrv, CTRL_SYNC, 0) == RES_OK) ? FR_OK : FR_DISK_ERR;
;;;4213   }
000014  b00b              ADD      sp,sp,#0x2c
000016  e8bd8ff0          POP      {r4-r11,pc}
                  |L23.26|
00001a  9909              LDR      r1,[sp,#0x24]         ;3998
00001c  2901              CMP      r1,#1                 ;3998
00001e  d901              BLS      |L23.36|
000020  2013              MOVS     r0,#0x13              ;3998
000022  e7f7              B        |L23.20|
                  |L23.36|
000024  1e69              SUBS     r1,r5,#1              ;3999
000026  420d              TST      r5,r1                 ;3999
000028  d001              BEQ      |L23.46|
00002a  2013              MOVS     r0,#0x13              ;3999
00002c  e7f2              B        |L23.20|
                  |L23.46|
00002e  49fe              LDR      r1,|L23.1064|
000030  f8514020          LDR      r4,[r1,r0,LSL #2]     ;4000
000034  b154              CBZ      r4,|L23.76|
000036  2100              MOVS     r1,#0                 ;4002
000038  7021              STRB     r1,[r4,#0]            ;4002
00003a  b2c0              UXTB     r0,r0                 ;4003
00003c  9004              STR      r0,[sp,#0x10]         ;4003
00003e  9804              LDR      r0,[sp,#0x10]         ;4007
000040  f7fffffe          BL       disk_initialize
000044  07c1              LSLS     r1,r0,#31             ;4008
000046  d003              BEQ      |L23.80|
000048  2003              MOVS     r0,#3                 ;4008
00004a  e7e3              B        |L23.20|
                  |L23.76|
00004c  200c              MOVS     r0,#0xc               ;4001
00004e  e7e1              B        |L23.20|
                  |L23.80|
000050  0740              LSLS     r0,r0,#29             ;4009
000052  d501              BPL      |L23.88|
000054  200a              MOVS     r0,#0xa               ;4009
000056  e7dd              B        |L23.20|
                  |L23.88|
000058  466a              MOV      r2,sp                 ;4024
00005a  2101              MOVS     r1,#1                 ;4024
00005c  9804              LDR      r0,[sp,#0x10]         ;4024
00005e  f7fffffe          BL       disk_ioctl
000062  b910              CBNZ     r0,|L23.106|
000064  9800              LDR      r0,[sp,#0]            ;4024
000066  2880              CMP      r0,#0x80              ;4024
000068  d201              BCS      |L23.110|
                  |L23.106|
00006a  2001              MOVS     r0,#1                 ;4025
00006c  e7d2              B        |L23.20|
                  |L23.110|
00006e  9909              LDR      r1,[sp,#0x24]         ;4026
000070  b111              CBZ      r1,|L23.120|
000072  f04f0800          MOV      r8,#0                 ;4026
000076  e001              B        |L23.124|
                  |L23.120|
000078  f04f083f          MOV      r8,#0x3f              ;4026
                  |L23.124|
00007c  eba00108          SUB      r1,r0,r8              ;4027
000080  9100              STR      r1,[sp,#0]            ;4027
000082  b97d              CBNZ     r5,|L23.164|
000084  f44f60fa          MOV      r0,#0x7d0             ;4031
000088  fbb1f2f0          UDIV     r2,r1,r0              ;4031
00008c  2000              MOVS     r0,#0                 ;4032
00008e  4be7              LDR      r3,|L23.1068|
000090  e000              B        |L23.148|
                  |L23.146|
000092  1c40              ADDS     r0,r0,#1              ;4032
                  |L23.148|
000094  f8335010          LDRH     r5,[r3,r0,LSL #1]     ;4032
000098  4295              CMP      r5,r2                 ;4032
00009a  d8fa              BHI      |L23.146|
00009c  4ae3              LDR      r2,|L23.1068|
00009e  3216              ADDS     r2,r2,#0x16           ;4033
0000a0  f8325010          LDRH     r5,[r2,r0,LSL #1]     ;4033
                  |L23.164|
0000a4  ea4f2955          LSR      r9,r5,#9              ;4035
0000a8  f1b90f00          CMP      r9,#0                 ;4036
0000ac  d101              BNE      |L23.178|
0000ae  f04f0901          MOV      r9,#1                 ;4036
                  |L23.178|
0000b2  f1b90f80          CMP      r9,#0x80              ;4037
0000b6  d901              BLS      |L23.188|
0000b8  f04f0980          MOV      r9,#0x80              ;4037
                  |L23.188|
0000bc  fbb1f0f9          UDIV     r0,r1,r9              ;4040
0000c0  2601              MOVS     r6,#1                 ;4041
0000c2  f64072f6          MOV      r2,#0xff6             ;4042
0000c6  4290              CMP      r0,r2                 ;4042
0000c8  d300              BCC      |L23.204|
0000ca  2602              MOVS     r6,#2                 ;4042
                  |L23.204|
0000cc  f64f72f6          MOV      r2,#0xfff6            ;4043
0000d0  4290              CMP      r0,r2                 ;4043
0000d2  d300              BCC      |L23.214|
0000d4  2603              MOVS     r6,#3                 ;4043
                  |L23.214|
0000d6  2e03              CMP      r6,#3                 ;4046
0000d8  d017              BEQ      |L23.266|
0000da  2e01              CMP      r6,#1                 ;4051
0000dc  d01e              BEQ      |L23.284|
0000de  0040              LSLS     r0,r0,#1              ;4051
0000e0  1d00              ADDS     r0,r0,#4              ;4051
                  |L23.226|
0000e2  f20010ff          ADD      r0,r0,#0x1ff          ;4052
0000e6  0a47              LSRS     r7,r0,#9              ;4052
0000e8  2501              MOVS     r5,#1                 ;4053
0000ea  f04f0a20          MOV      r10,#0x20             ;4054
                  |L23.238|
0000ee  eb080b05          ADD      r11,r8,r5             ;4056
0000f2  eb0b0007          ADD      r0,r11,r7             ;4057
0000f6  4450              ADD      r0,r0,r10             ;4058
0000f8  9001              STR      r0,[sp,#4]            ;4058
0000fa  9801              LDR      r0,[sp,#4]            ;4059
0000fc  4448              ADD      r0,r0,r9              ;4059
0000fe  eba00008          SUB      r0,r0,r8              ;4059
000102  4288              CMP      r0,r1                 ;4059
000104  d910              BLS      |L23.296|
000106  200e              MOVS     r0,#0xe               ;4059
000108  e784              B        |L23.20|
                  |L23.266|
00010a  f2402207          MOV      r2,#0x207             ;4047
00010e  eb020080          ADD      r0,r2,r0,LSL #2       ;4047
000112  0a47              LSRS     r7,r0,#9              ;4047
000114  2520              MOVS     r5,#0x20              ;4048
000116  f04f0a00          MOV      r10,#0                ;4049
00011a  e7e8              B        |L23.238|
                  |L23.284|
00011c  eb000040          ADD      r0,r0,r0,LSL #1       ;4051
000120  1c40              ADDS     r0,r0,#1              ;4051
000122  0840              LSRS     r0,r0,#1              ;4051
000124  1cc0              ADDS     r0,r0,#3              ;4051
000126  e7dc              B        |L23.226|
                  |L23.296|
000128  aa02              ADD      r2,sp,#8              ;4062
00012a  2103              MOVS     r1,#3                 ;4062
00012c  9804              LDR      r0,[sp,#0x10]         ;4062
00012e  f7fffffe          BL       disk_ioctl
000132  b920              CBNZ     r0,|L23.318|
000134  9802              LDR      r0,[sp,#8]            ;4062
000136  b110              CBZ      r0,|L23.318|
000138  f5b04f00          CMP      r0,#0x8000            ;4062
00013c  d901              BLS      |L23.322|
                  |L23.318|
00013e  2001              MOVS     r0,#1                 ;4062
000140  9002              STR      r0,[sp,#8]            ;4062
                  |L23.322|
000142  e9dd1001          LDRD     r1,r0,[sp,#4]         ;4063
000146  4401              ADD      r1,r1,r0              ;4063
000148  1e49              SUBS     r1,r1,#1              ;4063
00014a  1e40              SUBS     r0,r0,#1              ;4063
00014c  4381              BICS     r1,r1,r0              ;4063
00014e  9801              LDR      r0,[sp,#4]            ;4064
000150  1a08              SUBS     r0,r1,r0              ;4064
000152  9002              STR      r0,[sp,#8]            ;4064
000154  2e03              CMP      r6,#3                 ;4065
000156  d00b              BEQ      |L23.368|
000158  4407              ADD      r7,r7,r0              ;4069
                  |L23.346|
00015a  9800              LDR      r0,[sp,#0]            ;4073
00015c  1b41              SUBS     r1,r0,r5              ;4073
00015e  1bc9              SUBS     r1,r1,r7              ;4073
000160  eba1010a          SUB      r1,r1,r10             ;4073
000164  fbb1f1f9          UDIV     r1,r1,r9              ;4073
000168  9103              STR      r1,[sp,#0xc]          ;4073
00016a  2e02              CMP      r6,#2                 ;4074
00016c  d003              BEQ      |L23.374|
00016e  e007              B        |L23.384|
                  |L23.368|
000170  4405              ADD      r5,r5,r0              ;4066
000172  4483              ADD      r11,r11,r0            ;4067
000174  e7f1              B        |L23.346|
                  |L23.374|
000176  9903              LDR      r1,[sp,#0xc]          ;4074
000178  f64072f6          MOV      r2,#0xff6             ;4074
00017c  4291              CMP      r1,r2                 ;4074
00017e  d306              BCC      |L23.398|
                  |L23.384|
000180  2e03              CMP      r6,#3                 ;4075
000182  d106              BNE      |L23.402|
000184  9903              LDR      r1,[sp,#0xc]          ;4075
000186  f64f72f6          MOV      r2,#0xfff6            ;4075
00018a  4291              CMP      r1,r2                 ;4075
00018c  d201              BCS      |L23.402|
                  |L23.398|
00018e  200e              MOVS     r0,#0xe               ;4076
000190  e740              B        |L23.20|
                  |L23.402|
000192  2e03              CMP      r6,#3                 ;4079
000194  d002              BEQ      |L23.412|
000196  2e01              CMP      r6,#1                 ;4082
000198  d003              BEQ      |L23.418|
00019a  e008              B        |L23.430|
                  |L23.412|
00019c  200c              MOVS     r0,#0xc               ;4080
00019e  9005              STR      r0,[sp,#0x14]         ;4080
0001a0  e00c              B        |L23.444|
                  |L23.418|
0001a2  f5b03f80          CMP      r0,#0x10000           ;4082
0001a6  d202              BCS      |L23.430|
0001a8  2001              MOVS     r0,#1                 ;4083
0001aa  9005              STR      r0,[sp,#0x14]         ;4083
0001ac  e006              B        |L23.444|
                  |L23.430|
0001ae  f5b03f80          CMP      r0,#0x10000           ;4085
0001b2  d201              BCS      |L23.440|
0001b4  2004              MOVS     r0,#4                 ;4085
0001b6  e000              B        |L23.442|
                  |L23.440|
0001b8  2006              MOVS     r0,#6                 ;4085
                  |L23.442|
0001ba  9005              STR      r0,[sp,#0x14]         ;4085
                  |L23.444|
0001bc  9809              LDR      r0,[sp,#0x24]         ;4097
0001be  b110              CBZ      r0,|L23.454|
0001c0  20f0              MOVS     r0,#0xf0              ;4098
0001c2  9006              STR      r0,[sp,#0x18]         ;4098
0001c4  e03c              B        |L23.576|
                  |L23.454|
0001c6  f1040030          ADD      r0,r4,#0x30           ;4100
0001ca  f44f7200          MOV      r2,#0x200             ;4100
0001ce  2100              MOVS     r1,#0                 ;4100
0001d0  9007              STR      r0,[sp,#0x1c]         ;4100
0001d2  f7fffffe          BL       mem_set
0001d6  f50470f7          ADD      r0,r4,#0x1ee          ;4101
0001da  2101              MOVS     r1,#1                 ;4102
0001dc  7041              STRB     r1,[r0,#1]            ;4102
0001de  7081              STRB     r1,[r0,#2]            ;4103
0001e0  2200              MOVS     r2,#0                 ;4104
0001e2  70c2              STRB     r2,[r0,#3]            ;4104
0001e4  9905              LDR      r1,[sp,#0x14]         ;4105
0001e6  7101              STRB     r1,[r0,#4]            ;4105
0001e8  21fe              MOVS     r1,#0xfe              ;4106
0001ea  7141              STRB     r1,[r0,#5]            ;4106
0001ec  9900              LDR      r1,[sp,#0]            ;4107
0001ee  f64363c1          MOV      r3,#0x3ec1            ;4107
0001f2  4441              ADD      r1,r1,r8              ;4107
0001f4  fbb1f1f3          UDIV     r1,r1,r3              ;4107
0001f8  9102              STR      r1,[sp,#8]            ;4107
0001fa  233f              MOVS     r3,#0x3f              ;4108
0001fc  ea430c91          ORR      r12,r3,r1,LSR #2      ;4108
000200  f880c006          STRB     r12,[r0,#6]           ;4108
000204  71c1              STRB     r1,[r0,#7]            ;4109
000206  7203              STRB     r3,[r0,#8]            ;4110
000208  7242              STRB     r2,[r0,#9]            ;4110
00020a  7282              STRB     r2,[r0,#0xa]          ;4110
00020c  72c2              STRB     r2,[r0,#0xb]          ;4110
00020e  9900              LDR      r1,[sp,#0]            ;4111
000210  7301              STRB     r1,[r0,#0xc]          ;4111
000212  0a0a              LSRS     r2,r1,#8              ;4111
000214  7342              STRB     r2,[r0,#0xd]          ;4111
000216  0c0a              LSRS     r2,r1,#16             ;4111
000218  7382              STRB     r2,[r0,#0xe]          ;4111
00021a  0e09              LSRS     r1,r1,#24             ;4111
00021c  73c1              STRB     r1,[r0,#0xf]          ;4111
00021e  2055              MOVS     r0,#0x55              ;4112
000220  f884022e          STRB     r0,[r4,#0x22e]        ;4112
000224  20aa              MOVS     r0,#0xaa              ;4112
000226  f884022f          STRB     r0,[r4,#0x22f]        ;4112
00022a  2301              MOVS     r3,#1                 ;4113
00022c  2200              MOVS     r2,#0                 ;4113
00022e  9907              LDR      r1,[sp,#0x1c]         ;4113
000230  9804              LDR      r0,[sp,#0x10]         ;4113
000232  f7fffffe          BL       disk_write
000236  b108              CBZ      r0,|L23.572|
000238  2001              MOVS     r0,#1                 ;4114
00023a  e6eb              B        |L23.20|
                  |L23.572|
00023c  20f8              MOVS     r0,#0xf8              ;4115
00023e  9006              STR      r0,[sp,#0x18]         ;4115
                  |L23.576|
000240  3430              ADDS     r4,r4,#0x30           ;4120
000242  f44f7200          MOV      r2,#0x200             ;4121
000246  2100              MOVS     r1,#0                 ;4121
000248  4620              MOV      r0,r4                 ;4121
00024a  f7fffffe          BL       mem_set
00024e  220b              MOVS     r2,#0xb               ;4122
000250  a177              ADR      r1,|L23.1072|
000252  4620              MOV      r0,r4                 ;4122
000254  f7fffffe          BL       mem_cpy
000258  2100              MOVS     r1,#0                 ;4124
00025a  72e1              STRB     r1,[r4,#0xb]          ;4124
00025c  2002              MOVS     r0,#2                 ;4124
00025e  7320              STRB     r0,[r4,#0xc]          ;4124
000260  f884900d          STRB     r9,[r4,#0xd]          ;4125
000264  73a5              STRB     r5,[r4,#0xe]          ;4126
000266  0a28              LSRS     r0,r5,#8              ;4126
000268  73e0              STRB     r0,[r4,#0xf]          ;4126
00026a  2001              MOVS     r0,#1                 ;4127
00026c  7420              STRB     r0,[r4,#0x10]         ;4127
00026e  2e03              CMP      r6,#3                 ;4128
000270  d00b              BEQ      |L23.650|
000272  0240              LSLS     r0,r0,#9              ;4128
                  |L23.628|
000274  7460              STRB     r0,[r4,#0x11]         ;4129
000276  0a00              LSRS     r0,r0,#8              ;4129
000278  74a0              STRB     r0,[r4,#0x12]         ;4129
00027a  9800              LDR      r0,[sp,#0]            ;4130
00027c  f5b03f80          CMP      r0,#0x10000           ;4130
000280  d205              BCS      |L23.654|
000282  74e0              STRB     r0,[r4,#0x13]         ;4131
000284  0a00              LSRS     r0,r0,#8              ;4131
000286  7520              STRB     r0,[r4,#0x14]         ;4131
000288  e00b              B        |L23.674|
                  |L23.650|
00028a  2000              MOVS     r0,#0                 ;4128
00028c  e7f2              B        |L23.628|
                  |L23.654|
00028e  f8040f20          STRB     r0,[r4,#0x20]!        ;4133
000292  0a02              LSRS     r2,r0,#8              ;4133
000294  7062              STRB     r2,[r4,#1]            ;4133
000296  0c02              LSRS     r2,r0,#16             ;4133
000298  70a2              STRB     r2,[r4,#2]            ;4133
00029a  0e00              LSRS     r0,r0,#24             ;4133
00029c  70e0              STRB     r0,[r4,#3]            ;4133
00029e  f1a40420          SUB      r4,r4,#0x20           ;4133
                  |L23.674|
0002a2  9806              LDR      r0,[sp,#0x18]         ;4135
0002a4  7560              STRB     r0,[r4,#0x15]         ;4135
0002a6  f04f003f          MOV      r0,#0x3f              ;4136
0002aa  7620              STRB     r0,[r4,#0x18]         ;4136
0002ac  f04f0000          MOV      r0,#0                 ;4136
0002b0  7660              STRB     r0,[r4,#0x19]         ;4136
0002b2  f04f01ff          MOV      r1,#0xff              ;4137
0002b6  76a1              STRB     r1,[r4,#0x1a]         ;4137
0002b8  76e0              STRB     r0,[r4,#0x1b]         ;4137
0002ba  f884801c          STRB     r8,[r4,#0x1c]         ;4138
0002be  ea4f2018          LSR      r0,r8,#8              ;4138
0002c2  7760              STRB     r0,[r4,#0x1d]         ;4138
0002c4  ea4f4018          LSR      r0,r8,#16             ;4138
0002c8  77a0              STRB     r0,[r4,#0x1e]         ;4138
0002ca  ea4f6018          LSR      r0,r8,#24             ;4138
0002ce  77e0              STRB     r0,[r4,#0x1f]         ;4138
0002d0  f7fffffe          BL       get_fattime
0002d4  9002              STR      r0,[sp,#8]            ;4139
0002d6  2180              MOVS     r1,#0x80              ;4037
0002d8  2229              MOVS     r2,#0x29              ;4147
0002da  2e03              CMP      r6,#3                 ;4140
0002dc  d029              BEQ      |L23.818|
0002de  f1040416          ADD      r4,r4,#0x16           ;4150
0002e2  7460              STRB     r0,[r4,#0x11]         ;4150
0002e4  ea4f2310          LSR      r3,r0,#8              ;4150
0002e8  74a3              STRB     r3,[r4,#0x12]         ;4150
0002ea  ea4f4310          LSR      r3,r0,#16             ;4150
0002ee  74e3              STRB     r3,[r4,#0x13]         ;4150
0002f0  ea4f6010          LSR      r0,r0,#24             ;4150
0002f4  7520              STRB     r0,[r4,#0x14]         ;4150
0002f6  7027              STRB     r7,[r4,#0]            ;4151
0002f8  ea4f2017          LSR      r0,r7,#8              ;4151
0002fc  7060              STRB     r0,[r4,#1]            ;4151
0002fe  73a1              STRB     r1,[r4,#0xe]          ;4152
000300  7422              STRB     r2,[r4,#0x10]         ;4153
000302  f1a40416          SUB      r4,r4,#0x16           ;4153
000306  f04f0213          MOV      r2,#0x13              ;4154
00030a  a14c              ADR      r1,|L23.1084|
00030c  f104002b          ADD      r0,r4,#0x2b           ;4154
000310  f7fffffe          BL       mem_cpy
                  |L23.788|
000314  2055              MOVS     r0,#0x55              ;4156
000316  f88401fe          STRB     r0,[r4,#0x1fe]        ;4156
00031a  20aa              MOVS     r0,#0xaa              ;4156
00031c  f88401ff          STRB     r0,[r4,#0x1ff]        ;4156
000320  2301              MOVS     r3,#1                 ;4157
000322  4642              MOV      r2,r8                 ;4157
000324  4621              MOV      r1,r4                 ;4157
000326  9804              LDR      r0,[sp,#0x10]         ;4157
000328  f7fffffe          BL       disk_write
00032c  b3b0              CBZ      r0,|L23.924|
00032e  2001              MOVS     r0,#1                 ;4158
000330  e670              B        |L23.20|
                  |L23.818|
000332  f1040424          ADD      r4,r4,#0x24           ;4141
000336  77e0              STRB     r0,[r4,#0x1f]         ;4141
000338  ea4f2310          LSR      r3,r0,#8              ;4141
00033c  f8843020          STRB     r3,[r4,#0x20]         ;4141
000340  ea4f4310          LSR      r3,r0,#16             ;4141
000344  f8843021          STRB     r3,[r4,#0x21]         ;4141
000348  ea4f6010          LSR      r0,r0,#24             ;4141
00034c  f8840022          STRB     r0,[r4,#0x22]         ;4141
000350  7027              STRB     r7,[r4,#0]            ;4142
000352  ea4f2017          LSR      r0,r7,#8              ;4142
000356  7060              STRB     r0,[r4,#1]            ;4142
000358  ea4f4017          LSR      r0,r7,#16             ;4142
00035c  70a0              STRB     r0,[r4,#2]            ;4142
00035e  ea4f6017          LSR      r0,r7,#24             ;4142
000362  70e0              STRB     r0,[r4,#3]            ;4142
000364  f04f0002          MOV      r0,#2                 ;4143
000368  7220              STRB     r0,[r4,#8]            ;4143
00036a  f04f0000          MOV      r0,#0                 ;4143
00036e  7260              STRB     r0,[r4,#9]            ;4143
000370  72a0              STRB     r0,[r4,#0xa]          ;4143
000372  72e0              STRB     r0,[r4,#0xb]          ;4143
000374  f04f0301          MOV      r3,#1                 ;4144
000378  7323              STRB     r3,[r4,#0xc]          ;4144
00037a  7360              STRB     r0,[r4,#0xd]          ;4144
00037c  f04f0306          MOV      r3,#6                 ;4145
000380  73a3              STRB     r3,[r4,#0xe]          ;4145
000382  73e0              STRB     r0,[r4,#0xf]          ;4145
000384  7721              STRB     r1,[r4,#0x1c]         ;4146
000386  77a2              STRB     r2,[r4,#0x1e]         ;4147
000388  f1a40424          SUB      r4,r4,#0x24           ;4147
00038c  f04f0213          MOV      r2,#0x13              ;4148
000390  a12f              ADR      r1,|L23.1104|
000392  f1040047          ADD      r0,r4,#0x47           ;4148
000396  f7fffffe          BL       mem_cpy
00039a  e7bb              B        |L23.788|
                  |L23.924|
00039c  e7ff              B        |L23.926|
                  |L23.926|
00039e  2e03              CMP      r6,#3                 ;4159
0003a0  d106              BNE      |L23.944|
0003a2  2301              MOVS     r3,#1                 ;4160
0003a4  f1080206          ADD      r2,r8,#6              ;4160
0003a8  4621              MOV      r1,r4                 ;4160
0003aa  9804              LDR      r0,[sp,#0x10]         ;4160
0003ac  f7fffffe          BL       disk_write
                  |L23.944|
0003b0  465d              MOV      r5,r11                ;4163
0003b2  f04f0b00          MOV      r11,#0                ;4164
                  |L23.950|
0003b6  f44f7200          MOV      r2,#0x200             ;4165
0003ba  2100              MOVS     r1,#0                 ;4165
0003bc  4620              MOV      r0,r4                 ;4165
0003be  f7fffffe          BL       mem_set
0003c2  9806              LDR      r0,[sp,#0x18]         ;4166
0003c4  9002              STR      r0,[sp,#8]            ;4166
0003c6  2e03              CMP      r6,#3                 ;4167
0003c8  d012              BEQ      |L23.1008|
0003ca  2e01              CMP      r6,#1                 ;4168
0003cc  d00e              BEQ      |L23.1004|
0003ce  f06f01ff          MVN      r1,#0xff              ;4168
                  |L23.978|
0003d2  4301              ORRS     r1,r1,r0              ;4168
0003d4  9102              STR      r1,[sp,#8]            ;4168
0003d6  7021              STRB     r1,[r4,#0]            ;4169
0003d8  9802              LDR      r0,[sp,#8]            ;4169
0003da  0a00              LSRS     r0,r0,#8              ;4169
0003dc  7060              STRB     r0,[r4,#1]            ;4169
0003de  9802              LDR      r0,[sp,#8]            ;4169
0003e0  0c00              LSRS     r0,r0,#16             ;4169
0003e2  70a0              STRB     r0,[r4,#2]            ;4169
0003e4  9802              LDR      r0,[sp,#8]            ;4169
0003e6  0e00              LSRS     r0,r0,#24             ;4169
0003e8  70e0              STRB     r0,[r4,#3]            ;4169
0003ea  e018              B        |L23.1054|
                  |L23.1004|
0003ec  491d              LDR      r1,|L23.1124|
0003ee  e7f0              B        |L23.978|
                  |L23.1008|
0003f0  f06000ff          ORN      r0,r0,#0xff           ;4171
0003f4  9002              STR      r0,[sp,#8]            ;4171
0003f6  7020              STRB     r0,[r4,#0]            ;4172
0003f8  9802              LDR      r0,[sp,#8]            ;4172
0003fa  0a00              LSRS     r0,r0,#8              ;4172
0003fc  7060              STRB     r0,[r4,#1]            ;4172
0003fe  9802              LDR      r0,[sp,#8]            ;4172
000400  0c00              LSRS     r0,r0,#16             ;4172
000402  70a0              STRB     r0,[r4,#2]            ;4172
000404  9802              LDR      r0,[sp,#8]            ;4172
000406  0e00              LSRS     r0,r0,#24             ;4172
000408  70e0              STRB     r0,[r4,#3]            ;4172
00040a  20ff              MOVS     r0,#0xff              ;4173
00040c  7120              STRB     r0,[r4,#4]            ;4173
00040e  7160              STRB     r0,[r4,#5]            ;4173
000410  71a0              STRB     r0,[r4,#6]            ;4173
000412  71e0              STRB     r0,[r4,#7]            ;4173
000414  7220              STRB     r0,[r4,#8]            ;4174
000416  7260              STRB     r0,[r4,#9]            ;4174
000418  72a0              STRB     r0,[r4,#0xa]          ;4174
00041a  200f              MOVS     r0,#0xf               ;4174
00041c  72e0              STRB     r0,[r4,#0xb]          ;4174
                  |L23.1054|
00041e  462a              MOV      r2,r5                 ;4176
000420  1c6d              ADDS     r5,r5,#1              ;4176
000422  2301              MOVS     r3,#1                 ;4176
000424  4621              MOV      r1,r4                 ;4176
000426  e01f              B        |L23.1128|
                  |L23.1064|
                          DCD      ||.bss||
                  |L23.1068|
                          DCD      ||.constdata||+0xe
                  |L23.1072|
000430  ebfe904d          DCB      235,254,144,"MSDOS5.0",0
000434  53444f53
000438  352e3000
                  |L23.1084|
00043c  4e4f204e          DCB      "NO NAME    FAT     ",0
000440  414d4520
000444  20202046
000448  41542020
00044c  20202000
                  |L23.1104|
000450  4e4f204e          DCB      "NO NAME    FAT32   ",0
000454  414d4520
000458  20202046
00045c  41543332
000460  20202000
                  |L23.1124|
                          DCD      0x00ffff00
                  |L23.1128|
000468  9804              LDR      r0,[sp,#0x10]         ;4176
00046a  f7fffffe          BL       disk_write
00046e  b108              CBZ      r0,|L23.1140|
000470  2001              MOVS     r0,#1                 ;4177
000472  e5cf              B        |L23.20|
                  |L23.1140|
000474  f44f7200          MOV      r2,#0x200             ;4178
000478  2100              MOVS     r1,#0                 ;4178
00047a  4620              MOV      r0,r4                 ;4178
00047c  f7fffffe          BL       mem_set
000480  2001              MOVS     r0,#1                 ;4179
000482  9002              STR      r0,[sp,#8]            ;4179
000484  e00c              B        |L23.1184|
                  |L23.1158|
000486  462a              MOV      r2,r5                 ;4180
000488  1c6d              ADDS     r5,r5,#1              ;4180
00048a  2301              MOVS     r3,#1                 ;4180
00048c  4621              MOV      r1,r4                 ;4180
00048e  9804              LDR      r0,[sp,#0x10]         ;4180
000490  f7fffffe          BL       disk_write
000494  b108              CBZ      r0,|L23.1178|
000496  2001              MOVS     r0,#1                 ;4181
000498  e5bc              B        |L23.20|
                  |L23.1178|
00049a  9802              LDR      r0,[sp,#8]            ;4179
00049c  1c40              ADDS     r0,r0,#1              ;4179
00049e  9002              STR      r0,[sp,#8]            ;4179
                  |L23.1184|
0004a0  9802              LDR      r0,[sp,#8]            ;4179
0004a2  42b8              CMP      r0,r7                 ;4179
0004a4  d3ef              BCC      |L23.1158|
0004a6  f10b0b01          ADD      r11,r11,#1            ;4164
0004aa  f1bb0f00          CMP      r11,#0                ;4164
0004ae  d082              BEQ      |L23.950|
0004b0  2e03              CMP      r6,#3                 ;4186
0004b2  d000              BEQ      |L23.1206|
0004b4  46d1              MOV      r9,r10                ;4186
                  |L23.1206|
0004b6  462a              MOV      r2,r5                 ;4188
0004b8  1c6d              ADDS     r5,r5,#1              ;4188
0004ba  2301              MOVS     r3,#1                 ;4188
0004bc  4621              MOV      r1,r4                 ;4188
0004be  9804              LDR      r0,[sp,#0x10]         ;4188
0004c0  f7fffffe          BL       disk_write
0004c4  b108              CBZ      r0,|L23.1226|
0004c6  2001              MOVS     r0,#1                 ;4189
0004c8  e5a4              B        |L23.20|
                  |L23.1226|
0004ca  f1b90901          SUBS     r9,r9,#1              ;4190
0004ce  d1f2              BNE      |L23.1206|
0004d0  2e03              CMP      r6,#3                 ;4202
0004d2  d13a              BNE      |L23.1354|
0004d4  2052              MOVS     r0,#0x52              ;4203
0004d6  7020              STRB     r0,[r4,#0]            ;4203
0004d8  7060              STRB     r0,[r4,#1]            ;4203
0004da  2061              MOVS     r0,#0x61              ;4203
0004dc  70a0              STRB     r0,[r4,#2]            ;4203
0004de  2141              MOVS     r1,#0x41              ;4203
0004e0  70e1              STRB     r1,[r4,#3]            ;4203
0004e2  2272              MOVS     r2,#0x72              ;4204
0004e4  f88421e4          STRB     r2,[r4,#0x1e4]        ;4204
0004e8  f88421e5          STRB     r2,[r4,#0x1e5]        ;4204
0004ec  f88411e6          STRB     r1,[r4,#0x1e6]        ;4204
0004f0  f88401e7          STRB     r0,[r4,#0x1e7]        ;4204
0004f4  9803              LDR      r0,[sp,#0xc]          ;4205
0004f6  1e40              SUBS     r0,r0,#1              ;4205
0004f8  f88401e8          STRB     r0,[r4,#0x1e8]        ;4205
0004fc  0a01              LSRS     r1,r0,#8              ;4205
0004fe  f88411e9          STRB     r1,[r4,#0x1e9]        ;4205
000502  0c01              LSRS     r1,r0,#16             ;4205
000504  f88411ea          STRB     r1,[r4,#0x1ea]        ;4205
000508  0e00              LSRS     r0,r0,#24             ;4205
00050a  f88401eb          STRB     r0,[r4,#0x1eb]        ;4205
00050e  2002              MOVS     r0,#2                 ;4206
000510  f88401ec          STRB     r0,[r4,#0x1ec]        ;4206
000514  2000              MOVS     r0,#0                 ;4206
000516  f88401ed          STRB     r0,[r4,#0x1ed]        ;4206
00051a  f88401ee          STRB     r0,[r4,#0x1ee]        ;4206
00051e  f88401ef          STRB     r0,[r4,#0x1ef]        ;4206
000522  2055              MOVS     r0,#0x55              ;4207
000524  f88401fe          STRB     r0,[r4,#0x1fe]        ;4207
000528  20aa              MOVS     r0,#0xaa              ;4207
00052a  f88401ff          STRB     r0,[r4,#0x1ff]        ;4207
00052e  2301              MOVS     r3,#1                 ;4208
000530  f1080201          ADD      r2,r8,#1              ;4208
000534  4621              MOV      r1,r4                 ;4208
000536  9804              LDR      r0,[sp,#0x10]         ;4208
000538  f7fffffe          BL       disk_write
00053c  2301              MOVS     r3,#1                 ;4209
00053e  f1080207          ADD      r2,r8,#7              ;4209
000542  4621              MOV      r1,r4                 ;4209
000544  9804              LDR      r0,[sp,#0x10]         ;4209
000546  f7fffffe          BL       disk_write
                  |L23.1354|
00054a  2200              MOVS     r2,#0                 ;4212
00054c  4611              MOV      r1,r2                 ;4212
00054e  9804              LDR      r0,[sp,#0x10]         ;4212
000550  f7fffffe          BL       disk_ioctl
000554  b108              CBZ      r0,|L23.1370|
000556  2001              MOVS     r0,#1                 ;4212
000558  e55c              B        |L23.20|
                  |L23.1370|
00055a  2000              MOVS     r0,#0                 ;4212
00055c  e55a              B        |L23.20|
;;;4214   
                          ENDP


                          AREA ||i.f_mount||, CODE, READONLY, ALIGN=2

                  f_mount PROC
;;;2366   
;;;2367   FRESULT f_mount (
000000  b517              PUSH     {r0-r2,r4,lr}
;;;2368   	FATFS* fs,			/* Pointer to the file system object (NULL:unmount)*/
;;;2369   	const TCHAR* path,	/* Logical drive number to be mounted/unmounted */
;;;2370   	BYTE opt			/* 0:Do not mount (delayed mount), 1:Mount immediately */
;;;2371   )
;;;2372   {
000002  b081              SUB      sp,sp,#4
000004  4614              MOV      r4,r2
;;;2373   	FATFS *cfs;
;;;2374   	int vol;
;;;2375   	FRESULT res;
;;;2376   	const TCHAR *rp = path;
000006  9802              LDR      r0,[sp,#8]
000008  9000              STR      r0,[sp,#0]
;;;2377   
;;;2378   
;;;2379   	vol = get_ldnumber(&rp);
00000a  4668              MOV      r0,sp
00000c  f7fffffe          BL       get_ldnumber
;;;2380   	if (vol < 0) return FR_INVALID_DRIVE;
000010  2800              CMP      r0,#0
000012  da02              BGE      |L24.26|
000014  200b              MOVS     r0,#0xb
                  |L24.22|
;;;2381   	cfs = FatFs[vol];					/* Pointer to fs object */
;;;2382   
;;;2383   	if (cfs) {
;;;2384   #if _FS_LOCK
;;;2385   		clear_lock(cfs);
;;;2386   #endif
;;;2387   #if _FS_REENTRANT						/* Discard sync object of the current volume */
;;;2388   		if (!ff_del_syncobj(cfs->sobj)) return FR_INT_ERR;
;;;2389   #endif
;;;2390   		cfs->fs_type = 0;				/* Clear old fs object */
;;;2391   	}
;;;2392   
;;;2393   	if (fs) {
;;;2394   		fs->fs_type = 0;				/* Clear new fs object */
;;;2395   #if _FS_REENTRANT						/* Create sync object for the new volume */
;;;2396   		if (!ff_cre_syncobj((BYTE)vol, &fs->sobj)) return FR_INT_ERR;
;;;2397   #endif
;;;2398   	}
;;;2399   	FatFs[vol] = fs;					/* Register new fs object */
;;;2400   
;;;2401   	if (!fs || opt != 1) return FR_OK;	/* Do not mount now, it will be mounted later */
;;;2402   
;;;2403   	res = find_volume(&fs, &path, 0);	/* Force mounted the volume */
;;;2404   	LEAVE_FF(fs, res);
;;;2405   }
000016  b004              ADD      sp,sp,#0x10
000018  bd10              POP      {r4,pc}
                  |L24.26|
00001a  4b0b              LDR      r3,|L24.72|
00001c  f8531020          LDR      r1,[r3,r0,LSL #2]     ;2381
000020  2200              MOVS     r2,#0                 ;2383
000022  b101              CBZ      r1,|L24.38|
000024  700a              STRB     r2,[r1,#0]            ;2390
                  |L24.38|
000026  9901              LDR      r1,[sp,#4]            ;2393
000028  2900              CMP      r1,#0                 ;2393
00002a  d000              BEQ      |L24.46|
00002c  700a              STRB     r2,[r1,#0]            ;2394
                  |L24.46|
00002e  f8431020          STR      r1,[r3,r0,LSL #2]     ;2399
000032  d001              BEQ      |L24.56|
000034  2c01              CMP      r4,#1                 ;2401
000036  d001              BEQ      |L24.60|
                  |L24.56|
000038  2000              MOVS     r0,#0                 ;2401
00003a  e7ec              B        |L24.22|
                  |L24.60|
00003c  2200              MOVS     r2,#0                 ;2403
00003e  a902              ADD      r1,sp,#8              ;2403
000040  a801              ADD      r0,sp,#4              ;2403
000042  f7fffffe          BL       find_volume
000046  e7e6              B        |L24.22|
;;;2406   
                          ENDP

                  |L24.72|
                          DCD      ||.bss||

                          AREA ||i.f_open||, CODE, READONLY, ALIGN=1

                  f_open PROC
;;;2413   
;;;2414   FRESULT f_open (
000000  e92d4ff7          PUSH     {r0-r2,r4-r11,lr}
;;;2415   	FIL* fp,			/* Pointer to the blank file object */
;;;2416   	const TCHAR* path,	/* Pointer to the file name */
;;;2417   	BYTE mode			/* Access mode and file open mode flags */
;;;2418   )
;;;2419   {
000004  b08c              SUB      sp,sp,#0x30
000006  4606              MOV      r6,r0
;;;2420   	FRESULT res;
;;;2421   	DIR dj;
;;;2422   	BYTE *dir;
;;;2423   	DEF_NAMEBUF;
;;;2424   
;;;2425   
;;;2426   	if (!fp) return FR_INVALID_OBJECT;
000008  2e00              CMP      r6,#0
00000a  d00e              BEQ      |L25.42|
;;;2427   	fp->fs = 0;			/* Clear file object */
00000c  f04f0800          MOV      r8,#0
000010  f8c68000          STR      r8,[r6,#0]
;;;2428   
;;;2429   	/* Get logical drive number */
;;;2430   #if !_FS_READONLY
;;;2431   	mode &= FA_READ | FA_WRITE | FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW;
000014  f002071f          AND      r7,r2,#0x1f
;;;2432   	res = find_volume(&dj.fs, &path, (BYTE)(mode & ~FA_READ));
000018  f0270201          BIC      r2,r7,#1
00001c  a90d              ADD      r1,sp,#0x34
00001e  a803              ADD      r0,sp,#0xc
000020  f7fffffe          BL       find_volume
000024  4605              MOV      r5,r0
;;;2433   #else
;;;2434   	mode &= FA_READ;
;;;2435   	res = find_volume(&dj.fs, &path, 0);
;;;2436   #endif
;;;2437   	if (res == FR_OK) {
000026  b125              CBZ      r5,|L25.50|
000028  e0a0              B        |L25.364|
                  |L25.42|
00002a  2009              MOVS     r0,#9                 ;2426
                  |L25.44|
;;;2438   		INIT_BUF(dj);
;;;2439   		res = follow_path(&dj, path);	/* Follow the file path */
;;;2440   		dir = dj.dir;
;;;2441   #if !_FS_READONLY	/* R/W configuration */
;;;2442   		if (res == FR_OK) {
;;;2443   			if (!dir)	/* Default directory itself */
;;;2444   				res = FR_INVALID_NAME;
;;;2445   #if _FS_LOCK
;;;2446   			else
;;;2447   				res = chk_lock(&dj, (mode & ~FA_READ) ? 1 : 0);
;;;2448   #endif
;;;2449   		}
;;;2450   		/* Create or Open a file */
;;;2451   		if (mode & (FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW)) {
;;;2452   			DWORD dw, cl;
;;;2453   
;;;2454   			if (res != FR_OK) {					/* No file, create new */
;;;2455   				if (res == FR_NO_FILE)			/* There is no file to open, create a new entry */
;;;2456   #if _FS_LOCK
;;;2457   					res = enq_lock() ? dir_register(&dj) : FR_TOO_MANY_OPEN_FILES;
;;;2458   #else
;;;2459   					res = dir_register(&dj);
;;;2460   #endif
;;;2461   				mode |= FA_CREATE_ALWAYS;		/* File is created */
;;;2462   				dir = dj.dir;					/* New entry */
;;;2463   			}
;;;2464   			else {								/* Any object is already existing */
;;;2465   				if (dir[DIR_Attr] & (AM_RDO | AM_DIR)) {	/* Cannot overwrite it (R/O or DIR) */
;;;2466   					res = FR_DENIED;
;;;2467   				} else {
;;;2468   					if (mode & FA_CREATE_NEW)	/* Cannot create as new file */
;;;2469   						res = FR_EXIST;
;;;2470   				}
;;;2471   			}
;;;2472   			if (res == FR_OK && (mode & FA_CREATE_ALWAYS)) {	/* Truncate it if overwrite mode */
;;;2473   				dw = get_fattime();				/* Created time */
;;;2474   				ST_DWORD(dir+DIR_CrtTime, dw);
;;;2475   				dir[DIR_Attr] = 0;				/* Reset attribute */
;;;2476   				ST_DWORD(dir+DIR_FileSize, 0);	/* size = 0 */
;;;2477   				cl = ld_clust(dj.fs, dir);		/* Get start cluster */
;;;2478   				st_clust(dir, 0);				/* cluster = 0 */
;;;2479   				dj.fs->wflag = 1;
;;;2480   				if (cl) {						/* Remove the cluster chain if exist */
;;;2481   					dw = dj.fs->winsect;
;;;2482   					res = remove_chain(dj.fs, cl);
;;;2483   					if (res == FR_OK) {
;;;2484   						dj.fs->last_clust = cl - 1;	/* Reuse the cluster hole */
;;;2485   						res = move_window(dj.fs, dw);
;;;2486   					}
;;;2487   				}
;;;2488   			}
;;;2489   		}
;;;2490   		else {	/* Open an existing file */
;;;2491   			if (res == FR_OK) {					/* Follow succeeded */
;;;2492   				if (dir[DIR_Attr] & AM_DIR) {	/* It is a directory */
;;;2493   					res = FR_NO_FILE;
;;;2494   				} else {
;;;2495   					if ((mode & FA_WRITE) && (dir[DIR_Attr] & AM_RDO)) /* R/O violation */
;;;2496   						res = FR_DENIED;
;;;2497   				}
;;;2498   			}
;;;2499   		}
;;;2500   		if (res == FR_OK) {
;;;2501   			if (mode & FA_CREATE_ALWAYS)		/* Set file change flag if created or overwritten */
;;;2502   				mode |= FA__WRITTEN;
;;;2503   			fp->dir_sect = dj.fs->winsect;		/* Pointer to the directory entry */
;;;2504   			fp->dir_ptr = dir;
;;;2505   #if _FS_LOCK
;;;2506   			fp->lockid = inc_lock(&dj, (mode & ~FA_READ) ? 1 : 0);
;;;2507   			if (!fp->lockid) res = FR_INT_ERR;
;;;2508   #endif
;;;2509   		}
;;;2510   
;;;2511   #else				/* R/O configuration */
;;;2512   		if (res == FR_OK) {					/* Follow succeeded */
;;;2513   			dir = dj.dir;
;;;2514   			if (!dir) {						/* Current directory itself */
;;;2515   				res = FR_INVALID_NAME;
;;;2516   			} else {
;;;2517   				if (dir[DIR_Attr] & AM_DIR)	/* It is a directory */
;;;2518   					res = FR_NO_FILE;
;;;2519   			}
;;;2520   		}
;;;2521   #endif
;;;2522   		FREE_BUF();
;;;2523   
;;;2524   		if (res == FR_OK) {
;;;2525   			fp->flag = mode;					/* File access mode */
;;;2526   			fp->err = 0;						/* Clear error flag */
;;;2527   			fp->sclust = ld_clust(dj.fs, dir);	/* File start cluster */
;;;2528   			fp->fsize = LD_DWORD(dir+DIR_FileSize);	/* File size */
;;;2529   			fp->fptr = 0;						/* File pointer */
;;;2530   			fp->dsect = 0;
;;;2531   #if _USE_FASTSEEK
;;;2532   			fp->cltbl = 0;						/* Normal seek mode */
;;;2533   #endif
;;;2534   			fp->fs = dj.fs;	 					/* Validate file object */
;;;2535   			fp->id = fp->fs->id;
;;;2536   		}
;;;2537   	}
;;;2538   
;;;2539   	LEAVE_FF(dj.fs, res);
;;;2540   }
00002c  b00f              ADD      sp,sp,#0x3c
00002e  e8bd8ff0          POP      {r4-r11,pc}
                  |L25.50|
000032  f44f7000          MOV      r0,#0x200             ;2438
000036  f7fffffe          BL       ff_memalloc
00003a  4681              MOV      r9,r0                 ;2438
00003c  f1b90f00          CMP      r9,#0                 ;2438
000040  d00b              BEQ      |L25.90|
000042  f8cd9028          STR      r9,[sp,#0x28]         ;2438
000046  f8cdd024          STR      sp,[sp,#0x24]         ;2438
00004a  a803              ADD      r0,sp,#0xc            ;2439
00004c  990d              LDR      r1,[sp,#0x34]         ;2439
00004e  f7fffffe          BL       follow_path
000052  4605              MOV      r5,r0                 ;2439
000054  9c08              LDR      r4,[sp,#0x20]         ;2440
000056  b115              CBZ      r5,|L25.94|
000058  e003              B        |L25.98|
                  |L25.90|
00005a  2011              MOVS     r0,#0x11              ;2438
00005c  e7e6              B        |L25.44|
                  |L25.94|
00005e  b904              CBNZ     r4,|L25.98|
000060  2506              MOVS     r5,#6                 ;2444
                  |L25.98|
000062  f0170f1c          TST      r7,#0x1c              ;2451
000066  d04c              BEQ      |L25.258|
000068  b14d              CBZ      r5,|L25.126|
00006a  2d04              CMP      r5,#4                 ;2455
00006c  d103              BNE      |L25.118|
00006e  a803              ADD      r0,sp,#0xc            ;2459
000070  f7fffffe          BL       dir_register
000074  4605              MOV      r5,r0                 ;2459
                  |L25.118|
000076  f0470708          ORR      r7,r7,#8              ;2461
00007a  9c08              LDR      r4,[sp,#0x20]         ;2462
00007c  e008              B        |L25.144|
                  |L25.126|
00007e  7ae0              LDRB     r0,[r4,#0xb]          ;2465
000080  f0100f11          TST      r0,#0x11              ;2465
000084  d001              BEQ      |L25.138|
000086  2507              MOVS     r5,#7                 ;2466
000088  e002              B        |L25.144|
                  |L25.138|
00008a  0778              LSLS     r0,r7,#29             ;2468
00008c  d500              BPL      |L25.144|
00008e  2508              MOVS     r5,#8                 ;2469
                  |L25.144|
000090  bbb5              CBNZ     r5,|L25.256|
000092  0738              LSLS     r0,r7,#28             ;2472
000094  d540              BPL      |L25.280|
000096  f7fffffe          BL       get_fattime
00009a  73a0              STRB     r0,[r4,#0xe]          ;2474
00009c  0a01              LSRS     r1,r0,#8              ;2474
00009e  73e1              STRB     r1,[r4,#0xf]          ;2474
0000a0  0c01              LSRS     r1,r0,#16             ;2474
0000a2  7421              STRB     r1,[r4,#0x10]         ;2474
0000a4  0e00              LSRS     r0,r0,#24             ;2474
0000a6  7460              STRB     r0,[r4,#0x11]         ;2474
0000a8  f884800b          STRB     r8,[r4,#0xb]          ;2475
0000ac  f884801c          STRB     r8,[r4,#0x1c]         ;2476
0000b0  f884801d          STRB     r8,[r4,#0x1d]         ;2476
0000b4  f884801e          STRB     r8,[r4,#0x1e]         ;2476
0000b8  f884801f          STRB     r8,[r4,#0x1f]         ;2476
0000bc  4621              MOV      r1,r4                 ;2477
0000be  9803              LDR      r0,[sp,#0xc]          ;2477
0000c0  f7fffffe          BL       ld_clust
0000c4  4682              MOV      r10,r0                ;2477
0000c6  2100              MOVS     r1,#0                 ;2478
0000c8  4620              MOV      r0,r4                 ;2478
0000ca  f7fffffe          BL       st_clust
0000ce  9903              LDR      r1,[sp,#0xc]          ;2479
0000d0  2001              MOVS     r0,#1                 ;2479
0000d2  7108              STRB     r0,[r1,#4]            ;2479
0000d4  f1ba0f00          CMP      r10,#0                ;2480
0000d8  d01e              BEQ      |L25.280|
0000da  9803              LDR      r0,[sp,#0xc]          ;2481
0000dc  f8d0b02c          LDR      r11,[r0,#0x2c]        ;2481
0000e0  4651              MOV      r1,r10                ;2482
0000e2  9803              LDR      r0,[sp,#0xc]          ;2482
0000e4  f7fffffe          BL       remove_chain
0000e8  4605              MOV      r5,r0                 ;2482
0000ea  b94d              CBNZ     r5,|L25.256|
0000ec  9803              LDR      r0,[sp,#0xc]          ;2484
0000ee  f1aa0a01          SUB      r10,r10,#1            ;2484
0000f2  f8c0a00c          STR      r10,[r0,#0xc]         ;2484
0000f6  4659              MOV      r1,r11                ;2485
0000f8  9803              LDR      r0,[sp,#0xc]          ;2485
0000fa  f7fffffe          BL       move_window
0000fe  4605              MOV      r5,r0                 ;2485
                  |L25.256|
000100  e00a              B        |L25.280|
                  |L25.258|
000102  b94d              CBNZ     r5,|L25.280|
000104  7ae0              LDRB     r0,[r4,#0xb]          ;2492
000106  06c1              LSLS     r1,r0,#27             ;2492
000108  d501              BPL      |L25.270|
00010a  2504              MOVS     r5,#4                 ;2493
00010c  e004              B        |L25.280|
                  |L25.270|
00010e  07b9              LSLS     r1,r7,#30             ;2495
000110  d502              BPL      |L25.280|
000112  07c0              LSLS     r0,r0,#31             ;2495
000114  d000              BEQ      |L25.280|
000116  2507              MOVS     r5,#7                 ;2496
                  |L25.280|
000118  b93d              CBNZ     r5,|L25.298|
00011a  0738              LSLS     r0,r7,#28             ;2501
00011c  d501              BPL      |L25.290|
00011e  f0470720          ORR      r7,r7,#0x20           ;2502
                  |L25.290|
000122  9803              LDR      r0,[sp,#0xc]          ;2503
000124  6ac0              LDR      r0,[r0,#0x2c]         ;2503
000126  61f0              STR      r0,[r6,#0x1c]         ;2503
000128  6234              STR      r4,[r6,#0x20]         ;2504
                  |L25.298|
00012a  4648              MOV      r0,r9                 ;2522
00012c  f7fffffe          BL       ff_memfree
000130  b9e5              CBNZ     r5,|L25.364|
000132  71b7              STRB     r7,[r6,#6]            ;2525
000134  f8868007          STRB     r8,[r6,#7]            ;2526
000138  4621              MOV      r1,r4                 ;2527
00013a  9803              LDR      r0,[sp,#0xc]          ;2527
00013c  f7fffffe          BL       ld_clust
000140  6130              STR      r0,[r6,#0x10]         ;2527
000142  7f20              LDRB     r0,[r4,#0x1c]         ;2528
000144  7fe1              LDRB     r1,[r4,#0x1f]         ;2528
000146  7f62              LDRB     r2,[r4,#0x1d]         ;2528
000148  ea406001          ORR      r0,r0,r1,LSL #24      ;2528
00014c  7fa1              LDRB     r1,[r4,#0x1e]         ;2528
00014e  0409              LSLS     r1,r1,#16             ;2528
000150  ea412102          ORR      r1,r1,r2,LSL #8       ;2528
000154  4308              ORRS     r0,r0,r1              ;2528
000156  60f0              STR      r0,[r6,#0xc]          ;2528
000158  f8c68008          STR      r8,[r6,#8]            ;2529
00015c  f8c68018          STR      r8,[r6,#0x18]         ;2530
000160  f8c68024          STR      r8,[r6,#0x24]         ;2532
000164  9803              LDR      r0,[sp,#0xc]          ;2534
000166  6030              STR      r0,[r6,#0]            ;2534
000168  88c0              LDRH     r0,[r0,#6]            ;2535
00016a  80b0              STRH     r0,[r6,#4]            ;2535
                  |L25.364|
00016c  4628              MOV      r0,r5                 ;2539
00016e  e75d              B        |L25.44|
;;;2541   
                          ENDP


                          AREA ||i.f_opendir||, CODE, READONLY, ALIGN=1

                  f_opendir PROC
;;;3151   
;;;3152   FRESULT f_opendir (
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;3153   	DIR* dp,			/* Pointer to directory object to create */
;;;3154   	const TCHAR* path	/* Pointer to the directory path */
;;;3155   )
;;;3156   {
000002  b084              SUB      sp,sp,#0x10
000004  4605              MOV      r5,r0
;;;3157   	FRESULT res;
;;;3158   	FATFS* fs;
;;;3159   	DEF_NAMEBUF;
;;;3160   
;;;3161   
;;;3162   	if (!dp) return FR_INVALID_OBJECT;
000006  2d00              CMP      r5,#0
000008  d007              BEQ      |L26.26|
;;;3163   
;;;3164   	/* Get logical drive number */
;;;3165   	res = find_volume(&fs, &path, 0);
00000a  2200              MOVS     r2,#0
00000c  a905              ADD      r1,sp,#0x14
00000e  a803              ADD      r0,sp,#0xc
000010  f7fffffe          BL       find_volume
000014  4604              MOV      r4,r0
;;;3166   	if (res == FR_OK) {
000016  b11c              CBZ      r4,|L26.32|
000018  e030              B        |L26.124|
                  |L26.26|
00001a  2009              MOVS     r0,#9                 ;3162
                  |L26.28|
;;;3167   		dp->fs = fs;
;;;3168   		INIT_BUF(*dp);
;;;3169   		res = follow_path(dp, path);			/* Follow the path to the directory */
;;;3170   		FREE_BUF();
;;;3171   		if (res == FR_OK) {						/* Follow completed */
;;;3172   			if (dp->dir) {						/* It is not the origin directory itself */
;;;3173   				if (dp->dir[DIR_Attr] & AM_DIR)	/* The object is a sub directory */
;;;3174   					dp->sclust = ld_clust(fs, dp->dir);
;;;3175   				else							/* The object is a file */
;;;3176   					res = FR_NO_PATH;
;;;3177   			}
;;;3178   			if (res == FR_OK) {
;;;3179   				dp->id = fs->id;
;;;3180   				res = dir_sdi(dp, 0);			/* Rewind directory */
;;;3181   #if _FS_LOCK
;;;3182   				if (res == FR_OK) {
;;;3183   					if (dp->sclust) {
;;;3184   						dp->lockid = inc_lock(dp, 0);	/* Lock the sub directory */
;;;3185   						if (!dp->lockid)
;;;3186   							res = FR_TOO_MANY_OPEN_FILES;
;;;3187   					} else {
;;;3188   						dp->lockid = 0;	/* Root directory need not to be locked */
;;;3189   					}
;;;3190   				}
;;;3191   #endif
;;;3192   			}
;;;3193   		}
;;;3194   		if (res == FR_NO_FILE) res = FR_NO_PATH;
;;;3195   	}
;;;3196   	if (res != FR_OK) dp->fs = 0;		/* Invalidate the directory object if function faild */
;;;3197   
;;;3198   	LEAVE_FF(fs, res);
;;;3199   }
00001c  b006              ADD      sp,sp,#0x18
00001e  bd70              POP      {r4-r6,pc}
                  |L26.32|
000020  9803              LDR      r0,[sp,#0xc]          ;3167
000022  6028              STR      r0,[r5,#0]            ;3167
000024  f44f7000          MOV      r0,#0x200             ;3168
000028  f7fffffe          BL       ff_memalloc
00002c  4606              MOV      r6,r0                 ;3168
00002e  b166              CBZ      r6,|L26.74|
000030  61ee              STR      r6,[r5,#0x1c]         ;3168
000032  f8c5d018          STR      sp,[r5,#0x18]         ;3168
000036  4628              MOV      r0,r5                 ;3169
000038  9905              LDR      r1,[sp,#0x14]         ;3169
00003a  f7fffffe          BL       follow_path
00003e  4604              MOV      r4,r0                 ;3169
000040  4630              MOV      r0,r6                 ;3170
000042  f7fffffe          BL       ff_memfree
000046  b114              CBZ      r4,|L26.78|
000048  e015              B        |L26.118|
                  |L26.74|
00004a  2011              MOVS     r0,#0x11              ;3168
00004c  e7e6              B        |L26.28|
                  |L26.78|
00004e  6969              LDR      r1,[r5,#0x14]         ;3172
000050  b141              CBZ      r1,|L26.100|
000052  7ac8              LDRB     r0,[r1,#0xb]          ;3173
000054  06c0              LSLS     r0,r0,#27             ;3173
000056  d504              BPL      |L26.98|
000058  9803              LDR      r0,[sp,#0xc]          ;3174
00005a  f7fffffe          BL       ld_clust
00005e  60a8              STR      r0,[r5,#8]            ;3174
000060  e000              B        |L26.100|
                  |L26.98|
000062  2405              MOVS     r4,#5                 ;3176
                  |L26.100|
000064  b93c              CBNZ     r4,|L26.118|
000066  9803              LDR      r0,[sp,#0xc]          ;3179
000068  88c0              LDRH     r0,[r0,#6]            ;3179
00006a  80a8              STRH     r0,[r5,#4]            ;3179
00006c  2100              MOVS     r1,#0                 ;3180
00006e  4628              MOV      r0,r5                 ;3180
000070  f7fffffe          BL       dir_sdi
000074  4604              MOV      r4,r0                 ;3180
                  |L26.118|
000076  2c04              CMP      r4,#4                 ;3194
000078  d100              BNE      |L26.124|
00007a  2405              MOVS     r4,#5                 ;3194
                  |L26.124|
00007c  b10c              CBZ      r4,|L26.130|
00007e  2000              MOVS     r0,#0                 ;3196
000080  6028              STR      r0,[r5,#0]            ;3196
                  |L26.130|
000082  4620              MOV      r0,r4                 ;3198
000084  e7ca              B        |L26.28|
;;;3200   
                          ENDP


                          AREA ||i.f_printf||, CODE, READONLY, ALIGN=1

                  f_printf PROC
;;;4490   
;;;4491   int f_printf (
000000  b40f              PUSH     {r0-r3}
;;;4492   	FIL* fp,			/* Pointer to the file object */
;;;4493   	const TCHAR* fmt,	/* Pointer to the format string */
;;;4494   	...					/* Optional arguments... */
;;;4495   )
;;;4496   {
000002  e92d47f0          PUSH     {r4-r10,lr}
000006  b09a              SUB      sp,sp,#0x68
;;;4497   	va_list arp;
;;;4498   	BYTE f, r;
;;;4499   	UINT nw, i, j, w;
;;;4500   	DWORD v;
;;;4501   	TCHAR c, d, s[16], *p;
;;;4502   	putbuff pb;
;;;4503   
;;;4504   
;;;4505   	pb.fp = fp;				/* Initialize output buffer */
000008  9001              STR      r0,[sp,#4]
;;;4506   	pb.nchr = pb.idx = 0;
00000a  f04f0900          MOV      r9,#0
00000e  f8cd9008          STR      r9,[sp,#8]
000012  f8cd900c          STR      r9,[sp,#0xc]
;;;4507   
;;;4508   	va_start(arp, fmt);
000016  a824              ADD      r0,sp,#0x90
000018  9019              STR      r0,[sp,#0x64]
00001a  f10d0850          ADD      r8,sp,#0x50           ;4501
                  |L27.30|
;;;4509   
;;;4510   	for (;;) {
;;;4511   		c = *fmt++;
00001e  9823              LDR      r0,[sp,#0x8c]
000020  f8101b01          LDRB     r1,[r0],#1
000024  9023              STR      r0,[sp,#0x8c]
;;;4512   		if (c == 0) break;			/* End of string */
000026  2900              CMP      r1,#0
000028  d073              BEQ      |L27.274|
;;;4513   		if (c != '%') {				/* Non escape character */
00002a  2925              CMP      r1,#0x25
00002c  d003              BEQ      |L27.54|
;;;4514   			putc_bfd(&pb, c);
00002e  a801              ADD      r0,sp,#4
000030  f7fffffe          BL       putc_bfd
;;;4515   			continue;
000034  e7f3              B        |L27.30|
                  |L27.54|
;;;4516   		}
;;;4517   		w = f = 0;
000036  2500              MOVS     r5,#0
000038  462e              MOV      r6,r5
;;;4518   		c = *fmt++;
00003a  f8101b01          LDRB     r1,[r0],#1
00003e  9023              STR      r0,[sp,#0x8c]
;;;4519   		if (c == '0') {				/* Flag: '0' padding */
000040  2930              CMP      r1,#0x30
000042  d002              BEQ      |L27.74|
;;;4520   			f = 1; c = *fmt++;
;;;4521   		} else {
;;;4522   			if (c == '-') {			/* Flag: left justified */
000044  292d              CMP      r1,#0x2d
000046  d005              BEQ      |L27.84|
000048  e012              B        |L27.112|
                  |L27.74|
00004a  2501              MOVS     r5,#1                 ;4520
00004c  f8101b01          LDRB     r1,[r0],#1            ;4520
000050  9023              STR      r0,[sp,#0x8c]         ;4520
000052  e00d              B        |L27.112|
                  |L27.84|
;;;4523   				f = 2; c = *fmt++;
000054  2502              MOVS     r5,#2
000056  f8101b01          LDRB     r1,[r0],#1
00005a  9023              STR      r0,[sp,#0x8c]
00005c  e008              B        |L27.112|
                  |L27.94|
;;;4524   			}
;;;4525   		}
;;;4526   		while (IsDigit(c)) {		/* Precision */
;;;4527   			w = w * 10 + c - '0';
00005e  eb060086          ADD      r0,r6,r6,LSL #2
000062  eb010640          ADD      r6,r1,r0,LSL #1
000066  3e30              SUBS     r6,r6,#0x30
;;;4528   			c = *fmt++;
000068  9823              LDR      r0,[sp,#0x8c]
00006a  f8101b01          LDRB     r1,[r0],#1
00006e  9023              STR      r0,[sp,#0x8c]
                  |L27.112|
000070  f1a10030          SUB      r0,r1,#0x30           ;4526
000074  2809              CMP      r0,#9                 ;4526
000076  d9f2              BLS      |L27.94|
;;;4529   		}
;;;4530   		if (c == 'l' || c == 'L') {	/* Prefix: Size is long int */
000078  296c              CMP      r1,#0x6c
00007a  d001              BEQ      |L27.128|
00007c  294c              CMP      r1,#0x4c
00007e  d105              BNE      |L27.140|
                  |L27.128|
;;;4531   			f |= 4; c = *fmt++;
000080  f0450504          ORR      r5,r5,#4
000084  9823              LDR      r0,[sp,#0x8c]
000086  f8101b01          LDRB     r1,[r0],#1
00008a  9023              STR      r0,[sp,#0x8c]
                  |L27.140|
;;;4532   		}
;;;4533   		if (!c) break;
00008c  2900              CMP      r1,#0
00008e  d040              BEQ      |L27.274|
;;;4534   		d = c;
000090  460a              MOV      r2,r1
;;;4535   		if (IsLower(d)) d -= 0x20;
000092  f1a20061          SUB      r0,r2,#0x61
000096  2819              CMP      r0,#0x19
000098  d801              BHI      |L27.158|
00009a  3a20              SUBS     r2,r2,#0x20
00009c  b2d2              UXTB     r2,r2
                  |L27.158|
;;;4536   		switch (d) {				/* Type is... */
00009e  2a4f              CMP      r2,#0x4f
0000a0  d042              BEQ      |L27.296|
0000a2  dc06              BGT      |L27.178|
0000a4  2a42              CMP      r2,#0x42
0000a6  d03d              BEQ      |L27.292|
0000a8  2a43              CMP      r2,#0x43
0000aa  d033              BEQ      |L27.276|
0000ac  2a44              CMP      r2,#0x44
0000ae  d106              BNE      |L27.190|
0000b0  e03c              B        |L27.300|
                  |L27.178|
0000b2  2a53              CMP      r2,#0x53
0000b4  d007              BEQ      |L27.198|
0000b6  2a55              CMP      r2,#0x55
0000b8  d038              BEQ      |L27.300|
0000ba  2a58              CMP      r2,#0x58
0000bc  d038              BEQ      |L27.304|
                  |L27.190|
;;;4537   		case 'S' :					/* String */
;;;4538   			p = va_arg(arp, TCHAR*);
;;;4539   			for (j = 0; p[j]; j++) ;
;;;4540   			if (!(f & 2)) {
;;;4541   				while (j++ < w) putc_bfd(&pb, ' ');
;;;4542   			}
;;;4543   			while (*p) putc_bfd(&pb, *p++);
;;;4544   			while (j++ < w) putc_bfd(&pb, ' ');
;;;4545   			continue;
;;;4546   		case 'C' :					/* Character */
;;;4547   			putc_bfd(&pb, (TCHAR)va_arg(arp, int)); continue;
;;;4548   		case 'B' :					/* Binary */
;;;4549   			r = 2; break;
;;;4550   		case 'O' :					/* Octal */
;;;4551   			r = 8; break;
;;;4552   		case 'D' :					/* Signed decimal */
;;;4553   		case 'U' :					/* Unsigned decimal */
;;;4554   			r = 10; break;
;;;4555   		case 'X' :					/* Hexdecimal */
;;;4556   			r = 16; break;
;;;4557   		default:					/* Unknown type (pass-through) */
;;;4558   			putc_bfd(&pb, c); continue;
0000be  a801              ADD      r0,sp,#4
0000c0  f7fffffe          BL       putc_bfd
0000c4  e7ab              B        |L27.30|
                  |L27.198|
0000c6  9819              LDR      r0,[sp,#0x64]         ;4538
0000c8  c880              LDM      r0!,{r7}              ;4538
0000ca  9019              STR      r0,[sp,#0x64]         ;4538
0000cc  2400              MOVS     r4,#0                 ;4539
0000ce  e000              B        |L27.210|
                  |L27.208|
0000d0  1c64              ADDS     r4,r4,#1              ;4539
                  |L27.210|
0000d2  5d38              LDRB     r0,[r7,r4]            ;4539
0000d4  2800              CMP      r0,#0                 ;4539
0000d6  d1fb              BNE      |L27.208|
0000d8  07a8              LSLS     r0,r5,#30             ;4540
0000da  d504              BPL      |L27.230|
0000dc  e00c              B        |L27.248|
                  |L27.222|
0000de  2120              MOVS     r1,#0x20              ;4541
0000e0  a801              ADD      r0,sp,#4              ;4541
0000e2  f7fffffe          BL       putc_bfd
                  |L27.230|
0000e6  4620              MOV      r0,r4                 ;4541
0000e8  1c64              ADDS     r4,r4,#1              ;4541
0000ea  42b0              CMP      r0,r6                 ;4541
0000ec  d3f7              BCC      |L27.222|
0000ee  e003              B        |L27.248|
                  |L27.240|
0000f0  1c7f              ADDS     r7,r7,#1              ;4543
0000f2  a801              ADD      r0,sp,#4              ;4543
0000f4  f7fffffe          BL       putc_bfd
                  |L27.248|
0000f8  7839              LDRB     r1,[r7,#0]            ;4543
0000fa  2900              CMP      r1,#0                 ;4543
0000fc  d1f8              BNE      |L27.240|
0000fe  e003              B        |L27.264|
                  |L27.256|
000100  2120              MOVS     r1,#0x20              ;4544
000102  a801              ADD      r0,sp,#4              ;4544
000104  f7fffffe          BL       putc_bfd
                  |L27.264|
000108  4620              MOV      r0,r4                 ;4544
00010a  1c64              ADDS     r4,r4,#1              ;4544
00010c  42b0              CMP      r0,r6                 ;4544
00010e  d286              BCS      |L27.30|
000110  e7f6              B        |L27.256|
                  |L27.274|
000112  e069              B        |L27.488|
                  |L27.276|
000114  9819              LDR      r0,[sp,#0x64]         ;4547
000116  f8101b04          LDRB     r1,[r0],#4            ;4547
00011a  9019              STR      r0,[sp,#0x64]         ;4547
00011c  a801              ADD      r0,sp,#4              ;4547
00011e  f7fffffe          BL       putc_bfd
                  |L27.290|
000122  e77c              B        |L27.30|
                  |L27.292|
000124  2302              MOVS     r3,#2                 ;4549
000126  e004              B        |L27.306|
                  |L27.296|
000128  2308              MOVS     r3,#8                 ;4551
00012a  e002              B        |L27.306|
                  |L27.300|
00012c  230a              MOVS     r3,#0xa               ;4554
00012e  e000              B        |L27.306|
                  |L27.304|
000130  2310              MOVS     r3,#0x10              ;4556
                  |L27.306|
;;;4559   		}
;;;4560   
;;;4561   		/* Get an argument and put it in numeral */
;;;4562   		v = (f & 4) ? (DWORD)va_arg(arp, long) : ((d == 'D') ? (DWORD)(long)va_arg(arp, int) : (DWORD)va_arg(arp, unsigned int));
000132  0768              LSLS     r0,r5,#29
000134  d503              BPL      |L27.318|
000136  9c19              LDR      r4,[sp,#0x64]
000138  cc01              LDM      r4!,{r0}
00013a  9419              STR      r4,[sp,#0x64]
00013c  e004              B        |L27.328|
                  |L27.318|
00013e  2a44              CMP      r2,#0x44
000140  d005              BEQ      |L27.334|
000142  9c19              LDR      r4,[sp,#0x64]
000144  cc01              LDM      r4!,{r0}
000146  9419              STR      r4,[sp,#0x64]
                  |L27.328|
;;;4563   		if (d == 'D' && (v & 0x80000000)) {
000148  2a44              CMP      r2,#0x44
00014a  d004              BEQ      |L27.342|
00014c  e008              B        |L27.352|
                  |L27.334|
00014e  9c19              LDR      r4,[sp,#0x64]         ;4562
000150  cc01              LDM      r4!,{r0}              ;4562
000152  9419              STR      r4,[sp,#0x64]         ;4562
000154  e7f8              B        |L27.328|
                  |L27.342|
000156  2800              CMP      r0,#0
000158  da02              BGE      |L27.352|
;;;4564   			v = 0 - v;
00015a  4240              RSBS     r0,r0,#0
;;;4565   			f |= 8;
00015c  f0450508          ORR      r5,r5,#8
                  |L27.352|
;;;4566   		}
;;;4567   		i = 0;
000160  2400              MOVS     r4,#0
                  |L27.354|
;;;4568   		do {
;;;4569   			d = (TCHAR)(v % r); v /= r;
000162  4602              MOV      r2,r0
000164  fbb0f0f3          UDIV     r0,r0,r3
000168  fb032210          MLS      r2,r3,r0,r2
00016c  b2d2              UXTB     r2,r2
;;;4570   			if (d > 9) d += (c == 'x') ? 0x27 : 0x07;
00016e  2a09              CMP      r2,#9
000170  d904              BLS      |L27.380|
000172  2978              CMP      r1,#0x78
000174  d017              BEQ      |L27.422|
000176  2707              MOVS     r7,#7
                  |L27.376|
000178  443a              ADD      r2,r2,r7
00017a  b2d2              UXTB     r2,r2
                  |L27.380|
;;;4571   			s[i++] = d + '0';
00017c  3230              ADDS     r2,r2,#0x30
00017e  4627              MOV      r7,r4
000180  1c64              ADDS     r4,r4,#1
000182  f8082007          STRB     r2,[r8,r7]
;;;4572   		} while (v && i < sizeof s / sizeof s[0]);
000186  b108              CBZ      r0,|L27.396|
000188  2c10              CMP      r4,#0x10
00018a  d3ea              BCC      |L27.354|
                  |L27.396|
;;;4573   		if (f & 8) s[i++] = '-';
00018c  0728              LSLS     r0,r5,#28
00018e  d504              BPL      |L27.410|
000190  222d              MOVS     r2,#0x2d
000192  4620              MOV      r0,r4
000194  1c64              ADDS     r4,r4,#1
000196  f8082000          STRB     r2,[r8,r0]
                  |L27.410|
;;;4574   		j = i; d = (f & 1) ? '0' : ' ';
00019a  4627              MOV      r7,r4
00019c  07e8              LSLS     r0,r5,#31
00019e  d004              BEQ      |L27.426|
0001a0  f04f0a30          MOV      r10,#0x30
0001a4  e008              B        |L27.440|
                  |L27.422|
0001a6  2727              MOVS     r7,#0x27              ;4570
0001a8  e7e6              B        |L27.376|
                  |L27.426|
0001aa  f04f0a20          MOV      r10,#0x20
0001ae  e003              B        |L27.440|
                  |L27.432|
;;;4575   		while (!(f & 2) && j++ < w) putc_bfd(&pb, d);
0001b0  4651              MOV      r1,r10
0001b2  a801              ADD      r0,sp,#4
0001b4  f7fffffe          BL       putc_bfd
                  |L27.440|
0001b8  07a8              LSLS     r0,r5,#30
0001ba  d403              BMI      |L27.452|
0001bc  4638              MOV      r0,r7
0001be  1c7f              ADDS     r7,r7,#1
0001c0  42b0              CMP      r0,r6
0001c2  d3f5              BCC      |L27.432|
                  |L27.452|
;;;4576   		do putc_bfd(&pb, s[--i]); while (i);
0001c4  1e64              SUBS     r4,r4,#1
0001c6  a801              ADD      r0,sp,#4
0001c8  f8181004          LDRB     r1,[r8,r4]
0001cc  f7fffffe          BL       putc_bfd
0001d0  2c00              CMP      r4,#0
0001d2  d1f7              BNE      |L27.452|
0001d4  e003              B        |L27.478|
                  |L27.470|
;;;4577   		while (j++ < w) putc_bfd(&pb, d);
0001d6  4651              MOV      r1,r10
0001d8  a801              ADD      r0,sp,#4
0001da  f7fffffe          BL       putc_bfd
                  |L27.478|
0001de  4638              MOV      r0,r7
0001e0  1c7f              ADDS     r7,r7,#1
0001e2  42b0              CMP      r0,r6
0001e4  d29d              BCS      |L27.290|
0001e6  e7f6              B        |L27.470|
                  |L27.488|
;;;4578   	}
;;;4579   
;;;4580   	va_end(arp);
0001e8  f8cd9064          STR      r9,[sp,#0x64]
;;;4581   
;;;4582   	if (   pb.idx >= 0		/* Flush buffered characters to the file */
0001ec  9802              LDR      r0,[sp,#8]
0001ee  2800              CMP      r0,#0
0001f0  db10              BLT      |L27.532|
;;;4583   		&& f_write(pb.fp, pb.buf, (UINT)pb.idx, &nw) == FR_OK
0001f2  e9dd0201          LDRD     r0,r2,[sp,#4]
0001f6  ab18              ADD      r3,sp,#0x60
0001f8  a904              ADD      r1,sp,#0x10
0001fa  f7fffffe          BL       f_write
0001fe  b948              CBNZ     r0,|L27.532|
;;;4584   		&& (UINT)pb.idx == nw) return pb.nchr;
000200  9918              LDR      r1,[sp,#0x60]
000202  9802              LDR      r0,[sp,#8]
000204  4288              CMP      r0,r1
000206  d105              BNE      |L27.532|
000208  9803              LDR      r0,[sp,#0xc]
                  |L27.522|
;;;4585   	return EOF;
;;;4586   }
00020a  b01a              ADD      sp,sp,#0x68
00020c  e8bd07f0          POP      {r4-r10}
000210  f85dfb14          LDR      pc,[sp],#0x14
                  |L27.532|
000214  f04f30ff          MOV      r0,#0xffffffff        ;4585
000218  e7f7              B        |L27.522|
;;;4587   
                          ENDP


                          AREA ||i.f_putc||, CODE, READONLY, ALIGN=1

                  f_putc PROC
;;;4435   
;;;4436   int f_putc (
000000  b500              PUSH     {lr}
;;;4437   	TCHAR c,	/* A character to be output */
;;;4438   	FIL* fp		/* Pointer to the file object */
;;;4439   )
;;;4440   {
000002  b095              SUB      sp,sp,#0x54
;;;4441   	putbuff pb;
;;;4442   	UINT nw;
;;;4443   
;;;4444   
;;;4445   	pb.fp = fp;			/* Initialize output buffer */
000004  9102              STR      r1,[sp,#8]
;;;4446   	pb.nchr = pb.idx = 0;
000006  2100              MOVS     r1,#0
000008  9103              STR      r1,[sp,#0xc]
00000a  9104              STR      r1,[sp,#0x10]
;;;4447   
;;;4448   	putc_bfd(&pb, c);	/* Put a character */
00000c  4601              MOV      r1,r0
00000e  a802              ADD      r0,sp,#8
000010  f7fffffe          BL       putc_bfd
;;;4449   
;;;4450   	if (   pb.idx >= 0	/* Flush buffered characters to the file */
000014  9803              LDR      r0,[sp,#0xc]
000016  2800              CMP      r0,#0
000018  db0d              BLT      |L28.54|
;;;4451   		&& f_write(pb.fp, pb.buf, (UINT)pb.idx, &nw) == FR_OK
00001a  e9dd0202          LDRD     r0,r2,[sp,#8]
00001e  ab01              ADD      r3,sp,#4
000020  a905              ADD      r1,sp,#0x14
000022  f7fffffe          BL       f_write
000026  b930              CBNZ     r0,|L28.54|
;;;4452   		&& (UINT)pb.idx == nw) return pb.nchr;
000028  9901              LDR      r1,[sp,#4]
00002a  9803              LDR      r0,[sp,#0xc]
00002c  4288              CMP      r0,r1
00002e  d102              BNE      |L28.54|
000030  9804              LDR      r0,[sp,#0x10]
                  |L28.50|
;;;4453   	return EOF;
;;;4454   }
000032  b015              ADD      sp,sp,#0x54
000034  bd00              POP      {pc}
                  |L28.54|
000036  f04f30ff          MOV      r0,#0xffffffff        ;4453
00003a  e7fa              B        |L28.50|
;;;4455   
                          ENDP


                          AREA ||i.f_puts||, CODE, READONLY, ALIGN=1

                  f_puts PROC
;;;4462   
;;;4463   int f_puts (
000000  b510              PUSH     {r4,lr}
;;;4464   	const TCHAR* str,	/* Pointer to the string to be output */
;;;4465   	FIL* fp				/* Pointer to the file object */
;;;4466   )
;;;4467   {
000002  b094              SUB      sp,sp,#0x50
000004  4604              MOV      r4,r0
;;;4468   	putbuff pb;
;;;4469   	UINT nw;
;;;4470   
;;;4471   
;;;4472   	pb.fp = fp;				/* Initialize output buffer */
000006  9101              STR      r1,[sp,#4]
;;;4473   	pb.nchr = pb.idx = 0;
000008  2000              MOVS     r0,#0
00000a  9002              STR      r0,[sp,#8]
00000c  9003              STR      r0,[sp,#0xc]
00000e  e003              B        |L29.24|
                  |L29.16|
;;;4474   
;;;4475   	while (*str)			/* Put the string */
;;;4476   		putc_bfd(&pb, *str++);
000010  1c64              ADDS     r4,r4,#1
000012  a801              ADD      r0,sp,#4
000014  f7fffffe          BL       putc_bfd
                  |L29.24|
000018  7821              LDRB     r1,[r4,#0]            ;4475
00001a  2900              CMP      r1,#0                 ;4475
00001c  d1f8              BNE      |L29.16|
;;;4477   
;;;4478   	if (   pb.idx >= 0		/* Flush buffered characters to the file */
00001e  9802              LDR      r0,[sp,#8]
000020  2800              CMP      r0,#0
000022  db0d              BLT      |L29.64|
;;;4479   		&& f_write(pb.fp, pb.buf, (UINT)pb.idx, &nw) == FR_OK
000024  e9dd0201          LDRD     r0,r2,[sp,#4]
000028  466b              MOV      r3,sp
00002a  a904              ADD      r1,sp,#0x10
00002c  f7fffffe          BL       f_write
000030  b930              CBNZ     r0,|L29.64|
;;;4480   		&& (UINT)pb.idx == nw) return pb.nchr;
000032  9900              LDR      r1,[sp,#0]
000034  9802              LDR      r0,[sp,#8]
000036  4288              CMP      r0,r1
000038  d102              BNE      |L29.64|
00003a  9803              LDR      r0,[sp,#0xc]
                  |L29.60|
;;;4481   	return EOF;
;;;4482   }
00003c  b014              ADD      sp,sp,#0x50
00003e  bd10              POP      {r4,pc}
                  |L29.64|
000040  f04f30ff          MOV      r0,#0xffffffff        ;4481
000044  e7fa              B        |L29.60|
;;;4483   
                          ENDP


                          AREA ||i.f_read||, CODE, READONLY, ALIGN=1

                  f_read PROC
;;;2548   
;;;2549   FRESULT f_read (
000000  e92d4ff8          PUSH     {r3-r11,lr}
;;;2550   	FIL* fp, 		/* Pointer to the file object */
;;;2551   	void* buff,		/* Pointer to data buffer */
;;;2552   	UINT btr,		/* Number of bytes to read */
;;;2553   	UINT* br		/* Pointer to number of bytes read */
;;;2554   )
;;;2555   {
000004  4604              MOV      r4,r0
000006  460f              MOV      r7,r1
000008  4616              MOV      r6,r2
00000a  4698              MOV      r8,r3
;;;2556   	FRESULT res;
;;;2557   	DWORD clst, sect, remain;
;;;2558   	UINT rcnt, cc;
;;;2559   	BYTE csect, *rbuff = (BYTE*)buff;
;;;2560   
;;;2561   
;;;2562   	*br = 0;	/* Clear read byte counter */
00000c  2000              MOVS     r0,#0
00000e  f8c80000          STR      r0,[r8,#0]
;;;2563   
;;;2564   	res = validate(fp);							/* Check validity */
000012  4620              MOV      r0,r4
000014  f7fffffe          BL       validate
;;;2565   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
000018  2800              CMP      r0,#0
00001a  d112              BNE      |L30.66|
;;;2566   	if (fp->err)								/* Check error */
00001c  79e0              LDRB     r0,[r4,#7]
00001e  2800              CMP      r0,#0
000020  d10f              BNE      |L30.66|
;;;2567   		LEAVE_FF(fp->fs, (FRESULT)fp->err);
;;;2568   	if (!(fp->flag & FA_READ)) 					/* Check access mode */
000022  79a0              LDRB     r0,[r4,#6]
000024  07c0              LSLS     r0,r0,#31
000026  d00b              BEQ      |L30.64|
;;;2569   		LEAVE_FF(fp->fs, FR_DENIED);
;;;2570   	remain = fp->fsize - fp->fptr;
000028  e9d41002          LDRD     r1,r0,[r4,#8]
00002c  1a40              SUBS     r0,r0,r1
;;;2571   	if (btr > remain) btr = (UINT)remain;		/* Truncate btr by remaining bytes */
00002e  4286              CMP      r6,r0
000030  d900              BLS      |L30.52|
000032  4606              MOV      r6,r0
                  |L30.52|
;;;2572   
;;;2573   	for ( ;  btr;								/* Repeat until all data read */
;;;2574   		rbuff += rcnt, fp->fptr += rcnt, *br += rcnt, btr -= rcnt) {
;;;2575   		if ((fp->fptr % SS(fp->fs)) == 0) {		/* On the sector boundary? */
;;;2576   			csect = (BYTE)(fp->fptr / SS(fp->fs) & (fp->fs->csize - 1));	/* Sector offset in the cluster */
;;;2577   			if (!csect) {						/* On the cluster boundary? */
;;;2578   				if (fp->fptr == 0) {			/* On the top of the file? */
;;;2579   					clst = fp->sclust;			/* Follow from the origin */
;;;2580   				} else {						/* Middle or end of the file */
;;;2581   #if _USE_FASTSEEK
;;;2582   					if (fp->cltbl)
;;;2583   						clst = clmt_clust(fp, fp->fptr);	/* Get cluster# from the CLMT */
;;;2584   					else
;;;2585   #endif
;;;2586   						clst = get_fat(fp->fs, fp->clust);	/* Follow cluster chain on the FAT */
;;;2587   				}
;;;2588   				if (clst < 2) ABORT(fp->fs, FR_INT_ERR);
;;;2589   				if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2590   				fp->clust = clst;				/* Update current cluster */
;;;2591   			}
;;;2592   			sect = clust2sect(fp->fs, fp->clust);	/* Get current sector */
;;;2593   			if (!sect) ABORT(fp->fs, FR_INT_ERR);
;;;2594   			sect += csect;
;;;2595   			cc = btr / SS(fp->fs);				/* When remaining bytes >= sector size, */
;;;2596   			if (cc) {							/* Read maximum contiguous sectors directly */
;;;2597   				if (csect + cc > fp->fs->csize)	/* Clip at cluster boundary */
;;;2598   					cc = fp->fs->csize - csect;
;;;2599   				if (disk_read(fp->fs->drv, rbuff, sect, cc))
;;;2600   					ABORT(fp->fs, FR_DISK_ERR);
;;;2601   #if !_FS_READONLY && _FS_MINIMIZE <= 2			/* Replace one of the read sectors with cached data if it contains a dirty sector */
;;;2602   #if _FS_TINY
;;;2603   				if (fp->fs->wflag && fp->fs->winsect - sect < cc)
;;;2604   					mem_cpy(rbuff + ((fp->fs->winsect - sect) * SS(fp->fs)), fp->fs->win, SS(fp->fs));
;;;2605   #else
;;;2606   				if ((fp->flag & FA__DIRTY) && fp->dsect - sect < cc)
;;;2607   					mem_cpy(rbuff + ((fp->dsect - sect) * SS(fp->fs)), fp->buf, SS(fp->fs));
000034  f1040028          ADD      r0,r4,#0x28
000038  f04f0901          MOV      r9,#1                 ;2589
00003c  9000              STR      r0,[sp,#0]            ;2573
00003e  e093              B        |L30.360|
                  |L30.64|
000040  2007              MOVS     r0,#7                 ;2569
                  |L30.66|
;;;2608   #endif
;;;2609   #endif
;;;2610   				rcnt = SS(fp->fs) * cc;			/* Number of bytes transferred */
;;;2611   				continue;
;;;2612   			}
;;;2613   #if !_FS_TINY
;;;2614   			if (fp->dsect != sect) {			/* Load data sector if not in cache */
;;;2615   #if !_FS_READONLY
;;;2616   				if (fp->flag & FA__DIRTY) {		/* Write-back dirty sector cache */
;;;2617   					if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;2618   						ABORT(fp->fs, FR_DISK_ERR);
;;;2619   					fp->flag &= ~FA__DIRTY;
;;;2620   				}
;;;2621   #endif
;;;2622   				if (disk_read(fp->fs->drv, fp->buf, sect, 1))	/* Fill sector cache */
;;;2623   					ABORT(fp->fs, FR_DISK_ERR);
;;;2624   			}
;;;2625   #endif
;;;2626   			fp->dsect = sect;
;;;2627   		}
;;;2628   		rcnt = SS(fp->fs) - ((UINT)fp->fptr % SS(fp->fs));	/* Get partial sector data from sector buffer */
;;;2629   		if (rcnt > btr) rcnt = btr;
;;;2630   #if _FS_TINY
;;;2631   		if (move_window(fp->fs, fp->dsect))		/* Move sector window */
;;;2632   			ABORT(fp->fs, FR_DISK_ERR);
;;;2633   		mem_cpy(rbuff, &fp->fs->win[fp->fptr % SS(fp->fs)], rcnt);	/* Pick partial sector */
;;;2634   #else
;;;2635   		mem_cpy(rbuff, &fp->buf[fp->fptr % SS(fp->fs)], rcnt);	/* Pick partial sector */
;;;2636   #endif
;;;2637   	}
;;;2638   
;;;2639   	LEAVE_FF(fp->fs, FR_OK);
;;;2640   }
000042  e8bd8ff8          POP      {r3-r11,pc}
                  |L30.70|
000046  68a1              LDR      r1,[r4,#8]            ;2575
000048  05c8              LSLS     r0,r1,#23             ;2575
00004a  d175              BNE      |L30.312|
00004c  6820              LDR      r0,[r4,#0]            ;2576
00004e  7882              LDRB     r2,[r0,#2]            ;2576
000050  1e52              SUBS     r2,r2,#1              ;2576
000052  ea022251          AND      r2,r2,r1,LSR #9       ;2576
000056  f0020aff          AND      r10,r2,#0xff          ;2576
00005a  f1ba0f00          CMP      r10,#0                ;2577
00005e  d113              BNE      |L30.136|
000060  b129              CBZ      r1,|L30.110|
000062  6a62              LDR      r2,[r4,#0x24]         ;2582
000064  b12a              CBZ      r2,|L30.114|
000066  4620              MOV      r0,r4                 ;2583
000068  f7fffffe          BL       clmt_clust
00006c  e004              B        |L30.120|
                  |L30.110|
00006e  6920              LDR      r0,[r4,#0x10]         ;2579
000070  e002              B        |L30.120|
                  |L30.114|
000072  6961              LDR      r1,[r4,#0x14]         ;2586
000074  f7fffffe          BL       get_fat
                  |L30.120|
000078  2802              CMP      r0,#2                 ;2588
00007a  d202              BCS      |L30.130|
00007c  2002              MOVS     r0,#2                 ;2588
00007e  71e0              STRB     r0,[r4,#7]            ;2588
000080  e7df              B        |L30.66|
                  |L30.130|
000082  1c41              ADDS     r1,r0,#1              ;2589
000084  d01c              BEQ      |L30.192|
000086  6160              STR      r0,[r4,#0x14]         ;2590
                  |L30.136|
000088  6961              LDR      r1,[r4,#0x14]         ;2592
00008a  6820              LDR      r0,[r4,#0]            ;2592
00008c  f7fffffe          BL       clust2sect
000090  b1d0              CBZ      r0,|L30.200|
000092  eb000b0a          ADD      r11,r0,r10            ;2594
000096  0a75              LSRS     r5,r6,#9              ;2595
000098  b355              CBZ      r5,|L30.240|
00009a  6820              LDR      r0,[r4,#0]            ;2597
00009c  eb0a0205          ADD      r2,r10,r5             ;2597
0000a0  7881              LDRB     r1,[r0,#2]            ;2597
0000a2  428a              CMP      r2,r1                 ;2597
0000a4  d901              BLS      |L30.170|
0000a6  eba1050a          SUB      r5,r1,r10             ;2598
                  |L30.170|
0000aa  7840              LDRB     r0,[r0,#1]            ;2599
0000ac  462b              MOV      r3,r5                 ;2599
0000ae  465a              MOV      r2,r11                ;2599
0000b0  4639              MOV      r1,r7                 ;2599
0000b2  f7fffffe          BL       disk_read
0000b6  b150              CBZ      r0,|L30.206|
0000b8  f8849007          STRB     r9,[r4,#7]            ;2600
0000bc  2001              MOVS     r0,#1                 ;2600
0000be  e7c0              B        |L30.66|
                  |L30.192|
0000c0  f8849007          STRB     r9,[r4,#7]            ;2589
0000c4  2001              MOVS     r0,#1                 ;2589
0000c6  e7bc              B        |L30.66|
                  |L30.200|
0000c8  2002              MOVS     r0,#2                 ;2593
0000ca  71e0              STRB     r0,[r4,#7]            ;2593
0000cc  e7b9              B        |L30.66|
                  |L30.206|
0000ce  79a0              LDRB     r0,[r4,#6]            ;2606
0000d0  0640              LSLS     r0,r0,#25             ;2606
0000d2  d50b              BPL      |L30.236|
0000d4  69a0              LDR      r0,[r4,#0x18]         ;2606
0000d6  eba0000b          SUB      r0,r0,r11             ;2606
0000da  42a8              CMP      r0,r5                 ;2606
0000dc  d206              BCS      |L30.236|
0000de  eb072040          ADD      r0,r7,r0,LSL #9       ;2607
0000e2  f44f7200          MOV      r2,#0x200             ;2607
0000e6  9900              LDR      r1,[sp,#0]            ;2607
0000e8  f7fffffe          BL       mem_cpy
                  |L30.236|
0000ec  026d              LSLS     r5,r5,#9              ;2610
0000ee  e031              B        |L30.340|
                  |L30.240|
0000f0  69a2              LDR      r2,[r4,#0x18]         ;2614
0000f2  455a              CMP      r2,r11                ;2614
0000f4  d01e              BEQ      |L30.308|
0000f6  79a0              LDRB     r0,[r4,#6]            ;2616
0000f8  0640              LSLS     r0,r0,#25             ;2616
0000fa  d50e              BPL      |L30.282|
0000fc  6820              LDR      r0,[r4,#0]            ;2617
0000fe  2301              MOVS     r3,#1                 ;2617
000100  9900              LDR      r1,[sp,#0]            ;2617
000102  7840              LDRB     r0,[r0,#1]            ;2617
000104  f7fffffe          BL       disk_write
000108  b118              CBZ      r0,|L30.274|
00010a  f8849007          STRB     r9,[r4,#7]            ;2618
00010e  2001              MOVS     r0,#1                 ;2618
000110  e797              B        |L30.66|
                  |L30.274|
000112  79a0              LDRB     r0,[r4,#6]            ;2619
000114  f0200040          BIC      r0,r0,#0x40           ;2619
000118  71a0              STRB     r0,[r4,#6]            ;2619
                  |L30.282|
00011a  6820              LDR      r0,[r4,#0]            ;2622
00011c  2301              MOVS     r3,#1                 ;2622
00011e  465a              MOV      r2,r11                ;2622
000120  7840              LDRB     r0,[r0,#1]            ;2622
000122  9900              LDR      r1,[sp,#0]            ;2622
000124  f7fffffe          BL       disk_read
000128  b120              CBZ      r0,|L30.308|
00012a  f8849007          STRB     r9,[r4,#7]            ;2623
00012e  2001              MOVS     r0,#1                 ;2623
000130  e787              B        |L30.66|
000132  e001              B        |L30.312|
                  |L30.308|
000134  f8c4b018          STR      r11,[r4,#0x18]        ;2626
                  |L30.312|
000138  8920              LDRH     r0,[r4,#8]            ;2628
00013a  f3c00008          UBFX     r0,r0,#0,#9           ;2628
00013e  f5c07500          RSB      r5,r0,#0x200          ;2628
000142  42b5              CMP      r5,r6                 ;2629
000144  d900              BLS      |L30.328|
000146  4635              MOV      r5,r6                 ;2629
                  |L30.328|
000148  1901              ADDS     r1,r0,r4              ;2635
00014a  3128              ADDS     r1,r1,#0x28           ;2635
00014c  462a              MOV      r2,r5                 ;2635
00014e  4638              MOV      r0,r7                 ;2635
000150  f7fffffe          BL       mem_cpy
                  |L30.340|
000154  442f              ADD      r7,r7,r5              ;2574
000156  68a0              LDR      r0,[r4,#8]            ;2574
000158  4428              ADD      r0,r0,r5              ;2574
00015a  60a0              STR      r0,[r4,#8]            ;2574
00015c  f8d80000          LDR      r0,[r8,#0]            ;2574
000160  4428              ADD      r0,r0,r5              ;2574
000162  f8c80000          STR      r0,[r8,#0]            ;2574
000166  1b76              SUBS     r6,r6,r5              ;2574
                  |L30.360|
000168  2e00              CMP      r6,#0                 ;2573
00016a  f47faf6c          BNE      |L30.70|
00016e  2000              MOVS     r0,#0                 ;2639
000170  e767              B        |L30.66|
;;;2641   
                          ENDP


                          AREA ||i.f_readdir||, CODE, READONLY, ALIGN=1

                  f_readdir PROC
;;;3240   
;;;3241   FRESULT f_readdir (
000000  e92d43fe          PUSH     {r1-r9,lr}
;;;3242   	DIR* dp,			/* Pointer to the open directory object */
;;;3243   	FILINFO* fno		/* Pointer to file information to return */
;;;3244   )
;;;3245   {
000004  4605              MOV      r5,r0
000006  460f              MOV      r7,r1
;;;3246   	FRESULT res;
;;;3247   	DEF_NAMEBUF;
;;;3248   
;;;3249   
;;;3250   	res = validate(dp);						/* Check validity of the object */
000008  4628              MOV      r0,r5
00000a  f7fffffe          BL       validate
00000e  4604              MOV      r4,r0
;;;3251   	if (res == FR_OK) {
000010  bb8c              CBNZ     r4,|L31.118|
;;;3252   		if (!fno) {
000012  b197              CBZ      r7,|L31.58|
;;;3253   			res = dir_sdi(dp, 0);			/* Rewind the directory object */
;;;3254   		} else {
;;;3255   			INIT_BUF(*dp);
000014  f44f7000          MOV      r0,#0x200
000018  f7fffffe          BL       ff_memalloc
00001c  4606              MOV      r6,r0
00001e  b196              CBZ      r6,|L31.70|
000020  61ee              STR      r6,[r5,#0x1c]
000022  f8c5d018          STR      sp,[r5,#0x18]
;;;3256   			res = dir_read(dp, 0);			/* Read an item */
000026  2100              MOVS     r1,#0
000028  4628              MOV      r0,r5
00002a  f7fffffe          BL       dir_read
00002e  4604              MOV      r4,r0
;;;3257   			if (res == FR_NO_FILE) {		/* Reached end of directory */
000030  f04f0800          MOV      r8,#0
000034  2c04              CMP      r4,#4
000036  d009              BEQ      |L31.76|
000038  e00b              B        |L31.82|
                  |L31.58|
00003a  2100              MOVS     r1,#0                 ;3253
00003c  4628              MOV      r0,r5                 ;3253
00003e  f7fffffe          BL       dir_sdi
000042  4604              MOV      r4,r0                 ;3253
000044  e017              B        |L31.118|
                  |L31.70|
000046  2011              MOVS     r0,#0x11              ;3255
                  |L31.72|
;;;3258   				dp->sect = 0;
;;;3259   				res = FR_OK;
;;;3260   			}
;;;3261   			if (res == FR_OK) {				/* A valid entry is found */
;;;3262   				get_fileinfo(dp, fno);		/* Get the object information */
;;;3263   				res = dir_next(dp, 0);		/* Increment index for next */
;;;3264   				if (res == FR_NO_FILE) {
;;;3265   					dp->sect = 0;
;;;3266   					res = FR_OK;
;;;3267   				}
;;;3268   			}
;;;3269   			FREE_BUF();
;;;3270   		}
;;;3271   	}
;;;3272   
;;;3273   	LEAVE_FF(dp->fs, res);
;;;3274   }
000048  e8bd83fe          POP      {r1-r9,pc}
                  |L31.76|
00004c  f8c58010          STR      r8,[r5,#0x10]         ;3258
000050  2400              MOVS     r4,#0                 ;3259
                  |L31.82|
000052  b96c              CBNZ     r4,|L31.112|
000054  4639              MOV      r1,r7                 ;3262
000056  4628              MOV      r0,r5                 ;3262
000058  f7fffffe          BL       get_fileinfo
00005c  2100              MOVS     r1,#0                 ;3263
00005e  4628              MOV      r0,r5                 ;3263
000060  f7fffffe          BL       dir_next
000064  4604              MOV      r4,r0                 ;3263
000066  2c04              CMP      r4,#4                 ;3264
000068  d102              BNE      |L31.112|
00006a  f8c58010          STR      r8,[r5,#0x10]         ;3265
00006e  2400              MOVS     r4,#0                 ;3266
                  |L31.112|
000070  4630              MOV      r0,r6                 ;3269
000072  f7fffffe          BL       ff_memfree
                  |L31.118|
000076  4620              MOV      r0,r4                 ;3273
000078  e7e6              B        |L31.72|
;;;3275   
                          ENDP


                          AREA ||i.f_rename||, CODE, READONLY, ALIGN=1

                  f_rename PROC
;;;3669   
;;;3670   FRESULT f_rename (
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;3671   	const TCHAR* path_old,	/* Pointer to the object to be renamed */
;;;3672   	const TCHAR* path_new	/* Pointer to the new name */
;;;3673   )
;;;3674   {
000002  b09b              SUB      sp,sp,#0x6c
;;;3675   	FRESULT res;
;;;3676   	DIR djo, djn;
;;;3677   	BYTE buf[21], *dir;
;;;3678   	DWORD dw;
;;;3679   	DEF_NAMEBUF;
;;;3680   
;;;3681   
;;;3682   	/* Get logical drive number of the source object */
;;;3683   	res = find_volume(&djo.fs, &path_old, 1);
000004  2201              MOVS     r2,#1
000006  a91b              ADD      r1,sp,#0x6c
000008  a812              ADD      r0,sp,#0x48
00000a  f7fffffe          BL       find_volume
00000e  4604              MOV      r4,r0
;;;3684   	if (res == FR_OK) {
000010  2c00              CMP      r4,#0
000012  d172              BNE      |L32.250|
;;;3685   		djn.fs = djo.fs;
000014  9812              LDR      r0,[sp,#0x48]
000016  9009              STR      r0,[sp,#0x24]
;;;3686   		INIT_BUF(djo);
000018  f44f7000          MOV      r0,#0x200
00001c  f7fffffe          BL       ff_memalloc
000020  4606              MOV      r6,r0
000022  b14e              CBZ      r6,|L32.56|
000024  9619              STR      r6,[sp,#0x64]
000026  f8cdd060          STR      sp,[sp,#0x60]
;;;3687   		res = follow_path(&djo, path_old);		/* Check old object */
00002a  a812              ADD      r0,sp,#0x48
00002c  991b              LDR      r1,[sp,#0x6c]
00002e  f7fffffe          BL       follow_path
000032  4604              MOV      r4,r0
;;;3688   		if (_FS_RPATH && res == FR_OK && (djo.fn[NS] & NS_DOT))
;;;3689   			res = FR_INVALID_NAME;
;;;3690   #if _FS_LOCK
;;;3691   		if (res == FR_OK) res = chk_lock(&djo, 2);
;;;3692   #endif
;;;3693   		if (res == FR_OK) {						/* Old object is found */
000034  b11c              CBZ      r4,|L32.62|
000036  e070              B        |L32.282|
                  |L32.56|
000038  2011              MOVS     r0,#0x11              ;3686
                  |L32.58|
;;;3694   			if (!djo.dir) {						/* Is root dir? */
;;;3695   				res = FR_NO_FILE;
;;;3696   			} else {
;;;3697   				mem_cpy(buf, djo.dir+DIR_Attr, 21);		/* Save the object information except name */
;;;3698   				mem_cpy(&djn, &djo, sizeof (DIR));		/* Duplicate the directory object */
;;;3699   				if (get_ldnumber(&path_new) >= 0)		/* Snip drive number off and ignore it */
;;;3700   					res = follow_path(&djn, path_new);	/* and check if new object is exist */
;;;3701   				else
;;;3702   					res = FR_INVALID_DRIVE;
;;;3703   				if (res == FR_OK) res = FR_EXIST;		/* The new object name is already existing */
;;;3704   				if (res == FR_NO_FILE) { 				/* Is it a valid path and no name collision? */
;;;3705   /* Start critical section that any interruption can cause a cross-link */
;;;3706   					res = dir_register(&djn);			/* Register the new entry */
;;;3707   					if (res == FR_OK) {
;;;3708   						dir = djn.dir;					/* Copy object information except name */
;;;3709   						mem_cpy(dir+13, buf+2, 19);
;;;3710   						dir[DIR_Attr] = buf[0] | AM_ARC;
;;;3711   						djo.fs->wflag = 1;
;;;3712   						if (djo.sclust != djn.sclust && (dir[DIR_Attr] & AM_DIR)) {		/* Update .. entry in the directory if needed */
;;;3713   							dw = clust2sect(djo.fs, ld_clust(djo.fs, dir));
;;;3714   							if (!dw) {
;;;3715   								res = FR_INT_ERR;
;;;3716   							} else {
;;;3717   								res = move_window(djo.fs, dw);
;;;3718   								dir = djo.fs->win+SZ_DIR;	/* .. entry */
;;;3719   								if (res == FR_OK && dir[1] == '.') {
;;;3720   									dw = (djo.fs->fs_type == FS_FAT32 && djn.sclust == djo.fs->dirbase) ? 0 : djn.sclust;
;;;3721   									st_clust(dir, dw);
;;;3722   									djo.fs->wflag = 1;
;;;3723   								}
;;;3724   							}
;;;3725   						}
;;;3726   						if (res == FR_OK) {
;;;3727   							res = dir_remove(&djo);		/* Remove old entry */
;;;3728   							if (res == FR_OK)
;;;3729   								res = sync_fs(djo.fs);
;;;3730   						}
;;;3731   					}
;;;3732   /* End critical section */
;;;3733   				}
;;;3734   			}
;;;3735   		}
;;;3736   		FREE_BUF();
;;;3737   	}
;;;3738   
;;;3739   	LEAVE_FF(djo.fs, res);
;;;3740   }
00003a  b01d              ADD      sp,sp,#0x74
00003c  bdf0              POP      {r4-r7,pc}
                  |L32.62|
00003e  9817              LDR      r0,[sp,#0x5c]         ;3694
000040  b1a8              CBZ      r0,|L32.110|
000042  9917              LDR      r1,[sp,#0x5c]         ;3697
000044  2215              MOVS     r2,#0x15              ;3697
000046  310b              ADDS     r1,r1,#0xb            ;3697
000048  a803              ADD      r0,sp,#0xc            ;3697
00004a  f7fffffe          BL       mem_cpy
00004e  2224              MOVS     r2,#0x24              ;3698
000050  a912              ADD      r1,sp,#0x48           ;3698
000052  a809              ADD      r0,sp,#0x24           ;3698
000054  f7fffffe          BL       mem_cpy
000058  a81c              ADD      r0,sp,#0x70           ;3699
00005a  f7fffffe          BL       get_ldnumber
00005e  2800              CMP      r0,#0                 ;3699
000060  db07              BLT      |L32.114|
000062  a809              ADD      r0,sp,#0x24           ;3700
000064  991c              LDR      r1,[sp,#0x70]         ;3700
000066  f7fffffe          BL       follow_path
00006a  4604              MOV      r4,r0                 ;3700
00006c  e002              B        |L32.116|
                  |L32.110|
00006e  2404              MOVS     r4,#4                 ;3695
000070  e053              B        |L32.282|
                  |L32.114|
000072  240b              MOVS     r4,#0xb               ;3702
                  |L32.116|
000074  b904              CBNZ     r4,|L32.120|
000076  2408              MOVS     r4,#8                 ;3703
                  |L32.120|
000078  2c04              CMP      r4,#4                 ;3704
00007a  d14e              BNE      |L32.282|
00007c  a809              ADD      r0,sp,#0x24           ;3706
00007e  f7fffffe          BL       dir_register
000082  4604              MOV      r4,r0                 ;3706
000084  bbc4              CBNZ     r4,|L32.248|
000086  9d0e              LDR      r5,[sp,#0x38]         ;3708
000088  2213              MOVS     r2,#0x13              ;3709
00008a  f10d010e          ADD      r1,sp,#0xe            ;3709
00008e  f105000d          ADD      r0,r5,#0xd            ;3709
000092  f7fffffe          BL       mem_cpy
000096  f89d000c          LDRB     r0,[sp,#0xc]          ;3710
00009a  f0400020          ORR      r0,r0,#0x20           ;3710
00009e  72e8              STRB     r0,[r5,#0xb]          ;3710
0000a0  9812              LDR      r0,[sp,#0x48]         ;3711
0000a2  2701              MOVS     r7,#1                 ;3711
0000a4  7107              STRB     r7,[r0,#4]            ;3711
0000a6  990b              LDR      r1,[sp,#0x2c]         ;3712
0000a8  9814              LDR      r0,[sp,#0x50]         ;3712
0000aa  4288              CMP      r0,r1                 ;3712
0000ac  d02b              BEQ      |L32.262|
0000ae  7ae8              LDRB     r0,[r5,#0xb]          ;3712
0000b0  06c0              LSLS     r0,r0,#27             ;3712
0000b2  d528              BPL      |L32.262|
0000b4  4629              MOV      r1,r5                 ;3713
0000b6  9812              LDR      r0,[sp,#0x48]         ;3713
0000b8  f7fffffe          BL       ld_clust
0000bc  4601              MOV      r1,r0                 ;3713
0000be  9812              LDR      r0,[sp,#0x48]         ;3713
0000c0  f7fffffe          BL       clust2sect
0000c4  4601              MOV      r1,r0                 ;3713
0000c6  b139              CBZ      r1,|L32.216|
0000c8  9812              LDR      r0,[sp,#0x48]         ;3717
0000ca  f7fffffe          BL       move_window
0000ce  4604              MOV      r4,r0                 ;3717
0000d0  9812              LDR      r0,[sp,#0x48]         ;3718
0000d2  3050              ADDS     r0,r0,#0x50           ;3718
0000d4  b114              CBZ      r4,|L32.220|
0000d6  e016              B        |L32.262|
                  |L32.216|
0000d8  2402              MOVS     r4,#2                 ;3715
0000da  e014              B        |L32.262|
                  |L32.220|
0000dc  7841              LDRB     r1,[r0,#1]            ;3719
0000de  292e              CMP      r1,#0x2e              ;3719
0000e0  d111              BNE      |L32.262|
0000e2  9912              LDR      r1,[sp,#0x48]         ;3720
0000e4  7809              LDRB     r1,[r1,#0]            ;3720
0000e6  2903              CMP      r1,#3                 ;3720
0000e8  d108              BNE      |L32.252|
0000ea  9a12              LDR      r2,[sp,#0x48]         ;3720
0000ec  990b              LDR      r1,[sp,#0x2c]         ;3720
0000ee  6a52              LDR      r2,[r2,#0x24]         ;3720
0000f0  4291              CMP      r1,r2                 ;3720
0000f2  d103              BNE      |L32.252|
0000f4  2100              MOVS     r1,#0                 ;3720
0000f6  e002              B        |L32.254|
                  |L32.248|
0000f8  e00f              B        |L32.282|
                  |L32.250|
0000fa  e011              B        |L32.288|
                  |L32.252|
0000fc  990b              LDR      r1,[sp,#0x2c]         ;3720
                  |L32.254|
0000fe  f7fffffe          BL       st_clust
000102  9812              LDR      r0,[sp,#0x48]         ;3722
000104  7107              STRB     r7,[r0,#4]            ;3722
                  |L32.262|
000106  b944              CBNZ     r4,|L32.282|
000108  a812              ADD      r0,sp,#0x48           ;3727
00010a  f7fffffe          BL       dir_remove
00010e  4604              MOV      r4,r0                 ;3727
000110  b91c              CBNZ     r4,|L32.282|
000112  9812              LDR      r0,[sp,#0x48]         ;3729
000114  f7fffffe          BL       sync_fs
000118  4604              MOV      r4,r0                 ;3729
                  |L32.282|
00011a  4630              MOV      r0,r6                 ;3736
00011c  f7fffffe          BL       ff_memfree
                  |L32.288|
000120  4620              MOV      r0,r4                 ;3739
000122  e78a              B        |L32.58|
;;;3741   
                          ENDP


                          AREA ||i.f_setlabel||, CODE, READONLY, ALIGN=2

                  f_setlabel PROC
;;;3818   
;;;3819   FRESULT f_setlabel (
000000  e92d43f1          PUSH     {r0,r4-r9,lr}
;;;3820   	const TCHAR* label	/* Pointer to the volume label to set */
;;;3821   )
;;;3822   {
000004  b08c              SUB      sp,sp,#0x30
;;;3823   	FRESULT res;
;;;3824   	DIR dj;
;;;3825   	BYTE vn[11];
;;;3826   	UINT i, j, sl;
;;;3827   	WCHAR w;
;;;3828   	DWORD tm;
;;;3829   
;;;3830   
;;;3831   	/* Get logical drive number */
;;;3832   	res = find_volume(&dj.fs, &label, 1);
000006  2201              MOVS     r2,#1
000008  a90c              ADD      r1,sp,#0x30
00000a  a803              ADD      r0,sp,#0xc
00000c  f7fffffe          BL       find_volume
;;;3833   	if (res) LEAVE_FF(dj.fs, res);
000010  2800              CMP      r0,#0
000012  d149              BNE      |L33.168|
;;;3834   
;;;3835   	/* Create a volume label in directory form */
;;;3836   	vn[0] = 0;
000014  4681              MOV      r9,r0
000016  f88d9000          STRB     r9,[sp,#0]
;;;3837   	for (sl = 0; label[sl]; sl++) ;				/* Get name length */
00001a  2500              MOVS     r5,#0
00001c  980c              LDR      r0,[sp,#0x30]
00001e  e000              B        |L33.34|
                  |L33.32|
000020  1c6d              ADDS     r5,r5,#1
                  |L33.34|
000022  5d41              LDRB     r1,[r0,r5]
000024  2900              CMP      r1,#0
000026  d1fb              BNE      |L33.32|
000028  e000              B        |L33.44|
                  |L33.42|
;;;3838   	for ( ; sl && label[sl-1] == ' '; sl--) ;	/* Remove trailing spaces */
00002a  1e6d              SUBS     r5,r5,#1
                  |L33.44|
00002c  b125              CBZ      r5,|L33.56|
00002e  1941              ADDS     r1,r0,r5
000030  f8111c01          LDRB     r1,[r1,#-1]
000034  2920              CMP      r1,#0x20
000036  d0f8              BEQ      |L33.42|
                  |L33.56|
;;;3839   	if (sl) {	/* Create volume label in directory form */
000038  b38d              CBZ      r5,|L33.158|
;;;3840   		i = j = 0;
00003a  2400              MOVS     r4,#0
00003c  4626              MOV      r6,r4
00003e  46e8              MOV      r8,sp                 ;3825
                  |L33.64|
;;;3841   		do {
;;;3842   #if _USE_LFN && _LFN_UNICODE
;;;3843   			w = ff_convert(ff_wtoupper(label[i++]), 0);
;;;3844   #else
;;;3845   			w = (BYTE)label[i++];
000040  990c              LDR      r1,[sp,#0x30]
000042  4630              MOV      r0,r6
000044  1c76              ADDS     r6,r6,#1
000046  5c08              LDRB     r0,[r1,r0]
;;;3846   			if (IsDBCS1(w))
000048  f1a00281          SUB      r2,r0,#0x81
00004c  2a7d              CMP      r2,#0x7d
00004e  d813              BHI      |L33.120|
;;;3847   				w = (j < 10 && i < sl && IsDBCS2(label[i])) ? w << 8 | (BYTE)label[i++] : 0;
000050  2c0a              CMP      r4,#0xa
000052  d20f              BCS      |L33.116|
000054  42ae              CMP      r6,r5
000056  d20d              BCS      |L33.116|
000058  5d8a              LDRB     r2,[r1,r6]
00005a  f1a20340          SUB      r3,r2,#0x40
00005e  2b3e              CMP      r3,#0x3e
000060  d902              BLS      |L33.104|
000062  3a80              SUBS     r2,r2,#0x80
000064  2a7e              CMP      r2,#0x7e
000066  d805              BHI      |L33.116|
                  |L33.104|
000068  4632              MOV      r2,r6
00006a  1c76              ADDS     r6,r6,#1
00006c  5c89              LDRB     r1,[r1,r2]
00006e  ea412000          ORR      r0,r1,r0,LSL #8
000072  e000              B        |L33.118|
                  |L33.116|
000074  2000              MOVS     r0,#0
                  |L33.118|
000076  b280              UXTH     r0,r0
                  |L33.120|
;;;3848   #if _USE_LFN
;;;3849   			w = ff_convert(ff_wtoupper(ff_convert(w, 1)), 0);
000078  2101              MOVS     r1,#1
00007a  f7fffffe          BL       ff_convert
00007e  f7fffffe          BL       ff_wtoupper
000082  2100              MOVS     r1,#0
000084  f7fffffe          BL       ff_convert
000088  4607              MOV      r7,r0
;;;3850   #else
;;;3851   			if (IsLower(w)) w -= 0x20;			/* To upper ASCII characters */
;;;3852   #ifdef _EXCVT
;;;3853   			if (w >= 0x80) w = ExCvt[w - 0x80];	/* To upper extended characters (SBCS cfg) */
;;;3854   #else
;;;3855   			if (!_DF1S && w >= 0x80) w = 0;		/* Reject extended characters (ASCII cfg) */
;;;3856   #endif
;;;3857   #endif
;;;3858   #endif
;;;3859   			if (!w || chk_chr("\"*+,.:;<=>\?[]|\x7F", w) || j >= (UINT)((w >= 0x100) ? 10 : 11)) /* Reject invalid characters for volume label */
00008a  b167              CBZ      r7,|L33.166|
00008c  4639              MOV      r1,r7
00008e  a03f              ADR      r0,|L33.396|
000090  f7fffffe          BL       chk_chr
000094  b938              CBNZ     r0,|L33.166|
000096  2fff              CMP      r7,#0xff
000098  d902              BLS      |L33.160|
00009a  200a              MOVS     r0,#0xa
00009c  e001              B        |L33.162|
                  |L33.158|
00009e  e01b              B        |L33.216|
                  |L33.160|
0000a0  200b              MOVS     r0,#0xb
                  |L33.162|
0000a2  42a0              CMP      r0,r4
0000a4  d803              BHI      |L33.174|
                  |L33.166|
;;;3860   				LEAVE_FF(dj.fs, FR_INVALID_NAME);
0000a6  2006              MOVS     r0,#6
                  |L33.168|
;;;3861   			if (w >= 0x100) vn[j++] = (BYTE)(w >> 8);
;;;3862   			vn[j++] = (BYTE)w;
;;;3863   		} while (i < sl);
;;;3864   		while (j < 11) vn[j++] = ' ';
;;;3865   	}
;;;3866   
;;;3867   	/* Set volume label */
;;;3868   	dj.sclust = 0;					/* Open root directory */
;;;3869   	res = dir_sdi(&dj, 0);
;;;3870   	if (res == FR_OK) {
;;;3871   		res = dir_read(&dj, 1);		/* Get an entry with AM_VOL */
;;;3872   		if (res == FR_OK) {			/* A volume label is found */
;;;3873   			if (vn[0]) {
;;;3874   				mem_cpy(dj.dir, vn, 11);	/* Change the volume label name */
;;;3875   				tm = get_fattime();
;;;3876   				ST_DWORD(dj.dir+DIR_WrtTime, tm);
;;;3877   			} else {
;;;3878   				dj.dir[0] = DDE;			/* Remove the volume label */
;;;3879   			}
;;;3880   			dj.fs->wflag = 1;
;;;3881   			res = sync_fs(dj.fs);
;;;3882   		} else {					/* No volume label is found or error */
;;;3883   			if (res == FR_NO_FILE) {
;;;3884   				res = FR_OK;
;;;3885   				if (vn[0]) {				/* Create volume label as new */
;;;3886   					res = dir_alloc(&dj, 1);	/* Allocate an entry for volume label */
;;;3887   					if (res == FR_OK) {
;;;3888   						mem_set(dj.dir, 0, SZ_DIR);	/* Set volume label */
;;;3889   						mem_cpy(dj.dir, vn, 11);
;;;3890   						dj.dir[DIR_Attr] = AM_VOL;
;;;3891   						tm = get_fattime();
;;;3892   						ST_DWORD(dj.dir+DIR_WrtTime, tm);
;;;3893   						dj.fs->wflag = 1;
;;;3894   						res = sync_fs(dj.fs);
;;;3895   					}
;;;3896   				}
;;;3897   			}
;;;3898   		}
;;;3899   	}
;;;3900   
;;;3901   	LEAVE_FF(dj.fs, res);
;;;3902   }
0000a8  b00d              ADD      sp,sp,#0x34
0000aa  e8bd83f0          POP      {r4-r9,pc}
                  |L33.174|
0000ae  2fff              CMP      r7,#0xff              ;3861
0000b0  d904              BLS      |L33.188|
0000b2  0a39              LSRS     r1,r7,#8              ;3861
0000b4  4620              MOV      r0,r4                 ;3861
0000b6  1c64              ADDS     r4,r4,#1              ;3861
0000b8  f8081000          STRB     r1,[r8,r0]            ;3861
                  |L33.188|
0000bc  4620              MOV      r0,r4                 ;3862
0000be  1c64              ADDS     r4,r4,#1              ;3862
0000c0  f8087000          STRB     r7,[r8,r0]            ;3862
0000c4  42ae              CMP      r6,r5                 ;3863
0000c6  d3bb              BCC      |L33.64|
0000c8  2020              MOVS     r0,#0x20              ;3864
0000ca  e003              B        |L33.212|
                  |L33.204|
0000cc  4621              MOV      r1,r4                 ;3864
0000ce  1c64              ADDS     r4,r4,#1              ;3864
0000d0  f8080001          STRB     r0,[r8,r1]            ;3864
                  |L33.212|
0000d4  2c0b              CMP      r4,#0xb               ;3864
0000d6  d3f9              BCC      |L33.204|
                  |L33.216|
0000d8  f8cd9014          STR      r9,[sp,#0x14]         ;3868
0000dc  2100              MOVS     r1,#0                 ;3869
0000de  a803              ADD      r0,sp,#0xc            ;3869
0000e0  f7fffffe          BL       dir_sdi
0000e4  2800              CMP      r0,#0                 ;3870
0000e6  d1df              BNE      |L33.168|
0000e8  2101              MOVS     r1,#1                 ;3871
0000ea  a803              ADD      r0,sp,#0xc            ;3871
0000ec  f7fffffe          BL       dir_read
0000f0  2401              MOVS     r4,#1                 ;3832
0000f2  b360              CBZ      r0,|L33.334|
0000f4  2804              CMP      r0,#4                 ;3883
0000f6  d1d7              BNE      |L33.168|
0000f8  2000              MOVS     r0,#0                 ;3884
0000fa  f89d1000          LDRB     r1,[sp,#0]            ;3885
0000fe  2900              CMP      r1,#0                 ;3885
000100  d0d2              BEQ      |L33.168|
000102  2101              MOVS     r1,#1                 ;3886
000104  a803              ADD      r0,sp,#0xc            ;3886
000106  f7fffffe          BL       dir_alloc
00010a  2800              CMP      r0,#0                 ;3887
00010c  d1cc              BNE      |L33.168|
00010e  2220              MOVS     r2,#0x20              ;3888
000110  2100              MOVS     r1,#0                 ;3888
000112  9808              LDR      r0,[sp,#0x20]         ;3888
000114  f7fffffe          BL       mem_set
000118  220b              MOVS     r2,#0xb               ;3889
00011a  4669              MOV      r1,sp                 ;3889
00011c  9808              LDR      r0,[sp,#0x20]         ;3889
00011e  f7fffffe          BL       mem_cpy
000122  9908              LDR      r1,[sp,#0x20]         ;3890
000124  2008              MOVS     r0,#8                 ;3890
000126  72c8              STRB     r0,[r1,#0xb]          ;3890
000128  f7fffffe          BL       get_fattime
00012c  9908              LDR      r1,[sp,#0x20]         ;3892
00012e  7588              STRB     r0,[r1,#0x16]         ;3892
000130  9a08              LDR      r2,[sp,#0x20]         ;3892
000132  0a01              LSRS     r1,r0,#8              ;3892
000134  75d1              STRB     r1,[r2,#0x17]         ;3892
000136  9a08              LDR      r2,[sp,#0x20]         ;3892
000138  0c01              LSRS     r1,r0,#16             ;3892
00013a  7611              STRB     r1,[r2,#0x18]         ;3892
00013c  9908              LDR      r1,[sp,#0x20]         ;3892
00013e  0e00              LSRS     r0,r0,#24             ;3892
000140  7648              STRB     r0,[r1,#0x19]         ;3892
000142  9803              LDR      r0,[sp,#0xc]          ;3893
000144  7104              STRB     r4,[r0,#4]            ;3893
000146  9803              LDR      r0,[sp,#0xc]          ;3894
000148  f7fffffe          BL       sync_fs
00014c  e7ac              B        |L33.168|
                  |L33.334|
00014e  f89d0000          LDRB     r0,[sp,#0]            ;3873
000152  b190              CBZ      r0,|L33.378|
000154  220b              MOVS     r2,#0xb               ;3874
000156  4669              MOV      r1,sp                 ;3874
000158  9808              LDR      r0,[sp,#0x20]         ;3874
00015a  f7fffffe          BL       mem_cpy
00015e  f7fffffe          BL       get_fattime
000162  9908              LDR      r1,[sp,#0x20]         ;3876
000164  7588              STRB     r0,[r1,#0x16]         ;3876
000166  9a08              LDR      r2,[sp,#0x20]         ;3876
000168  0a01              LSRS     r1,r0,#8              ;3876
00016a  75d1              STRB     r1,[r2,#0x17]         ;3876
00016c  9a08              LDR      r2,[sp,#0x20]         ;3876
00016e  0c01              LSRS     r1,r0,#16             ;3876
000170  7611              STRB     r1,[r2,#0x18]         ;3876
000172  9908              LDR      r1,[sp,#0x20]         ;3876
000174  0e00              LSRS     r0,r0,#24             ;3876
000176  7648              STRB     r0,[r1,#0x19]         ;3876
000178  e002              B        |L33.384|
                  |L33.378|
00017a  9908              LDR      r1,[sp,#0x20]         ;3878
00017c  20e5              MOVS     r0,#0xe5              ;3878
00017e  7008              STRB     r0,[r1,#0]            ;3878
                  |L33.384|
000180  9803              LDR      r0,[sp,#0xc]          ;3880
000182  7104              STRB     r4,[r0,#4]            ;3880
000184  9803              LDR      r0,[sp,#0xc]          ;3881
000186  f7fffffe          BL       sync_fs
00018a  e78d              B        |L33.168|
;;;3903   
                          ENDP

                  |L33.396|
00018c  222a2b2c          DCB      """*+,.:;<=>?[]|",127,0
000190  2e3a3b3c
000194  3d3e3f5b
000198  5d7c7f00

                          AREA ||i.f_stat||, CODE, READONLY, ALIGN=1

                  f_stat PROC
;;;3282   
;;;3283   FRESULT f_stat (
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;3284   	const TCHAR* path,	/* Pointer to the file path */
;;;3285   	FILINFO* fno		/* Pointer to file information to return */
;;;3286   )
;;;3287   {
000002  b08c              SUB      sp,sp,#0x30
000004  460e              MOV      r6,r1
;;;3288   	FRESULT res;
;;;3289   	DIR dj;
;;;3290   	DEF_NAMEBUF;
;;;3291   
;;;3292   
;;;3293   	/* Get logical drive number */
;;;3294   	res = find_volume(&dj.fs, &path, 0);
000006  2200              MOVS     r2,#0
000008  a90c              ADD      r1,sp,#0x30
00000a  a803              ADD      r0,sp,#0xc
00000c  f7fffffe          BL       find_volume
000010  4604              MOV      r4,r0
;;;3295   	if (res == FR_OK) {
000012  b9f4              CBNZ     r4,|L34.82|
;;;3296   		INIT_BUF(dj);
000014  f44f7000          MOV      r0,#0x200
000018  f7fffffe          BL       ff_memalloc
00001c  4605              MOV      r5,r0
00001e  b14d              CBZ      r5,|L34.52|
000020  950a              STR      r5,[sp,#0x28]
000022  f8cdd024          STR      sp,[sp,#0x24]
;;;3297   		res = follow_path(&dj, path);	/* Follow the file path */
000026  a803              ADD      r0,sp,#0xc
000028  990c              LDR      r1,[sp,#0x30]
00002a  f7fffffe          BL       follow_path
00002e  4604              MOV      r4,r0
;;;3298   		if (res == FR_OK) {				/* Follow completed */
000030  b11c              CBZ      r4,|L34.58|
000032  e00b              B        |L34.76|
                  |L34.52|
000034  2011              MOVS     r0,#0x11              ;3296
                  |L34.54|
;;;3299   			if (dj.dir) {		/* Found an object */
;;;3300   				if (fno) get_fileinfo(&dj, fno);
;;;3301   			} else {			/* It is root directory */
;;;3302   				res = FR_INVALID_NAME;
;;;3303   			}
;;;3304   		}
;;;3305   		FREE_BUF();
;;;3306   	}
;;;3307   
;;;3308   	LEAVE_FF(dj.fs, res);
;;;3309   }
000036  b00e              ADD      sp,sp,#0x38
000038  bd70              POP      {r4-r6,pc}
                  |L34.58|
00003a  9808              LDR      r0,[sp,#0x20]         ;3299
00003c  b128              CBZ      r0,|L34.74|
00003e  b12e              CBZ      r6,|L34.76|
000040  4631              MOV      r1,r6                 ;3300
000042  a803              ADD      r0,sp,#0xc            ;3300
000044  f7fffffe          BL       get_fileinfo
000048  e000              B        |L34.76|
                  |L34.74|
00004a  2406              MOVS     r4,#6                 ;3302
                  |L34.76|
00004c  4628              MOV      r0,r5                 ;3305
00004e  f7fffffe          BL       ff_memfree
                  |L34.82|
000052  4620              MOV      r0,r4                 ;3308
000054  e7ef              B        |L34.54|
;;;3310   
                          ENDP


                          AREA ||i.f_sync||, CODE, READONLY, ALIGN=1

                  f_sync PROC
;;;2771   
;;;2772   FRESULT f_sync (
000000  b570              PUSH     {r4-r6,lr}
;;;2773   	FIL* fp		/* Pointer to the file object */
;;;2774   )
;;;2775   {
000002  4604              MOV      r4,r0
;;;2776   	FRESULT res;
;;;2777   	DWORD tm;
;;;2778   	BYTE *dir;
;;;2779   
;;;2780   
;;;2781   	res = validate(fp);					/* Check validity of the object */
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       validate
;;;2782   	if (res == FR_OK) {
00000a  2800              CMP      r0,#0
00000c  d10e              BNE      |L35.44|
;;;2783   		if (fp->flag & FA__WRITTEN) {	/* Has the file been written? */
00000e  79a1              LDRB     r1,[r4,#6]
000010  068a              LSLS     r2,r1,#26
000012  d50b              BPL      |L35.44|
;;;2784   			/* Write-back dirty buffer */
;;;2785   #if !_FS_TINY
;;;2786   			if (fp->flag & FA__DIRTY) {
000014  0648              LSLS     r0,r1,#25
000016  d50e              BPL      |L35.54|
;;;2787   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
000018  6820              LDR      r0,[r4,#0]
00001a  2301              MOVS     r3,#1
00001c  f1040128          ADD      r1,r4,#0x28
000020  7840              LDRB     r0,[r0,#1]
000022  69a2              LDR      r2,[r4,#0x18]
000024  f7fffffe          BL       disk_write
000028  b108              CBZ      r0,|L35.46|
;;;2788   					LEAVE_FF(fp->fs, FR_DISK_ERR);
00002a  2001              MOVS     r0,#1
                  |L35.44|
;;;2789   				fp->flag &= ~FA__DIRTY;
;;;2790   			}
;;;2791   #endif
;;;2792   			/* Update the directory entry */
;;;2793   			res = move_window(fp->fs, fp->dir_sect);
;;;2794   			if (res == FR_OK) {
;;;2795   				dir = fp->dir_ptr;
;;;2796   				dir[DIR_Attr] |= AM_ARC;					/* Set archive bit */
;;;2797   				ST_DWORD(dir+DIR_FileSize, fp->fsize);		/* Update file size */
;;;2798   				st_clust(dir, fp->sclust);					/* Update start cluster */
;;;2799   				tm = get_fattime();							/* Update updated time */
;;;2800   				ST_DWORD(dir+DIR_WrtTime, tm);
;;;2801   				ST_WORD(dir+DIR_LstAccDate, 0);
;;;2802   				fp->flag &= ~FA__WRITTEN;
;;;2803   				fp->fs->wflag = 1;
;;;2804   				res = sync_fs(fp->fs);
;;;2805   			}
;;;2806   		}
;;;2807   	}
;;;2808   
;;;2809   	LEAVE_FF(fp->fs, res);
;;;2810   }
00002c  bd70              POP      {r4-r6,pc}
                  |L35.46|
00002e  79a0              LDRB     r0,[r4,#6]            ;2789
000030  f0200040          BIC      r0,r0,#0x40           ;2789
000034  71a0              STRB     r0,[r4,#6]            ;2789
                  |L35.54|
000036  69e1              LDR      r1,[r4,#0x1c]         ;2793
000038  6820              LDR      r0,[r4,#0]            ;2793
00003a  f7fffffe          BL       move_window
00003e  2800              CMP      r0,#0                 ;2794
000040  d1f4              BNE      |L35.44|
000042  6a25              LDR      r5,[r4,#0x20]         ;2795
000044  7ae8              LDRB     r0,[r5,#0xb]          ;2796
000046  f0400020          ORR      r0,r0,#0x20           ;2796
00004a  72e8              STRB     r0,[r5,#0xb]          ;2796
00004c  7b20              LDRB     r0,[r4,#0xc]          ;2797
00004e  7728              STRB     r0,[r5,#0x1c]         ;2797
000050  89a0              LDRH     r0,[r4,#0xc]          ;2797
000052  0a00              LSRS     r0,r0,#8              ;2797
000054  7768              STRB     r0,[r5,#0x1d]         ;2797
000056  68e0              LDR      r0,[r4,#0xc]          ;2797
000058  0c00              LSRS     r0,r0,#16             ;2797
00005a  77a8              STRB     r0,[r5,#0x1e]         ;2797
00005c  68e0              LDR      r0,[r4,#0xc]          ;2797
00005e  0e00              LSRS     r0,r0,#24             ;2797
000060  77e8              STRB     r0,[r5,#0x1f]         ;2797
000062  4628              MOV      r0,r5                 ;2798
000064  6921              LDR      r1,[r4,#0x10]         ;2798
000066  f7fffffe          BL       st_clust
00006a  f7fffffe          BL       get_fattime
00006e  75a8              STRB     r0,[r5,#0x16]         ;2800
000070  0a01              LSRS     r1,r0,#8              ;2800
000072  75e9              STRB     r1,[r5,#0x17]         ;2800
000074  0c01              LSRS     r1,r0,#16             ;2800
000076  7629              STRB     r1,[r5,#0x18]         ;2800
000078  0e00              LSRS     r0,r0,#24             ;2800
00007a  7668              STRB     r0,[r5,#0x19]         ;2800
00007c  2000              MOVS     r0,#0                 ;2801
00007e  74a8              STRB     r0,[r5,#0x12]         ;2801
000080  74e8              STRB     r0,[r5,#0x13]         ;2801
000082  79a0              LDRB     r0,[r4,#6]            ;2802
000084  f0200020          BIC      r0,r0,#0x20           ;2802
000088  71a0              STRB     r0,[r4,#6]            ;2802
00008a  6821              LDR      r1,[r4,#0]            ;2803
00008c  2001              MOVS     r0,#1                 ;2803
00008e  7108              STRB     r0,[r1,#4]            ;2803
000090  6820              LDR      r0,[r4,#0]            ;2804
000092  e8bd4070          POP      {r4-r6,lr}            ;2804
000096  f7ffbffe          B.W      sync_fs
;;;2811   
                          ENDP


                          AREA ||i.f_truncate||, CODE, READONLY, ALIGN=1

                  f_truncate PROC
;;;3384   
;;;3385   FRESULT f_truncate (
000000  b570              PUSH     {r4-r6,lr}
;;;3386   	FIL* fp		/* Pointer to the file object */
;;;3387   )
;;;3388   {
000002  4604              MOV      r4,r0
;;;3389   	FRESULT res;
;;;3390   	DWORD ncl;
;;;3391   
;;;3392   
;;;3393   	res = validate(fp);						/* Check validity of the object */
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       validate
00000a  4605              MOV      r5,r0
;;;3394   	if (res == FR_OK) {
00000c  b93d              CBNZ     r5,|L36.30|
;;;3395   		if (fp->err) {						/* Check error */
00000e  79e0              LDRB     r0,[r4,#7]
000010  b108              CBZ      r0,|L36.22|
;;;3396   			res = (FRESULT)fp->err;
000012  4605              MOV      r5,r0
000014  e003              B        |L36.30|
                  |L36.22|
;;;3397   		} else {
;;;3398   			if (!(fp->flag & FA_WRITE))		/* Check access mode */
000016  79a0              LDRB     r0,[r4,#6]
000018  0780              LSLS     r0,r0,#30
00001a  d400              BMI      |L36.30|
;;;3399   				res = FR_DENIED;
00001c  2507              MOVS     r5,#7
                  |L36.30|
;;;3400   		}
;;;3401   	}
;;;3402   	if (res == FR_OK) {
00001e  bbed              CBNZ     r5,|L36.156|
;;;3403   		if (fp->fsize > fp->fptr) {
000020  e9d40102          LDRD     r0,r1,[r4,#8]
000024  4281              CMP      r1,r0
000026  d93e              BLS      |L36.166|
;;;3404   			fp->fsize = fp->fptr;	/* Set file size to current R/W point */
000028  60e0              STR      r0,[r4,#0xc]
;;;3405   			fp->flag |= FA__WRITTEN;
00002a  79a1              LDRB     r1,[r4,#6]
00002c  f0410120          ORR      r1,r1,#0x20
000030  71a1              STRB     r1,[r4,#6]
;;;3406   			if (fp->fptr == 0) {	/* When set file size to zero, remove entire cluster chain */
000032  b138              CBZ      r0,|L36.68|
;;;3407   				res = remove_chain(fp->fs, fp->sclust);
;;;3408   				fp->sclust = 0;
;;;3409   			} else {				/* When truncate a part of the file, remove remaining clusters */
;;;3410   				ncl = get_fat(fp->fs, fp->clust);
000034  6961              LDR      r1,[r4,#0x14]
000036  6820              LDR      r0,[r4,#0]
000038  f7fffffe          BL       get_fat
00003c  4606              MOV      r6,r0
;;;3411   				res = FR_OK;
;;;3412   				if (ncl == 0xFFFFFFFF) res = FR_DISK_ERR;
00003e  1c70              ADDS     r0,r6,#1
000040  d008              BEQ      |L36.84|
000042  e008              B        |L36.86|
                  |L36.68|
000044  6921              LDR      r1,[r4,#0x10]         ;3407
000046  6820              LDR      r0,[r4,#0]            ;3407
000048  f7fffffe          BL       remove_chain
00004c  4605              MOV      r5,r0                 ;3407
00004e  2000              MOVS     r0,#0                 ;3408
000050  6120              STR      r0,[r4,#0x10]         ;3408
000052  e014              B        |L36.126|
                  |L36.84|
000054  2501              MOVS     r5,#1
                  |L36.86|
;;;3413   				if (ncl == 1) res = FR_INT_ERR;
000056  2e01              CMP      r6,#1
000058  d100              BNE      |L36.92|
00005a  2502              MOVS     r5,#2
                  |L36.92|
;;;3414   				if (res == FR_OK && ncl < fp->fs->n_fatent) {
00005c  b97d              CBNZ     r5,|L36.126|
00005e  6820              LDR      r0,[r4,#0]
000060  6941              LDR      r1,[r0,#0x14]
000062  42b1              CMP      r1,r6
000064  d90b              BLS      |L36.126|
;;;3415   					res = put_fat(fp->fs, fp->clust, 0x0FFFFFFF);
000066  f06f4270          MVN      r2,#0xf0000000
00006a  6961              LDR      r1,[r4,#0x14]
00006c  f7fffffe          BL       put_fat
000070  4605              MOV      r5,r0
;;;3416   					if (res == FR_OK) res = remove_chain(fp->fs, ncl);
000072  b925              CBNZ     r5,|L36.126|
000074  4631              MOV      r1,r6
000076  6820              LDR      r0,[r4,#0]
000078  f7fffffe          BL       remove_chain
00007c  4605              MOV      r5,r0
                  |L36.126|
;;;3417   				}
;;;3418   			}
;;;3419   #if !_FS_TINY
;;;3420   			if (res == FR_OK && (fp->flag & FA__DIRTY)) {
00007e  b995              CBNZ     r5,|L36.166|
000080  79a0              LDRB     r0,[r4,#6]
000082  0640              LSLS     r0,r0,#25
000084  d50f              BPL      |L36.166|
;;;3421   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
000086  6820              LDR      r0,[r4,#0]
000088  2301              MOVS     r3,#1
00008a  f1040128          ADD      r1,r4,#0x28
00008e  7840              LDRB     r0,[r0,#1]
000090  69a2              LDR      r2,[r4,#0x18]
000092  f7fffffe          BL       disk_write
000096  b110              CBZ      r0,|L36.158|
;;;3422   					res = FR_DISK_ERR;
000098  2501              MOVS     r5,#1
00009a  e004              B        |L36.166|
                  |L36.156|
00009c  e005              B        |L36.170|
                  |L36.158|
;;;3423   				else
;;;3424   					fp->flag &= ~FA__DIRTY;
00009e  79a0              LDRB     r0,[r4,#6]
0000a0  f0200040          BIC      r0,r0,#0x40
0000a4  71a0              STRB     r0,[r4,#6]
                  |L36.166|
;;;3425   			}
;;;3426   #endif
;;;3427   		}
;;;3428   		if (res != FR_OK) fp->err = (FRESULT)res;
0000a6  b105              CBZ      r5,|L36.170|
0000a8  71e5              STRB     r5,[r4,#7]
                  |L36.170|
;;;3429   	}
;;;3430   
;;;3431   	LEAVE_FF(fp->fs, res);
0000aa  4628              MOV      r0,r5
;;;3432   }
0000ac  bd70              POP      {r4-r6,pc}
;;;3433   
                          ENDP


                          AREA ||i.f_unlink||, CODE, READONLY, ALIGN=1

                  f_unlink PROC
;;;3440   
;;;3441   FRESULT f_unlink (
000000  b5f1              PUSH     {r0,r4-r7,lr}
;;;3442   	const TCHAR* path		/* Pointer to the file or directory path */
;;;3443   )
;;;3444   {
000002  b096              SUB      sp,sp,#0x58
;;;3445   	FRESULT res;
;;;3446   	DIR dj, sdj;
;;;3447   	BYTE *dir;
;;;3448   	DWORD dclst;
;;;3449   	DEF_NAMEBUF;
;;;3450   
;;;3451   
;;;3452   	/* Get logical drive number */
;;;3453   	res = find_volume(&dj.fs, &path, 1);
000004  2201              MOVS     r2,#1
000006  a916              ADD      r1,sp,#0x58
000008  a80d              ADD      r0,sp,#0x34
00000a  f7fffffe          BL       find_volume
00000e  4604              MOV      r4,r0
;;;3454   	if (res == FR_OK) {
000010  2c00              CMP      r4,#0
000012  d152              BNE      |L37.186|
;;;3455   		INIT_BUF(dj);
000014  f44f7000          MOV      r0,#0x200
000018  f7fffffe          BL       ff_memalloc
00001c  4607              MOV      r7,r0
00001e  b14f              CBZ      r7,|L37.52|
000020  9714              STR      r7,[sp,#0x50]
000022  a801              ADD      r0,sp,#4
000024  9013              STR      r0,[sp,#0x4c]
;;;3456   		res = follow_path(&dj, path);		/* Follow the file path */
000026  a80d              ADD      r0,sp,#0x34
000028  9916              LDR      r1,[sp,#0x58]
00002a  f7fffffe          BL       follow_path
00002e  4604              MOV      r4,r0
;;;3457   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
;;;3458   			res = FR_INVALID_NAME;			/* Cannot remove dot entry */
;;;3459   #if _FS_LOCK
;;;3460   		if (res == FR_OK) res = chk_lock(&dj, 2);	/* Cannot remove open file */
;;;3461   #endif
;;;3462   		if (res == FR_OK) {					/* The object is accessible */
000030  b11c              CBZ      r4,|L37.58|
000032  e03f              B        |L37.180|
                  |L37.52|
000034  2011              MOVS     r0,#0x11              ;3455
                  |L37.54|
;;;3463   			dir = dj.dir;
;;;3464   			if (!dir) {
;;;3465   				res = FR_INVALID_NAME;		/* Cannot remove the start directory */
;;;3466   			} else {
;;;3467   				if (dir[DIR_Attr] & AM_RDO)
;;;3468   					res = FR_DENIED;		/* Cannot remove R/O object */
;;;3469   			}
;;;3470   			dclst = ld_clust(dj.fs, dir);
;;;3471   			if (res == FR_OK && (dir[DIR_Attr] & AM_DIR)) {	/* Is it a sub-dir? */
;;;3472   				if (dclst < 2) {
;;;3473   					res = FR_INT_ERR;
;;;3474   				} else {
;;;3475   					mem_cpy(&sdj, &dj, sizeof (DIR));	/* Check if the sub-directory is empty or not */
;;;3476   					sdj.sclust = dclst;
;;;3477   					res = dir_sdi(&sdj, 2);		/* Exclude dot entries */
;;;3478   					if (res == FR_OK) {
;;;3479   						res = dir_read(&sdj, 0);	/* Read an item */
;;;3480   						if (res == FR_OK		/* Not empty directory */
;;;3481   #if _FS_RPATH
;;;3482   						|| dclst == dj.fs->cdir	/* Current directory */
;;;3483   #endif
;;;3484   						) res = FR_DENIED;
;;;3485   						if (res == FR_NO_FILE) res = FR_OK;	/* Empty */
;;;3486   					}
;;;3487   				}
;;;3488   			}
;;;3489   			if (res == FR_OK) {
;;;3490   				res = dir_remove(&dj);		/* Remove the directory entry */
;;;3491   				if (res == FR_OK) {
;;;3492   					if (dclst)				/* Remove the cluster chain if exist */
;;;3493   						res = remove_chain(dj.fs, dclst);
;;;3494   					if (res == FR_OK) res = sync_fs(dj.fs);
;;;3495   				}
;;;3496   			}
;;;3497   		}
;;;3498   		FREE_BUF();
;;;3499   	}
;;;3500   
;;;3501   	LEAVE_FF(dj.fs, res);
;;;3502   }
000036  b017              ADD      sp,sp,#0x5c
000038  bdf0              POP      {r4-r7,pc}
                  |L37.58|
00003a  9e12              LDR      r6,[sp,#0x48]         ;3463
00003c  b156              CBZ      r6,|L37.84|
00003e  7af0              LDRB     r0,[r6,#0xb]          ;3467
000040  07c0              LSLS     r0,r0,#31             ;3467
000042  d000              BEQ      |L37.70|
000044  2407              MOVS     r4,#7                 ;3468
                  |L37.70|
000046  4631              MOV      r1,r6                 ;3470
000048  980d              LDR      r0,[sp,#0x34]         ;3470
00004a  f7fffffe          BL       ld_clust
00004e  4605              MOV      r5,r0                 ;3470
000050  b114              CBZ      r4,|L37.88|
000052  e01e              B        |L37.146|
                  |L37.84|
000054  2406              MOVS     r4,#6                 ;3465
000056  e7f6              B        |L37.70|
                  |L37.88|
000058  7af0              LDRB     r0,[r6,#0xb]          ;3471
00005a  06c0              LSLS     r0,r0,#27             ;3471
00005c  d519              BPL      |L37.146|
00005e  2d02              CMP      r5,#2                 ;3472
000060  d201              BCS      |L37.102|
000062  2402              MOVS     r4,#2                 ;3473
000064  e015              B        |L37.146|
                  |L37.102|
000066  2224              MOVS     r2,#0x24              ;3475
000068  a90d              ADD      r1,sp,#0x34           ;3475
00006a  a804              ADD      r0,sp,#0x10           ;3475
00006c  f7fffffe          BL       mem_cpy
000070  9506              STR      r5,[sp,#0x18]         ;3476
000072  2102              MOVS     r1,#2                 ;3477
000074  a804              ADD      r0,sp,#0x10           ;3477
000076  f7fffffe          BL       dir_sdi
00007a  4604              MOV      r4,r0                 ;3477
00007c  b94c              CBNZ     r4,|L37.146|
00007e  2100              MOVS     r1,#0                 ;3479
000080  a804              ADD      r0,sp,#0x10           ;3479
000082  f7fffffe          BL       dir_read
000086  4604              MOV      r4,r0                 ;3479
000088  b904              CBNZ     r4,|L37.140|
00008a  2407              MOVS     r4,#7                 ;3484
                  |L37.140|
00008c  2c04              CMP      r4,#4                 ;3485
00008e  d100              BNE      |L37.146|
000090  2400              MOVS     r4,#0                 ;3485
                  |L37.146|
000092  b97c              CBNZ     r4,|L37.180|
000094  a80d              ADD      r0,sp,#0x34           ;3490
000096  f7fffffe          BL       dir_remove
00009a  4604              MOV      r4,r0                 ;3490
00009c  b954              CBNZ     r4,|L37.180|
00009e  b125              CBZ      r5,|L37.170|
0000a0  4629              MOV      r1,r5                 ;3493
0000a2  980d              LDR      r0,[sp,#0x34]         ;3493
0000a4  f7fffffe          BL       remove_chain
0000a8  4604              MOV      r4,r0                 ;3493
                  |L37.170|
0000aa  b91c              CBNZ     r4,|L37.180|
0000ac  980d              LDR      r0,[sp,#0x34]         ;3494
0000ae  f7fffffe          BL       sync_fs
0000b2  4604              MOV      r4,r0                 ;3494
                  |L37.180|
0000b4  4638              MOV      r0,r7                 ;3498
0000b6  f7fffffe          BL       ff_memfree
                  |L37.186|
0000ba  4620              MOV      r0,r4                 ;3501
0000bc  e7bb              B        |L37.54|
;;;3503   
                          ENDP


                          AREA ||i.f_utime||, CODE, READONLY, ALIGN=1

                  f_utime PROC
;;;3627   
;;;3628   FRESULT f_utime (
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;3629   	const TCHAR* path,	/* Pointer to the file/directory name */
;;;3630   	const FILINFO* fno	/* Pointer to the time stamp to be set */
;;;3631   )
;;;3632   {
000002  b08c              SUB      sp,sp,#0x30
000004  460d              MOV      r5,r1
;;;3633   	FRESULT res;
;;;3634   	DIR dj;
;;;3635   	BYTE *dir;
;;;3636   	DEF_NAMEBUF;
;;;3637   
;;;3638   
;;;3639   	/* Get logical drive number */
;;;3640   	res = find_volume(&dj.fs, &path, 1);
000006  2201              MOVS     r2,#1
000008  a90c              ADD      r1,sp,#0x30
00000a  a803              ADD      r0,sp,#0xc
00000c  f7fffffe          BL       find_volume
000010  4604              MOV      r4,r0
;;;3641   	if (res == FR_OK) {
000012  bb44              CBNZ     r4,|L38.102|
;;;3642   		INIT_BUF(dj);
000014  f44f7000          MOV      r0,#0x200
000018  f7fffffe          BL       ff_memalloc
00001c  4606              MOV      r6,r0
00001e  b166              CBZ      r6,|L38.58|
000020  960a              STR      r6,[sp,#0x28]
000022  f8cdd024          STR      sp,[sp,#0x24]
;;;3643   		res = follow_path(&dj, path);	/* Follow the file path */
000026  a803              ADD      r0,sp,#0xc
000028  990c              LDR      r1,[sp,#0x30]
00002a  f7fffffe          BL       follow_path
00002e  4604              MOV      r4,r0
;;;3644   		FREE_BUF();
000030  4630              MOV      r0,r6
000032  f7fffffe          BL       ff_memfree
;;;3645   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
;;;3646   			res = FR_INVALID_NAME;
;;;3647   		if (res == FR_OK) {
000036  b11c              CBZ      r4,|L38.64|
000038  e015              B        |L38.102|
                  |L38.58|
00003a  2011              MOVS     r0,#0x11              ;3642
                  |L38.60|
;;;3648   			dir = dj.dir;
;;;3649   			if (!dir) {					/* Root directory */
;;;3650   				res = FR_INVALID_NAME;
;;;3651   			} else {					/* File or sub-directory */
;;;3652   				ST_WORD(dir+DIR_WrtTime, fno->ftime);
;;;3653   				ST_WORD(dir+DIR_WrtDate, fno->fdate);
;;;3654   				dj.fs->wflag = 1;
;;;3655   				res = sync_fs(dj.fs);
;;;3656   			}
;;;3657   		}
;;;3658   	}
;;;3659   
;;;3660   	LEAVE_FF(dj.fs, res);
;;;3661   }
00003c  b00e              ADD      sp,sp,#0x38
00003e  bd70              POP      {r4-r6,pc}
                  |L38.64|
000040  9808              LDR      r0,[sp,#0x20]         ;3648
000042  b190              CBZ      r0,|L38.106|
000044  79a9              LDRB     r1,[r5,#6]            ;3652
000046  7581              STRB     r1,[r0,#0x16]         ;3652
000048  88e9              LDRH     r1,[r5,#6]            ;3652
00004a  0a09              LSRS     r1,r1,#8              ;3652
00004c  75c1              STRB     r1,[r0,#0x17]         ;3652
00004e  7929              LDRB     r1,[r5,#4]            ;3653
000050  7601              STRB     r1,[r0,#0x18]         ;3653
000052  88a9              LDRH     r1,[r5,#4]            ;3653
000054  0a09              LSRS     r1,r1,#8              ;3653
000056  7641              STRB     r1,[r0,#0x19]         ;3653
000058  9903              LDR      r1,[sp,#0xc]          ;3654
00005a  2001              MOVS     r0,#1                 ;3654
00005c  7108              STRB     r0,[r1,#4]            ;3654
00005e  9803              LDR      r0,[sp,#0xc]          ;3655
000060  f7fffffe          BL       sync_fs
000064  4604              MOV      r4,r0                 ;3655
                  |L38.102|
000066  4620              MOV      r0,r4                 ;3660
000068  e7e8              B        |L38.60|
                  |L38.106|
00006a  2406              MOVS     r4,#6                 ;3650
00006c  e7fb              B        |L38.102|
;;;3662   
                          ENDP


                          AREA ||i.f_write||, CODE, READONLY, ALIGN=1

                  f_write PROC
;;;2649   
;;;2650   FRESULT f_write (
000000  e92d4ff8          PUSH     {r3-r11,lr}
;;;2651   	FIL* fp,			/* Pointer to the file object */
;;;2652   	const void *buff,	/* Pointer to the data to be written */
;;;2653   	UINT btw,			/* Number of bytes to write */
;;;2654   	UINT* bw			/* Pointer to number of bytes written */
;;;2655   )
;;;2656   {
000004  4604              MOV      r4,r0
000006  460f              MOV      r7,r1
000008  4616              MOV      r6,r2
00000a  4698              MOV      r8,r3
;;;2657   	FRESULT res;
;;;2658   	DWORD clst, sect;
;;;2659   	UINT wcnt, cc;
;;;2660   	const BYTE *wbuff = (const BYTE*)buff;
;;;2661   	BYTE csect;
;;;2662   
;;;2663   
;;;2664   	*bw = 0;	/* Clear write byte counter */
00000c  2000              MOVS     r0,#0
00000e  f8c80000          STR      r0,[r8,#0]
;;;2665   
;;;2666   	res = validate(fp);						/* Check validity */
000012  4620              MOV      r0,r4
000014  f7fffffe          BL       validate
;;;2667   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
000018  2800              CMP      r0,#0
00001a  d106              BNE      |L39.42|
;;;2668   	if (fp->err)							/* Check error */
00001c  79e0              LDRB     r0,[r4,#7]
00001e  2800              CMP      r0,#0
000020  d103              BNE      |L39.42|
;;;2669   		LEAVE_FF(fp->fs, (FRESULT)fp->err);
;;;2670   	if (!(fp->flag & FA_WRITE))				/* Check access mode */
000022  79a0              LDRB     r0,[r4,#6]
000024  0780              LSLS     r0,r0,#30
000026  d402              BMI      |L39.46|
;;;2671   		LEAVE_FF(fp->fs, FR_DENIED);
000028  2007              MOVS     r0,#7
                  |L39.42|
;;;2672   	if (fp->fptr + btw < fp->fptr) btw = 0;	/* File size cannot reach 4GB */
;;;2673   
;;;2674   	for ( ;  btw;							/* Repeat until all data written */
;;;2675   		wbuff += wcnt, fp->fptr += wcnt, *bw += wcnt, btw -= wcnt) {
;;;2676   		if ((fp->fptr % SS(fp->fs)) == 0) {	/* On the sector boundary? */
;;;2677   			csect = (BYTE)(fp->fptr / SS(fp->fs) & (fp->fs->csize - 1));	/* Sector offset in the cluster */
;;;2678   			if (!csect) {					/* On the cluster boundary? */
;;;2679   				if (fp->fptr == 0) {		/* On the top of the file? */
;;;2680   					clst = fp->sclust;		/* Follow from the origin */
;;;2681   					if (clst == 0)			/* When no cluster is allocated, */
;;;2682   						clst = create_chain(fp->fs, 0);	/* Create a new cluster chain */
;;;2683   				} else {					/* Middle or end of the file */
;;;2684   #if _USE_FASTSEEK
;;;2685   					if (fp->cltbl)
;;;2686   						clst = clmt_clust(fp, fp->fptr);	/* Get cluster# from the CLMT */
;;;2687   					else
;;;2688   #endif
;;;2689   						clst = create_chain(fp->fs, fp->clust);	/* Follow or stretch cluster chain on the FAT */
;;;2690   				}
;;;2691   				if (clst == 0) break;		/* Could not allocate a new cluster (disk full) */
;;;2692   				if (clst == 1) ABORT(fp->fs, FR_INT_ERR);
;;;2693   				if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2694   				fp->clust = clst;			/* Update current cluster */
;;;2695   				if (fp->sclust == 0) fp->sclust = clst;	/* Set start cluster if the first write */
;;;2696   			}
;;;2697   #if _FS_TINY
;;;2698   			if (fp->fs->winsect == fp->dsect && sync_window(fp->fs))	/* Write-back sector cache */
;;;2699   				ABORT(fp->fs, FR_DISK_ERR);
;;;2700   #else
;;;2701   			if (fp->flag & FA__DIRTY) {		/* Write-back sector cache */
;;;2702   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;2703   					ABORT(fp->fs, FR_DISK_ERR);
;;;2704   				fp->flag &= ~FA__DIRTY;
;;;2705   			}
;;;2706   #endif
;;;2707   			sect = clust2sect(fp->fs, fp->clust);	/* Get current sector */
;;;2708   			if (!sect) ABORT(fp->fs, FR_INT_ERR);
;;;2709   			sect += csect;
;;;2710   			cc = btw / SS(fp->fs);			/* When remaining bytes >= sector size, */
;;;2711   			if (cc) {						/* Write maximum contiguous sectors directly */
;;;2712   				if (csect + cc > fp->fs->csize)	/* Clip at cluster boundary */
;;;2713   					cc = fp->fs->csize - csect;
;;;2714   				if (disk_write(fp->fs->drv, wbuff, sect, cc))
;;;2715   					ABORT(fp->fs, FR_DISK_ERR);
;;;2716   #if _FS_MINIMIZE <= 2
;;;2717   #if _FS_TINY
;;;2718   				if (fp->fs->winsect - sect < cc) {	/* Refill sector cache if it gets invalidated by the direct write */
;;;2719   					mem_cpy(fp->fs->win, wbuff + ((fp->fs->winsect - sect) * SS(fp->fs)), SS(fp->fs));
;;;2720   					fp->fs->wflag = 0;
;;;2721   				}
;;;2722   #else
;;;2723   				if (fp->dsect - sect < cc) { /* Refill sector cache if it gets invalidated by the direct write */
;;;2724   					mem_cpy(fp->buf, wbuff + ((fp->dsect - sect) * SS(fp->fs)), SS(fp->fs));
;;;2725   					fp->flag &= ~FA__DIRTY;
;;;2726   				}
;;;2727   #endif
;;;2728   #endif
;;;2729   				wcnt = SS(fp->fs) * cc;		/* Number of bytes transferred */
;;;2730   				continue;
;;;2731   			}
;;;2732   #if _FS_TINY
;;;2733   			if (fp->fptr >= fp->fsize) {	/* Avoid silly cache filling at growing edge */
;;;2734   				if (sync_window(fp->fs)) ABORT(fp->fs, FR_DISK_ERR);
;;;2735   				fp->fs->winsect = sect;
;;;2736   			}
;;;2737   #else
;;;2738   			if (fp->dsect != sect) {		/* Fill sector cache with file data */
;;;2739   				if (fp->fptr < fp->fsize &&
;;;2740   					disk_read(fp->fs->drv, fp->buf, sect, 1))
;;;2741   						ABORT(fp->fs, FR_DISK_ERR);
;;;2742   			}
;;;2743   #endif
;;;2744   			fp->dsect = sect;
;;;2745   		}
;;;2746   		wcnt = SS(fp->fs) - ((UINT)fp->fptr % SS(fp->fs));/* Put partial sector into file I/O buffer */
;;;2747   		if (wcnt > btw) wcnt = btw;
;;;2748   #if _FS_TINY
;;;2749   		if (move_window(fp->fs, fp->dsect))	/* Move sector window */
;;;2750   			ABORT(fp->fs, FR_DISK_ERR);
;;;2751   		mem_cpy(&fp->fs->win[fp->fptr % SS(fp->fs)], wbuff, wcnt);	/* Fit partial sector */
;;;2752   		fp->fs->wflag = 1;
;;;2753   #else
;;;2754   		mem_cpy(&fp->buf[fp->fptr % SS(fp->fs)], wbuff, wcnt);	/* Fit partial sector */
;;;2755   		fp->flag |= FA__DIRTY;
;;;2756   #endif
;;;2757   	}
;;;2758   
;;;2759   	if (fp->fptr > fp->fsize) fp->fsize = fp->fptr;	/* Update file size if needed */
;;;2760   	fp->flag |= FA__WRITTEN;						/* Set file change flag */
;;;2761   
;;;2762   	LEAVE_FF(fp->fs, FR_OK);
;;;2763   }
00002a  e8bd8ff8          POP      {r3-r11,pc}
                  |L39.46|
00002e  68a0              LDR      r0,[r4,#8]            ;2672
000030  1981              ADDS     r1,r0,r6              ;2672
000032  d300              BCC      |L39.54|
000034  2600              MOVS     r6,#0                 ;2672
                  |L39.54|
000036  f1040028          ADD      r0,r4,#0x28           ;2702
00003a  f04f0901          MOV      r9,#1                 ;2658
00003e  9000              STR      r0,[sp,#0]            ;2674
000040  e0a9              B        |L39.406|
                  |L39.66|
000042  68a1              LDR      r1,[r4,#8]            ;2676
000044  05c8              LSLS     r0,r1,#23             ;2676
000046  d171              BNE      |L39.300|
000048  6822              LDR      r2,[r4,#0]            ;2677
00004a  7890              LDRB     r0,[r2,#2]            ;2677
00004c  1e40              SUBS     r0,r0,#1              ;2677
00004e  ea002051          AND      r0,r0,r1,LSR #9       ;2677
000052  f0000aff          AND      r10,r0,#0xff          ;2677
000056  f1ba0f00          CMP      r10,#0                ;2678
00005a  d123              BNE      |L39.164|
00005c  b129              CBZ      r1,|L39.106|
00005e  6a60              LDR      r0,[r4,#0x24]         ;2685
000060  b150              CBZ      r0,|L39.120|
000062  4620              MOV      r0,r4                 ;2686
000064  f7fffffe          BL       clmt_clust
000068  e00a              B        |L39.128|
                  |L39.106|
00006a  6920              LDR      r0,[r4,#0x10]         ;2680
00006c  b940              CBNZ     r0,|L39.128|
00006e  2100              MOVS     r1,#0                 ;2682
000070  4610              MOV      r0,r2                 ;2682
000072  f7fffffe          BL       create_chain
000076  e003              B        |L39.128|
                  |L39.120|
000078  4610              MOV      r0,r2                 ;2689
00007a  6961              LDR      r1,[r4,#0x14]         ;2689
00007c  f7fffffe          BL       create_chain
                  |L39.128|
000080  2800              CMP      r0,#0                 ;2691
000082  d07d              BEQ      |L39.384|
000084  2801              CMP      r0,#1                 ;2692
000086  d005              BEQ      |L39.148|
000088  1c41              ADDS     r1,r0,#1              ;2693
00008a  d006              BEQ      |L39.154|
00008c  6160              STR      r0,[r4,#0x14]         ;2694
00008e  6921              LDR      r1,[r4,#0x10]         ;2695
000090  b139              CBZ      r1,|L39.162|
000092  e007              B        |L39.164|
                  |L39.148|
000094  2002              MOVS     r0,#2                 ;2692
000096  71e0              STRB     r0,[r4,#7]            ;2692
000098  e7c7              B        |L39.42|
                  |L39.154|
00009a  f8849007          STRB     r9,[r4,#7]            ;2693
00009e  2001              MOVS     r0,#1                 ;2693
0000a0  e7c3              B        |L39.42|
                  |L39.162|
0000a2  6120              STR      r0,[r4,#0x10]         ;2695
                  |L39.164|
0000a4  79a0              LDRB     r0,[r4,#6]            ;2701
0000a6  0640              LSLS     r0,r0,#25             ;2701
0000a8  d50f              BPL      |L39.202|
0000aa  6820              LDR      r0,[r4,#0]            ;2702
0000ac  2301              MOVS     r3,#1                 ;2702
0000ae  69a2              LDR      r2,[r4,#0x18]         ;2702
0000b0  7840              LDRB     r0,[r0,#1]            ;2702
0000b2  9900              LDR      r1,[sp,#0]            ;2702
0000b4  f7fffffe          BL       disk_write
0000b8  b118              CBZ      r0,|L39.194|
0000ba  f8849007          STRB     r9,[r4,#7]            ;2703
0000be  2001              MOVS     r0,#1                 ;2703
0000c0  e7b3              B        |L39.42|
                  |L39.194|
0000c2  79a0              LDRB     r0,[r4,#6]            ;2704
0000c4  f0200040          BIC      r0,r0,#0x40           ;2704
0000c8  71a0              STRB     r0,[r4,#6]            ;2704
                  |L39.202|
0000ca  6961              LDR      r1,[r4,#0x14]         ;2707
0000cc  6820              LDR      r0,[r4,#0]            ;2707
0000ce  f7fffffe          BL       clust2sect
0000d2  b1b0              CBZ      r0,|L39.258|
0000d4  eb000b0a          ADD      r11,r0,r10            ;2709
0000d8  0a75              LSRS     r5,r6,#9              ;2710
0000da  b345              CBZ      r5,|L39.302|
0000dc  6820              LDR      r0,[r4,#0]            ;2712
0000de  eb0a0205          ADD      r2,r10,r5             ;2712
0000e2  7881              LDRB     r1,[r0,#2]            ;2712
0000e4  428a              CMP      r2,r1                 ;2712
0000e6  d901              BLS      |L39.236|
0000e8  eba1050a          SUB      r5,r1,r10             ;2713
                  |L39.236|
0000ec  7840              LDRB     r0,[r0,#1]            ;2714
0000ee  462b              MOV      r3,r5                 ;2714
0000f0  465a              MOV      r2,r11                ;2714
0000f2  4639              MOV      r1,r7                 ;2714
0000f4  f7fffffe          BL       disk_write
0000f8  b130              CBZ      r0,|L39.264|
0000fa  f8849007          STRB     r9,[r4,#7]            ;2715
0000fe  2001              MOVS     r0,#1                 ;2715
000100  e793              B        |L39.42|
                  |L39.258|
000102  2002              MOVS     r0,#2                 ;2708
000104  71e0              STRB     r0,[r4,#7]            ;2708
000106  e790              B        |L39.42|
                  |L39.264|
000108  69a0              LDR      r0,[r4,#0x18]         ;2723
00010a  eba0000b          SUB      r0,r0,r11             ;2723
00010e  42a8              CMP      r0,r5                 ;2723
000110  d20a              BCS      |L39.296|
000112  eb072140          ADD      r1,r7,r0,LSL #9       ;2724
000116  f44f7200          MOV      r2,#0x200             ;2724
00011a  9800              LDR      r0,[sp,#0]            ;2724
00011c  f7fffffe          BL       mem_cpy
000120  79a0              LDRB     r0,[r4,#6]            ;2725
000122  f0200040          BIC      r0,r0,#0x40           ;2725
000126  71a0              STRB     r0,[r4,#6]            ;2725
                  |L39.296|
000128  026d              LSLS     r5,r5,#9              ;2729
00012a  e028              B        |L39.382|
                  |L39.300|
00012c  e015              B        |L39.346|
                  |L39.302|
00012e  e7ff              B        |L39.304|
                  |L39.304|
000130  69a0              LDR      r0,[r4,#0x18]         ;2738
000132  4558              CMP      r0,r11                ;2738
000134  d00f              BEQ      |L39.342|
000136  e9d40102          LDRD     r0,r1,[r4,#8]         ;2739
00013a  4288              CMP      r0,r1                 ;2739
00013c  d20b              BCS      |L39.342|
00013e  6820              LDR      r0,[r4,#0]            ;2740
000140  2301              MOVS     r3,#1                 ;2740
000142  465a              MOV      r2,r11                ;2740
000144  7840              LDRB     r0,[r0,#1]            ;2740
000146  9900              LDR      r1,[sp,#0]            ;2740
000148  f7fffffe          BL       disk_read
00014c  b118              CBZ      r0,|L39.342|
00014e  f8849007          STRB     r9,[r4,#7]            ;2741
000152  2001              MOVS     r0,#1                 ;2741
000154  e769              B        |L39.42|
                  |L39.342|
000156  f8c4b018          STR      r11,[r4,#0x18]        ;2744
                  |L39.346|
00015a  8920              LDRH     r0,[r4,#8]            ;2746
00015c  f3c00008          UBFX     r0,r0,#0,#9           ;2746
000160  f5c07500          RSB      r5,r0,#0x200          ;2746
000164  42b5              CMP      r5,r6                 ;2747
000166  d900              BLS      |L39.362|
000168  4635              MOV      r5,r6                 ;2747
                  |L39.362|
00016a  4420              ADD      r0,r0,r4              ;2754
00016c  3028              ADDS     r0,r0,#0x28           ;2754
00016e  462a              MOV      r2,r5                 ;2754
000170  4639              MOV      r1,r7                 ;2754
000172  f7fffffe          BL       mem_cpy
000176  79a0              LDRB     r0,[r4,#6]            ;2755
000178  f0400040          ORR      r0,r0,#0x40           ;2755
00017c  71a0              STRB     r0,[r4,#6]            ;2755
                  |L39.382|
00017e  e000              B        |L39.386|
                  |L39.384|
000180  e00c              B        |L39.412|
                  |L39.386|
000182  442f              ADD      r7,r7,r5              ;2675
000184  68a0              LDR      r0,[r4,#8]            ;2675
000186  4428              ADD      r0,r0,r5              ;2675
000188  60a0              STR      r0,[r4,#8]            ;2675
00018a  f8d80000          LDR      r0,[r8,#0]            ;2675
00018e  4428              ADD      r0,r0,r5              ;2675
000190  f8c80000          STR      r0,[r8,#0]            ;2675
000194  1b76              SUBS     r6,r6,r5              ;2675
                  |L39.406|
000196  2e00              CMP      r6,#0                 ;2674
000198  f47faf53          BNE      |L39.66|
                  |L39.412|
00019c  e9d40102          LDRD     r0,r1,[r4,#8]         ;2759
0001a0  4288              CMP      r0,r1                 ;2759
0001a2  d900              BLS      |L39.422|
0001a4  60e0              STR      r0,[r4,#0xc]          ;2759
                  |L39.422|
0001a6  79a0              LDRB     r0,[r4,#6]            ;2760
0001a8  f0400020          ORR      r0,r0,#0x20           ;2760
0001ac  71a0              STRB     r0,[r4,#6]            ;2760
0001ae  2000              MOVS     r0,#0                 ;2762
0001b0  e73b              B        |L39.42|
;;;2764   
                          ENDP


                          AREA ||i.find_volume||, CODE, READONLY, ALIGN=2

                  find_volume PROC
;;;2162   static
;;;2163   FRESULT find_volume (	/* FR_OK(0): successful, !=0: any error occurred */
000000  e92d47ff          PUSH     {r0-r10,lr}
;;;2164   	FATFS** rfs,		/* Pointer to pointer to the found file system object */
;;;2165   	const TCHAR** path,	/* Pointer to pointer to the path name (drive number) */
;;;2166   	BYTE wmode			/* !=0: Check write protection for write access */
;;;2167   )
;;;2168   {
000004  4680              MOV      r8,r0
000006  4608              MOV      r0,r1
000008  4616              MOV      r6,r2
;;;2169   	BYTE fmt;
;;;2170   	int vol;
;;;2171   	DSTATUS stat;
;;;2172   	DWORD bsect, fasize, tsect, sysect, nclst, szbfat;
;;;2173   	WORD nrsv;
;;;2174   	FATFS *fs;
;;;2175   
;;;2176   
;;;2177   	/* Get logical drive number from the path name */
;;;2178   	*rfs = 0;
00000a  2700              MOVS     r7,#0
00000c  f8c87000          STR      r7,[r8,#0]
;;;2179   	vol = get_ldnumber(path);
000010  f7fffffe          BL       get_ldnumber
000014  4605              MOV      r5,r0
;;;2180   	if (vol < 0) return FR_INVALID_DRIVE;
000016  2d00              CMP      r5,#0
000018  da03              BGE      |L40.34|
00001a  200b              MOVS     r0,#0xb
                  |L40.28|
;;;2181   
;;;2182   	/* Check if the file system object is valid or not */
;;;2183   	fs = FatFs[vol];					/* Get pointer to the file system object */
;;;2184   	if (!fs) return FR_NOT_ENABLED;		/* Is the file system object available? */
;;;2185   
;;;2186   	ENTER_FF(fs);						/* Lock the volume */
;;;2187   	*rfs = fs;							/* Return pointer to the file system object */
;;;2188   
;;;2189   	if (fs->fs_type) {					/* If the volume has been mounted */
;;;2190   		stat = disk_status(fs->drv);
;;;2191   		if (!(stat & STA_NOINIT)) {		/* and the physical drive is kept initialized */
;;;2192   			if (!_FS_READONLY && wmode && (stat & STA_PROTECT))	/* Check write protection if needed */
;;;2193   				return FR_WRITE_PROTECTED;
;;;2194   			return FR_OK;				/* The file system object is valid */
;;;2195   		}
;;;2196   	}
;;;2197   
;;;2198   	/* The file system object is not valid. */
;;;2199   	/* Following code attempts to mount the volume. (analyze BPB and initialize the fs object) */
;;;2200   
;;;2201   	fs->fs_type = 0;					/* Clear the file system object */
;;;2202   	fs->drv = LD2PD(vol);				/* Bind the logical drive and a physical drive */
;;;2203   	stat = disk_initialize(fs->drv);	/* Initialize the physical drive */
;;;2204   	if (stat & STA_NOINIT)				/* Check if the initialization succeeded */
;;;2205   		return FR_NOT_READY;			/* Failed to initialize due to no medium or hard error */
;;;2206   	if (!_FS_READONLY && wmode && (stat & STA_PROTECT))	/* Check disk write protection if needed */
;;;2207   		return FR_WRITE_PROTECTED;
;;;2208   #if _MAX_SS != _MIN_SS						/* Get sector size (multiple sector size cfg only) */
;;;2209   	if (disk_ioctl(fs->drv, GET_SECTOR_SIZE, &SS(fs)) != RES_OK
;;;2210   		|| SS(fs) < _MIN_SS || SS(fs) > _MAX_SS) return FR_DISK_ERR;
;;;2211   #endif
;;;2212   	/* Find an FAT partition on the drive. Supports only generic partitioning, FDISK and SFD. */
;;;2213   	bsect = 0;
;;;2214   	fmt = check_fs(fs, bsect);					/* Load sector 0 and check if it is an FAT boot sector as SFD */
;;;2215   	if (fmt == 1 || (!fmt && (LD2PT(vol)))) {	/* Not an FAT boot sector or forced partition number */
;;;2216   		UINT i;
;;;2217   		DWORD br[4];
;;;2218   
;;;2219   		for (i = 0; i < 4; i++) {			/* Get partition offset */
;;;2220   			BYTE *pt = fs->win+MBR_Table + i * SZ_PTE;
;;;2221   			br[i] = pt[4] ? LD_DWORD(&pt[8]) : 0;
;;;2222   		}
;;;2223   		i = LD2PT(vol);						/* Partition number: 0:auto, 1-4:forced */
;;;2224   		if (i) i--;
;;;2225   		do {								/* Find an FAT volume */
;;;2226   			bsect = br[i];
;;;2227   			fmt = bsect ? check_fs(fs, bsect) : 2;	/* Check the partition */
;;;2228   		} while (!LD2PT(vol) && fmt && ++i < 4);
;;;2229   	}
;;;2230   	if (fmt == 3) return FR_DISK_ERR;		/* An error occured in the disk I/O layer */
;;;2231   	if (fmt) return FR_NO_FILESYSTEM;		/* No FAT volume is found */
;;;2232   
;;;2233   	/* An FAT volume is found. Following code initializes the file system object */
;;;2234   
;;;2235   	if (LD_WORD(fs->win+BPB_BytsPerSec) != SS(fs))		/* (BPB_BytsPerSec must be equal to the physical sector size) */
;;;2236   		return FR_NO_FILESYSTEM;
;;;2237   
;;;2238   	fasize = LD_WORD(fs->win+BPB_FATSz16);				/* Number of sectors per FAT */
;;;2239   	if (!fasize) fasize = LD_DWORD(fs->win+BPB_FATSz32);
;;;2240   	fs->fsize = fasize;
;;;2241   
;;;2242   	fs->n_fats = fs->win[BPB_NumFATs];					/* Number of FAT copies */
;;;2243   	if (fs->n_fats != 1 && fs->n_fats != 2)				/* (Must be 1 or 2) */
;;;2244   		return FR_NO_FILESYSTEM;
;;;2245   	fasize *= fs->n_fats;								/* Number of sectors for FAT area */
;;;2246   
;;;2247   	fs->csize = fs->win[BPB_SecPerClus];				/* Number of sectors per cluster */
;;;2248   	if (!fs->csize || (fs->csize & (fs->csize - 1)))	/* (Must be power of 2) */
;;;2249   		return FR_NO_FILESYSTEM;
;;;2250   
;;;2251   	fs->n_rootdir = LD_WORD(fs->win+BPB_RootEntCnt);	/* Number of root directory entries */
;;;2252   	if (fs->n_rootdir % (SS(fs) / SZ_DIR))				/* (Must be sector aligned) */
;;;2253   		return FR_NO_FILESYSTEM;
;;;2254   
;;;2255   	tsect = LD_WORD(fs->win+BPB_TotSec16);				/* Number of sectors on the volume */
;;;2256   	if (!tsect) tsect = LD_DWORD(fs->win+BPB_TotSec32);
;;;2257   
;;;2258   	nrsv = LD_WORD(fs->win+BPB_RsvdSecCnt);				/* Number of reserved sectors */
;;;2259   	if (!nrsv) return FR_NO_FILESYSTEM;					/* (Must not be 0) */
;;;2260   
;;;2261   	/* Determine the FAT sub type */
;;;2262   	sysect = nrsv + fasize + fs->n_rootdir / (SS(fs) / SZ_DIR);	/* RSV+FAT+DIR */
;;;2263   	if (tsect < sysect) return FR_NO_FILESYSTEM;		/* (Invalid volume size) */
;;;2264   	nclst = (tsect - sysect) / fs->csize;				/* Number of clusters */
;;;2265   	if (!nclst) return FR_NO_FILESYSTEM;				/* (Invalid volume size) */
;;;2266   	fmt = FS_FAT12;
;;;2267   	if (nclst >= MIN_FAT16) fmt = FS_FAT16;
;;;2268   	if (nclst >= MIN_FAT32) fmt = FS_FAT32;
;;;2269   
;;;2270   	/* Boundaries and Limits */
;;;2271   	fs->n_fatent = nclst + 2;							/* Number of FAT entries */
;;;2272   	fs->volbase = bsect;								/* Volume start sector */
;;;2273   	fs->fatbase = bsect + nrsv; 						/* FAT start sector */
;;;2274   	fs->database = bsect + sysect;						/* Data start sector */
;;;2275   	if (fmt == FS_FAT32) {
;;;2276   		if (fs->n_rootdir) return FR_NO_FILESYSTEM;		/* (BPB_RootEntCnt must be 0) */
;;;2277   		fs->dirbase = LD_DWORD(fs->win+BPB_RootClus);	/* Root directory start cluster */
;;;2278   		szbfat = fs->n_fatent * 4;						/* (Needed FAT size) */
;;;2279   	} else {
;;;2280   		if (!fs->n_rootdir)	return FR_NO_FILESYSTEM;	/* (BPB_RootEntCnt must not be 0) */
;;;2281   		fs->dirbase = fs->fatbase + fasize;				/* Root directory start sector */
;;;2282   		szbfat = (fmt == FS_FAT16) ?					/* (Needed FAT size) */
;;;2283   			fs->n_fatent * 2 : fs->n_fatent * 3 / 2 + (fs->n_fatent & 1);
;;;2284   	}
;;;2285   	if (fs->fsize < (szbfat + (SS(fs) - 1)) / SS(fs))	/* (BPB_FATSz must not be less than needed) */
;;;2286   		return FR_NO_FILESYSTEM;
;;;2287   
;;;2288   #if !_FS_READONLY
;;;2289   	/* Initialize cluster allocation information */
;;;2290   	fs->last_clust = fs->free_clust = 0xFFFFFFFF;
;;;2291   
;;;2292   	/* Get fsinfo if available */
;;;2293   	fs->fsi_flag = 0x80;
;;;2294   #if (_FS_NOFSINFO & 3) != 3
;;;2295   	if (fmt == FS_FAT32				/* Enable FSINFO only if FAT32 and BPB_FSInfo is 1 */
;;;2296   		&& LD_WORD(fs->win+BPB_FSInfo) == 1
;;;2297   		&& move_window(fs, bsect + 1) == FR_OK)
;;;2298   	{
;;;2299   		fs->fsi_flag = 0;
;;;2300   		if (LD_WORD(fs->win+BS_55AA) == 0xAA55	/* Load FSINFO data if available */
;;;2301   			&& LD_DWORD(fs->win+FSI_LeadSig) == 0x41615252
;;;2302   			&& LD_DWORD(fs->win+FSI_StrucSig) == 0x61417272)
;;;2303   		{
;;;2304   #if (_FS_NOFSINFO & 1) == 0
;;;2305   			fs->free_clust = LD_DWORD(fs->win+FSI_Free_Count);
;;;2306   #endif
;;;2307   #if (_FS_NOFSINFO & 2) == 0
;;;2308   			fs->last_clust = LD_DWORD(fs->win+FSI_Nxt_Free);
;;;2309   #endif
;;;2310   		}
;;;2311   	}
;;;2312   #endif
;;;2313   #endif
;;;2314   	fs->fs_type = fmt;	/* FAT sub-type */
;;;2315   	fs->id = ++Fsid;	/* File system mount ID */
;;;2316   #if _FS_RPATH
;;;2317   	fs->cdir = 0;		/* Set current directory to root */
;;;2318   #endif
;;;2319   #if _FS_LOCK			/* Clear file lock semaphores */
;;;2320   	clear_lock(fs);
;;;2321   #endif
;;;2322   
;;;2323   	return FR_OK;
;;;2324   }
00001c  b004              ADD      sp,sp,#0x10
00001e  e8bd87f0          POP      {r4-r10,pc}
                  |L40.34|
000022  48b8              LDR      r0,|L40.772|
000024  f8504025          LDR      r4,[r0,r5,LSL #2]     ;2183
000028  b18c              CBZ      r4,|L40.78|
00002a  f8c84000          STR      r4,[r8,#0]            ;2187
00002e  7820              LDRB     r0,[r4,#0]            ;2189
000030  b120              CBZ      r0,|L40.60|
000032  7860              LDRB     r0,[r4,#1]            ;2190
000034  f7fffffe          BL       disk_status
000038  07c1              LSLS     r1,r0,#31             ;2191
00003a  d00a              BEQ      |L40.82|
                  |L40.60|
00003c  7027              STRB     r7,[r4,#0]            ;2201
00003e  b2e8              UXTB     r0,r5                 ;2202
000040  7060              STRB     r0,[r4,#1]            ;2202
000042  f7fffffe          BL       disk_initialize
000046  07c1              LSLS     r1,r0,#31             ;2204
000048  d00a              BEQ      |L40.96|
00004a  2003              MOVS     r0,#3                 ;2205
00004c  e7e6              B        |L40.28|
                  |L40.78|
00004e  200c              MOVS     r0,#0xc               ;2184
000050  e7e4              B        |L40.28|
                  |L40.82|
000052  b11e              CBZ      r6,|L40.92|
000054  0740              LSLS     r0,r0,#29             ;2192
000056  d501              BPL      |L40.92|
000058  200a              MOVS     r0,#0xa               ;2193
00005a  e7df              B        |L40.28|
                  |L40.92|
00005c  2000              MOVS     r0,#0                 ;2194
00005e  e7dd              B        |L40.28|
                  |L40.96|
000060  b11e              CBZ      r6,|L40.106|
000062  0740              LSLS     r0,r0,#29             ;2206
000064  d501              BPL      |L40.106|
000066  200a              MOVS     r0,#0xa               ;2207
000068  e7d8              B        |L40.28|
                  |L40.106|
00006a  2500              MOVS     r5,#0                 ;2213
00006c  4629              MOV      r1,r5                 ;2214
00006e  4620              MOV      r0,r4                 ;2214
000070  f7fffffe          BL       check_fs
000074  2801              CMP      r0,#1                 ;2215
000076  d126              BNE      |L40.198|
000078  2100              MOVS     r1,#0                 ;2219
00007a  46e8              MOV      r8,sp                 ;2217
                  |L40.124|
00007c  eb041001          ADD      r0,r4,r1,LSL #4       ;2220
000080  f50070f7          ADD      r0,r0,#0x1ee          ;2220
000084  7902              LDRB     r2,[r0,#4]            ;2221
000086  b152              CBZ      r2,|L40.158|
000088  7a02              LDRB     r2,[r0,#8]            ;2221
00008a  7ac3              LDRB     r3,[r0,#0xb]          ;2221
00008c  ea426203          ORR      r2,r2,r3,LSL #24      ;2221
000090  7a83              LDRB     r3,[r0,#0xa]          ;2221
000092  7a40              LDRB     r0,[r0,#9]            ;2221
000094  041b              LSLS     r3,r3,#16             ;2221
000096  ea432000          ORR      r0,r3,r0,LSL #8       ;2221
00009a  4302              ORRS     r2,r2,r0              ;2221
00009c  e000              B        |L40.160|
                  |L40.158|
00009e  2200              MOVS     r2,#0                 ;2221
                  |L40.160|
0000a0  f8482021          STR      r2,[r8,r1,LSL #2]     ;2221
0000a4  1c49              ADDS     r1,r1,#1              ;2219
0000a6  2904              CMP      r1,#4                 ;2219
0000a8  d3e8              BCC      |L40.124|
0000aa  2600              MOVS     r6,#0                 ;2223
                  |L40.172|
0000ac  f8585026          LDR      r5,[r8,r6,LSL #2]     ;2226
0000b0  b125              CBZ      r5,|L40.188|
0000b2  4629              MOV      r1,r5                 ;2227
0000b4  4620              MOV      r0,r4                 ;2227
0000b6  f7fffffe          BL       check_fs
0000ba  e000              B        |L40.190|
                  |L40.188|
0000bc  2002              MOVS     r0,#2                 ;2227
                  |L40.190|
0000be  b110              CBZ      r0,|L40.198|
0000c0  1c76              ADDS     r6,r6,#1              ;2228
0000c2  2e04              CMP      r6,#4                 ;2228
0000c4  d3f2              BCC      |L40.172|
                  |L40.198|
0000c6  2803              CMP      r0,#3                 ;2230
0000c8  d002              BEQ      |L40.208|
0000ca  b118              CBZ      r0,|L40.212|
0000cc  200d              MOVS     r0,#0xd               ;2231
0000ce  e7a5              B        |L40.28|
                  |L40.208|
0000d0  2001              MOVS     r0,#1                 ;2230
0000d2  e7a3              B        |L40.28|
                  |L40.212|
0000d4  f894003b          LDRB     r0,[r4,#0x3b]         ;2235
0000d8  f894103c          LDRB     r1,[r4,#0x3c]         ;2235
0000dc  ea402001          ORR      r0,r0,r1,LSL #8       ;2235
0000e0  f5b07f00          CMP      r0,#0x200             ;2235
0000e4  d001              BEQ      |L40.234|
0000e6  200d              MOVS     r0,#0xd               ;2236
0000e8  e798              B        |L40.28|
                  |L40.234|
0000ea  f8940046          LDRB     r0,[r4,#0x46]         ;2238
0000ee  f8941047          LDRB     r1,[r4,#0x47]         ;2238
0000f2  ea402001          ORR      r0,r0,r1,LSL #8       ;2238
0000f6  b958              CBNZ     r0,|L40.272|
0000f8  f8140f54          LDRB     r0,[r4,#0x54]!        ;2239
0000fc  78e1              LDRB     r1,[r4,#3]            ;2239
0000fe  7862              LDRB     r2,[r4,#1]            ;2239
000100  ea406001          ORR      r0,r0,r1,LSL #24      ;2239
000104  78a1              LDRB     r1,[r4,#2]            ;2239
000106  0409              LSLS     r1,r1,#16             ;2239
000108  3c54              SUBS     r4,r4,#0x54           ;2239
00010a  ea412102          ORR      r1,r1,r2,LSL #8       ;2239
00010e  4308              ORRS     r0,r0,r1              ;2239
                  |L40.272|
000110  61a0              STR      r0,[r4,#0x18]         ;2240
000112  f8949040          LDRB     r9,[r4,#0x40]         ;2242
000116  f8849003          STRB     r9,[r4,#3]            ;2242
00011a  f1b90f01          CMP      r9,#1                 ;2243
00011e  d004              BEQ      |L40.298|
000120  f1b90f02          CMP      r9,#2                 ;2243
000124  d001              BEQ      |L40.298|
000126  200d              MOVS     r0,#0xd               ;2244
000128  e778              B        |L40.28|
                  |L40.298|
00012a  fb09f900          MUL      r9,r9,r0              ;2245
00012e  f894203d          LDRB     r2,[r4,#0x3d]         ;2247
000132  70a2              STRB     r2,[r4,#2]            ;2247
000134  b112              CBZ      r2,|L40.316|
000136  1e51              SUBS     r1,r2,#1              ;2248
000138  420a              TST      r2,r1                 ;2248
00013a  d001              BEQ      |L40.320|
                  |L40.316|
00013c  200d              MOVS     r0,#0xd               ;2249
00013e  e76d              B        |L40.28|
                  |L40.320|
000140  f8941041          LDRB     r1,[r4,#0x41]         ;2251
000144  f8943042          LDRB     r3,[r4,#0x42]         ;2251
000148  ea412303          ORR      r3,r1,r3,LSL #8       ;2251
00014c  8123              STRH     r3,[r4,#8]            ;2251
00014e  0719              LSLS     r1,r3,#28             ;2252
000150  d001              BEQ      |L40.342|
000152  200d              MOVS     r0,#0xd               ;2253
000154  e762              B        |L40.28|
                  |L40.342|
000156  f8941043          LDRB     r1,[r4,#0x43]         ;2255
00015a  f8946044          LDRB     r6,[r4,#0x44]         ;2255
00015e  ea412106          ORR      r1,r1,r6,LSL #8       ;2255
000162  b961              CBNZ     r1,|L40.382|
000164  f8141f50          LDRB     r1,[r4,#0x50]!        ;2256
000168  78e6              LDRB     r6,[r4,#3]            ;2256
00016a  f894c001          LDRB     r12,[r4,#1]           ;2256
00016e  ea416106          ORR      r1,r1,r6,LSL #24      ;2256
000172  78a6              LDRB     r6,[r4,#2]            ;2256
000174  0436              LSLS     r6,r6,#16             ;2256
000176  3c50              SUBS     r4,r4,#0x50           ;2256
000178  ea46260c          ORR      r6,r6,r12,LSL #8      ;2256
00017c  4331              ORRS     r1,r1,r6              ;2256
                  |L40.382|
00017e  f894603e          LDRB     r6,[r4,#0x3e]         ;2258
000182  f894c03f          LDRB     r12,[r4,#0x3f]        ;2258
000186  ea46280c          ORR      r8,r6,r12,LSL #8      ;2258
00018a  f1b80f00          CMP      r8,#0                 ;2259
00018e  d007              BEQ      |L40.416|
000190  eb080609          ADD      r6,r8,r9              ;2262
000194  eb061c13          ADD      r12,r6,r3,LSR #4      ;2262
000198  4561              CMP      r1,r12                ;2263
00019a  d203              BCS      |L40.420|
00019c  200d              MOVS     r0,#0xd               ;2263
00019e  e73d              B        |L40.28|
                  |L40.416|
0001a0  200d              MOVS     r0,#0xd               ;2259
0001a2  e73b              B        |L40.28|
                  |L40.420|
0001a4  eba1010c          SUB      r1,r1,r12             ;2264
0001a8  fbb1f1f2          UDIV     r1,r1,r2              ;2264
0001ac  b339              CBZ      r1,|L40.510|
0001ae  2601              MOVS     r6,#1                 ;2266
0001b0  f64072f6          MOV      r2,#0xff6             ;2267
0001b4  4291              CMP      r1,r2                 ;2267
0001b6  d300              BCC      |L40.442|
0001b8  2602              MOVS     r6,#2                 ;2267
                  |L40.442|
0001ba  f64f72f6          MOV      r2,#0xfff6            ;2268
0001be  4291              CMP      r1,r2                 ;2268
0001c0  d300              BCC      |L40.452|
0001c2  2603              MOVS     r6,#3                 ;2268
                  |L40.452|
0001c4  1c89              ADDS     r1,r1,#2              ;2271
0001c6  6161              STR      r1,[r4,#0x14]         ;2271
0001c8  61e5              STR      r5,[r4,#0x1c]         ;2272
0001ca  eb050208          ADD      r2,r5,r8              ;2273
0001ce  6222              STR      r2,[r4,#0x20]         ;2273
0001d0  44ac              ADD      r12,r12,r5            ;2274
0001d2  f8c4c028          STR      r12,[r4,#0x28]        ;2274
0001d6  2e03              CMP      r6,#3                 ;2275
0001d8  d013              BEQ      |L40.514|
0001da  b333              CBZ      r3,|L40.554|
0001dc  444a              ADD      r2,r2,r9              ;2281
0001de  6262              STR      r2,[r4,#0x24]         ;2281
0001e0  2e02              CMP      r6,#2                 ;2282
0001e2  d024              BEQ      |L40.558|
0001e4  f0010201          AND      r2,r1,#1              ;2283
0001e8  eb010141          ADD      r1,r1,r1,LSL #1       ;2283
0001ec  eb020151          ADD      r1,r2,r1,LSR #1       ;2283
                  |L40.496|
0001f0  f20111ff          ADD      r1,r1,#0x1ff          ;2285
0001f4  ebb02f51          CMP      r0,r1,LSR #9          ;2285
0001f8  d21b              BCS      |L40.562|
0001fa  200d              MOVS     r0,#0xd               ;2286
0001fc  e70e              B        |L40.28|
                  |L40.510|
0001fe  200d              MOVS     r0,#0xd               ;2265
000200  e70c              B        |L40.28|
                  |L40.514|
000202  b10b              CBZ      r3,|L40.520|
000204  200d              MOVS     r0,#0xd               ;2276
000206  e709              B        |L40.28|
                  |L40.520|
000208  f894205c          LDRB     r2,[r4,#0x5c]         ;2277
00020c  f894305f          LDRB     r3,[r4,#0x5f]         ;2277
000210  f894c05d          LDRB     r12,[r4,#0x5d]        ;2277
000214  ea426203          ORR      r2,r2,r3,LSL #24      ;2277
000218  f894305e          LDRB     r3,[r4,#0x5e]         ;2277
00021c  041b              LSLS     r3,r3,#16             ;2277
00021e  ea43230c          ORR      r3,r3,r12,LSL #8      ;2277
000222  431a              ORRS     r2,r2,r3              ;2277
000224  6262              STR      r2,[r4,#0x24]         ;2277
000226  0089              LSLS     r1,r1,#2              ;2278
000228  e7e2              B        |L40.496|
                  |L40.554|
00022a  200d              MOVS     r0,#0xd               ;2280
00022c  e6f6              B        |L40.28|
                  |L40.558|
00022e  0049              LSLS     r1,r1,#1              ;2283
000230  e7de              B        |L40.496|
                  |L40.562|
000232  f04f30ff          MOV      r0,#0xffffffff        ;2290
000236  6120              STR      r0,[r4,#0x10]         ;2290
000238  60e0              STR      r0,[r4,#0xc]          ;2290
00023a  2080              MOVS     r0,#0x80              ;2293
00023c  7160              STRB     r0,[r4,#5]            ;2293
00023e  2e03              CMP      r6,#3                 ;2295
000240  d157              BNE      |L40.754|
000242  f8940060          LDRB     r0,[r4,#0x60]         ;2296
000246  f8941061          LDRB     r1,[r4,#0x61]         ;2296
00024a  ea402001          ORR      r0,r0,r1,LSL #8       ;2296
00024e  2801              CMP      r0,#1                 ;2296
000250  d14f              BNE      |L40.754|
000252  1c69              ADDS     r1,r5,#1              ;2297
000254  4620              MOV      r0,r4                 ;2297
000256  f7fffffe          BL       move_window
00025a  bbe0              CBNZ     r0,|L40.726|
00025c  7167              STRB     r7,[r4,#5]            ;2299
00025e  f894022e          LDRB     r0,[r4,#0x22e]        ;2300
000262  f894122f          LDRB     r1,[r4,#0x22f]        ;2300
000266  ea402001          ORR      r0,r0,r1,LSL #8       ;2300
00026a  f5a0412a          SUB      r1,r0,#0xaa00         ;2300
00026e  3955              SUBS     r1,r1,#0x55           ;2300
000270  d13f              BNE      |L40.754|
000272  f8140f30          LDRB     r0,[r4,#0x30]!        ;2301
000276  78e1              LDRB     r1,[r4,#3]            ;2301
000278  7862              LDRB     r2,[r4,#1]            ;2301
00027a  ea406001          ORR      r0,r0,r1,LSL #24      ;2301
00027e  78a1              LDRB     r1,[r4,#2]            ;2301
000280  3c30              SUBS     r4,r4,#0x30           ;2301
000282  0409              LSLS     r1,r1,#16             ;2301
000284  ea412102          ORR      r1,r1,r2,LSL #8       ;2301
000288  4308              ORRS     r0,r0,r1              ;2301
00028a  491f              LDR      r1,|L40.776|
00028c  4288              CMP      r0,r1                 ;2301
00028e  d130              BNE      |L40.754|
000290  f8940214          LDRB     r0,[r4,#0x214]        ;2302
000294  f8941217          LDRB     r1,[r4,#0x217]        ;2302
000298  f8942215          LDRB     r2,[r4,#0x215]        ;2302
00029c  ea406001          ORR      r0,r0,r1,LSL #24      ;2302
0002a0  f8941216          LDRB     r1,[r4,#0x216]        ;2302
0002a4  0409              LSLS     r1,r1,#16             ;2302
0002a6  ea412102          ORR      r1,r1,r2,LSL #8       ;2302
0002aa  4308              ORRS     r0,r0,r1              ;2302
0002ac  4917              LDR      r1,|L40.780|
0002ae  4288              CMP      r0,r1                 ;2302
0002b0  d11f              BNE      |L40.754|
0002b2  f8940218          LDRB     r0,[r4,#0x218]        ;2305
0002b6  f894121b          LDRB     r1,[r4,#0x21b]        ;2305
0002ba  f8942219          LDRB     r2,[r4,#0x219]        ;2305
0002be  ea406001          ORR      r0,r0,r1,LSL #24      ;2305
0002c2  f894121a          LDRB     r1,[r4,#0x21a]        ;2305
0002c6  0409              LSLS     r1,r1,#16             ;2305
0002c8  ea412102          ORR      r1,r1,r2,LSL #8       ;2305
0002cc  4308              ORRS     r0,r0,r1              ;2305
0002ce  6120              STR      r0,[r4,#0x10]         ;2305
0002d0  f894021c          LDRB     r0,[r4,#0x21c]        ;2308
0002d4  e000              B        |L40.728|
                  |L40.726|
0002d6  e00c              B        |L40.754|
                  |L40.728|
0002d8  f894121f          LDRB     r1,[r4,#0x21f]        ;2308
0002dc  f894221d          LDRB     r2,[r4,#0x21d]        ;2308
0002e0  ea406001          ORR      r0,r0,r1,LSL #24      ;2308
0002e4  f894121e          LDRB     r1,[r4,#0x21e]        ;2308
0002e8  0409              LSLS     r1,r1,#16             ;2308
0002ea  ea412102          ORR      r1,r1,r2,LSL #8       ;2308
0002ee  4308              ORRS     r0,r0,r1              ;2308
0002f0  60e0              STR      r0,[r4,#0xc]          ;2308
                  |L40.754|
0002f2  7026              STRB     r6,[r4,#0]            ;2314
0002f4  4906              LDR      r1,|L40.784|
0002f6  8808              LDRH     r0,[r1,#0]            ;2315  ; Fsid
0002f8  1c40              ADDS     r0,r0,#1              ;2315
0002fa  8008              STRH     r0,[r1,#0]            ;2315
0002fc  80e0              STRH     r0,[r4,#6]            ;2315
0002fe  2000              MOVS     r0,#0                 ;2323
000300  e68c              B        |L40.28|
;;;2325   
                          ENDP

000302  0000              DCW      0x0000
                  |L40.772|
                          DCD      ||.bss||
                  |L40.776|
                          DCD      0x41615252
                  |L40.780|
                          DCD      0x61417272
                  |L40.784|
                          DCD      ||.data||

                          AREA ||i.fit_lfn||, CODE, READONLY, ALIGN=2

                  fit_lfn PROC
;;;1371   static
;;;1372   void fit_lfn (
000000  e92d43f0          PUSH     {r4-r9,lr}
;;;1373   	const WCHAR* lfnbuf,	/* Pointer to the LFN buffer */
;;;1374   	BYTE* dir,				/* Pointer to the directory entry */
;;;1375   	BYTE ord,				/* LFN order (1-20) */
;;;1376   	BYTE sum				/* SFN sum */
;;;1377   )
;;;1378   {
;;;1379   	UINT i, s;
;;;1380   	WCHAR wc;
;;;1381   
;;;1382   
;;;1383   	dir[LDIR_Chksum] = sum;			/* Set check sum */
000004  734b              STRB     r3,[r1,#0xd]
;;;1384   	dir[LDIR_Attr] = AM_LFN;		/* Set attribute. LFN entry */
000006  230f              MOVS     r3,#0xf
000008  72cb              STRB     r3,[r1,#0xb]
;;;1385   	dir[LDIR_Type] = 0;
00000a  2300              MOVS     r3,#0
00000c  730b              STRB     r3,[r1,#0xc]
;;;1386   	ST_WORD(dir+LDIR_FstClusLO, 0);
00000e  768b              STRB     r3,[r1,#0x1a]
000010  76cb              STRB     r3,[r1,#0x1b]
;;;1387   
;;;1388   	i = (ord - 1) * 13;				/* Get offset in the LFN buffer */
000012  1e53              SUBS     r3,r2,#1
000014  eb030483          ADD      r4,r3,r3,LSL #2
000018  eb0405c3          ADD      r5,r4,r3,LSL #3
;;;1389   	s = wc = 0;
00001c  2300              MOVS     r3,#0
00001e  461c              MOV      r4,r3
;;;1390   	do {
;;;1391   		if (wc != 0xFFFF) wc = lfnbuf[i++];	/* Get an effective character */
;;;1392   		ST_WORD(dir+LfnOfs[s], wc);	/* Put it */
000020  4e11              LDR      r6,|L41.104|
000022  f1010c01          ADD      r12,r1,#1
000026  f64f77ff          MOV      r7,#0xffff            ;1391
                  |L41.42|
00002a  42bb              CMP      r3,r7                 ;1391
00002c  d003              BEQ      |L41.54|
00002e  462b              MOV      r3,r5                 ;1391
000030  1c6d              ADDS     r5,r5,#1              ;1391
000032  f8303013          LDRH     r3,[r0,r3,LSL #1]     ;1391
                  |L41.54|
000036  f8168004          LDRB     r8,[r6,r4]
00003a  f8013008          STRB     r3,[r1,r8]
00003e  f8169004          LDRB     r9,[r6,r4]
000042  ea4f2813          LSR      r8,r3,#8
000046  f809800c          STRB     r8,[r9,r12]
;;;1393   		if (!wc) wc = 0xFFFF;		/* Padding characters following last character */
00004a  b903              CBNZ     r3,|L41.78|
00004c  463b              MOV      r3,r7
                  |L41.78|
;;;1394   	} while (++s < 13);
00004e  1c64              ADDS     r4,r4,#1
000050  2c0d              CMP      r4,#0xd
000052  d3ea              BCC      |L41.42|
;;;1395   	if (wc == 0xFFFF || !lfnbuf[i]) ord |= LLE;	/* Bottom LFN part is the start of LFN sequence */
000054  42bb              CMP      r3,r7
000056  d002              BEQ      |L41.94|
000058  f8300015          LDRH     r0,[r0,r5,LSL #1]
00005c  b908              CBNZ     r0,|L41.98|
                  |L41.94|
00005e  f0420240          ORR      r2,r2,#0x40
                  |L41.98|
;;;1396   	dir[LDIR_Ord] = ord;			/* Set the LFN order */
000062  700a              STRB     r2,[r1,#0]
;;;1397   }
000064  e8bd83f0          POP      {r4-r9,pc}
;;;1398   
                          ENDP

                  |L41.104|
                          DCD      ||.constdata||

                          AREA ||i.follow_path||, CODE, READONLY, ALIGN=1

                  follow_path PROC
;;;2013   static
;;;2014   FRESULT follow_path (	/* FR_OK(0): successful, !=0: error code */
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;2015   	DIR* dp,			/* Directory object to return last directory and found object */
;;;2016   	const TCHAR* path	/* Full-path string to find a file or directory */
;;;2017   )
;;;2018   {
000002  4604              MOV      r4,r0
;;;2019   	FRESULT res;
;;;2020   	BYTE *dir, ns;
;;;2021   
;;;2022   
;;;2023   #if _FS_RPATH
;;;2024   	if (*path == '/' || *path == '\\') {	/* There is a heading separator */
;;;2025   		path++;	dp->sclust = 0;				/* Strip it and start from the root directory */
;;;2026   	} else {								/* No heading separator */
;;;2027   		dp->sclust = dp->fs->cdir;			/* Start from the current directory */
;;;2028   	}
;;;2029   #else
;;;2030   	if (*path == '/' || *path == '\\')		/* Strip heading separator if exist */
000004  9901              LDR      r1,[sp,#4]
000006  7808              LDRB     r0,[r1,#0]
000008  282f              CMP      r0,#0x2f
00000a  d001              BEQ      |L42.16|
00000c  285c              CMP      r0,#0x5c
00000e  d101              BNE      |L42.20|
                  |L42.16|
;;;2031   		path++;
000010  1c49              ADDS     r1,r1,#1
000012  9101              STR      r1,[sp,#4]
                  |L42.20|
;;;2032   	dp->sclust = 0;							/* Always start from the root directory */
000014  2500              MOVS     r5,#0
000016  60a5              STR      r5,[r4,#8]
;;;2033   #endif
;;;2034   
;;;2035   	if ((UINT)*path < ' ') {				/* Null path name is the origin directory itself */
000018  9801              LDR      r0,[sp,#4]
00001a  7800              LDRB     r0,[r0,#0]
00001c  2820              CMP      r0,#0x20
00001e  d205              BCS      |L42.44|
;;;2036   		res = dir_sdi(dp, 0);
000020  2100              MOVS     r1,#0
000022  4620              MOV      r0,r4
000024  f7fffffe          BL       dir_sdi
;;;2037   		dp->dir = 0;
000028  6165              STR      r5,[r4,#0x14]
                  |L42.42|
;;;2038   	} else {								/* Follow path */
;;;2039   		for (;;) {
;;;2040   			res = create_name(dp, &path);	/* Get a segment name of the path */
;;;2041   			if (res != FR_OK) break;
;;;2042   			res = dir_find(dp);				/* Find an object with the sagment name */
;;;2043   			ns = dp->fn[NS];
;;;2044   			if (res != FR_OK) {				/* Failed to find the object */
;;;2045   				if (res == FR_NO_FILE) {	/* Object is not found */
;;;2046   					if (_FS_RPATH && (ns & NS_DOT)) {	/* If dot entry is not exist, */
;;;2047   						dp->sclust = 0; dp->dir = 0;	/* it is the root directory and stay there */
;;;2048   						if (!(ns & NS_LAST)) continue;	/* Continue to follow if not last segment */
;;;2049   						res = FR_OK;					/* Ended at the root directroy. Function completed. */
;;;2050   					} else {							/* Could not find the object */
;;;2051   						if (!(ns & NS_LAST)) res = FR_NO_PATH;	/* Adjust error code if not last segment */
;;;2052   					}
;;;2053   				}
;;;2054   				break;
;;;2055   			}
;;;2056   			if (ns & NS_LAST) break;			/* Last segment matched. Function completed. */
;;;2057   			dir = dp->dir;						/* Follow the sub-directory */
;;;2058   			if (!(dir[DIR_Attr] & AM_DIR)) {	/* It is not a sub-directory and cannot follow */
;;;2059   				res = FR_NO_PATH; break;
;;;2060   			}
;;;2061   			dp->sclust = ld_clust(dp->fs, dir);
;;;2062   		}
;;;2063   	}
;;;2064   
;;;2065   	return res;
;;;2066   }
00002a  bd7c              POP      {r2-r6,pc}
                  |L42.44|
00002c  a901              ADD      r1,sp,#4              ;2040
00002e  4620              MOV      r0,r4                 ;2040
000030  f7fffffe          BL       create_name
000034  2800              CMP      r0,#0                 ;2041
000036  d1f8              BNE      |L42.42|
000038  4620              MOV      r0,r4                 ;2042
00003a  f7fffffe          BL       dir_find
00003e  69a1              LDR      r1,[r4,#0x18]         ;2043
000040  7ac9              LDRB     r1,[r1,#0xb]          ;2043
000042  b128              CBZ      r0,|L42.80|
000044  2804              CMP      r0,#4                 ;2045
000046  d1f0              BNE      |L42.42|
000048  0749              LSLS     r1,r1,#29             ;2051
00004a  d4ee              BMI      |L42.42|
00004c  2005              MOVS     r0,#5                 ;2051
                  |L42.78|
00004e  bd7c              POP      {r2-r6,pc}
                  |L42.80|
000050  0749              LSLS     r1,r1,#29             ;2056
000052  d4fc              BMI      |L42.78|
000054  6961              LDR      r1,[r4,#0x14]         ;2057
000056  7ac8              LDRB     r0,[r1,#0xb]          ;2058
000058  06c0              LSLS     r0,r0,#27             ;2058
00005a  d401              BMI      |L42.96|
00005c  2005              MOVS     r0,#5                 ;2059
00005e  bd7c              POP      {r2-r6,pc}
                  |L42.96|
000060  6820              LDR      r0,[r4,#0]            ;2061
000062  f7fffffe          BL       ld_clust
000066  60a0              STR      r0,[r4,#8]            ;2061
000068  e7e0              B        |L42.44|
;;;2067   
                          ENDP


                          AREA ||i.gen_numname||, CODE, READONLY, ALIGN=2

                  gen_numname PROC
;;;1409   static
;;;1410   void gen_numname (
000000  b57c              PUSH     {r2-r6,lr}
;;;1411   	BYTE* dst,			/* Pointer to the buffer to store numbered SFN */
;;;1412   	const BYTE* src,	/* Pointer to SFN */
;;;1413   	const WCHAR* lfn,	/* Pointer to LFN */
;;;1414   	UINT seq			/* Sequence number */
;;;1415   )
;;;1416   {
000002  4605              MOV      r5,r0
000004  4616              MOV      r6,r2
000006  461c              MOV      r4,r3
;;;1417   	BYTE ns[8], c;
;;;1418   	UINT i, j;
;;;1419   
;;;1420   
;;;1421   	mem_cpy(dst, src, 11);
000008  220b              MOVS     r2,#0xb
00000a  4628              MOV      r0,r5
00000c  f7fffffe          BL       mem_cpy
;;;1422   
;;;1423   	if (seq > 5) {	/* On many collisions, generate a hash number instead of sequential number */
000010  2c05              CMP      r4,#5
000012  d912              BLS      |L43.58|
;;;1424   		WCHAR wc;
;;;1425   		DWORD sr = seq;
;;;1426   
;;;1427   		while (*lfn) {	/* Create a CRC */
;;;1428   			wc = *lfn++;
;;;1429   			for (i = 0; i < 16; i++) {
;;;1430   				sr = (sr << 1) + (wc & 1);
;;;1431   				wc >>= 1;
;;;1432   				if (sr & 0x10000) sr ^= 0x11021;
000014  481f              LDR      r0,|L43.148|
000016  e00d              B        |L43.52|
                  |L43.24|
000018  1cb6              ADDS     r6,r6,#2              ;1428
00001a  2300              MOVS     r3,#0                 ;1429
                  |L43.28|
00001c  4622              MOV      r2,r4                 ;1430
00001e  460c              MOV      r4,r1                 ;1430
000020  f362045f          BFI      r4,r2,#1,#31          ;1430
000024  ea4f0151          LSR      r1,r1,#1              ;1431
000028  03e2              LSLS     r2,r4,#15
00002a  d500              BPL      |L43.46|
00002c  4044              EORS     r4,r4,r0
                  |L43.46|
00002e  1c5b              ADDS     r3,r3,#1              ;1429
000030  2b10              CMP      r3,#0x10              ;1429
000032  d3f3              BCC      |L43.28|
                  |L43.52|
000034  8831              LDRH     r1,[r6,#0]            ;1427
000036  2900              CMP      r1,#0                 ;1427
000038  d1ee              BNE      |L43.24|
                  |L43.58|
;;;1433   			}
;;;1434   		}
;;;1435   		seq = (UINT)sr;
;;;1436   	}
;;;1437   
;;;1438   	/* itoa (hexdecimal) */
;;;1439   	i = 7;
00003a  2207              MOVS     r2,#7
00003c  466b              MOV      r3,sp                 ;1417
                  |L43.62|
;;;1440   	do {
;;;1441   		c = (seq % 16) + '0';
00003e  f004010f          AND      r1,r4,#0xf
000042  3130              ADDS     r1,r1,#0x30
;;;1442   		if (c > '9') c += 7;
000044  2939              CMP      r1,#0x39
000046  d901              BLS      |L43.76|
000048  1dc9              ADDS     r1,r1,#7
00004a  b2c9              UXTB     r1,r1
                  |L43.76|
;;;1443   		ns[i--] = c;
00004c  4610              MOV      r0,r2
00004e  1e52              SUBS     r2,r2,#1
000050  5419              STRB     r1,[r3,r0]
;;;1444   		seq /= 16;
000052  0924              LSRS     r4,r4,#4
;;;1445   	} while (seq);
000054  2c00              CMP      r4,#0
000056  d1f2              BNE      |L43.62|
;;;1446   	ns[i] = '~';
000058  207e              MOVS     r0,#0x7e
00005a  5498              STRB     r0,[r3,r2]
;;;1447   
;;;1448   	/* Append the number */
;;;1449   	for (j = 0; j < i && dst[j] != ' '; j++) {
00005c  2100              MOVS     r1,#0
00005e  1e54              SUBS     r4,r2,#1              ;1443
000060  e006              B        |L43.112|
                  |L43.98|
;;;1450   		if (IsDBCS1(dst[j])) {
000062  3881              SUBS     r0,r0,#0x81
000064  287d              CMP      r0,#0x7d
000066  d802              BHI      |L43.110|
;;;1451   			if (j == i - 1) break;
000068  42a1              CMP      r1,r4
00006a  d006              BEQ      |L43.122|
;;;1452   			j++;
00006c  1c49              ADDS     r1,r1,#1
                  |L43.110|
00006e  1c49              ADDS     r1,r1,#1              ;1449
                  |L43.112|
000070  4291              CMP      r1,r2                 ;1449
000072  d202              BCS      |L43.122|
000074  5c68              LDRB     r0,[r5,r1]            ;1449
000076  2820              CMP      r0,#0x20              ;1449
000078  d1f3              BNE      |L43.98|
                  |L43.122|
;;;1453   		}
;;;1454   	}
;;;1455   	do {
;;;1456   		dst[j++] = (i < 8) ? ns[i++] : ' ';
00007a  2a08              CMP      r2,#8
00007c  d203              BCS      |L43.134|
00007e  4610              MOV      r0,r2
000080  1c52              ADDS     r2,r2,#1
000082  5c18              LDRB     r0,[r3,r0]
000084  e000              B        |L43.136|
                  |L43.134|
000086  2020              MOVS     r0,#0x20
                  |L43.136|
000088  460c              MOV      r4,r1
00008a  1c49              ADDS     r1,r1,#1
00008c  5528              STRB     r0,[r5,r4]
;;;1457   	} while (j < 8);
00008e  2908              CMP      r1,#8
000090  d3f3              BCC      |L43.122|
;;;1458   }
000092  bd7c              POP      {r2-r6,pc}
;;;1459   #endif
                          ENDP

                  |L43.148|
                          DCD      0x00011021

                          AREA ||i.get_fat||, CODE, READONLY, ALIGN=1

                  get_fat PROC
;;;864    
;;;865    DWORD get_fat (	/* 0xFFFFFFFF:Disk error, 1:Internal error, Else:Cluster status */
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;866    	FATFS* fs,	/* File system object */
;;;867    	DWORD clst	/* Cluster# to get the link information */
;;;868    )
;;;869    {
000004  4604              MOV      r4,r0
000006  460d              MOV      r5,r1
;;;870    	UINT wc, bc;
;;;871    	BYTE *p;
;;;872    
;;;873    
;;;874    	if (clst < 2 || clst >= fs->n_fatent)	/* Check range */
000008  2d02              CMP      r5,#2
00000a  d302              BCC      |L44.18|
00000c  6960              LDR      r0,[r4,#0x14]
00000e  42a8              CMP      r0,r5
000010  d802              BHI      |L44.24|
                  |L44.18|
;;;875    		return 1;
000012  2001              MOVS     r0,#1
                  |L44.20|
;;;876    
;;;877    	switch (fs->fs_type) {
;;;878    	case FS_FAT12 :
;;;879    		bc = (UINT)clst; bc += bc / 2;
;;;880    		if (move_window(fs, fs->fatbase + (bc / SS(fs)))) break;
;;;881    		wc = fs->win[bc % SS(fs)]; bc++;
;;;882    		if (move_window(fs, fs->fatbase + (bc / SS(fs)))) break;
;;;883    		wc |= fs->win[bc % SS(fs)] << 8;
;;;884    		return clst & 1 ? wc >> 4 : (wc & 0xFFF);
;;;885    
;;;886    	case FS_FAT16 :
;;;887    		if (move_window(fs, fs->fatbase + (clst / (SS(fs) / 2)))) break;
;;;888    		p = &fs->win[clst * 2 % SS(fs)];
;;;889    		return LD_WORD(p);
;;;890    
;;;891    	case FS_FAT32 :
;;;892    		if (move_window(fs, fs->fatbase + (clst / (SS(fs) / 4)))) break;
;;;893    		p = &fs->win[clst * 4 % SS(fs)];
;;;894    		return LD_DWORD(p) & 0x0FFFFFFF;
;;;895    
;;;896    	default:
;;;897    		return 1;
;;;898    	}
;;;899    
;;;900    	return 0xFFFFFFFF;	/* An error occurred at the disk I/O layer */
;;;901    }
000014  e8bd81f0          POP      {r4-r8,pc}
                  |L44.24|
000018  7820              LDRB     r0,[r4,#0]            ;877
00001a  2801              CMP      r0,#1                 ;877
00001c  d005              BEQ      |L44.42|
00001e  2802              CMP      r0,#2                 ;877
000020  d027              BEQ      |L44.114|
000022  2803              CMP      r0,#3                 ;877
000024  d035              BEQ      |L44.146|
000026  2001              MOVS     r0,#1                 ;897
000028  e7f4              B        |L44.20|
                  |L44.42|
00002a  eb050655          ADD      r6,r5,r5,LSR #1       ;879
00002e  6a20              LDR      r0,[r4,#0x20]         ;880
000030  eb002156          ADD      r1,r0,r6,LSR #9       ;880
000034  4620              MOV      r0,r4                 ;880
000036  f7fffffe          BL       move_window
00003a  bb88              CBNZ     r0,|L44.160|
00003c  f3c60008          UBFX     r0,r6,#0,#9           ;881
000040  4420              ADD      r0,r0,r4              ;881
000042  f8907030          LDRB     r7,[r0,#0x30]         ;881
000046  1c76              ADDS     r6,r6,#1              ;881
000048  6a20              LDR      r0,[r4,#0x20]         ;882
00004a  eb002156          ADD      r1,r0,r6,LSR #9       ;882
00004e  4620              MOV      r0,r4                 ;882
000050  f7fffffe          BL       move_window
000054  bb20              CBNZ     r0,|L44.160|
000056  f3c60008          UBFX     r0,r6,#0,#9           ;883
00005a  4420              ADD      r0,r0,r4              ;883
00005c  f8900030          LDRB     r0,[r0,#0x30]         ;883
000060  ea472000          ORR      r0,r7,r0,LSL #8       ;883
000064  07e9              LSLS     r1,r5,#31             ;884
000066  d001              BEQ      |L44.108|
000068  0900              LSRS     r0,r0,#4              ;884
00006a  e7d3              B        |L44.20|
                  |L44.108|
00006c  f3c0000b          UBFX     r0,r0,#0,#12          ;884
000070  e7d0              B        |L44.20|
                  |L44.114|
000072  6a20              LDR      r0,[r4,#0x20]         ;887
000074  eb002115          ADD      r1,r0,r5,LSR #8       ;887
000078  4620              MOV      r0,r4                 ;887
00007a  f7fffffe          BL       move_window
00007e  b978              CBNZ     r0,|L44.160|
000080  b2e8              UXTB     r0,r5                 ;888
000082  eb040040          ADD      r0,r4,r0,LSL #1       ;888
000086  3030              ADDS     r0,r0,#0x30           ;888
000088  7801              LDRB     r1,[r0,#0]            ;889
00008a  7840              LDRB     r0,[r0,#1]            ;889
00008c  ea412000          ORR      r0,r1,r0,LSL #8       ;889
000090  e7c0              B        |L44.20|
                  |L44.146|
000092  6a20              LDR      r0,[r4,#0x20]         ;892
000094  eb0011d5          ADD      r1,r0,r5,LSR #7       ;892
000098  4620              MOV      r0,r4                 ;892
00009a  f7fffffe          BL       move_window
00009e  b110              CBZ      r0,|L44.166|
                  |L44.160|
0000a0  f04f30ff          MOV      r0,#0xffffffff        ;900
0000a4  e7b6              B        |L44.20|
                  |L44.166|
0000a6  f24010ff          MOV      r0,#0x1ff             ;893
0000aa  ea000085          AND      r0,r0,r5,LSL #2       ;893
0000ae  4420              ADD      r0,r0,r4              ;893
0000b0  3030              ADDS     r0,r0,#0x30           ;893
0000b2  7801              LDRB     r1,[r0,#0]            ;894
0000b4  78c2              LDRB     r2,[r0,#3]            ;894
0000b6  ea416102          ORR      r1,r1,r2,LSL #24      ;894
0000ba  7882              LDRB     r2,[r0,#2]            ;894
0000bc  7840              LDRB     r0,[r0,#1]            ;894
0000be  0412              LSLS     r2,r2,#16             ;894
0000c0  ea422000          ORR      r0,r2,r0,LSL #8       ;894
0000c4  4301              ORRS     r1,r1,r0              ;894
0000c6  f0214070          BIC      r0,r1,#0xf0000000     ;894
0000ca  e7a3              B        |L44.20|
;;;902    
                          ENDP


                          AREA ||i.get_fileinfo||, CODE, READONLY, ALIGN=1

                  get_fileinfo PROC
;;;1733   static
;;;1734   void get_fileinfo (		/* No return code */
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;1735   	DIR* dp,			/* Pointer to the directory object */
;;;1736   	FILINFO* fno	 	/* Pointer to the file information to be filled */
;;;1737   )
;;;1738   {
000004  460e              MOV      r6,r1
;;;1739   	UINT i;
;;;1740   	TCHAR *p, c;
;;;1741   
;;;1742   
;;;1743   	p = fno->fname;
000006  f1060509          ADD      r5,r6,#9
;;;1744   	if (dp->sect) {		/* Get SFN */
00000a  6901              LDR      r1,[r0,#0x10]
00000c  2900              CMP      r1,#0
00000e  d037              BEQ      |L45.128|
;;;1745   		BYTE *dir = dp->dir;
000010  6943              LDR      r3,[r0,#0x14]
;;;1746   
;;;1747   		i = 0;
000012  2400              MOVS     r4,#0
                  |L45.20|
;;;1748   		while (i < 11) {		/* Copy name body and extension */
;;;1749   			c = (TCHAR)dir[i++];
000014  4621              MOV      r1,r4
000016  1c64              ADDS     r4,r4,#1
000018  5c5a              LDRB     r2,[r3,r1]
;;;1750   			if (c == ' ') continue;			/* Skip padding spaces */
00001a  2a20              CMP      r2,#0x20
00001c  d017              BEQ      |L45.78|
;;;1751   			if (c == NDDE) c = (TCHAR)DDE;	/* Restore replaced DDE character */
00001e  2a05              CMP      r2,#5
000020  d100              BNE      |L45.36|
000022  22e5              MOVS     r2,#0xe5
                  |L45.36|
;;;1752   			if (i == 9) *p++ = '.';			/* Insert a . if extension is exist */
000024  2c09              CMP      r4,#9
000026  d102              BNE      |L45.46|
000028  212e              MOVS     r1,#0x2e
00002a  f8051b01          STRB     r1,[r5],#1
                  |L45.46|
;;;1753   #if _USE_LFN
;;;1754   			if (IsUpper(c) && (dir[DIR_NTres] & (i >= 9 ? NS_EXT : NS_BODY)))
00002e  f1a20141          SUB      r1,r2,#0x41
000032  2919              CMP      r1,#0x19
000034  d809              BHI      |L45.74|
000036  7b1f              LDRB     r7,[r3,#0xc]
000038  2c09              CMP      r4,#9
00003a  d301              BCC      |L45.64|
00003c  2110              MOVS     r1,#0x10
00003e  e000              B        |L45.66|
                  |L45.64|
000040  2108              MOVS     r1,#8
                  |L45.66|
000042  420f              TST      r7,r1
000044  d001              BEQ      |L45.74|
;;;1755   				c += 0x20;			/* To lower */
000046  3220              ADDS     r2,r2,#0x20
000048  b2d2              UXTB     r2,r2
                  |L45.74|
;;;1756   #if _LFN_UNICODE
;;;1757   			if (IsDBCS1(c) && i != 8 && i != 11 && IsDBCS2(dir[i]))
;;;1758   				c = c << 8 | dir[i++];
;;;1759   			c = ff_convert(c, 1);	/* OEM -> Unicode */
;;;1760   			if (!c) c = '?';
;;;1761   #endif
;;;1762   #endif
;;;1763   			*p++ = c;
00004a  f8052b01          STRB     r2,[r5],#1
                  |L45.78|
00004e  2c0b              CMP      r4,#0xb               ;1748
000050  d3e0              BCC      |L45.20|
;;;1764   		}
;;;1765   		fno->fattrib = dir[DIR_Attr];				/* Attribute */
000052  7ad9              LDRB     r1,[r3,#0xb]
000054  7231              STRB     r1,[r6,#8]
;;;1766   		fno->fsize = LD_DWORD(dir+DIR_FileSize);	/* Size */
000056  7f19              LDRB     r1,[r3,#0x1c]
000058  7fda              LDRB     r2,[r3,#0x1f]
00005a  7f5c              LDRB     r4,[r3,#0x1d]
00005c  ea416102          ORR      r1,r1,r2,LSL #24
000060  7f9a              LDRB     r2,[r3,#0x1e]
000062  0412              LSLS     r2,r2,#16
000064  ea422204          ORR      r2,r2,r4,LSL #8
000068  4311              ORRS     r1,r1,r2
00006a  6031              STR      r1,[r6,#0]
;;;1767   		fno->fdate = LD_WORD(dir+DIR_WrtDate);		/* Date */
00006c  7e19              LDRB     r1,[r3,#0x18]
00006e  7e5a              LDRB     r2,[r3,#0x19]
000070  ea412102          ORR      r1,r1,r2,LSL #8
000074  80b1              STRH     r1,[r6,#4]
;;;1768   		fno->ftime = LD_WORD(dir+DIR_WrtTime);		/* Time */
000076  7d99              LDRB     r1,[r3,#0x16]
000078  7dda              LDRB     r2,[r3,#0x17]
00007a  ea412102          ORR      r1,r1,r2,LSL #8
00007e  80f1              STRH     r1,[r6,#6]
                  |L45.128|
;;;1769   	}
;;;1770   	*p = 0;		/* Terminate SFN string by a \0 */
000080  f04f0800          MOV      r8,#0
000084  f8858000          STRB     r8,[r5,#0]
;;;1771   
;;;1772   #if _USE_LFN
;;;1773   	if (fno->lfname) {
000088  69b7              LDR      r7,[r6,#0x18]
00008a  2f00              CMP      r7,#0
00008c  d026              BEQ      |L45.220|
;;;1774   		WCHAR w, *lfn;
;;;1775   
;;;1776   		i = 0; p = fno->lfname;
00008e  2400              MOVS     r4,#0
;;;1777   		if (dp->sect && fno->lfsize && dp->lfn_idx != 0xFFFF) {	/* Get LFN if available */
000090  6901              LDR      r1,[r0,#0x10]
000092  b309              CBZ      r1,|L45.216|
000094  69f1              LDR      r1,[r6,#0x1c]
000096  b1f9              CBZ      r1,|L45.216|
000098  8c01              LDRH     r1,[r0,#0x20]
00009a  f5a1427f          SUB      r2,r1,#0xff00
00009e  3aff              SUBS     r2,r2,#0xff
0000a0  d01a              BEQ      |L45.216|
;;;1778   			lfn = dp->lfn;
0000a2  69c5              LDR      r5,[r0,#0x1c]
;;;1779   			while ((w = *lfn++) != 0) {		/* Get an LFN character */
0000a4  e014              B        |L45.208|
                  |L45.166|
;;;1780   #if !_LFN_UNICODE
;;;1781   				w = ff_convert(w, 0);		/* Unicode -> OEM */
0000a6  2100              MOVS     r1,#0
0000a8  f7fffffe          BL       ff_convert
;;;1782   				if (!w) { i = 0; break; }	/* No LFN if it could not be converted */
0000ac  b158              CBZ      r0,|L45.198|
;;;1783   				if (_DF1S && w >= 0x100)	/* Put 1st byte if it is a DBC (always false on SBCS cfg) */
0000ae  28ff              CMP      r0,#0xff
0000b0  d903              BLS      |L45.186|
;;;1784   					p[i++] = (TCHAR)(w >> 8);
0000b2  0a02              LSRS     r2,r0,#8
0000b4  4621              MOV      r1,r4
0000b6  1c64              ADDS     r4,r4,#1
0000b8  547a              STRB     r2,[r7,r1]
                  |L45.186|
;;;1785   #endif
;;;1786   				if (i >= fno->lfsize - 1) { i = 0; break; }	/* No LFN if buffer overflow */
0000ba  69f1              LDR      r1,[r6,#0x1c]
0000bc  1e49              SUBS     r1,r1,#1
0000be  42a1              CMP      r1,r4
0000c0  d803              BHI      |L45.202|
0000c2  2400              MOVS     r4,#0
0000c4  e008              B        |L45.216|
                  |L45.198|
0000c6  2400              MOVS     r4,#0                 ;1782
0000c8  e006              B        |L45.216|
                  |L45.202|
;;;1787   				p[i++] = (TCHAR)w;
0000ca  4621              MOV      r1,r4
0000cc  1c64              ADDS     r4,r4,#1
0000ce  5478              STRB     r0,[r7,r1]
                  |L45.208|
0000d0  f8350b02          LDRH     r0,[r5],#2            ;1779
0000d4  2800              CMP      r0,#0                 ;1779
0000d6  d1e6              BNE      |L45.166|
                  |L45.216|
;;;1788   			}
;;;1789   		}
;;;1790   		p[i] = 0;	/* Terminate LFN string by a \0 */
0000d8  f8078004          STRB     r8,[r7,r4]
                  |L45.220|
;;;1791   	}
;;;1792   #endif
;;;1793   }
0000dc  e8bd81f0          POP      {r4-r8,pc}
;;;1794   #endif /* _FS_MINIMIZE <= 1 || _FS_RPATH >= 2*/
                          ENDP


                          AREA ||i.get_ldnumber||, CODE, READONLY, ALIGN=1

                  get_ldnumber PROC
;;;2075   static
;;;2076   int get_ldnumber (		/* Returns logical drive number (-1:invalid drive) */
000000  b510              PUSH     {r4,lr}
;;;2077   	const TCHAR** path	/* Pointer to pointer to the path name */
;;;2078   )
;;;2079   {
000002  4604              MOV      r4,r0
;;;2080   	const TCHAR *tp, *tt;
;;;2081   	UINT i;
;;;2082   	int vol = -1;
000004  f04f30ff          MOV      r0,#0xffffffff
;;;2083   
;;;2084   
;;;2085   	if (*path) {	/* If the pointer is not a null */
000008  6823              LDR      r3,[r4,#0]
00000a  2b00              CMP      r3,#0
00000c  d00b              BEQ      |L46.38|
;;;2086   		for (tt = *path; (UINT)*tt >= (_USE_LFN ? ' ' : '!') && *tt != ':'; tt++) ;	/* Find ':' in the path */
00000e  4619              MOV      r1,r3
000010  e000              B        |L46.20|
                  |L46.18|
000012  1c49              ADDS     r1,r1,#1
                  |L46.20|
000014  780a              LDRB     r2,[r1,#0]
000016  2a20              CMP      r2,#0x20
000018  d301              BCC      |L46.30|
00001a  2a3a              CMP      r2,#0x3a
00001c  d1f9              BNE      |L46.18|
                  |L46.30|
;;;2087   		if (*tt == ':') {	/* If a ':' is exist in the path name */
00001e  780a              LDRB     r2,[r1,#0]
000020  2a3a              CMP      r2,#0x3a
000022  d001              BEQ      |L46.40|
;;;2088   			tp = *path;
;;;2089   			i = *tp++ - '0'; 
;;;2090   			if (i < 10 && tp == tt) {	/* Is there a numeric drive id? */
;;;2091   				if (i < _VOLUMES) {	/* If a drive id is found, get the value and strip it */
;;;2092   					vol = (int)i;
;;;2093   					*path = ++tt;
;;;2094   				}
;;;2095   			} else {	/* No numeric drive number */
;;;2096   #if _STR_VOLUME_ID		/* Find string drive id */
;;;2097   				static const char* const str[] = {_VOLUME_STRS};
;;;2098   				const char *sp;
;;;2099   				char c;
;;;2100   				TCHAR tc;
;;;2101   
;;;2102   				i = 0; tt++;
;;;2103   				do {
;;;2104   					sp = str[i]; tp = *path;
;;;2105   					do {	/* Compare a string drive id with path name */
;;;2106   						c = *sp++; tc = *tp++;
;;;2107   						if (IsLower(tc)) tc -= 0x20;
;;;2108   					} while (c && (TCHAR)c == tc);
;;;2109   				} while ((c || tp != tt) && ++i < _VOLUMES);	/* Repeat for each id until pattern match */
;;;2110   				if (i < _VOLUMES) {	/* If a drive id is found, get the value and strip it */
;;;2111   					vol = (int)i;
;;;2112   					*path = tt;
;;;2113   				}
;;;2114   #endif
;;;2115   			}
;;;2116   			return vol;
;;;2117   		}
;;;2118   #if _FS_RPATH && _VOLUMES >= 2
;;;2119   		vol = CurrVol;	/* Current drive */
;;;2120   #else
;;;2121   		vol = 0;		/* Drive 0 */
000024  2000              MOVS     r0,#0
                  |L46.38|
;;;2122   #endif
;;;2123   	}
;;;2124   	return vol;
;;;2125   }
000026  bd10              POP      {r4,pc}
                  |L46.40|
000028  f8132b01          LDRB     r2,[r3],#1            ;2089
00002c  3a30              SUBS     r2,r2,#0x30           ;2089
00002e  2a0a              CMP      r2,#0xa               ;2090
000030  d2f9              BCS      |L46.38|
000032  428b              CMP      r3,r1                 ;2090
000034  d1f7              BNE      |L46.38|
000036  2a03              CMP      r2,#3                 ;2091
000038  d2f5              BCS      |L46.38|
00003a  4610              MOV      r0,r2                 ;2092
00003c  1c49              ADDS     r1,r1,#1              ;2093
00003e  6021              STR      r1,[r4,#0]            ;2093
000040  bd10              POP      {r4,pc}
;;;2126   
                          ENDP


                          AREA ||i.ld_clust||, CODE, READONLY, ALIGN=1

                  ld_clust PROC
;;;1268   static
;;;1269   DWORD ld_clust (
000000  4602              MOV      r2,r0
;;;1270   	FATFS* fs,	/* Pointer to the fs object */
;;;1271   	BYTE* dir	/* Pointer to the directory entry */
;;;1272   )
;;;1273   {
;;;1274   	DWORD cl;
;;;1275   
;;;1276   	cl = LD_WORD(dir+DIR_FstClusLO);
000002  7e88              LDRB     r0,[r1,#0x1a]
000004  7ecb              LDRB     r3,[r1,#0x1b]
000006  ea402003          ORR      r0,r0,r3,LSL #8
;;;1277   	if (fs->fs_type == FS_FAT32)
00000a  7812              LDRB     r2,[r2,#0]
00000c  2a03              CMP      r2,#3
00000e  d105              BNE      |L47.28|
;;;1278   		cl |= (DWORD)LD_WORD(dir+DIR_FstClusHI) << 16;
000010  7d0a              LDRB     r2,[r1,#0x14]
000012  7d49              LDRB     r1,[r1,#0x15]
000014  ea422101          ORR      r1,r2,r1,LSL #8
000018  ea404001          ORR      r0,r0,r1,LSL #16
                  |L47.28|
;;;1279   
;;;1280   	return cl;
;;;1281   }
00001c  4770              BX       lr
;;;1282   
                          ENDP


                          AREA ||i.mem_cmp||, CODE, READONLY, ALIGN=1

                  mem_cmp PROC
;;;587    static
;;;588    int mem_cmp (const void* dst, const void* src, UINT cnt) {
000000  b510              PUSH     {r4,lr}
;;;589    	const BYTE *d = (const BYTE *)dst, *s = (const BYTE *)src;
;;;590    	int r = 0;
000002  2300              MOVS     r3,#0
                  |L48.4|
;;;591    
;;;592    	while (cnt-- && (r = *d++ - *s++) == 0) ;
000004  1e52              SUBS     r2,r2,#1
000006  d305              BCC      |L48.20|
000008  f8103b01          LDRB     r3,[r0],#1
00000c  f8114b01          LDRB     r4,[r1],#1
000010  1b1b              SUBS     r3,r3,r4
000012  d0f7              BEQ      |L48.4|
                  |L48.20|
;;;593    	return r;
000014  4618              MOV      r0,r3
;;;594    }
000016  bd10              POP      {r4,pc}
;;;595    
                          ENDP


                          AREA ||i.mem_cpy||, CODE, READONLY, ALIGN=1

                  mem_cpy PROC
;;;561    static
;;;562    void mem_cpy (void* dst, const void* src, UINT cnt) {
000000  e003              B        |L49.10|
                  |L49.2|
;;;563    	BYTE *d = (BYTE*)dst;
;;;564    	const BYTE *s = (const BYTE*)src;
;;;565    
;;;566    #if _WORD_ACCESS == 1
;;;567    	while (cnt >= sizeof (int)) {
;;;568    		*(int*)d = *(int*)s;
;;;569    		d += sizeof (int); s += sizeof (int);
;;;570    		cnt -= sizeof (int);
;;;571    	}
;;;572    #endif
;;;573    	while (cnt--)
;;;574    		*d++ = *s++;
000002  f8113b01          LDRB     r3,[r1],#1
000006  f8003b01          STRB     r3,[r0],#1
                  |L49.10|
00000a  1e52              SUBS     r2,r2,#1              ;573
00000c  d2f9              BCS      |L49.2|
;;;575    }
00000e  4770              BX       lr
;;;576    
                          ENDP


                          AREA ||i.mem_set||, CODE, READONLY, ALIGN=1

                  mem_set PROC
;;;578    static
;;;579    void mem_set (void* dst, int val, UINT cnt) {
000000  b2c9              UXTB     r1,r1
000002  e001              B        |L50.8|
                  |L50.4|
;;;580    	BYTE *d = (BYTE*)dst;
;;;581    
;;;582    	while (cnt--)
;;;583    		*d++ = (BYTE)val;
000004  f8001b01          STRB     r1,[r0],#1
                  |L50.8|
000008  1e52              SUBS     r2,r2,#1              ;582
00000a  d2fb              BCS      |L50.4|
;;;584    }
00000c  4770              BX       lr
;;;585    
                          ENDP


                          AREA ||i.move_window||, CODE, READONLY, ALIGN=1

                  move_window PROC
;;;780    static
;;;781    FRESULT move_window (
000000  b570              PUSH     {r4-r6,lr}
;;;782    	FATFS* fs,		/* File system object */
;;;783    	DWORD sector	/* Sector number to make appearance in the fs->win[] */
;;;784    )
;;;785    {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;786    	if (sector != fs->winsect) {	/* Changed current window */
000006  6ae0              LDR      r0,[r4,#0x2c]
000008  42a8              CMP      r0,r5
00000a  d010              BEQ      |L51.46|
;;;787    #if !_FS_READONLY
;;;788    		if (sync_window(fs) != FR_OK)
00000c  4620              MOV      r0,r4
00000e  f7fffffe          BL       sync_window
000012  b108              CBZ      r0,|L51.24|
;;;789    			return FR_DISK_ERR;
000014  2001              MOVS     r0,#1
;;;790    #endif
;;;791    		if (disk_read(fs->drv, fs->win, sector, 1))
;;;792    			return FR_DISK_ERR;
;;;793    		fs->winsect = sector;
;;;794    	}
;;;795    
;;;796    	return FR_OK;
;;;797    }
000016  bd70              POP      {r4-r6,pc}
                  |L51.24|
000018  7860              LDRB     r0,[r4,#1]            ;791
00001a  2301              MOVS     r3,#1                 ;791
00001c  462a              MOV      r2,r5                 ;791
00001e  f1040130          ADD      r1,r4,#0x30           ;791
000022  f7fffffe          BL       disk_read
000026  b108              CBZ      r0,|L51.44|
000028  2001              MOVS     r0,#1                 ;792
00002a  bd70              POP      {r4-r6,pc}
                  |L51.44|
00002c  62e5              STR      r5,[r4,#0x2c]         ;793
                  |L51.46|
00002e  2000              MOVS     r0,#0                 ;796
000030  bd70              POP      {r4-r6,pc}
;;;798    
                          ENDP


                          AREA ||i.pick_lfn||, CODE, READONLY, ALIGN=2

                  pick_lfn PROC
;;;1338   static
;;;1339   int pick_lfn (			/* 1:Succeeded, 0:Buffer overflow */
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;1340   	WCHAR* lfnbuf,		/* Pointer to the Unicode-LFN buffer */
;;;1341   	BYTE* dir			/* Pointer to the directory entry */
;;;1342   )
;;;1343   {
;;;1344   	UINT i, s;
;;;1345   	WCHAR wc, uc;
;;;1346   
;;;1347   
;;;1348   	i = ((dir[LDIR_Ord] & 0x3F) - 1) * 13;	/* Offset in the LFN buffer */
000004  780a              LDRB     r2,[r1,#0]
000006  f002023f          AND      r2,r2,#0x3f
00000a  1e52              SUBS     r2,r2,#1
00000c  eb020382          ADD      r3,r2,r2,LSL #2
000010  eb0302c2          ADD      r2,r3,r2,LSL #3
;;;1349   
;;;1350   	s = 0; wc = 1;
000014  2300              MOVS     r3,#0
000016  2501              MOVS     r5,#1
;;;1351   	do {
;;;1352   		uc = LD_WORD(dir+LfnOfs[s]);		/* Pick an LFN character from the entry */
000018  4f14              LDR      r7,|L52.108|
00001a  1c4e              ADDS     r6,r1,#1
;;;1353   		if (wc) {	/* Last character has not been processed */
;;;1354   			if (i >= _MAX_LFN) return 0;	/* Buffer overflow? */
;;;1355   			lfnbuf[i++] = wc = uc;			/* Store it */
;;;1356   		} else {
;;;1357   			if (uc != 0xFFFF) return 0;		/* Check filler */
00001c  f64f7cff          MOV      r12,#0xffff
                  |L52.32|
000020  5cfc              LDRB     r4,[r7,r3]            ;1352
000022  f8118004          LDRB     r8,[r1,r4]            ;1352
000026  5da4              LDRB     r4,[r4,r6]            ;1352
000028  ea482404          ORR      r4,r8,r4,LSL #8       ;1352
00002c  b155              CBZ      r5,|L52.68|
00002e  2aff              CMP      r2,#0xff              ;1354
000030  d302              BCC      |L52.56|
000032  2000              MOVS     r0,#0                 ;1354
                  |L52.52|
;;;1358   		}
;;;1359   	} while (++s < 13);						/* Read all character in the entry */
;;;1360   
;;;1361   	if (dir[LDIR_Ord] & LLE) {				/* Put terminator if it is the last LFN part */
;;;1362   		if (i >= _MAX_LFN) return 0;		/* Buffer overflow? */
;;;1363   		lfnbuf[i] = 0;
;;;1364   	}
;;;1365   
;;;1366   	return 1;
;;;1367   }
000034  e8bd81f0          POP      {r4-r8,pc}
                  |L52.56|
000038  4690              MOV      r8,r2                 ;1355
00003a  4625              MOV      r5,r4                 ;1355
00003c  1c52              ADDS     r2,r2,#1              ;1355
00003e  f8204018          STRH     r4,[r0,r8,LSL #1]     ;1355
000042  e003              B        |L52.76|
                  |L52.68|
000044  4564              CMP      r4,r12                ;1357
000046  d001              BEQ      |L52.76|
000048  2000              MOVS     r0,#0                 ;1357
00004a  e7f3              B        |L52.52|
                  |L52.76|
00004c  1c5b              ADDS     r3,r3,#1              ;1359
00004e  2b0d              CMP      r3,#0xd               ;1359
000050  d3e6              BCC      |L52.32|
000052  7809              LDRB     r1,[r1,#0]            ;1361
000054  0649              LSLS     r1,r1,#25             ;1361
000056  d506              BPL      |L52.102|
000058  2aff              CMP      r2,#0xff              ;1362
00005a  d301              BCC      |L52.96|
00005c  2000              MOVS     r0,#0                 ;1362
00005e  e7e9              B        |L52.52|
                  |L52.96|
000060  2100              MOVS     r1,#0                 ;1363
000062  f8201012          STRH     r1,[r0,r2,LSL #1]     ;1363
                  |L52.102|
000066  2001              MOVS     r0,#1                 ;1366
000068  e7e4              B        |L52.52|
;;;1368   
                          ENDP

00006a  0000              DCW      0x0000
                  |L52.108|
                          DCD      ||.constdata||

                          AREA ||i.put_fat||, CODE, READONLY, ALIGN=1

                  put_fat PROC
;;;910    
;;;911    FRESULT put_fat (
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;912    	FATFS* fs,	/* File system object */
;;;913    	DWORD clst,	/* Cluster# to be changed in range of 2 to fs->n_fatent - 1 */
;;;914    	DWORD val	/* New value to mark the cluster */
;;;915    )
;;;916    {
000004  4604              MOV      r4,r0
000006  460d              MOV      r5,r1
000008  4616              MOV      r6,r2
;;;917    	UINT bc;
;;;918    	BYTE *p;
;;;919    	FRESULT res;
;;;920    
;;;921    
;;;922    	if (clst < 2 || clst >= fs->n_fatent) {	/* Check range */
00000a  2d02              CMP      r5,#2
00000c  d302              BCC      |L53.20|
00000e  6960              LDR      r0,[r4,#0x14]
000010  42a8              CMP      r0,r5
000012  d802              BHI      |L53.26|
                  |L53.20|
;;;923    		res = FR_INT_ERR;
000014  2002              MOVS     r0,#2
                  |L53.22|
;;;924    
;;;925    	} else {
;;;926    		switch (fs->fs_type) {
;;;927    		case FS_FAT12 :
;;;928    			bc = (UINT)clst; bc += bc / 2;
;;;929    			res = move_window(fs, fs->fatbase + (bc / SS(fs)));
;;;930    			if (res != FR_OK) break;
;;;931    			p = &fs->win[bc % SS(fs)];
;;;932    			*p = (clst & 1) ? ((*p & 0x0F) | ((BYTE)val << 4)) : (BYTE)val;
;;;933    			bc++;
;;;934    			fs->wflag = 1;
;;;935    			res = move_window(fs, fs->fatbase + (bc / SS(fs)));
;;;936    			if (res != FR_OK) break;
;;;937    			p = &fs->win[bc % SS(fs)];
;;;938    			*p = (clst & 1) ? (BYTE)(val >> 4) : ((*p & 0xF0) | ((BYTE)(val >> 8) & 0x0F));
;;;939    			break;
;;;940    
;;;941    		case FS_FAT16 :
;;;942    			res = move_window(fs, fs->fatbase + (clst / (SS(fs) / 2)));
;;;943    			if (res != FR_OK) break;
;;;944    			p = &fs->win[clst * 2 % SS(fs)];
;;;945    			ST_WORD(p, (WORD)val);
;;;946    			break;
;;;947    
;;;948    		case FS_FAT32 :
;;;949    			res = move_window(fs, fs->fatbase + (clst / (SS(fs) / 4)));
;;;950    			if (res != FR_OK) break;
;;;951    			p = &fs->win[clst * 4 % SS(fs)];
;;;952    			val |= LD_DWORD(p) & 0xF0000000;
;;;953    			ST_DWORD(p, val);
;;;954    			break;
;;;955    
;;;956    		default :
;;;957    			res = FR_INT_ERR;
;;;958    		}
;;;959    		fs->wflag = 1;
;;;960    	}
;;;961    
;;;962    	return res;
;;;963    }
000016  e8bd87f0          POP      {r4-r10,pc}
                  |L53.26|
00001a  7820              LDRB     r0,[r4,#0]            ;926
00001c  f00609ff          AND      r9,r6,#0xff           ;932
000020  f04f0801          MOV      r8,#1                 ;926
000024  2801              CMP      r0,#1                 ;926
000026  d007              BEQ      |L53.56|
000028  2802              CMP      r0,#2                 ;926
00002a  d037              BEQ      |L53.156|
00002c  2803              CMP      r0,#3                 ;926
00002e  d046              BEQ      |L53.190|
000030  2002              MOVS     r0,#2                 ;957
                  |L53.50|
000032  f8848004          STRB     r8,[r4,#4]            ;959
000036  e7ee              B        |L53.22|
                  |L53.56|
000038  eb050755          ADD      r7,r5,r5,LSR #1       ;928
00003c  6a20              LDR      r0,[r4,#0x20]         ;929
00003e  eb002157          ADD      r1,r0,r7,LSR #9       ;929
000042  4620              MOV      r0,r4                 ;929
000044  f7fffffe          BL       move_window
000048  2800              CMP      r0,#0                 ;930
00004a  d1f2              BNE      |L53.50|
00004c  f3c70008          UBFX     r0,r7,#0,#9           ;931
000050  4420              ADD      r0,r0,r4              ;931
000052  3030              ADDS     r0,r0,#0x30           ;931
000054  07e9              LSLS     r1,r5,#31             ;932
000056  d003              BEQ      |L53.96|
000058  7801              LDRB     r1,[r0,#0]            ;932
00005a  f369111f          BFI      r1,r9,#4,#28          ;932
00005e  e000              B        |L53.98|
                  |L53.96|
000060  4631              MOV      r1,r6                 ;932
                  |L53.98|
000062  7001              STRB     r1,[r0,#0]            ;932
000064  1c7f              ADDS     r7,r7,#1              ;933
000066  f8848004          STRB     r8,[r4,#4]            ;934
00006a  6a20              LDR      r0,[r4,#0x20]         ;935
00006c  eb002157          ADD      r1,r0,r7,LSR #9       ;935
000070  4620              MOV      r0,r4                 ;935
000072  f7fffffe          BL       move_window
000076  2800              CMP      r0,#0                 ;936
000078  d1db              BNE      |L53.50|
00007a  f3c70108          UBFX     r1,r7,#0,#9           ;937
00007e  4421              ADD      r1,r1,r4              ;937
000080  3130              ADDS     r1,r1,#0x30           ;937
000082  07ea              LSLS     r2,r5,#31             ;938
000084  d002              BEQ      |L53.140|
000086  f3c61207          UBFX     r2,r6,#4,#8           ;938
00008a  e005              B        |L53.152|
                  |L53.140|
00008c  780a              LDRB     r2,[r1,#0]            ;938
00008e  f3c62303          UBFX     r3,r6,#8,#4           ;938
000092  f00202f0          AND      r2,r2,#0xf0           ;938
000096  431a              ORRS     r2,r2,r3              ;938
                  |L53.152|
000098  700a              STRB     r2,[r1,#0]            ;938
00009a  e7ca              B        |L53.50|
                  |L53.156|
00009c  6a20              LDR      r0,[r4,#0x20]         ;942
00009e  eb002115          ADD      r1,r0,r5,LSR #8       ;942
0000a2  4620              MOV      r0,r4                 ;942
0000a4  f7fffffe          BL       move_window
0000a8  2800              CMP      r0,#0                 ;943
0000aa  d1c2              BNE      |L53.50|
0000ac  b2e9              UXTB     r1,r5                 ;944
0000ae  eb040141          ADD      r1,r4,r1,LSL #1       ;944
0000b2  f8819030          STRB     r9,[r1,#0x30]         ;945
0000b6  0a32              LSRS     r2,r6,#8              ;945
0000b8  f8812031          STRB     r2,[r1,#0x31]         ;945
0000bc  e7b9              B        |L53.50|
                  |L53.190|
0000be  6a20              LDR      r0,[r4,#0x20]         ;949
0000c0  eb0011d5          ADD      r1,r0,r5,LSR #7       ;949
0000c4  4620              MOV      r0,r4                 ;949
0000c6  f7fffffe          BL       move_window
0000ca  2800              CMP      r0,#0                 ;950
0000cc  d1b1              BNE      |L53.50|
0000ce  f24011ff          MOV      r1,#0x1ff             ;951
0000d2  ea010185          AND      r1,r1,r5,LSL #2       ;951
0000d6  4421              ADD      r1,r1,r4              ;951
0000d8  3130              ADDS     r1,r1,#0x30           ;951
0000da  f04f4370          MOV      r3,#0xf0000000        ;952
0000de  78ca              LDRB     r2,[r1,#3]            ;952
0000e0  ea036202          AND      r2,r3,r2,LSL #24      ;952
0000e4  4332              ORRS     r2,r2,r6              ;952
0000e6  700a              STRB     r2,[r1,#0]            ;953
0000e8  0a13              LSRS     r3,r2,#8              ;953
0000ea  704b              STRB     r3,[r1,#1]            ;953
0000ec  0c13              LSRS     r3,r2,#16             ;953
0000ee  708b              STRB     r3,[r1,#2]            ;953
0000f0  0e12              LSRS     r2,r2,#24             ;953
0000f2  70ca              STRB     r2,[r1,#3]            ;953
0000f4  e79d              B        |L53.50|
;;;964    #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.putc_bfd||, CODE, READONLY, ALIGN=1

                  putc_bfd PROC
;;;4380   static
;;;4381   void putc_bfd (
000000  b538              PUSH     {r3-r5,lr}
;;;4382   	putbuff* pb,
;;;4383   	TCHAR c
;;;4384   )
;;;4385   {
000002  4604              MOV      r4,r0
;;;4386   	UINT bw;
;;;4387   	int i;
;;;4388   
;;;4389   
;;;4390   	if (_USE_STRFUNC == 2 && c == '\n')	 /* LF -> CRLF conversion */
;;;4391   		putc_bfd(pb, '\r');
;;;4392   
;;;4393   	i = pb->idx;	/* Buffer write index (-1:error) */
000004  6860              LDR      r0,[r4,#4]
;;;4394   	if (i < 0) return;
000006  2800              CMP      r0,#0
000008  db16              BLT      |L54.56|
;;;4395   
;;;4396   #if _USE_LFN && _LFN_UNICODE
;;;4397   #if _STRF_ENCODE == 3			/* Write a character in UTF-8 */
;;;4398   	if (c < 0x80) {				/* 7-bit */
;;;4399   		pb->buf[i++] = (BYTE)c;
;;;4400   	} else {
;;;4401   		if (c < 0x800) {		/* 11-bit */
;;;4402   			pb->buf[i++] = (BYTE)(0xC0 | c >> 6);
;;;4403   		} else {				/* 16-bit */
;;;4404   			pb->buf[i++] = (BYTE)(0xE0 | c >> 12);
;;;4405   			pb->buf[i++] = (BYTE)(0x80 | (c >> 6 & 0x3F));
;;;4406   		}
;;;4407   		pb->buf[i++] = (BYTE)(0x80 | (c & 0x3F));
;;;4408   	}
;;;4409   #elif _STRF_ENCODE == 2			/* Write a character in UTF-16BE */
;;;4410   	pb->buf[i++] = (BYTE)(c >> 8);
;;;4411   	pb->buf[i++] = (BYTE)c;
;;;4412   #elif _STRF_ENCODE == 1			/* Write a character in UTF-16LE */
;;;4413   	pb->buf[i++] = (BYTE)c;
;;;4414   	pb->buf[i++] = (BYTE)(c >> 8);
;;;4415   #else							/* Write a character in ANSI/OEM */
;;;4416   	c = ff_convert(c, 0);	/* Unicode -> OEM */
;;;4417   	if (!c) c = '?';
;;;4418   	if (c >= 0x100)
;;;4419   		pb->buf[i++] = (BYTE)(c >> 8);
;;;4420   	pb->buf[i++] = (BYTE)c;
;;;4421   #endif
;;;4422   #else							/* Write a character without conversion */
;;;4423   	pb->buf[i++] = (BYTE)c;
00000a  1c45              ADDS     r5,r0,#1
00000c  4420              ADD      r0,r0,r4
00000e  7301              STRB     r1,[r0,#0xc]
;;;4424   #endif
;;;4425   
;;;4426   	if (i >= (int)(sizeof pb->buf) - 3) {	/* Write buffered characters to the file */
000010  2d3d              CMP      r5,#0x3d
000012  db0d              BLT      |L54.48|
;;;4427   		f_write(pb->fp, pb->buf, (UINT)i, &bw);
000014  466b              MOV      r3,sp
000016  462a              MOV      r2,r5
000018  f104010c          ADD      r1,r4,#0xc
00001c  6820              LDR      r0,[r4,#0]
00001e  f7fffffe          BL       f_write
;;;4428   		i = (bw == (UINT)i) ? 0 : -1;
000022  9800              LDR      r0,[sp,#0]
000024  42a8              CMP      r0,r5
000026  d101              BNE      |L54.44|
000028  2500              MOVS     r5,#0
00002a  e001              B        |L54.48|
                  |L54.44|
00002c  f04f35ff          MOV      r5,#0xffffffff
                  |L54.48|
;;;4429   	}
;;;4430   	pb->idx = i;
000030  6065              STR      r5,[r4,#4]
;;;4431   	pb->nchr++;
000032  68a0              LDR      r0,[r4,#8]
000034  1c40              ADDS     r0,r0,#1
000036  60a0              STR      r0,[r4,#8]
                  |L54.56|
;;;4432   }
000038  bd38              POP      {r3-r5,pc}
;;;4433   
                          ENDP


                          AREA ||i.remove_chain||, CODE, READONLY, ALIGN=1

                  remove_chain PROC
;;;973    static
;;;974    FRESULT remove_chain (
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;975    	FATFS* fs,			/* File system object */
;;;976    	DWORD clst			/* Cluster# to remove a chain from */
;;;977    )
;;;978    {
000004  4604              MOV      r4,r0
000006  460f              MOV      r7,r1
;;;979    	FRESULT res;
;;;980    	DWORD nxt;
;;;981    #if _USE_ERASE
;;;982    	DWORD scl = clst, ecl = clst, rt[2];
;;;983    #endif
;;;984    
;;;985    	if (clst < 2 || clst >= fs->n_fatent) {	/* Check range */
000008  2f02              CMP      r7,#2
00000a  d302              BCC      |L55.18|
00000c  6960              LDR      r0,[r4,#0x14]
00000e  42b8              CMP      r0,r7
000010  d801              BHI      |L55.22|
                  |L55.18|
;;;986    		res = FR_INT_ERR;
000012  2602              MOVS     r6,#2
000014  e024              B        |L55.96|
                  |L55.22|
;;;987    
;;;988    	} else {
;;;989    		res = FR_OK;
000016  2600              MOVS     r6,#0
;;;990    		while (clst < fs->n_fatent) {			/* Not a last link? */
000018  e01f              B        |L55.90|
                  |L55.26|
;;;991    			nxt = get_fat(fs, clst);			/* Get cluster status */
00001a  4639              MOV      r1,r7
00001c  4620              MOV      r0,r4
00001e  f7fffffe          BL       get_fat
000022  4605              MOV      r5,r0
;;;992    			if (nxt == 0) break;				/* Empty cluster? */
000024  b1e5              CBZ      r5,|L55.96|
;;;993    			if (nxt == 1) { res = FR_INT_ERR; break; }	/* Internal error? */
000026  2d01              CMP      r5,#1
000028  d009              BEQ      |L55.62|
;;;994    			if (nxt == 0xFFFFFFFF) { res = FR_DISK_ERR; break; }	/* Disk error? */
00002a  1c68              ADDS     r0,r5,#1
00002c  d009              BEQ      |L55.66|
;;;995    			res = put_fat(fs, clst, 0);			/* Mark the cluster "empty" */
00002e  2200              MOVS     r2,#0
000030  4639              MOV      r1,r7
000032  4620              MOV      r0,r4
000034  f7fffffe          BL       put_fat
000038  4606              MOV      r6,r0
;;;996    			if (res != FR_OK) break;
00003a  b98e              CBNZ     r6,|L55.96|
00003c  e003              B        |L55.70|
                  |L55.62|
00003e  2602              MOVS     r6,#2                 ;993
000040  e00e              B        |L55.96|
                  |L55.66|
000042  2601              MOVS     r6,#1                 ;994
000044  e00c              B        |L55.96|
                  |L55.70|
;;;997    			if (fs->free_clust != 0xFFFFFFFF) {	/* Update FSINFO */
000046  6920              LDR      r0,[r4,#0x10]
000048  1c41              ADDS     r1,r0,#1
00004a  d005              BEQ      |L55.88|
;;;998    				fs->free_clust++;
00004c  1c40              ADDS     r0,r0,#1
00004e  6120              STR      r0,[r4,#0x10]
;;;999    				fs->fsi_flag |= 1;
000050  7960              LDRB     r0,[r4,#5]
000052  f0400001          ORR      r0,r0,#1
000056  7160              STRB     r0,[r4,#5]
                  |L55.88|
;;;1000   			}
;;;1001   #if _USE_ERASE
;;;1002   			if (ecl + 1 == nxt) {	/* Is next cluster contiguous? */
;;;1003   				ecl = nxt;
;;;1004   			} else {				/* End of contiguous clusters */ 
;;;1005   				rt[0] = clust2sect(fs, scl);					/* Start sector */
;;;1006   				rt[1] = clust2sect(fs, ecl) + fs->csize - 1;	/* End sector */
;;;1007   				disk_ioctl(fs->drv, CTRL_ERASE_SECTOR, rt);		/* Erase the block */
;;;1008   				scl = ecl = nxt;
;;;1009   			}
;;;1010   #endif
;;;1011   			clst = nxt;	/* Next cluster */
000058  462f              MOV      r7,r5
                  |L55.90|
00005a  6960              LDR      r0,[r4,#0x14]         ;990
00005c  42b8              CMP      r0,r7                 ;990
00005e  d8dc              BHI      |L55.26|
                  |L55.96|
;;;1012   		}
;;;1013   	}
;;;1014   
;;;1015   	return res;
000060  4630              MOV      r0,r6
;;;1016   }
000062  e8bd81f0          POP      {r4-r8,pc}
;;;1017   #endif
                          ENDP


                          AREA ||i.st_clust||, CODE, READONLY, ALIGN=1

                  st_clust PROC
;;;1285   static
;;;1286   void st_clust (
000000  7681              STRB     r1,[r0,#0x1a]
;;;1287   	BYTE* dir,	/* Pointer to the directory entry */
;;;1288   	DWORD cl	/* Value to be set */
;;;1289   )
;;;1290   {
;;;1291   	ST_WORD(dir+DIR_FstClusLO, cl);
000002  0a0a              LSRS     r2,r1,#8
000004  76c2              STRB     r2,[r0,#0x1b]
;;;1292   	ST_WORD(dir+DIR_FstClusHI, cl >> 16);
000006  0c0a              LSRS     r2,r1,#16
000008  7502              STRB     r2,[r0,#0x14]
00000a  0e09              LSRS     r1,r1,#24
00000c  7541              STRB     r1,[r0,#0x15]
;;;1293   }
00000e  4770              BX       lr
;;;1294   #endif
                          ENDP


                          AREA ||i.sum_sfn||, CODE, READONLY, ALIGN=1

                  sum_sfn PROC
;;;1468   static
;;;1469   BYTE sum_sfn (
000000  4601              MOV      r1,r0
;;;1470   	const BYTE* dir		/* Pointer to the SFN entry */
;;;1471   )
;;;1472   {
;;;1473   	BYTE sum = 0;
000002  2000              MOVS     r0,#0
;;;1474   	UINT n = 11;
000004  220b              MOVS     r2,#0xb
                  |L57.6|
;;;1475   
;;;1476   	do sum = (sum >> 1) + (sum << 7) + *dir++; while (--n);
000006  0843              LSRS     r3,r0,#1
000008  eb0310c0          ADD      r0,r3,r0,LSL #7
00000c  f8113b01          LDRB     r3,[r1],#1
000010  4418              ADD      r0,r0,r3
000012  b2c0              UXTB     r0,r0
000014  1e52              SUBS     r2,r2,#1
000016  d1f6              BNE      |L57.6|
;;;1477   	return sum;
;;;1478   }
000018  4770              BX       lr
;;;1479   #endif
                          ENDP


                          AREA ||i.sync_fs||, CODE, READONLY, ALIGN=1

                  sync_fs PROC
;;;806    static
;;;807    FRESULT sync_fs (	/* FR_OK: successful, FR_DISK_ERR: failed */
000000  b570              PUSH     {r4-r6,lr}
;;;808    	FATFS* fs		/* File system object */
;;;809    )
;;;810    {
000002  4604              MOV      r4,r0
;;;811    	FRESULT res;
;;;812    
;;;813    
;;;814    	res = sync_window(fs);
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       sync_window
00000a  4605              MOV      r5,r0
;;;815    	if (res == FR_OK) {
00000c  bbed              CBNZ     r5,|L58.138|
;;;816    		/* Update FSINFO sector if needed */
;;;817    		if (fs->fs_type == FS_FAT32 && fs->fsi_flag == 1) {
00000e  7820              LDRB     r0,[r4,#0]
000010  2803              CMP      r0,#3
000012  d147              BNE      |L58.164|
000014  7960              LDRB     r0,[r4,#5]
000016  2801              CMP      r0,#1
000018  d144              BNE      |L58.164|
;;;818    			/* Create FSINFO structure */
;;;819    			mem_set(fs->win, 0, SS(fs));
00001a  0242              LSLS     r2,r0,#9
00001c  f1040030          ADD      r0,r4,#0x30
000020  2100              MOVS     r1,#0
000022  4606              MOV      r6,r0
000024  f7fffffe          BL       mem_set
;;;820    			ST_WORD(fs->win+BS_55AA, 0xAA55);
000028  2055              MOVS     r0,#0x55
00002a  f884022e          STRB     r0,[r4,#0x22e]
00002e  20aa              MOVS     r0,#0xaa
000030  f884022f          STRB     r0,[r4,#0x22f]
;;;821    			ST_DWORD(fs->win+FSI_LeadSig, 0x41615252);
000034  2052              MOVS     r0,#0x52
000036  f8840030          STRB     r0,[r4,#0x30]
00003a  f8840031          STRB     r0,[r4,#0x31]
00003e  2161              MOVS     r1,#0x61
000040  f8841032          STRB     r1,[r4,#0x32]
000044  2041              MOVS     r0,#0x41
000046  f8840033          STRB     r0,[r4,#0x33]
;;;822    			ST_DWORD(fs->win+FSI_StrucSig, 0x61417272);
00004a  2272              MOVS     r2,#0x72
00004c  f8842214          STRB     r2,[r4,#0x214]
000050  f8842215          STRB     r2,[r4,#0x215]
000054  f8840216          STRB     r0,[r4,#0x216]
000058  f8841217          STRB     r1,[r4,#0x217]
;;;823    			ST_DWORD(fs->win+FSI_Free_Count, fs->free_clust);
00005c  6920              LDR      r0,[r4,#0x10]
00005e  f8840218          STRB     r0,[r4,#0x218]
000062  0a01              LSRS     r1,r0,#8
000064  f8841219          STRB     r1,[r4,#0x219]
000068  0c01              LSRS     r1,r0,#16
00006a  f884121a          STRB     r1,[r4,#0x21a]
00006e  0e00              LSRS     r0,r0,#24
000070  f884021b          STRB     r0,[r4,#0x21b]
;;;824    			ST_DWORD(fs->win+FSI_Nxt_Free, fs->last_clust);
000074  68e0              LDR      r0,[r4,#0xc]
000076  f884021c          STRB     r0,[r4,#0x21c]
00007a  0a01              LSRS     r1,r0,#8
00007c  f884121d          STRB     r1,[r4,#0x21d]
000080  0c01              LSRS     r1,r0,#16
000082  f884121e          STRB     r1,[r4,#0x21e]
000086  0e00              LSRS     r0,r0,#24
000088  e000              B        |L58.140|
                  |L58.138|
00008a  e012              B        |L58.178|
                  |L58.140|
00008c  f884021f          STRB     r0,[r4,#0x21f]
;;;825    			/* Write it into the FSINFO sector */
;;;826    			fs->winsect = fs->volbase + 1;
000090  69e2              LDR      r2,[r4,#0x1c]
000092  1c52              ADDS     r2,r2,#1
000094  62e2              STR      r2,[r4,#0x2c]
;;;827    			disk_write(fs->drv, fs->win, fs->winsect, 1);
000096  7860              LDRB     r0,[r4,#1]
000098  2301              MOVS     r3,#1
00009a  4631              MOV      r1,r6
00009c  f7fffffe          BL       disk_write
;;;828    			fs->fsi_flag = 0;
0000a0  2000              MOVS     r0,#0
0000a2  7160              STRB     r0,[r4,#5]
                  |L58.164|
;;;829    		}
;;;830    		/* Make sure that no pending write process in the physical drive */
;;;831    		if (disk_ioctl(fs->drv, CTRL_SYNC, 0) != RES_OK)
0000a4  2200              MOVS     r2,#0
0000a6  7860              LDRB     r0,[r4,#1]
0000a8  4611              MOV      r1,r2
0000aa  f7fffffe          BL       disk_ioctl
0000ae  b100              CBZ      r0,|L58.178|
;;;832    			res = FR_DISK_ERR;
0000b0  2501              MOVS     r5,#1
                  |L58.178|
;;;833    	}
;;;834    
;;;835    	return res;
0000b2  4628              MOV      r0,r5
;;;836    }
0000b4  bd70              POP      {r4-r6,pc}
;;;837    #endif
                          ENDP


                          AREA ||i.sync_window||, CODE, READONLY, ALIGN=1

                  sync_window PROC
;;;754    static
;;;755    FRESULT sync_window (
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;756    	FATFS* fs		/* File system object */
;;;757    )
;;;758    {
000004  4604              MOV      r4,r0
;;;759    	DWORD wsect;
;;;760    	UINT nf;
;;;761    
;;;762    
;;;763    	if (fs->wflag) {	/* Write back the sector if it is dirty */
000006  7920              LDRB     r0,[r4,#4]
000008  2800              CMP      r0,#0
00000a  d020              BEQ      |L59.78|
;;;764    		wsect = fs->winsect;	/* Current sector number */
00000c  6ae6              LDR      r6,[r4,#0x2c]
;;;765    		if (disk_write(fs->drv, fs->win, wsect, 1))
00000e  f1040130          ADD      r1,r4,#0x30
000012  7860              LDRB     r0,[r4,#1]
000014  2301              MOVS     r3,#1
000016  4632              MOV      r2,r6
000018  460f              MOV      r7,r1
00001a  f7fffffe          BL       disk_write
00001e  b110              CBZ      r0,|L59.38|
;;;766    			return FR_DISK_ERR;
000020  2001              MOVS     r0,#1
                  |L59.34|
;;;767    		fs->wflag = 0;
;;;768    		if (wsect - fs->fatbase < fs->fsize) {		/* Is it in the FAT area? */
;;;769    			for (nf = fs->n_fats; nf >= 2; nf--) {	/* Reflect the change to all FAT copies */
;;;770    				wsect += fs->fsize;
;;;771    				disk_write(fs->drv, fs->win, wsect, 1);
;;;772    			}
;;;773    		}
;;;774    	}
;;;775    	return FR_OK;
;;;776    }
000022  e8bd81f0          POP      {r4-r8,pc}
                  |L59.38|
000026  2000              MOVS     r0,#0                 ;767
000028  7120              STRB     r0,[r4,#4]            ;767
00002a  6a20              LDR      r0,[r4,#0x20]         ;768
00002c  69a1              LDR      r1,[r4,#0x18]         ;768
00002e  1a30              SUBS     r0,r6,r0              ;768
000030  4288              CMP      r0,r1                 ;768
000032  d20c              BCS      |L59.78|
000034  78e5              LDRB     r5,[r4,#3]            ;769
000036  e008              B        |L59.74|
                  |L59.56|
000038  69a0              LDR      r0,[r4,#0x18]         ;770
00003a  4406              ADD      r6,r6,r0              ;770
00003c  7860              LDRB     r0,[r4,#1]            ;771
00003e  2301              MOVS     r3,#1                 ;771
000040  4632              MOV      r2,r6                 ;771
000042  4639              MOV      r1,r7                 ;771
000044  f7fffffe          BL       disk_write
000048  1e6d              SUBS     r5,r5,#1              ;769
                  |L59.74|
00004a  2d02              CMP      r5,#2                 ;769
00004c  d2f4              BCS      |L59.56|
                  |L59.78|
00004e  2000              MOVS     r0,#0                 ;775
000050  e7e7              B        |L59.34|
;;;777    #endif
                          ENDP


                          AREA ||i.validate||, CODE, READONLY, ALIGN=1

                  validate PROC
;;;2333   static
;;;2334   FRESULT validate (	/* FR_OK(0): The object is valid, !=0: Invalid */
000000  b510              PUSH     {r4,lr}
;;;2335   	void* obj		/* Pointer to the object FIL/DIR to check validity */
;;;2336   )
;;;2337   {
;;;2338   	FIL *fil = (FIL*)obj;	/* Assuming offset of .fs and .id in the FIL/DIR structure is identical */
;;;2339   
;;;2340   
;;;2341   	if (!fil || !fil->fs || !fil->fs->fs_type || fil->fs->id != fil->id)
000002  2800              CMP      r0,#0
000004  d007              BEQ      |L60.22|
000006  6801              LDR      r1,[r0,#0]
000008  b129              CBZ      r1,|L60.22|
00000a  780a              LDRB     r2,[r1,#0]
00000c  b11a              CBZ      r2,|L60.22|
00000e  88ca              LDRH     r2,[r1,#6]
000010  8880              LDRH     r0,[r0,#4]
000012  4282              CMP      r2,r0
000014  d001              BEQ      |L60.26|
                  |L60.22|
;;;2342   		return FR_INVALID_OBJECT;
000016  2009              MOVS     r0,#9
;;;2343   
;;;2344   	ENTER_FF(fil->fs);		/* Lock file system */
;;;2345   
;;;2346   	if (disk_status(fil->fs->drv) & STA_NOINIT)
;;;2347   		return FR_NOT_READY;
;;;2348   
;;;2349   	return FR_OK;
;;;2350   }
000018  bd10              POP      {r4,pc}
                  |L60.26|
00001a  7848              LDRB     r0,[r1,#1]            ;2346
00001c  f7fffffe          BL       disk_status
000020  07c0              LSLS     r0,r0,#31             ;2346
000022  d001              BEQ      |L60.40|
000024  2003              MOVS     r0,#3                 ;2347
000026  bd10              POP      {r4,pc}
                  |L60.40|
000028  2000              MOVS     r0,#0                 ;2349
00002a  bd10              POP      {r4,pc}
;;;2351   
                          ENDP


                          AREA ||.bss||, DATA, NOINIT, ALIGN=2

                  FatFs
                          %        12

                          AREA ||.constdata||, DATA, READONLY, ALIGN=1

                  LfnOfs
000000  01030507          DCB      0x01,0x03,0x05,0x07
000004  090e1012          DCB      0x09,0x0e,0x10,0x12
000008  1416181c          DCB      0x14,0x16,0x18,0x1c
00000c  1e00              DCB      0x1e,0x00
                  vst
00000e  0400              DCW      0x0400
000010  02000100          DCW      0x0200,0x0100
000014  00800040          DCW      0x0080,0x0040
000018  00200010          DCW      0x0020,0x0010
00001c  00080004          DCW      0x0008,0x0004
000020  00020000          DCW      0x0002,0x0000
                  ||cst||
000024  80004000          DCW      0x8000,0x4000
000028  20001000          DCW      0x2000,0x1000
00002c  08004000          DCW      0x0800,0x4000
000030  20001000          DCW      0x2000,0x1000
000034  08000400          DCW      0x0800,0x0400
000038  0200              DCW      0x0200

                          AREA ||.data||, DATA, ALIGN=1

                  Fsid
000000  0000              DCB      0x00,0x00
