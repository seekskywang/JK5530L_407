/******************************************************************/
/* 名?：24c01功能函?                                                    */
/* 效果：                                                        */
/* ?容：                                                       */
/* 作者：zhan                                                  */
/* ?系方式QQ:363116119                                        */
/******************************************************************/
#include "IIC_24C01.h"
#include "AT24C01.h"
#include "my_register.h"
/*
*********************************************************************************************************
*	? ? ?: ee_CheckOk
*	????: ????EERPOMˇ???
*	?    ?u?
*	? ? ?: 1 ????i 0 ?????
*********************************************************************************************************
*/
vu8 ee_CheckOk(void)
{
	if (i2c_CheckDevice(EE_DEV_ADDR) == 0)
	{
		return 1;
	}
	else
	{
		/* ???i????I2C?????? */
		i2c_Stop();		
		return 0;
	}
}

/*
*********************************************************************************************************
*	? ? ?: ee_ReadBytes
*	????: ???EEPROM?????????????
*	?    ?u_usAddress : ????
*			 _usSize : ????i?λ???
*			 _pReadBuf : ?????????????
*	? ? ?: 0 ????i1????
*********************************************************************************************************
*/
vu8 ReadBytes(vu8 *_pReadBuf, vu16 _usAddress, vu16 _usSize)
{
	vu16 i;
	
	/* ????EEPROM?????R??il??????? */
	
	/* ?1?u??I2C?????? */
	i2c_Start();
	
	/* ?2?u??????i?7bitˇ??ibit0ˇ????λi0???i1??? */
	i2c_SendByte(EE_DEV_ADDR | I2C_WR);	/* ??ˇ??R */
	
	/* ?3?u??ACK */
	if (i2c_WaitAck() != 0)
	{
		goto cmd_fail;	/* EEPROM????? */
	}

	/* ?4?u??????i24C02??256??i??1??????i??ˇ24C04??i?o????l????? */
	i2c_SendByte((vu8)_usAddress);
	
	/* ?5?u??ACK */
	if (i2c_WaitAck() != 0)
	{
		goto cmd_fail;	/* EEPROM????? */
	}
	
	/* ?6?u????I2C??c????e????EEPROM????i???????? */
	i2c_Start();
	
	/* ?7?u??????i?7bitˇ??ibit0ˇ????λi0???i1??? */
	i2c_SendByte(EE_DEV_ADDR | I2C_RD);	/* ??ˇ??R */
	
	/* ?8?u??ACK */
	if (i2c_WaitAck() != 0)
	{
		goto cmd_fail;	/* EEPROM????? */
	}	
	
	/* ?9?u?????? */
	for (i = 0; i < _usSize; i++)
	{
		_pReadBuf[i] = i2c_ReadByte();	/* ?1??? */
		
		/* y??1????i????Acki ?????????Acki?Nack */
		if (i != _usSize - 1)
		{
			i2c_Ack();	/* ???????iCPU??ACK??(??SDA = 0) */
		}
		else
		{
			i2c_NAck();	/* ??1??????iCPU??NACK??(??SDA = 1) */
		}
	}
	/* ??I2C?????? */
	i2c_Stop();
	return 1;	/* ???? */

cmd_fail: /* ?R?????i????????i????I2C??????? */
	/* ??I2C?????? */
	i2c_Stop();
	return 0;
}

/*
*********************************************************************************************************
*	? ? ?: ee_WriteBytes
*	????: ???EEPROM??????????i???????????E
*	?    ?u_usAddress : ????
*			 _usSize : ????i?λ???
*			 _pWriteBuf : ?????????????
*	? ? ?: 0 ????i1????
*********************************************************************************************************
*/
vu8 WriteBytes(vu8 *_pWriteBuf, vu16 _usAddress, vu16 _usSize)
{
	vu16 i,m;
	vu16 usAddr;
	
	/* 
		???EEPROM???????l???????iy??????????pagec
		??24xx02ipage size = 8
		????m???u????????iu?1???i?????
		????l????E: ?????page wirte??c
	*/

	usAddr = _usAddress;	
	for (i = 0; i < _usSize; i++)
	{
		/* ????1????ˇ??????i????????????? */
		if ((i == 0) || (usAddr & (EE_PAGE_SIZE - 1)) == 0)
		{
			/*a?e?u?????i???????a*/
			i2c_Stop();
			
			/* ???????????i???????ˇ???, ???? 10ms 			
				CLK?E?200KHz?i?????30???
			*/
			for (m = 0; m < 100; m++)
			{				
				/* ?1?u??I2C?????? */
				i2c_Start();
				
				/* ?2?u??????i?7bitˇ??ibit0ˇ????λi0???i1??? */
				i2c_SendByte(EE_DEV_ADDR | I2C_WR);	/* ??ˇ??R */
				
				/* ?3?u??????i????ˇ????? */
				if (i2c_WaitAck() == 0)
				{
					break;
				}
			}
			if (m  == 1000)
			{
				goto cmd_fail;	/* EEPROM????? */
			}
		
			/* ?4?u??????i24C02??256??i??1??????i??ˇ24C04??i?o????l????? */
			i2c_SendByte((vu8)usAddr);
			
			/* ?5?u??ACK */
			if (i2c_WaitAck() != 0)
			{
				goto cmd_fail;	/* EEPROM????? */
			}
		}
	
		/* ?6?u?????? */
		i2c_SendByte(_pWriteBuf[i]);
	
		/* ?7?u??ACK */
		if (i2c_WaitAck() != 0)
		{
			goto cmd_fail;	/* EEPROM????? */
		}

		usAddr++;	/* ???1 */		
	}
	
	/* ?R????i??I2C?????? */
	i2c_Stop();
	return 1;

cmd_fail: /* ?R?????i????????i????I2C??????? */
	/* ??I2C?????? */
	i2c_Stop();
	return 0; 
}

void ee_Erase(void)
{
	vu16 i;
	vu8 buf[EE_SIZE];
	
	/* ????? */
	for (i = 0; i < EE_SIZE; i++)
	{
		buf[i] = 0xFF;
	}
	
	/* ?EEPROM, ???? = 0i????? 256 */
}

/*
*********************************************************************************************************
*	? ? ?: EEPROM_WriteByte
*	????: ???EEPROM??????????
*	?    ?uAddr : ??
*			 Data : ??
*			
*	? ? ?:
*********************************************************************************************************
*/
void EEPROM_WriteByte(vu16 Addr,vu8 Data)
{
	vu16 i,m;
	vu16 usAddr;
	/* 
		???EEPROM???????l???????iy??????????pagec
		??24xx02ipage size = 8
		????m???u????????iu?1???i?????
		????l????E: ?????page wirte??c
	*/
		usAddr = Addr;	
		/* ????1????ˇ??????i????????????? */
			/*a?e?u?????i???????a*/
			i2c_Stop();
			
			/* ???????????i???????ˇ???, ???? 10ms 			
				CLK?E?200KHz?i?????30???
			*/
			for (m = 0; m < 100; m++)
			{				
				/* ?1?u??I2C?????? */
				i2c_Start();
				
				/* ?2?u??????i?7bitˇ??ibit0ˇ????λi0???i1??? */
				i2c_SendByte(EE_DEV_ADDR | I2C_WR);	/* ??ˇ??R */
				
				/* ?3?u??????i????ˇ????? */
				if (i2c_WaitAck() == 0)
				{
					break;
				}
			}
			if (m  == 1000)
			{
				goto cmd_fail;	/* EEPROM????? */
			}
		
			/* ?4?u??????i24C02??256??i??1??????i??ˇ24C04??i?o????l????? */
			i2c_SendByte((vu8)usAddr);
			
			/* ?5?u??ACK */
			if (i2c_WaitAck() != 0)
			{
				goto cmd_fail;	/* EEPROM????? */
			}
		/* ?6?u?????? */
		i2c_SendByte(Data);
	
		/* ?7?u??ACK */
		if (i2c_WaitAck() != 0)
		{
			goto cmd_fail;	/* EEPROM????? */
		}
		/* ?R????i??I2C?????? */
		i2c_Stop();
		

		cmd_fail: /* ?R?????i????????i????I2C??????? */
		/* ??I2C?????? */
		i2c_Stop();
		          
}
/*
*********************************************************************************************************
*	? ? ?: EEPROM_ReadByte
*	????: ????????
*	?    ??eadAddr: ????
*			 
*			 
*	
*********************************************************************************************************
*/
vu8 EEPROM_READ_Byte(vu8 ReadAddr)
{
	vu16 i;
	static vu8 date;
	/* ????EEPROM?????R??il??????? */
	
	/* ?1?u??I2C?????? */
	i2c_Start();
	
	/* ?2?u??????i?7bitˇ??ibit0ˇ????λi0???i1??? */
	i2c_SendByte(EE_DEV_ADDR | I2C_WR);	/* ??ˇ??R */
	
	/* ?3?u??ACK */
	if (i2c_WaitAck() != 0)
	{
		goto cmd_fail;	/* EEPROM????? */
	}

	/* ?4?u??????i24C02??256??i??1??????i??ˇ24C04??i?o????l????? */
	i2c_SendByte(ReadAddr);
	
	/* ?5?u??ACK */
	if (i2c_WaitAck() != 0)
	{
		goto cmd_fail;	/* EEPROM????? */
	}
	
	/* ?6?u????I2C??c????e????EEPROM????i???????? */
	i2c_Start();
	
	/* ?7?u??????i?7bitˇ??ibit0ˇ????λi0???i1??? */
	i2c_SendByte(EE_DEV_ADDR | I2C_RD);	/* ??ˇ??R */
	
	/* ?8?u??ACK */
	if (i2c_WaitAck() != 0)
	{
		goto cmd_fail;	/* EEPROM????? */
	}	
	
	/* ?9?u?????? */

	 date= i2c_ReadByte();	/* ?1??? */
	
	/* y??1????i????Acki ?????????Acki?Nack */
	i2c_NAck();	/* ??1??????iCPU??NACK??(??SDA = 1) */
	/* ??I2C?????? */
	i2c_Stop();
	return date;	/* ???? ??????*/
	
	cmd_fail: /* ?R?????i????????i????I2C??????? */
	/* ??I2C?????? */
	i2c_Stop();
	return 0;
}

/*--------------------------------------------------------------------------------------------------*/

static void ee_Delay( vu32 nCount)	 //???????
{
	for(; nCount != 0; nCount--);
}

/*
 * eeprom AT24C02 ????
 */
/*********************************************END OF FILE**********************/
